# Day 07 æ¯æ—¥è€ƒè¯• - ç­”æ¡ˆè§£æ

## ğŸ“Š é€‰æ‹©é¢˜ç­”æ¡ˆï¼ˆ50 åˆ†ï¼‰

### ç¬¬ 1 é¢˜ï¼šD
**è§£æ**ï¼š`move_to` ä¸éœ€è¦ `acquires` å£°æ˜ï¼Œå› ä¸ºå®ƒæ˜¯å‘å…¨å±€å­˜å‚¨**å†™å…¥**æ–°èµ„æºï¼Œè€Œä¸æ˜¯è¯»å–æˆ–ä¿®æ”¹å·²å­˜åœ¨çš„èµ„æºã€‚åªæœ‰ `borrow_global`ã€`borrow_global_mut` å’Œ `move_from` éœ€è¦ `acquires`ã€‚

---

### ç¬¬ 2 é¢˜ï¼šB
**è§£æ**ï¼šåŒä¸€åœ°å€ä¸èƒ½å­˜å‚¨ä¸¤ä¸ªç›¸åŒç±»å‹çš„èµ„æºã€‚ç¬¬ä¸€æ¬¡ `move_to` æˆåŠŸåï¼Œç¬¬äºŒæ¬¡ä¼šè§¦å‘è¿è¡Œæ—¶é”™è¯¯ `RESOURCE_ALREADY_EXISTS`ã€‚è¿™æ˜¯ Move çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶ä¹‹ä¸€ã€‚

---

### ç¬¬ 3 é¢˜ï¼šB
**è§£æ**ï¼š`acquires` çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ç¼–è¯‘æœŸå£°æ˜å‡½æ•°ä¼šè®¿é—®å“ªäº›å…¨å±€èµ„æºï¼Œå¸®åŠ©ç¼–è¯‘å™¨æ£€æµ‹ï¼š
- èµ„æºè®¿é—®çš„åˆæ³•æ€§
- é˜²æ­¢å¾ªç¯ä¾èµ–
- ç¡®ä¿å€Ÿç”¨è§„åˆ™çš„æ­£ç¡®æ€§

---

### ç¬¬ 4 é¢˜ï¼šA
**è§£æ**ï¼š
- âœ… **A æ­£ç¡®**ï¼šå¤šä¸ªä¸å¯å˜å€Ÿç”¨å¯ä»¥åŒæ—¶å­˜åœ¨
- âŒ **B é”™è¯¯**ï¼šä¸èƒ½åŒæ—¶å­˜åœ¨ä¸¤ä¸ªå¯å˜å€Ÿç”¨
- âŒ **C é”™è¯¯**ï¼šä¸å¯å˜å’Œå¯å˜å€Ÿç”¨ä¸èƒ½åŒæ—¶å­˜åœ¨
- âŒ **D é”™è¯¯**ï¼šA æ˜¯æ­£ç¡®çš„

è¿™éµå¾ª Rust/Move çš„å€Ÿç”¨è§„åˆ™ï¼š**å¤šè¯»æˆ–å•å†™**ã€‚

---

### ç¬¬ 5 é¢˜ï¼šB
**è§£æ**ï¼šMove çš„è®¾è®¡å“²å­¦æ˜¯"èµ„æºçš„å”¯ä¸€æ‰€æœ‰æƒ"ï¼š
- æ¯ä¸ªåœ°å€æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæŸç±»å‹çš„èµ„æº
- ä¿è¯äº†èµ„æºçš„å”¯ä¸€æ€§å’Œå¯é¢„æµ‹æ€§
- é¿å…äº†çŠ¶æ€å†²çªå’Œæ•°æ®ç«äº‰
- ä½¿å¾—èµ„æºç®¡ç†æ›´åŠ æ¸…æ™°å’Œå®‰å…¨

---

### ç¬¬ 6 é¢˜ï¼šC
**è§£æ**ï¼š`move_from` åªèƒ½ä»èµ„æºçš„**æ‰€æœ‰è€…åœ°å€**ç§»é™¤èµ„æºï¼Œä¸èƒ½ä»»æ„æ“ä½œå…¶ä»–åœ°å€çš„èµ„æºã€‚è¿™æ˜¯æ‰€æœ‰æƒæœºåˆ¶çš„æ ¸å¿ƒä¿æŠ¤ã€‚

æ­£ç¡®çš„è¯´æ³•ï¼š
- âœ… è¿”å›çš„èµ„æºå¿…é¡»è¢«å¤„ç†ï¼ˆæ‰€æœ‰æƒè½¬ç§»ï¼‰
- âœ… éœ€è¦ `acquires` å£°æ˜
- âœ… èµ„æºç§»é™¤åè¯¥åœ°å€ä¸å†æœ‰æ­¤ç±»å‹èµ„æº

---

### ç¬¬ 7 é¢˜ï¼šB
**è§£æ**ï¼šä»£ç é€šè¿‡**ä½œç”¨åŸŸåˆ†ç¦»**é¿å…äº†å€Ÿç”¨å†²çªï¼š
```move
let balance = {
    let account = borrow_global<Account>(addr);  // ä¸å¯å˜å€Ÿç”¨
    account.balance
};  // ä½œç”¨åŸŸç»“æŸï¼Œå€Ÿç”¨é‡Šæ”¾

let account_mut = borrow_global_mut<Account>(addr);  // å¯å˜å€Ÿç”¨
```
ç¬¬ä¸€ä¸ªå€Ÿç”¨åœ¨ä½œç”¨åŸŸç»“æŸåé‡Šæ”¾ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªå€Ÿç”¨æ˜¯åˆæ³•çš„ã€‚

---

### ç¬¬ 8 é¢˜ï¼šD
**è§£æ**ï¼šä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š
1. **å€Ÿç”¨å†²çª**ï¼šå¦‚æœ `from` å’Œ `to` æ˜¯åŒä¸€åœ°å€ï¼Œä¼šåŒæ—¶äº§ç”Ÿä¸¤ä¸ªå¯å˜å€Ÿç”¨
2. **ç¼ºå°‘ä½™é¢æ£€æŸ¥**ï¼šæ²¡æœ‰éªŒè¯ `from_account.balance >= amount`

æ”¹è¿›æ–¹æ¡ˆï¼š
```move
assert!(signer::address_of(from) != to, E_SELF_TRANSFER);
assert!(from_account.balance >= amount, E_INSUFFICIENT_BALANCE);
```

---

### ç¬¬ 9 é¢˜ï¼šB
**è§£æ**ï¼šèµ„æºæ³¨å†Œè¡¨æ¨¡å¼çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯**é›†ä¸­ç®¡ç†**ï¼š
- ä¸€ä¸ªä¸­å¿ƒåŒ–çš„åˆçº¦å­˜å‚¨å¤šä¸ªç”¨æˆ·çš„æ•°æ®
- ä¾¿äºæ‰¹é‡æŸ¥è¯¢å’Œç®¡ç†
- å‡å°‘æ¯ä¸ªç”¨æˆ·çš„ gas æˆæœ¬
- é€‚åˆéœ€è¦å…¨å±€è§†å›¾çš„åœºæ™¯

---

### ç¬¬ 10 é¢˜ï¼šB
**è§£æ**ï¼šè¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„è¯¯è§£ï¼

**è§„åˆ™**ï¼šå¦‚æœå‡½æ•° A è°ƒç”¨äº†å‡½æ•° Bï¼Œè€Œ B æœ‰ `acquires T`ï¼Œé‚£ä¹ˆ A ä¹Ÿå¿…é¡»å£°æ˜ `acquires T`ã€‚

æ­£ç¡®å†™æ³•ï¼š
```move
public fun caller(addr: address): u64 acquires Account {
    helper(addr)
}
```

`acquires` å…·æœ‰**ä¼ é€’æ€§**ã€‚

---

### ç¬¬ 11 é¢˜ï¼ˆé™„åŠ é¢˜ï¼‰ï¼šA
**è§£æ**ï¼šè¿™æ˜¯ç»å…¸çš„**æ‡’åŠ è½½æ¨¡å¼**ï¼ˆLazy Initializationï¼‰ï¼š
- ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åˆ›å»ºèµ„æº
- åç»­è°ƒç”¨ç›´æ¥è¿”å›å·²å­˜åœ¨çš„èµ„æº
- å¸¸ç”¨äºä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆæ— éœ€å•ç‹¬çš„æ³¨å†Œæ­¥éª¤ï¼‰

æ³¨æ„ï¼š
- `exists<T>()` ä¸éœ€è¦ `acquires`ï¼ˆåªæ˜¯æ£€æŸ¥å­˜åœ¨æ€§ï¼‰
- `move_to` ä¸éœ€è¦ `acquires`ï¼ˆæ˜¯åˆ›å»ºæ“ä½œï¼‰
- åªæœ‰ `borrow_global_mut` éœ€è¦ `acquires`

---

## ğŸ“ ç¼–ç¨‹é¢˜ç­”æ¡ˆï¼ˆ50 åˆ†ï¼‰

### å®Œæ•´å®ç°ä»£ç 

```move
module my_addr::points_system {
    use std::signer;
    use std::error;
    
    /// ç”¨æˆ·ç§¯åˆ†è´¦æˆ·
    struct PointsAccount has key {
        points: u64,
        total_earned: u64,
        total_spent: u64,
        level: u8
    }
    
    /// é”™è¯¯ç 
    const E_ACCOUNT_ALREADY_EXISTS: u64 = 1;
    const E_ACCOUNT_NOT_FOUND: u64 = 2;
    const E_INSUFFICIENT_POINTS: u64 = 3;
    const E_INVALID_AMOUNT: u64 = 4;
    
    /// åˆ›å»ºç§¯åˆ†è´¦æˆ·
    public fun create_account(account: &signer) {
        let addr = signer::address_of(account);
        
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å·²å­˜åœ¨
        assert!(!exists<PointsAccount>(addr), error::already_exists(E_ACCOUNT_ALREADY_EXISTS));
        
        // åˆ›å»ºæ–°è´¦æˆ·
        let points_account = PointsAccount {
            points: 0,
            total_earned: 0,
            total_spent: 0,
            level: 0
        };
        
        move_to(account, points_account);
    }
    
    /// èµšå–ç§¯åˆ†
    public fun earn_points(account: &signer, amount: u64) acquires PointsAccount {
        // éªŒè¯é‡‘é¢
        assert!(amount > 0, error::invalid_argument(E_INVALID_AMOUNT));
        
        let addr = signer::address_of(account);
        assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));
        
        let points_account = borrow_global_mut<PointsAccount>(addr);
        
        // å¢åŠ ç§¯åˆ†
        points_account.points = points_account.points + amount;
        points_account.total_earned = points_account.total_earned + amount;
        
        // è®¡ç®—ç­‰çº§ï¼šæ¯ 1000 ç§¯åˆ†å‡ 1 çº§ï¼Œæœ€é«˜ 5 çº§
        let new_level = points_account.total_earned / 1000;
        if (new_level > 5) {
            points_account.level = 5;
        } else {
            points_account.level = (new_level as u8);
        };
    }
    
    /// æ¶ˆè´¹ç§¯åˆ†
    public fun spend_points(account: &signer, amount: u64) acquires PointsAccount {
        // éªŒè¯é‡‘é¢
        assert!(amount > 0, error::invalid_argument(E_INVALID_AMOUNT));
        
        let addr = signer::address_of(account);
        assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));
        
        let points_account = borrow_global_mut<PointsAccount>(addr);
        
        // æ£€æŸ¥ä½™é¢
        assert!(points_account.points >= amount, error::invalid_state(E_INSUFFICIENT_POINTS));
        
        // æ¶ˆè´¹ç§¯åˆ†
        points_account.points = points_account.points - amount;
        points_account.total_spent = points_account.total_spent + amount;
    }
    
    /// æŸ¥è¯¢ç§¯åˆ†ä½™é¢
    public fun get_balance(addr: address): u64 acquires PointsAccount {
        assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));
        borrow_global<PointsAccount>(addr).points
    }
    
    /// æŸ¥è¯¢ç”¨æˆ·ç­‰çº§
    public fun get_level(addr: address): u8 acquires PointsAccount {
        assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));
        borrow_global<PointsAccount>(addr).level
    }
    
    /// æŸ¥è¯¢è´¦æˆ·ç»Ÿè®¡ä¿¡æ¯
    public fun get_statistics(addr: address): (u64, u64, u64, u8) acquires PointsAccount {
        assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));
        
        let account = borrow_global<PointsAccount>(addr);
        (account.points, account.total_earned, account.total_spent, account.level)
    }
    
    /// æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
    public fun account_exists(addr: address): bool {
        exists<PointsAccount>(addr)
    }
    
    #[test(user = @0x1)]
    fun test_points_system(user: &signer) acquires PointsAccount {
        create_account(user);
        let addr = signer::address_of(user);
        
        earn_points(user, 500);
        assert!(get_balance(addr) == 500, 0);
        assert!(get_level(addr) == 0, 1);
        
        earn_points(user, 1500);
        assert!(get_balance(addr) == 2000, 2);
        assert!(get_level(addr) == 2, 3);
        
        spend_points(user, 500);
        assert!(get_balance(addr) == 1500, 4);
        
        let (points, earned, spent, level) = get_statistics(addr);
        assert!(points == 1500, 5);
        assert!(earned == 2000, 6);
        assert!(spent == 500, 7);
        assert!(level == 2, 8);
    }
    
    #[test(user = @0x1)]
    #[expected_failure(abort_code = E_ACCOUNT_ALREADY_EXISTS)]
    fun test_duplicate_account(user: &signer) {
        create_account(user);
        create_account(user);
    }
    
    #[test(user = @0x1)]
    #[expected_failure(abort_code = E_INSUFFICIENT_POINTS)]
    fun test_insufficient_points(user: &signer) acquires PointsAccount {
        create_account(user);
        earn_points(user, 100);
        spend_points(user, 200);
    }
}
```

### å…³é”®ç‚¹è§£æ

#### 1. create_accountï¼ˆ10 åˆ†ï¼‰
```move
// âœ… æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
assert!(!exists<PointsAccount>(addr), error::already_exists(E_ACCOUNT_ALREADY_EXISTS));

// âœ… åˆå§‹åŒ–æ‰€æœ‰å­—æ®µ
let points_account = PointsAccount {
    points: 0,
    total_earned: 0,
    total_spent: 0,
    level: 0
};

// âœ… å­˜å‚¨åˆ°å…¨å±€
move_to(account, points_account);
```

#### 2. earn_pointsï¼ˆ15 åˆ†ï¼‰
```move
// âœ… éªŒè¯é‡‘é¢
assert!(amount > 0, error::invalid_argument(E_INVALID_AMOUNT));

// âœ… æ›´æ–°ç§¯åˆ†
points_account.points = points_account.points + amount;
points_account.total_earned = points_account.total_earned + amount;

// âœ… ç­‰çº§è®¡ç®—ï¼ˆå…³é”®ï¼ï¼‰
let new_level = points_account.total_earned / 1000;
if (new_level > 5) {
    points_account.level = 5;  // æœ€é«˜ 5 çº§
} else {
    points_account.level = (new_level as u8);
};
```

#### 3. spend_pointsï¼ˆ10 åˆ†ï¼‰
```move
// âœ… ä½™é¢æ£€æŸ¥
assert!(points_account.points >= amount, error::invalid_state(E_INSUFFICIENT_POINTS));

// âœ… æ›´æ–°çŠ¶æ€
points_account.points = points_account.points - amount;
points_account.total_spent = points_account.total_spent + amount;
```

#### 4. æŸ¥è¯¢å‡½æ•°ï¼ˆ10 åˆ†ï¼‰
```move
// âœ… ä½¿ç”¨ exists æ£€æŸ¥
assert!(exists<PointsAccount>(addr), error::not_found(E_ACCOUNT_NOT_FOUND));

// âœ… ä½¿ç”¨ borrow_global è¯»å–
borrow_global<PointsAccount>(addr).points
```

#### 5. acquires å£°æ˜ï¼ˆ5 åˆ†ï¼‰
```move
// âœ… æ‰€æœ‰è®¿é—®å…¨å±€å­˜å‚¨çš„å‡½æ•°éƒ½éœ€è¦
public fun earn_points(account: &signer, amount: u64) acquires PointsAccount {
    // ...
}

// âœ… åªæ£€æŸ¥å­˜åœ¨æ€§ä¸éœ€è¦ acquires
public fun account_exists(addr: address): bool {
    exists<PointsAccount>(addr)
}
```

---

## ğŸ¯ å¸¸è§é”™è¯¯åŠæ‰£åˆ†ç‚¹

### âŒ é”™è¯¯ 1ï¼šå¿˜è®° acquires å£°æ˜ï¼ˆ-5 åˆ†ï¼‰
```move
// é”™è¯¯
public fun get_balance(addr: address): u64 {
    borrow_global<PointsAccount>(addr).points  // ç¼–è¯‘é”™è¯¯ï¼
}

// æ­£ç¡®
public fun get_balance(addr: address): u64 acquires PointsAccount {
    borrow_global<PointsAccount>(addr).points
}
```

### âŒ é”™è¯¯ 2ï¼šç­‰çº§è®¡ç®—é”™è¯¯ï¼ˆ-10 åˆ†ï¼‰
```move
// é”™è¯¯ï¼šæ²¡æœ‰é™åˆ¶æœ€é«˜ç­‰çº§
points_account.level = (points_account.total_earned / 1000 as u8);

// æ­£ç¡®ï¼šä½¿ç”¨ min å‡½æ•°æˆ– if è¯­å¥
let new_level = points_account.total_earned / 1000;
if (new_level > 5) {
    points_account.level = 5;
} else {
    points_account.level = (new_level as u8);
};
```

### âŒ é”™è¯¯ 3ï¼šç¼ºå°‘ä½™é¢æ£€æŸ¥ï¼ˆ-5 åˆ†ï¼‰
```move
// é”™è¯¯ï¼šç›´æ¥æ‰£é™¤å¯èƒ½å¯¼è‡´ä¸‹æº¢
points_account.points = points_account.points - amount;

// æ­£ç¡®ï¼šå…ˆæ£€æŸ¥
assert!(points_account.points >= amount, E_INSUFFICIENT_POINTS);
points_account.points = points_account.points - amount;
```

### âŒ é”™è¯¯ 4ï¼šé‡å¤åˆ›å»ºè´¦æˆ·æœªæ£€æŸ¥ï¼ˆ-5 åˆ†ï¼‰
```move
// é”™è¯¯ï¼šæ²¡æœ‰æ£€æŸ¥
public fun create_account(account: &signer) {
    move_to(account, PointsAccount { ... });  // å¯èƒ½å¤±è´¥
}

// æ­£ç¡®ï¼šå…ˆæ£€æŸ¥
assert!(!exists<PointsAccount>(addr), E_ACCOUNT_ALREADY_EXISTS);
move_to(account, PointsAccount { ... });
```

---

## ğŸ“Š è¯„åˆ†ç»†åˆ™

### é€‰æ‹©é¢˜ï¼ˆ50 åˆ†ï¼‰
- å‰ 10 é¢˜ï¼šæ¯é¢˜ 5 åˆ†
- ç¬¬ 11 é¢˜é™„åŠ é¢˜ï¼š10 åˆ†

### ç¼–ç¨‹é¢˜ï¼ˆ50 åˆ†ï¼‰
| åŠŸèƒ½æ¨¡å— | åˆ†æ•° | è¯„åˆ†ç‚¹ |
|---------|------|--------|
| create_account | 10 | exists æ£€æŸ¥ (3)ã€åˆå§‹åŒ– (4)ã€move_to (3) |
| earn_points | 15 | é‡‘é¢éªŒè¯ (2)ã€ç§¯åˆ†æ›´æ–° (5)ã€ç­‰çº§è®¡ç®— (8) |
| spend_points | 10 | ä½™é¢æ£€æŸ¥ (5)ã€ç§¯åˆ†æ‰£é™¤ (5) |
| æŸ¥è¯¢å‡½æ•° | 10 | exists æ£€æŸ¥ (3)ã€borrow_global (4)ã€è¿”å›å€¼ (3) |
| acquires å£°æ˜ | 5 | æ‰€æœ‰éœ€è¦çš„åœ°æ–¹éƒ½æ­£ç¡®å£°æ˜ |

### æ€»åˆ†åˆ†å¸ƒ
- **90-100 åˆ†**ï¼šä¼˜ç§€ï¼Œå®Œå…¨æŒæ¡
- **80-89 åˆ†**ï¼šè‰¯å¥½ï¼ŒåŸºæœ¬æŒæ¡
- **70-79 åˆ†**ï¼šåŠæ ¼ï¼Œéœ€è¦åŠ å¼º
- **< 70 åˆ†**ï¼šä¸åŠæ ¼ï¼Œéœ€è¦é‡å­¦

---

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ç†è§£ acquires çš„æœ¬è´¨**ï¼š
   - ç¼–è¯‘æœŸèµ„æºè®¿é—®å£°æ˜
   - é˜²æ­¢å¾ªç¯ä¾èµ–
   - ç¡®ä¿å€Ÿç”¨å®‰å…¨

2. **æŒæ¡å€Ÿç”¨è§„åˆ™**ï¼š
   - å¤šä¸ªä¸å¯å˜å€Ÿç”¨ âœ…
   - ä¸€ä¸ªå¯å˜å€Ÿç”¨ âœ…
   - æ··åˆå€Ÿç”¨ âŒ

3. **èµ„æºæ“ä½œæ¨¡å¼**ï¼š
   - åˆ›å»ºï¼š`move_to`
   - è¯»å–ï¼š`borrow_global`
   - ä¿®æ”¹ï¼š`borrow_global_mut`
   - åˆ é™¤ï¼š`move_from`
   - æ£€æŸ¥ï¼š`exists`

4. **é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**ï¼š
   - å®šä¹‰æ¸…æ™°çš„é”™è¯¯ç 
   - ä½¿ç”¨ `error` æ¨¡å—çš„æ ‡å‡†å‡½æ•°
   - å…ˆéªŒè¯å†æ“ä½œ

---

**å¦‚æœä½ çš„åˆ†æ•°ä½äº 70 åˆ†ï¼Œå»ºè®®é‡æ–°å­¦ä¹ æœ¬ç« å†…å®¹ï¼** ğŸ“š
