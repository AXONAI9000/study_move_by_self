# Day 04: ç»“æ„ä½“ä¸èµ„æºæ¦‚å¿µ - ç¼–ç¨‹é¢˜

## é¢˜ç›® 1ï¼šé“¶è¡Œè´¦æˆ·ç³»ç»Ÿï¼ˆéš¾åº¦ï¼šâ­â­ï¼‰

### é—®é¢˜æè¿°
å®ç°ä¸€ä¸ªç®€å•çš„é“¶è¡Œè´¦æˆ·ç³»ç»Ÿï¼Œæ”¯æŒå¼€æˆ·ã€å­˜æ¬¾ã€å–æ¬¾å’ŒæŸ¥è¯¢ä½™é¢åŠŸèƒ½ã€‚

### è¦æ±‚
1. å®šä¹‰ `BankAccount` èµ„æºï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
   - `account_number`: è´¦æˆ·å·ç ï¼ˆu64ï¼‰
   - `owner`: è´¦æˆ·æ‰€æœ‰è€…åœ°å€ï¼ˆaddressï¼‰
   - `balance`: è´¦æˆ·ä½™é¢ï¼ˆu64ï¼‰
   - `is_active`: è´¦æˆ·æ˜¯å¦æ¿€æ´»ï¼ˆboolï¼‰

2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
```move
// å¼€æˆ·
public fun open_account(account: &signer, account_number: u64, initial_balance: u64)

// å­˜æ¬¾
public fun deposit(addr: address, amount: u64)

// å–æ¬¾
public fun withdraw(account: &signer, amount: u64)

// æŸ¥è¯¢ä½™é¢
public fun get_balance(addr: address): u64

// å†»ç»“è´¦æˆ·
public fun freeze_account(account: &signer)

// è§£å†»è´¦æˆ·
public fun unfreeze_account(account: &signer)
```

### æµ‹è¯•ç”¨ä¾‹
```move
#[test(user = @0x123)]
public fun test_bank_account(user: &signer) {
    open_account(user, 1001, 1000);
    
    let addr = signer::address_of(user);
    assert!(get_balance(addr) == 1000, 0);
    
    deposit(addr, 500);
    assert!(get_balance(addr) == 1500, 1);
    
    withdraw(user, 300);
    assert!(get_balance(addr) == 1200, 2);
}
```

### è¯„åˆ†æ ‡å‡†
- ç»“æ„ä½“å®šä¹‰æ­£ç¡®ï¼ˆ20åˆ†ï¼‰
- å‡½æ•°å®ç°å®Œæ•´ï¼ˆ40åˆ†ï¼‰
- é”™è¯¯å¤„ç†å¾—å½“ï¼ˆ20åˆ†ï¼‰
- æµ‹è¯•é€šè¿‡ï¼ˆ20åˆ†ï¼‰

---

## é¢˜ç›® 2ï¼šä»£å¸äº¤æ¢æ± ï¼ˆéš¾åº¦ï¼šâ­â­â­ï¼‰

### é—®é¢˜æè¿°
å®ç°ä¸€ä¸ªç®€å•çš„è‡ªåŠ¨åŒ–åšå¸‚å•†ï¼ˆAMMï¼‰ä»£å¸äº¤æ¢æ± ï¼Œæ”¯æŒä¸¤ç§ä»£å¸ä¹‹é—´çš„å…‘æ¢ã€‚

### è¦æ±‚
1. å®šä¹‰ä»£å¸ç±»å‹ï¼š
```move
struct CoinA has drop {}
struct CoinB has drop {}
```

2. å®šä¹‰ `LiquidityPool` èµ„æºï¼š
   - `reserve_a`: CoinA çš„å‚¨å¤‡é‡ï¼ˆu64ï¼‰
   - `reserve_b`: CoinB çš„å‚¨å¤‡é‡ï¼ˆu64ï¼‰
   - `total_liquidity`: æ€»æµåŠ¨æ€§ä»½é¢ï¼ˆu64ï¼‰

3. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
```move
// åˆå§‹åŒ–æµåŠ¨æ€§æ± 
public fun initialize_pool(admin: &signer, initial_a: u64, initial_b: u64)

// æ·»åŠ æµåŠ¨æ€§
public fun add_liquidity(account: &signer, amount_a: u64, amount_b: u64): u64

// ç§»é™¤æµåŠ¨æ€§
public fun remove_liquidity(account: &signer, liquidity: u64): (u64, u64)

// äº¤æ¢ A åˆ° Bï¼ˆä½¿ç”¨å¸¸æ•°ä¹˜ç§¯å…¬å¼ x * y = kï¼‰
public fun swap_a_to_b(amount_in: u64): u64

// äº¤æ¢ B åˆ° A
public fun swap_b_to_a(amount_in: u64): u64

// è·å–å‚¨å¤‡é‡
public fun get_reserves(): (u64, u64)
```

### æç¤º
å¸¸æ•°ä¹˜ç§¯å…¬å¼ï¼š`reserve_a * reserve_b = k`ï¼ˆå¸¸æ•°ï¼‰

äº¤æ¢è®¡ç®—ï¼š
```
amount_out = (reserve_out * amount_in) / (reserve_in + amount_in)
```

### æµ‹è¯•ç”¨ä¾‹
```move
#[test(admin = @0x1)]
public fun test_liquidity_pool(admin: &signer) {
    initialize_pool(admin, 1000, 2000);
    
    let (reserve_a, reserve_b) = get_reserves();
    assert!(reserve_a == 1000 && reserve_b == 2000, 0);
    
    // æµ‹è¯•äº¤æ¢
    let amount_out = swap_a_to_b(100);
    // éªŒè¯è¾“å‡ºé‡‘é¢åˆç†æ€§
    assert!(amount_out > 0 && amount_out < 200, 1);
}
```

### è¯„åˆ†æ ‡å‡†
- ç»“æ„ä½“å’Œç±»å‹å®šä¹‰ï¼ˆ15åˆ†ï¼‰
- æµåŠ¨æ€§ç®¡ç†å‡½æ•°ï¼ˆ25åˆ†ï¼‰
- äº¤æ¢å‡½æ•°å®ç°ï¼ˆ35åˆ†ï¼‰
- æ•°å­¦è®¡ç®—æ­£ç¡®ï¼ˆ15åˆ†ï¼‰
- æµ‹è¯•è¦†ç›–ï¼ˆ10åˆ†ï¼‰

---

## é¢˜ç›® 3ï¼šæŠ•ç¥¨æ²»ç†ç³»ç»Ÿï¼ˆéš¾åº¦ï¼šâ­â­â­â­ï¼‰

### é—®é¢˜æè¿°
å®ç°ä¸€ä¸ªå»ä¸­å¿ƒåŒ–è‡ªæ²»ç»„ç»‡ï¼ˆDAOï¼‰çš„æŠ•ç¥¨æ²»ç†ç³»ç»Ÿï¼Œæ”¯æŒææ¡ˆåˆ›å»ºã€æŠ•ç¥¨å’Œæ‰§è¡Œã€‚

### è¦æ±‚
1. å®šä¹‰ç»“æ„ä½“ï¼š
```move
struct Proposal has store, drop {
    id: u64,
    title: vector<u8>,
    description: vector<u8>,
    proposer: address,
    yes_votes: u64,
    no_votes: u64,
    end_time: u64,
    executed: bool,
}

struct Vote has store {
    proposal_id: u64,
    voter: address,
    support: bool,
    voting_power: u64,
}

struct GovernanceToken has key {
    balance: u64,
}

struct DAO has key {
    proposals: vector<Proposal>,
    votes: vector<Vote>,
    next_proposal_id: u64,
    quorum: u64,  // æœ€å°æŠ•ç¥¨æ•°è¦æ±‚
}
```

2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
```move
// åˆå§‹åŒ– DAO
public fun initialize_dao(admin: &signer, quorum: u64)

// åˆ†å‘æ²»ç†ä»£å¸
public fun mint_governance_token(account: &signer, amount: u64)

// åˆ›å»ºææ¡ˆ
public fun create_proposal(
    account: &signer,
    dao_addr: address,
    title: vector<u8>,
    description: vector<u8>,
    end_time: u64
): u64

// æŠ•ç¥¨
public fun cast_vote(
    account: &signer,
    dao_addr: address,
    proposal_id: u64,
    support: bool
)

// æ£€æŸ¥ææ¡ˆæ˜¯å¦é€šè¿‡
public fun is_proposal_passed(dao_addr: address, proposal_id: u64): bool

// æ‰§è¡Œææ¡ˆ
public fun execute_proposal(
    account: &signer,
    dao_addr: address,
    proposal_id: u64
)

// è·å–ææ¡ˆè¯¦æƒ…
public fun get_proposal_info(dao_addr: address, proposal_id: u64): (u64, u64, bool)
```

### ä¸šåŠ¡è§„åˆ™
1. åªæœ‰æŒæœ‰æ²»ç†ä»£å¸çš„åœ°å€æ‰èƒ½åˆ›å»ºææ¡ˆ
2. æŠ•ç¥¨æƒé‡ç­‰äºæŒæœ‰çš„ä»£å¸æ•°é‡
3. åŒä¸€åœ°å€å¯¹åŒä¸€ææ¡ˆåªèƒ½æŠ•ç¥¨ä¸€æ¬¡
4. ææ¡ˆé€šè¿‡æ¡ä»¶ï¼š
   - æŠ•ç¥¨æ€»æ•° >= æ³•å®šäººæ•°ï¼ˆquorumï¼‰
   - èµæˆç¥¨ > åå¯¹ç¥¨
5. åªæœ‰ææ¡ˆåˆ›å»ºè€…å¯ä»¥æ‰§è¡Œå·²é€šè¿‡çš„ææ¡ˆ

### æµ‹è¯•ç”¨ä¾‹
```move
#[test(admin = @0x1, user1 = @0x2, user2 = @0x3)]
public fun test_governance(admin: &signer, user1: &signer, user2: &signer) {
    // åˆå§‹åŒ– DAO
    initialize_dao(admin, 100);
    
    // åˆ†å‘ä»£å¸
    mint_governance_token(user1, 60);
    mint_governance_token(user2, 50);
    
    // åˆ›å»ºææ¡ˆ
    let dao_addr = signer::address_of(admin);
    let proposal_id = create_proposal(
        user1,
        dao_addr,
        b"Proposal 1",
        b"Test proposal",
        1000000
    );
    
    // æŠ•ç¥¨
    cast_vote(user1, dao_addr, proposal_id, true);
    cast_vote(user2, dao_addr, proposal_id, true);
    
    // æ£€æŸ¥ç»“æœ
    assert!(is_proposal_passed(dao_addr, proposal_id), 0);
    
    // æ‰§è¡Œææ¡ˆ
    execute_proposal(user1, dao_addr, proposal_id);
}
```

### è¯„åˆ†æ ‡å‡†
- æ•°æ®ç»“æ„è®¾è®¡ï¼ˆ20åˆ†ï¼‰
- ææ¡ˆç®¡ç†ï¼ˆ25åˆ†ï¼‰
- æŠ•ç¥¨é€»è¾‘ï¼ˆ25åˆ†ï¼‰
- æƒé™æ§åˆ¶ï¼ˆ15åˆ†ï¼‰
- è¾¹ç•Œæ¡ä»¶å¤„ç†ï¼ˆ15åˆ†ï¼‰

---

## é¢˜ç›® 4ï¼šå¤šç­¾é’±åŒ…ï¼ˆéš¾åº¦ï¼šâ­â­â­â­â­ï¼‰

### é—®é¢˜æè¿°
å®ç°ä¸€ä¸ªå¤šé‡ç­¾åé’±åŒ…ç³»ç»Ÿï¼Œéœ€è¦å¤šä¸ªæ‰€æœ‰è€…å…±åŒç­¾åæ‰èƒ½æ‰§è¡Œäº¤æ˜“ã€‚

### è¦æ±‚
1. å®šä¹‰ç»“æ„ä½“ï¼š
```move
struct Transaction has store, drop {
    id: u64,
    to: address,
    amount: u64,
    executed: bool,
    confirmations: vector<address>,
}

struct MultiSigWallet has key {
    owners: vector<address>,
    required_confirmations: u64,
    transactions: vector<Transaction>,
    next_tx_id: u64,
    balance: u64,
}
```

2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
```move
// åˆ›å»ºå¤šç­¾é’±åŒ…
public fun create_wallet(
    creator: &signer,
    owners: vector<address>,
    required_confirmations: u64
)

// å­˜å…¥èµ„é‡‘
public fun deposit(wallet_addr: address, amount: u64)

// æäº¤äº¤æ˜“
public fun submit_transaction(
    owner: &signer,
    wallet_addr: address,
    to: address,
    amount: u64
): u64

// ç¡®è®¤äº¤æ˜“
public fun confirm_transaction(
    owner: &signer,
    wallet_addr: address,
    tx_id: u64
)

// æ’¤é”€ç¡®è®¤
public fun revoke_confirmation(
    owner: &signer,
    wallet_addr: address,
    tx_id: u64
)

// æ‰§è¡Œäº¤æ˜“
public fun execute_transaction(
    owner: &signer,
    wallet_addr: address,
    tx_id: u64
)

// æ£€æŸ¥æ˜¯å¦ä¸ºæ‰€æœ‰è€…
public fun is_owner(wallet_addr: address, addr: address): bool

// è·å–ç¡®è®¤æ•°
public fun get_confirmation_count(wallet_addr: address, tx_id: u64): u64

// æ£€æŸ¥äº¤æ˜“æ˜¯å¦å·²ç¡®è®¤
public fun is_confirmed(wallet_addr: address, tx_id: u64): bool
```

### ä¸šåŠ¡è§„åˆ™
1. é’±åŒ…åˆ›å»ºæ—¶å¿…é¡»æŒ‡å®šæ‰€æœ‰è€…åˆ—è¡¨å’Œæ‰€éœ€ç¡®è®¤æ•°
2. æ‰€éœ€ç¡®è®¤æ•°å¿…é¡» <= æ‰€æœ‰è€…æ•°é‡
3. åªæœ‰æ‰€æœ‰è€…å¯ä»¥æäº¤ã€ç¡®è®¤å’Œæ‰§è¡Œäº¤æ˜“
4. åŒä¸€æ‰€æœ‰è€…ä¸èƒ½å¯¹åŒä¸€äº¤æ˜“é‡å¤ç¡®è®¤
5. äº¤æ˜“åªæœ‰åœ¨è·å¾—è¶³å¤Ÿç¡®è®¤åæ‰èƒ½æ‰§è¡Œ
6. å·²æ‰§è¡Œçš„äº¤æ˜“ä¸èƒ½å†æ¬¡æ‰§è¡Œ
7. ä½™é¢å¿…é¡»è¶³å¤Ÿæ‰èƒ½æ‰§è¡Œäº¤æ˜“

### æµ‹è¯•ç”¨ä¾‹
```move
#[test(owner1 = @0x1, owner2 = @0x2, owner3 = @0x3, recipient = @0x4)]
public fun test_multisig_wallet(
    owner1: &signer,
    owner2: &signer,
    owner3: &signer,
    recipient: &signer
) {
    // åˆ›å»ºé’±åŒ…ï¼ˆ3ä¸ªæ‰€æœ‰è€…ï¼Œéœ€è¦2ä¸ªç¡®è®¤ï¼‰
    let owners = vector::empty<address>();
    vector::push_back(&mut owners, signer::address_of(owner1));
    vector::push_back(&mut owners, signer::address_of(owner2));
    vector::push_back(&mut owners, signer::address_of(owner3));
    
    create_wallet(owner1, owners, 2);
    
    let wallet_addr = signer::address_of(owner1);
    
    // å­˜å…¥èµ„é‡‘
    deposit(wallet_addr, 1000);
    
    // æäº¤äº¤æ˜“
    let tx_id = submit_transaction(
        owner1,
        wallet_addr,
        signer::address_of(recipient),
        500
    );
    
    // ç¬¬ä¸€ä¸ªç¡®è®¤ï¼ˆæäº¤è€…è‡ªåŠ¨ç¡®è®¤ï¼‰
    assert!(get_confirmation_count(wallet_addr, tx_id) == 1, 0);
    
    // ç¬¬äºŒä¸ªç¡®è®¤
    confirm_transaction(owner2, wallet_addr, tx_id);
    assert!(get_confirmation_count(wallet_addr, tx_id) == 2, 1);
    
    // ç°åœ¨å¯ä»¥æ‰§è¡Œ
    assert!(is_confirmed(wallet_addr, tx_id), 2);
    execute_transaction(owner1, wallet_addr, tx_id);
}
```

### è¯„åˆ†æ ‡å‡†
- æ•°æ®ç»“æ„è®¾è®¡ï¼ˆ15åˆ†ï¼‰
- é’±åŒ…åˆ›å»ºå’ŒéªŒè¯ï¼ˆ15åˆ†ï¼‰
- äº¤æ˜“æäº¤é€»è¾‘ï¼ˆ20åˆ†ï¼‰
- ç¡®è®¤ç®¡ç†ï¼ˆ20åˆ†ï¼‰
- äº¤æ˜“æ‰§è¡Œï¼ˆ20åˆ†ï¼‰
- å®‰å…¨æ£€æŸ¥ï¼ˆ10åˆ†ï¼‰

---

## ğŸ“ æäº¤è¯´æ˜

### æ–‡ä»¶ç»“æ„
```
sources/
â”œâ”€â”€ problem1_bank.move
â”œâ”€â”€ problem2_pool.move
â”œâ”€â”€ problem3_governance.move
â””â”€â”€ problem4_multisig.move
```

### æäº¤è¦æ±‚
1. æ¯é“é¢˜åˆ›å»ºç‹¬ç«‹çš„æ¨¡å—æ–‡ä»¶
2. åŒ…å«å®Œæ•´çš„å‡½æ•°å®ç°
3. æ·»åŠ å¿…è¦çš„æ³¨é‡Šè¯´æ˜
4. åŒ…å«æµ‹è¯•ç”¨ä¾‹
5. ç¡®ä¿ä»£ç å¯ä»¥ç¼–è¯‘é€šè¿‡

### ç¼–è¯‘å’Œæµ‹è¯•
```bash
# ç¼–è¯‘
aptos move compile

# æµ‹è¯•æ‰€æœ‰é¢˜ç›®
aptos move test

# æµ‹è¯•ç‰¹å®šé¢˜ç›®
aptos move test --filter test_bank_account
```

---

## ğŸ’¡ è§£é¢˜æç¤º

### é¢˜ç›® 1 æç¤º
- ä½¿ç”¨ `assert!` éªŒè¯è´¦æˆ·çŠ¶æ€
- å–æ¬¾æ—¶æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
- å†»ç»“çš„è´¦æˆ·ä¸èƒ½è¿›è¡Œäº¤æ˜“

### é¢˜ç›® 2 æç¤º
- æ’å®šä¹˜ç§¯å…¬å¼ï¼š`x * y = k`
- é¿å…é™¤é›¶é”™è¯¯
- æµåŠ¨æ€§ä»½é¢æŒ‰æ¯”ä¾‹åˆ†é…

### é¢˜ç›® 3 æç¤º
- ä½¿ç”¨ `vector::length` éå†æŸ¥æ‰¾
- é˜²æ­¢é‡å¤æŠ•ç¥¨
- ææ¡ˆæ—¶é—´éªŒè¯

### é¢˜ç›® 4 æç¤º
- ä½¿ç”¨ `vector::contains` æ£€æŸ¥æ‰€æœ‰è€…
- ç¡®è®¤åˆ—è¡¨ä¸åº”åŒ…å«é‡å¤åœ°å€
- ä»”ç»†å¤„ç†è¾¹ç•Œæ¡ä»¶

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆè¿™äº›ç¼–ç¨‹é¢˜åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

âœ… ç†Ÿç»ƒå®šä¹‰å’Œä½¿ç”¨ç»“æ„ä½“  
âœ… æ­£ç¡®é€‰æ‹©å’Œåº”ç”¨èƒ½åŠ›ç³»ç»Ÿ  
âœ… ç®¡ç†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ  
âœ… å®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘  
âœ… è¿›è¡Œå……åˆ†çš„é”™è¯¯å¤„ç†  
âœ… ç¼–å†™å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹  

**ç¥ä½ ç¼–ç¨‹æ„‰å¿«ï¼** ğŸš€
