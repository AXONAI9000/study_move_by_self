# æ ¸å¿ƒæ¦‚å¿µï¼šå®Œæ•´ DEX æ¶æ„è®¾è®¡

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#1-ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æ¨¡å—åŒ–è®¾è®¡åŸåˆ™](#2-æ¨¡å—åŒ–è®¾è®¡åŸåˆ™)
3. [æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†](#3-æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†)
4. [äº‹ä»¶ç³»ç»Ÿè®¾è®¡](#4-äº‹ä»¶ç³»ç»Ÿè®¾è®¡)
5. [å®‰å…¨æœ€ä½³å®è·µ](#5-å®‰å…¨æœ€ä½³å®è·µ)
6. [å‰åç«¯é›†æˆæ–¹æ¡ˆ](#6-å‰åç«¯é›†æˆæ–¹æ¡ˆ)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## 1. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„

ä¸€ä¸ªå®Œæ•´çš„ DEX ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚ï¼ˆFrontendï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Swap    â”‚  â”‚ Liquidity â”‚  â”‚ Pool List â”‚  â”‚ Analyticsâ”‚ â”‚
â”‚  â”‚ Component â”‚  â”‚ Component â”‚  â”‚ Component â”‚  â”‚Component â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚              â”‚              â”‚             â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Aptos TypeScript SDK                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Transaction  â”‚  â”‚   View      â”‚  â”‚    Event    â”‚       â”‚
â”‚  â”‚   Builder    â”‚  â”‚  Functions  â”‚  â”‚   Listener  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚              â”‚
                        â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Aptos åŒºå—é“¾å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              DEX æ ¸å¿ƒæ¨¡å—ï¼ˆdex.moveï¼‰                 â”‚   â”‚
â”‚  â”‚  - åˆå§‹åŒ–å’Œé…ç½®                                       â”‚   â”‚
â”‚  â”‚  - æƒé™ç®¡ç†                                          â”‚   â”‚
â”‚  â”‚  - ç´§æ€¥æš‚åœ                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æµåŠ¨æ€§æ± æ¨¡å—ï¼ˆliquidity_pool.moveï¼‰                  â”‚   â”‚
â”‚  â”‚  - åˆ›å»ºäº¤æ˜“å¯¹                                         â”‚   â”‚
â”‚  â”‚  - æ·»åŠ /ç§»é™¤æµåŠ¨æ€§                                    â”‚   â”‚
â”‚  â”‚  - LP Token ç®¡ç†                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Swap è·¯ç”±æ¨¡å—ï¼ˆswap_router.moveï¼‰                   â”‚   â”‚
â”‚  â”‚  - Exact Input Swap                                  â”‚   â”‚
â”‚  â”‚  - Exact Output Swap                                 â”‚   â”‚
â”‚  â”‚  - å¤šè·³è·¯ç”±                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é¢„è¨€æœºé›†æˆæ¨¡å—ï¼ˆoracle_integration.moveï¼‰            â”‚   â”‚
â”‚  â”‚  - ä»·æ ¼æŸ¥è¯¢                                           â”‚   â”‚
â”‚  â”‚  - TVL è®¡ç®—                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¾…åŠ©æ¨¡å—                                             â”‚   â”‚
â”‚  â”‚  - æ•°å­¦åº“ï¼ˆmath.moveï¼‰                               â”‚   â”‚
â”‚  â”‚  - äº‹ä»¶å®šä¹‰ï¼ˆevents.moveï¼‰                           â”‚   â”‚
â”‚  â”‚  - é”™è¯¯å®šä¹‰ï¼ˆerrors.moveï¼‰                           â”‚   â”‚
â”‚  â”‚  - ä»£å¸æ³¨å†Œè¡¨ï¼ˆtoken_registry.moveï¼‰                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨¡å—èŒè´£

#### 1.2.1 æ ¸å¿ƒæ¨¡å—ï¼ˆdex.moveï¼‰

**èŒè´£**ï¼š
- DEX å…¨å±€é…ç½®å’Œåˆå§‹åŒ–
- æƒé™ç®¡ç†ï¼ˆç®¡ç†å‘˜ã€æ“ä½œå‘˜ï¼‰
- ç´§æ€¥æš‚åœæœºåˆ¶
- åè®®è´¹ç”¨æ”¶å–

**å…³é”®å‡½æ•°**ï¼š
```move
module dex_addr::dex {
    /// åˆå§‹åŒ– DEX
    public entry fun initialize(admin: &signer)
    
    /// è®¾ç½®è´¹ç‡
    public entry fun set_fee_rate(admin: &signer, new_rate: u64)
    
    /// ç´§æ€¥æš‚åœ
    public entry fun pause(admin: &signer)
    
    /// æ¢å¤è¿è¡Œ
    public entry fun unpause(admin: &signer)
    
    /// æå–åè®®è´¹ç”¨
    public entry fun collect_protocol_fees<X, Y>(admin: &signer)
}
```

#### 1.2.2 æµåŠ¨æ€§æ± æ¨¡å—ï¼ˆliquidity_pool.moveï¼‰

**èŒè´£**ï¼š
- ç®¡ç†æµåŠ¨æ€§æ± çš„ç”Ÿå‘½å‘¨æœŸ
- å¤„ç†æµåŠ¨æ€§çš„æ·»åŠ å’Œç§»é™¤
- LP Token çš„é“¸é€ å’Œé”€æ¯
- ç»´æŠ¤æ± å­å‚¨å¤‡

**å…³é”®æ•°æ®ç»“æ„**ï¼š
```move
struct LiquidityPool<phantom X, phantom Y> has key {
    /// ä»£å¸ X å‚¨å¤‡
    reserve_x: Coin<X>,
    
    /// ä»£å¸ Y å‚¨å¤‡
    reserve_y: Coin<Y>,
    
    /// LP Token æ€»ä¾›åº”é‡
    lp_token_supply: u64,
    
    /// ç´¯ç§¯çš„åè®®è´¹ç”¨
    protocol_fee_x: Coin<X>,
    protocol_fee_y: Coin<Y>,
    
    /// æ± å­åˆ›å»ºæ—¶é—´
    created_at: u64,
    
    /// ç´¯ç§¯äº¤æ˜“é‡
    cumulative_volume_x: u128,
    cumulative_volume_y: u128,
    
    /// äº‹ä»¶å¥æŸ„
    add_liquidity_events: EventHandle<AddLiquidityEvent>,
    remove_liquidity_events: EventHandle<RemoveLiquidityEvent>,
    swap_events: EventHandle<SwapEvent>,
}
```

**å…³é”®å‡½æ•°**ï¼š
```move
module dex_addr::liquidity_pool {
    /// åˆ›å»ºæ–°çš„æµåŠ¨æ€§æ± 
    public entry fun create_pool<X, Y>(creator: &signer)
    
    /// æ·»åŠ æµåŠ¨æ€§
    public entry fun add_liquidity<X, Y>(
        user: &signer,
        amount_x: u64,
        amount_y: u64,
        min_liquidity: u64
    )
    
    /// ç§»é™¤æµåŠ¨æ€§
    public entry fun remove_liquidity<X, Y>(
        user: &signer,
        liquidity: u64,
        min_amount_x: u64,
        min_amount_y: u64
    )
    
    /// æŸ¥è¯¢æ± å­å‚¨å¤‡
    #[view]
    public fun get_reserves<X, Y>(): (u64, u64)
    
    /// è®¡ç®— LP Token æ•°é‡
    public fun calculate_liquidity(
        amount_x: u64,
        amount_y: u64,
        reserve_x: u64,
        reserve_y: u64,
        total_supply: u64
    ): u64
}
```

#### 1.2.3 Swap è·¯ç”±æ¨¡å—ï¼ˆswap_router.moveï¼‰

**èŒè´£**ï¼š
- å¤„ç†ä»£å¸äº¤æ¢
- æ»‘ç‚¹ä¿æŠ¤
- å¤šè·³è·¯ç”±ï¼ˆå¯é€‰ï¼‰
- è®¡ç®—æœ€ä¼˜è·¯å¾„

**å…³é”®å‡½æ•°**ï¼š
```move
module dex_addr::swap_router {
    /// Exact Input Swap
    public entry fun swap_exact_input<X, Y>(
        user: &signer,
        amount_in: u64,
        min_amount_out: u64
    )
    
    /// Exact Output Swap
    public entry fun swap_exact_output<X, Y>(
        user: &signer,
        amount_out: u64,
        max_amount_in: u64
    )
    
    /// å¤šè·³ Swapï¼ˆX -> Z -> Yï¼‰
    public entry fun multi_hop_swap<X, Z, Y>(
        user: &signer,
        amount_in: u64,
        min_amount_out: u64
    )
    
    /// è®¡ç®—è¾“å‡ºæ•°é‡
    #[view]
    public fun get_amount_out(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64
    ): u64
    
    /// è®¡ç®—è¾“å…¥æ•°é‡
    #[view]
    public fun get_amount_in(
        amount_out: u64,
        reserve_in: u64,
        reserve_out: u64
    ): u64
}
```

#### 1.2.4 é¢„è¨€æœºé›†æˆæ¨¡å—ï¼ˆoracle_integration.moveï¼‰

**èŒè´£**ï¼š
- æä¾›ç¾å…ƒä»·æ ¼æŸ¥è¯¢
- è®¡ç®— TVL
- æ±‡ç‡è®¡ç®—

**å…³é”®å‡½æ•°**ï¼š
```move
module dex_addr::oracle_integration {
    /// è·å–ä»£å¸ç¾å…ƒä»·æ ¼
    #[view]
    public fun get_token_usd_price<T>(): u64
    
    /// è®¡ç®—æ± å­ TVL
    #[view]
    public fun calculate_pool_tvl<X, Y>(): u64
    
    /// è·å–æ±‡ç‡ï¼ˆX/Y çš„ç¾å…ƒæ¯”ä¾‹ï¼‰
    #[view]
    public fun get_exchange_rate_usd<X, Y>(): u64
}
```

#### 1.2.5 è¾…åŠ©æ¨¡å—

**æ•°å­¦åº“ï¼ˆmath.moveï¼‰**ï¼š
```move
module dex_addr::math {
    /// å¹³æ–¹æ ¹ï¼ˆBabylonian methodï¼‰
    public fun sqrt(y: u128): u64
    
    /// æœ€å°å€¼
    public fun min(a: u64, b: u64): u64
    
    /// å®‰å…¨ä¹˜æ³•ï¼ˆæ£€æŸ¥æº¢å‡ºï¼‰
    public fun safe_mul_div(a: u64, b: u64, c: u64): u64
}
```

**äº‹ä»¶å®šä¹‰ï¼ˆevents.moveï¼‰**ï¼š
```move
module dex_addr::events {
    struct SwapEvent has drop, store {
        user: address,
        token_in: String,
        token_out: String,
        amount_in: u64,
        amount_out: u64,
        fee_amount: u64,
        timestamp: u64,
    }
    
    struct AddLiquidityEvent has drop, store {
        user: address,
        token_x: String,
        token_y: String,
        amount_x: u64,
        amount_y: u64,
        liquidity_minted: u64,
        timestamp: u64,
    }
    
    struct RemoveLiquidityEvent has drop, store {
        user: address,
        token_x: String,
        token_y: String,
        liquidity_burned: u64,
        amount_x: u64,
        amount_y: u64,
        timestamp: u64,
    }
}
```

**é”™è¯¯å®šä¹‰ï¼ˆerrors.moveï¼‰**ï¼š
```move
module dex_addr::errors {
    // é€šç”¨é”™è¯¯ (0-99)
    const ERROR_NOT_AUTHORIZED: u64 = 1;
    const ERROR_PAUSED: u64 = 2;
    const ERROR_ZERO_AMOUNT: u64 = 3;
    
    // æµåŠ¨æ€§ç›¸å…³ (100-199)
    const ERROR_POOL_EXISTS: u64 = 100;
    const ERROR_POOL_NOT_EXISTS: u64 = 101;
    const ERROR_INSUFFICIENT_LIQUIDITY: u64 = 102;
    const ERROR_INSUFFICIENT_AMOUNT: u64 = 103;
    
    // Swap ç›¸å…³ (200-299)
    const ERROR_SLIPPAGE_EXCEEDED: u64 = 200;
    const ERROR_K_INVARIANT: u64 = 201;
    const ERROR_IDENTICAL_TOKENS: u64 = 202;
    
    // é¢„è¨€æœºç›¸å…³ (300-399)
    const ERROR_PRICE_NOT_FOUND: u64 = 300;
    const ERROR_STALE_PRICE: u64 = 301;
}
```

### 1.3 æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   dex.move                      â”‚
â”‚              (DEX æ ¸å¿ƒæ¨¡å—)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚liquidity_ â”‚ â”‚  swap_    â”‚ â”‚   oracle_         â”‚
â”‚pool.move  â”‚ â”‚router.moveâ”‚ â”‚integration.move   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ math.move â”‚ â”‚events.moveâ”‚ â”‚errors.moveâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–è§„åˆ™**ï¼š
1. **é¡¶å±‚æ¨¡å—**ï¼ˆdex.moveï¼‰ä¾èµ–æ‰€æœ‰å…¶ä»–æ¨¡å—
2. **ä¸šåŠ¡æ¨¡å—**ï¼ˆliquidity_pool, swap_router, oracleï¼‰ç›¸äº’ç‹¬ç«‹
3. **è¾…åŠ©æ¨¡å—**ï¼ˆmath, events, errorsï¼‰è¢«æ‰€æœ‰æ¨¡å—ä¾èµ–
4. **é¿å…å¾ªç¯ä¾èµ–**

---

## 2. æ¨¡å—åŒ–è®¾è®¡åŸåˆ™

### 2.1 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸï¼š

```move
// âœ… æ­£ç¡®ï¼šèŒè´£å•ä¸€
module dex_addr::liquidity_pool {
    // åªè´Ÿè´£æµåŠ¨æ€§ç®¡ç†
    public fun add_liquidity<X, Y>(...) {}
    public fun remove_liquidity<X, Y>(...) {}
}

module dex_addr::swap_router {
    // åªè´Ÿè´£äº¤æ¢é€»è¾‘
    public fun swap_exact_input<X, Y>(...) {}
    public fun swap_exact_output<X, Y>(...) {}
}

// âŒ é”™è¯¯ï¼šèŒè´£æ··ä¹±
module dex_addr::dex_all_in_one {
    // åŒ…å«æµåŠ¨æ€§ã€äº¤æ¢ã€é¢„è¨€æœºç­‰æ‰€æœ‰åŠŸèƒ½
    // éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•
}
```

### 2.2 å¼€æ”¾å°é—­åŸåˆ™ï¼ˆOCPï¼‰

æ¨¡å—å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ï¼š

```move
// âœ… æ­£ç¡®ï¼šå¯æ‰©å±•è®¾è®¡
module dex_addr::swap_router {
    // åŸºç¡€ swap åŠŸèƒ½
    public fun swap_exact_input<X, Y>(...) {}
    
    // æ–°å¢å¤šè·³åŠŸèƒ½ï¼Œä¸ä¿®æ”¹åŸæœ‰ä»£ç 
    public fun multi_hop_swap<X, Z, Y>(...) {
        // å†…éƒ¨è°ƒç”¨ swap_exact_input ä¸¤æ¬¡
    }
}

// å¯ä»¥æ·»åŠ æ–°çš„è·¯ç”±ç­–ç•¥
module dex_addr::advanced_router {
    use dex_addr::swap_router;
    
    // æ™ºèƒ½è·¯ç”±ï¼Œé€‰æ‹©æœ€ä¼˜è·¯å¾„
    public fun smart_swap<X, Y>(...) {
        // ä½¿ç”¨ swap_router çš„åŸºç¡€åŠŸèƒ½
    }
}
```

### 2.3 æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰

æä¾›ç»†ç²’åº¦çš„æ¥å£ï¼š

```move
// âœ… æ­£ç¡®ï¼šç»†ç²’åº¦æ¥å£
module dex_addr::liquidity_pool {
    /// æŸ¥è¯¢æ¥å£ - åªè¯»
    #[view]
    public fun get_reserves<X, Y>(): (u64, u64) {}
    
    #[view]
    public fun get_lp_token_supply<X, Y>(): u64 {}
    
    /// æ“ä½œæ¥å£ - ä¿®æ”¹çŠ¶æ€
    public entry fun add_liquidity<X, Y>(...) {}
    
    public entry fun remove_liquidity<X, Y>(...) {}
}

// âŒ é”™è¯¯ï¼šè‡ƒè‚¿æ¥å£
public fun do_everything<X, Y>(...) {
    // ä¸€ä¸ªå‡½æ•°åšå¤ªå¤šäº‹æƒ…
}
```

### 2.4 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰

é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ï¼š

```move
// âœ… æ­£ç¡®ï¼šä¾èµ–æŠ½è±¡ï¼ˆæ¥å£ï¼‰
module dex_addr::swap_router {
    use dex_addr::liquidity_pool;  // ä¾èµ–æ¥å£
    
    public fun swap_exact_input<X, Y>(...) {
        // è°ƒç”¨ liquidity_pool çš„å…¬å…±æ¥å£
        let (reserve_x, reserve_y) = liquidity_pool::get_reserves<X, Y>();
        // ...
    }
}

// æµåŠ¨æ€§æ± çš„å®ç°å¯ä»¥æ”¹å˜ï¼Œåªè¦æ¥å£ä¸å˜
module dex_addr::liquidity_pool {
    #[view]
    public fun get_reserves<X, Y>(): (u64, u64) {
        // å®ç°ç»†èŠ‚å¯ä»¥ä¿®æ”¹
    }
}
```

---

## 3. æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†

### 3.1 å…¨å±€çŠ¶æ€ vs å±€éƒ¨çŠ¶æ€

#### 3.1.1 å…¨å±€çŠ¶æ€ï¼ˆå­˜å‚¨åœ¨é“¾ä¸Šï¼‰

```move
/// å…¨å±€ DEX é…ç½®ï¼ˆå­˜å‚¨åœ¨ @dex_addrï¼‰
struct DEXConfig has key {
    admin: address,
    fee_rate: u64,              // åŸºç‚¹ï¼ˆ30 = 0.3%ï¼‰
    protocol_fee_share: u64,    // åè®®è´¹ç”¨åˆ†æˆ
    paused: bool,
    created_at: u64,
}

/// æ¯ä¸ªäº¤æ˜“å¯¹ä¸€ä¸ªæµåŠ¨æ€§æ± ï¼ˆå­˜å‚¨åœ¨ @dex_addrï¼‰
struct LiquidityPool<phantom X, phantom Y> has key {
    reserve_x: Coin<X>,
    reserve_y: Coin<Y>,
    lp_token_supply: u64,
    // ...
}

/// ç”¨æˆ·çš„ LP Tokenï¼ˆå­˜å‚¨åœ¨ç”¨æˆ·åœ°å€ï¼‰
struct LPToken<phantom X, phantom Y> has key {
    balance: u64,
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ°¸ä¹…å­˜å‚¨
- âœ… æ‰€æœ‰äººå¯è§
- âœ… éœ€è¦æ”¯ä»˜å­˜å‚¨è´¹ç”¨
- âŒ ä¿®æ”¹éœ€è¦äº¤æ˜“

#### 3.1.2 å±€éƒ¨çŠ¶æ€ï¼ˆå‡½æ•°å†…ä¸´æ—¶å˜é‡ï¼‰

```move
public fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64
) acquires LiquidityPool {
    // å±€éƒ¨å˜é‡ - ä¸å­˜å‚¨åœ¨é“¾ä¸Š
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    let reserve_x = coin::value(&pool.reserve_x);
    let reserve_y = coin::value(&pool.reserve_y);
    
    // è®¡ç®—è¾“å‡ºï¼ˆå±€éƒ¨è®¡ç®—ï¼‰
    let amount_out = calculate_output(amount_in, reserve_x, reserve_y);
    
    // ä¿®æ”¹å…¨å±€çŠ¶æ€
    // ...
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ— å­˜å‚¨æˆæœ¬
- âœ… è®¡ç®—é«˜æ•ˆ
- âŒ å‡½æ•°ç»“æŸåæ¶ˆå¤±
- âŒ å…¶ä»–äººçœ‹ä¸åˆ°

### 3.2 çŠ¶æ€å˜åŒ–æµç¨‹

#### 3.2.1 æ·»åŠ æµåŠ¨æ€§çš„çŠ¶æ€å˜åŒ–

```
ç”¨æˆ·æ“ä½œï¼šadd_liquidity(1000 USDC, 50 APT)

1. è¯»å–å½“å‰çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LiquidityPool<USDC, APT>        â”‚
   â”‚ - reserve_x: 10000 USDC         â”‚
   â”‚ - reserve_y: 500 APT            â”‚
   â”‚ - lp_token_supply: 7000         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. æ‰§è¡Œæ“ä½œ
   - ä»ç”¨æˆ·è½¬å…¥ 1000 USDC
   - ä»ç”¨æˆ·è½¬å…¥ 50 APT
   - è®¡ç®— LP = sqrt(1000 * 50) * 7000 / sqrt(10000 * 500) = 700
   - é“¸é€  700 LP Token

3. æ›´æ–°çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LiquidityPool<USDC, APT>        â”‚
   â”‚ - reserve_x: 11000 USDC â¬†ï¸       â”‚
   â”‚ - reserve_y: 550 APT â¬†ï¸          â”‚
   â”‚ - lp_token_supply: 7700 â¬†ï¸       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User's LPToken<USDC, APT>       â”‚
   â”‚ - balance: 700 (æ–°å¢)           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. å‘å‡ºäº‹ä»¶
   AddLiquidityEvent {
       user: @0x123,
       amount_x: 1000,
       amount_y: 50,
       liquidity_minted: 700,
       timestamp: 1699123456,
   }
```

#### 3.2.2 Swap çš„çŠ¶æ€å˜åŒ–

```
ç”¨æˆ·æ“ä½œï¼šswap_exact_input<USDC, APT>(1000 USDC)

1. è¯»å–çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LiquidityPool<USDC, APT>        â”‚
   â”‚ - reserve_x: 11000 USDC         â”‚
   â”‚ - reserve_y: 550 APT            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. è®¡ç®—è¾“å‡º
   - amount_in_with_fee = 1000 * 997 / 1000 = 997
   - amount_out = 997 * 550 / (11000 + 997) â‰ˆ 45.75 APT

3. æ‰§è¡Œäº¤æ¢
   - ä»ç”¨æˆ·è½¬å…¥ 1000 USDC
   - è½¬ç»™ç”¨æˆ· 45.75 APT
   - 3 USDC ä½œä¸ºæ‰‹ç»­è´¹

4. æ›´æ–°çŠ¶æ€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LiquidityPool<USDC, APT>        â”‚
   â”‚ - reserve_x: 12000 USDC â¬†ï¸       â”‚
   â”‚ - reserve_y: 504.25 APT â¬‡ï¸       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. éªŒè¯ K å€¼
   - K_before = 11000 * 550 = 6,050,000
   - K_after = 12000 * 504.25 = 6,051,000
   - K_after >= K_before âœ…

6. å‘å‡ºäº‹ä»¶
   SwapEvent {
       user: @0x123,
       token_in: "USDC",
       token_out: "APT",
       amount_in: 1000,
       amount_out: 45.75,
       fee_amount: 3,
       timestamp: 1699123456,
   }
```

### 3.3 çŠ¶æ€ä¸€è‡´æ€§ä¿è¯

#### 3.3.1 åŸå­æ€§ï¼ˆAtomicityï¼‰

```move
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64
) acquires LiquidityPool {
    // æ•´ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ
    // è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
    
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    
    // 1. è®¡ç®—è¾“å‡º
    let amount_out = calculate_output(...);
    
    // 2. éªŒè¯æ»‘ç‚¹
    assert!(amount_out >= min_amount_out, ERROR_SLIPPAGE);
    
    // 3. è½¬å…¥ä»£å¸
    let coins_in = coin::withdraw<X>(user, amount_in);
    coin::merge(&mut pool.reserve_x, coins_in);
    
    // 4. è½¬å‡ºä»£å¸
    let coins_out = coin::extract(&mut pool.reserve_y, amount_out);
    coin::deposit(signer::address_of(user), coins_out);
    
    // 5. éªŒè¯ K å€¼
    verify_k_invariant(...);
    
    // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ˆassertï¼‰ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š
}
```

#### 3.3.2 K å€¼ä¸å˜æ€§

```move
fun verify_k_invariant(
    reserve_x_before: u64,
    reserve_y_before: u64,
    reserve_x_after: u64,
    reserve_y_after: u64,
    fee_adjusted: bool
) {
    let k_before = (reserve_x_before as u128) * (reserve_y_before as u128);
    let k_after = (reserve_x_after as u128) * (reserve_y_after as u128);
    
    if (fee_adjusted) {
        // Swap å K å€¼åº”è¯¥å¢åŠ ï¼ˆå› ä¸ºæ”¶å–äº†æ‰‹ç»­è´¹ï¼‰
        assert!(k_after >= k_before, ERROR_K_INVARIANT);
    } else {
        // æ·»åŠ /ç§»é™¤æµåŠ¨æ€§ï¼ŒK å€¼ä¼šå˜åŒ–ï¼Œä½†è¦åˆç†
        // æ£€æŸ¥å…¶ä»–çº¦æŸæ¡ä»¶
    }
}
```

---

## 4. äº‹ä»¶ç³»ç»Ÿè®¾è®¡

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶ï¼Ÿ

**åŒºå—é“¾çš„ç‰¹ç‚¹**ï¼š
- âœ… çŠ¶æ€å­˜å‚¨åœ¨é“¾ä¸Š
- âŒ éš¾ä»¥æŸ¥è¯¢å†å²æ•°æ®
- âŒ æ— æ³•ä¸»åŠ¨é€šçŸ¥å‰ç«¯

**äº‹ä»¶çš„ä½œç”¨**ï¼š
- âœ… è®°å½•å†å²æ“ä½œ
- âœ… é€šçŸ¥å‰ç«¯çŠ¶æ€å˜åŒ–
- âœ… ä¾¿äºé“¾ä¸‹ç´¢å¼•
- âœ… å®¡è®¡å’Œåˆ†æ

### 4.2 äº‹ä»¶è®¾è®¡åŸåˆ™

#### 4.2.1 åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

```move
// âŒ é”™è¯¯ï¼šä¿¡æ¯ä¸è¶³
struct SwapEvent has drop, store {
    amount_in: u64,
    amount_out: u64,
}

// âœ… æ­£ç¡®ï¼šå®Œæ•´ä¿¡æ¯
struct SwapEvent has drop, store {
    user: address,              // è°å‘èµ·çš„
    token_in: String,           // è¾“å…¥ä»£å¸
    token_out: String,          // è¾“å‡ºä»£å¸
    amount_in: u64,             // è¾“å…¥æ•°é‡
    amount_out: u64,            // è¾“å‡ºæ•°é‡
    fee_amount: u64,            // æ‰‹ç»­è´¹
    reserve_in_after: u64,      // äº¤æ¢åçš„å‚¨å¤‡
    reserve_out_after: u64,
    timestamp: u64,             // æ—¶é—´æˆ³
}
```

#### 4.2.2 äº‹ä»¶åº”è¯¥æ˜¯ä¸å¯å˜çš„

```move
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ has drop, store
struct SwapEvent has drop, store {
    // ...
}

// âŒ é”™è¯¯ï¼šä¸åº”è¯¥æœ‰ key èƒ½åŠ›
struct SwapEvent has key, drop, store {
    // ä¸åº”è¯¥å­˜å‚¨åœ¨å…¨å±€
}
```

#### 4.2.3 åœ¨å…³é”®æ“ä½œåå‘å°„äº‹ä»¶

```move
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64
) acquires LiquidityPool {
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    
    // 1. æ‰§è¡Œäº¤æ¢
    // ...
    
    // 2. æ›´æ–°çŠ¶æ€
    // ...
    
    // 3. å‘å°„äº‹ä»¶ï¼ˆæœ€åä¸€æ­¥ï¼‰
    event::emit_event(
        &mut pool.swap_events,
        SwapEvent {
            user: signer::address_of(user),
            token_in: type_name<X>(),
            token_out: type_name<Y>(),
            amount_in,
            amount_out,
            fee_amount,
            reserve_in_after: coin::value(&pool.reserve_x),
            reserve_out_after: coin::value(&pool.reserve_y),
            timestamp: timestamp::now_seconds(),
        }
    );
}
```

### 4.3 å®Œæ•´çš„äº‹ä»¶ä½“ç³»

```move
module dex_addr::events {
    use std::string::String;
    
    /// æµåŠ¨æ€§æ·»åŠ äº‹ä»¶
    struct AddLiquidityEvent has drop, store {
        user: address,
        token_x: String,
        token_y: String,
        amount_x: u64,
        amount_y: u64,
        liquidity_minted: u64,
        total_supply_after: u64,
        reserve_x_after: u64,
        reserve_y_after: u64,
        timestamp: u64,
    }
    
    /// æµåŠ¨æ€§ç§»é™¤äº‹ä»¶
    struct RemoveLiquidityEvent has drop, store {
        user: address,
        token_x: String,
        token_y: String,
        liquidity_burned: u64,
        amount_x: u64,
        amount_y: u64,
        total_supply_after: u64,
        reserve_x_after: u64,
        reserve_y_after: u64,
        timestamp: u64,
    }
    
    /// Swap äº‹ä»¶
    struct SwapEvent has drop, store {
        user: address,
        token_in: String,
        token_out: String,
        amount_in: u64,
        amount_out: u64,
        fee_amount: u64,
        reserve_in_after: u64,
        reserve_out_after: u64,
        timestamp: u64,
    }
    
    /// æ± å­åˆ›å»ºäº‹ä»¶
    struct PoolCreatedEvent has drop, store {
        creator: address,
        token_x: String,
        token_y: String,
        timestamp: u64,
    }
    
    /// ä»·æ ¼æ›´æ–°äº‹ä»¶ï¼ˆæ¥è‡ªé¢„è¨€æœºï¼‰
    struct PriceUpdatedEvent has drop, store {
        token: String,
        old_price: u64,
        new_price: u64,
        timestamp: u64,
    }
    
    /// DEX é…ç½®å˜æ›´äº‹ä»¶
    struct ConfigUpdatedEvent has drop, store {
        admin: address,
        parameter: String,  // "fee_rate", "paused" ç­‰
        old_value: u64,
        new_value: u64,
        timestamp: u64,
    }
}
```

### 4.4 å‰ç«¯ç›‘å¬äº‹ä»¶

```typescript
// TypeScript ç¤ºä¾‹
import { AptosClient } from "aptos";

const client = new AptosClient("https://fullnode.testnet.aptoslabs.com");

// ç›‘å¬ Swap äº‹ä»¶
async function listenToSwapEvents() {
    const eventHandle = `${DEX_ADDRESS}::liquidity_pool::LiquidityPool<USDC, APT>::swap_events`;
    
    // è·å–æœ€æ–°äº‹ä»¶
    const events = await client.getEventsByEventHandle(
        DEX_ADDRESS,
        eventHandle,
        { limit: 10 }
    );
    
    events.forEach(event => {
        console.log("Swap Event:", {
            user: event.data.user,
            tokenIn: event.data.token_in,
            tokenOut: event.data.token_out,
            amountIn: event.data.amount_in,
            amountOut: event.data.amount_out,
            timestamp: event.data.timestamp
        });
    });
}

// å®æ—¶ç›‘å¬ï¼ˆè½®è¯¢ï¼‰
setInterval(listenToSwapEvents, 3000);  // æ¯ 3 ç§’æŸ¥è¯¢ä¸€æ¬¡
```

---

## 5. å®‰å…¨æœ€ä½³å®è·µ

### 5.1 é‡å…¥æ”»å‡»é˜²æŠ¤

**Move çš„å¤©ç„¶ä¼˜åŠ¿**ï¼šMove çš„èµ„æºæ¨¡å‹å¤©ç„¶é˜²æ­¢é‡å…¥æ”»å‡»ã€‚

```move
// âœ… Move ä¸­ä¸å¯èƒ½å‘ç”Ÿé‡å…¥
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64
) acquires LiquidityPool {
    // å€Ÿç”¨ poolï¼ˆç‹¬å è®¿é—®ï¼‰
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    
    // åœ¨è¿™ä¸ªå‡½æ•°æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–äººæ— æ³•å€Ÿç”¨åŒä¸€ä¸ª pool
    // å› æ­¤ä¸å¯èƒ½é‡å…¥
    
    // ...
}

// pool è¢« borrow_global_mut å€Ÿç”¨åï¼š
// - åŒä¸€äº¤æ˜“ä¸­ä¸èƒ½å†æ¬¡å€Ÿç”¨
// - å…¶ä»–äº¤æ˜“ä¼šç­‰å¾…è¿™ä¸ªäº¤æ˜“å®Œæˆ
```

**é¢å¤–ä¿æŠ¤**ï¼šä½¿ç”¨é‡å…¥é”ï¼ˆå¯é€‰ï¼‰

```move
struct ReentrancyGuard has key {
    locked: bool,
}

public fun enter_guard(): bool acquires ReentrancyGuard {
    let guard = borrow_global_mut<ReentrancyGuard>(@dex_addr);
    assert!(!guard.locked, ERROR_REENTRANT_CALL);
    guard.locked = true;
    true
}

public fun exit_guard() acquires ReentrancyGuard {
    let guard = borrow_global_mut<ReentrancyGuard>(@dex_addr);
    guard.locked = false;
}

// ä½¿ç”¨ç¤ºä¾‹
public entry fun swap(...) acquires LiquidityPool, ReentrancyGuard {
    enter_guard();
    
    // æ‰§è¡Œæ“ä½œ
    // ...
    
    exit_guard();
}
```

### 5.2 æ•´æ•°æº¢å‡ºä¿æŠ¤

```move
// âŒ é”™è¯¯ï¼šå¯èƒ½æº¢å‡º
let result = a * b / c;  // å¦‚æœ a * b > u64::MAXï¼Œæº¢å‡ºï¼

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ u128
let result = ((a as u128) * (b as u128) / (c as u128) as u64);

// âœ… æ›´å¥½ï¼šä½¿ç”¨å®‰å…¨å‡½æ•°
module dex_addr::math {
    /// å®‰å…¨çš„ä¹˜é™¤æ³•
    public fun safe_mul_div(a: u64, b: u64, c: u64): u64 {
        assert!(c > 0, ERROR_DIVISION_BY_ZERO);
        let result = (a as u128) * (b as u128) / (c as u128);
        assert!(result <= (U64_MAX as u128), ERROR_OVERFLOW);
        (result as u64)
    }
}
```

### 5.3 æƒé™æ§åˆ¶

```move
module dex_addr::dex {
    struct DEXConfig has key {
        admin: address,
        operators: vector<address>,
        paused: bool,
    }
    
    /// æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    fun assert_admin(account: &signer) acquires DEXConfig {
        let config = borrow_global<DEXConfig>(@dex_addr);
        let addr = signer::address_of(account);
        assert!(addr == config.admin, ERROR_NOT_ADMIN);
    }
    
    /// æ£€æŸ¥æ“ä½œå‘˜æƒé™
    fun assert_operator(account: &signer) acquires DEXConfig {
        let config = borrow_global<DEXConfig>(@dex_addr);
        let addr = signer::address_of(account);
        assert!(
            addr == config.admin || vector::contains(&config.operators, &addr),
            ERROR_NOT_AUTHORIZED
        );
    }
    
    /// æ£€æŸ¥æœªæš‚åœ
    fun assert_not_paused() acquires DEXConfig {
        let config = borrow_global<DEXConfig>(@dex_addr);
        assert!(!config.paused, ERROR_PAUSED);
    }
    
    /// è®¾ç½®è´¹ç‡ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    public entry fun set_fee_rate(
        admin: &signer,
        new_rate: u64
    ) acquires DEXConfig {
        assert_admin(admin);
        assert!(new_rate <= 1000, ERROR_INVALID_FEE_RATE);  // æœ€å¤§ 10%
        
        let config = borrow_global_mut<DEXConfig>(@dex_addr);
        config.fee_rate = new_rate;
    }
    
    /// Swapï¼ˆä»»ä½•äººï¼Œéœ€æœªæš‚åœï¼‰
    public entry fun swap<X, Y>(
        user: &signer,
        amount_in: u64,
        min_amount_out: u64
    ) acquires DEXConfig, LiquidityPool {
        assert_not_paused();
        
        // æ‰§è¡Œ swap
        // ...
    }
}
```

### 5.4 ç´§æ€¥æš‚åœæœºåˆ¶

```move
module dex_addr::dex {
    /// ç´§æ€¥æš‚åœ
    public entry fun pause(admin: &signer) acquires DEXConfig {
        assert_admin(admin);
        
        let config = borrow_global_mut<DEXConfig>(@dex_addr);
        config.paused = true;
        
        event::emit(PausedEvent {
            admin: signer::address_of(admin),
            timestamp: timestamp::now_seconds(),
        });
    }
    
    /// æ¢å¤è¿è¡Œ
    public entry fun unpause(admin: &signer) acquires DEXConfig {
        assert_admin(admin);
        
        let config = borrow_global_mut<DEXConfig>(@dex_addr);
        config.paused = false;
        
        event::emit(UnpausedEvent {
            admin: signer::address_of(admin),
            timestamp: timestamp::now_seconds(),
        });
    }
}
```

### 5.5 è¾“å…¥éªŒè¯

```move
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64
) acquires LiquidityPool {
    // 1. éªŒè¯è¾“å…¥æ•°é‡
    assert!(amount_in > 0, ERROR_ZERO_AMOUNT);
    assert!(min_amount_out > 0, ERROR_ZERO_AMOUNT);
    
    // 2. éªŒè¯ä»£å¸ä¸ç›¸åŒ
    assert!(
        type_info::type_of<X>() != type_info::type_of<Y>(),
        ERROR_IDENTICAL_TOKENS
    );
    
    // 3. éªŒè¯æ± å­å­˜åœ¨
    assert!(
        exists<LiquidityPool<X, Y>>(@dex_addr),
        ERROR_POOL_NOT_EXISTS
    );
    
    // 4. éªŒè¯æ± å­æœ‰è¶³å¤ŸæµåŠ¨æ€§
    let pool = borrow_global<LiquidityPool<X, Y>>(@dex_addr);
    let reserve_out = coin::value(&pool.reserve_y);
    assert!(reserve_out > min_amount_out, ERROR_INSUFFICIENT_LIQUIDITY);
    
    // æ‰§è¡Œæ“ä½œ
    // ...
}
```

---

## 6. å‰åç«¯é›†æˆæ–¹æ¡ˆ

### 6.1 Aptos TypeScript SDK é›†æˆ

#### 6.1.1 åŸºç¡€é…ç½®

```typescript
import { AptosClient, AptosAccount, FaucetClient } from "aptos";

// é…ç½®å®¢æˆ·ç«¯
const NODE_URL = "https://fullnode.testnet.aptoslabs.com";
const FAUCET_URL = "https://faucet.testnet.aptoslabs.com";

const client = new AptosClient(NODE_URL);
const faucetClient = new FaucetClient(NODE_URL, FAUCET_URL);

// DEX åˆçº¦åœ°å€
const DEX_ADDRESS = "0x...";
```

#### 6.1.2 é’±åŒ…é›†æˆ

```typescript
import { useWallet } from "@manahippo/aptos-wallet-adapter";

function WalletConnect() {
    const { connect, disconnect, account, connected } = useWallet();
    
    return (
        <div>
            {!connected ? (
                <button onClick={() => connect("Petra")}>
                    Connect Petra Wallet
                </button>
            ) : (
                <div>
                    <p>Connected: {account?.address}</p>
                    <button onClick={disconnect}>Disconnect</button>
                </div>
            )}
        </div>
    );
}
```

#### 6.1.3 æŸ¥è¯¢æ± å­ä¿¡æ¯

```typescript
// æŸ¥è¯¢æ± å­å‚¨å¤‡
async function getPoolReserves(
    tokenX: string,
    tokenY: string
): Promise<{ reserveX: number; reserveY: number }> {
    const payload = {
        function: `${DEX_ADDRESS}::liquidity_pool::get_reserves`,
        type_arguments: [tokenX, tokenY],
        arguments: [],
    };
    
    const result = await client.view(payload);
    
    return {
        reserveX: Number(result[0]),
        reserveY: Number(result[1]),
    };
}

// è®¡ç®—è¾“å‡ºæ•°é‡
async function getAmountOut(
    amountIn: number,
    tokenIn: string,
    tokenOut: string
): Promise<number> {
    const { reserveX, reserveY } = await getPoolReserves(tokenIn, tokenOut);
    
    const payload = {
        function: `${DEX_ADDRESS}::swap_router::get_amount_out`,
        type_arguments: [],
        arguments: [amountIn, reserveX, reserveY],
    };
    
    const result = await client.view(payload);
    return Number(result[0]);
}
```

#### 6.1.4 æ‰§è¡Œ Swap

```typescript
async function swapExactInput(
    wallet: any,
    tokenIn: string,
    tokenOut: string,
    amountIn: number,
    minAmountOut: number
): Promise<string> {
    const payload = {
        type: "entry_function_payload",
        function: `${DEX_ADDRESS}::swap_router::swap_exact_input`,
        type_arguments: [tokenIn, tokenOut],
        arguments: [amountIn.toString(), minAmountOut.toString()],
    };
    
    const txnRequest = await client.generateTransaction(
        wallet.account.address,
        payload
    );
    
    const signedTxn = await wallet.signTransaction(txnRequest);
    const txnHash = await client.submitTransaction(signedTxn);
    
    await client.waitForTransaction(txnHash);
    
    return txnHash;
}
```

#### 6.1.5 æ·»åŠ æµåŠ¨æ€§

```typescript
async function addLiquidity(
    wallet: any,
    tokenX: string,
    tokenY: string,
    amountX: number,
    amountY: number,
    minLiquidity: number
): Promise<string> {
    const payload = {
        type: "entry_function_payload",
        function: `${DEX_ADDRESS}::liquidity_pool::add_liquidity`,
        type_arguments: [tokenX, tokenY],
        arguments: [
            amountX.toString(),
            amountY.toString(),
            minLiquidity.toString()
        ],
    };
    
    const txnRequest = await client.generateTransaction(
        wallet.account.address,
        payload
    );
    
    const signedTxn = await wallet.signTransaction(txnRequest);
    const txnHash = await client.submitTransaction(signedTxn);
    
    await client.waitForTransaction(txnHash);
    
    return txnHash;
}
```

### 6.2 React ç»„ä»¶è®¾è®¡

#### 6.2.1 Swap ç»„ä»¶

```typescript
import React, { useState, useEffect } from "react";
import { useWallet } from "@manahippo/aptos-wallet-adapter";

function SwapComponent() {
    const { account, signAndSubmitTransaction } = useWallet();
    
    const [tokenIn, setTokenIn] = useState("USDC");
    const [tokenOut, setTokenOut] = useState("APT");
    const [amountIn, setAmountIn] = useState("");
    const [amountOut, setAmountOut] = useState("");
    const [slippage, setSlippage] = useState(0.5);  // 0.5%
    const [loading, setLoading] = useState(false);
    
    // è‡ªåŠ¨è®¡ç®—è¾“å‡ºæ•°é‡
    useEffect(() => {
        if (amountIn && Number(amountIn) > 0) {
            calculateOutput();
        }
    }, [amountIn, tokenIn, tokenOut]);
    
    async function calculateOutput() {
        const output = await getAmountOut(
            Number(amountIn),
            TOKEN_ADDRESSES[tokenIn],
            TOKEN_ADDRESSES[tokenOut]
        );
        setAmountOut((output / 1e6).toFixed(6));
    }
    
    async function handleSwap() {
        if (!account) {
            alert("Please connect wallet");
            return;
        }
        
        setLoading(true);
        
        try {
            const minAmountOut = Number(amountOut) * (1 - slippage / 100) * 1e6;
            
            const txHash = await swapExactInput(
                { account, signAndSubmitTransaction },
                TOKEN_ADDRESSES[tokenIn],
                TOKEN_ADDRESSES[tokenOut],
                Number(amountIn) * 1e6,
                Math.floor(minAmountOut)
            );
            
            alert(`Swap successful! Tx: ${txHash}`);
        } catch (error) {
            console.error("Swap failed:", error);
            alert("Swap failed: " + error.message);
        } finally {
            setLoading(false);
        }
    }
    
    return (
        <div className="swap-container">
            <h2>Swap</h2>
            
            <div className="input-group">
                <label>From</label>
                <input
                    type="number"
                    value={amountIn}
                    onChange={(e) => setAmountIn(e.target.value)}
                    placeholder="0.0"
                />
                <select value={tokenIn} onChange={(e) => setTokenIn(e.target.value)}>
                    <option>USDC</option>
                    <option>APT</option>
                    <option>BTC</option>
                </select>
            </div>
            
            <div className="swap-arrow">â¬‡ï¸</div>
            
            <div className="input-group">
                <label>To (estimated)</label>
                <input
                    type="number"
                    value={amountOut}
                    readOnly
                    placeholder="0.0"
                />
                <select value={tokenOut} onChange={(e) => setTokenOut(e.target.value)}>
                    <option>APT</option>
                    <option>USDC</option>
                    <option>BTC</option>
                </select>
            </div>
            
            <div className="slippage-setting">
                <label>Slippage Tolerance: {slippage}%</label>
                <input
                    type="range"
                    min="0.1"
                    max="5"
                    step="0.1"
                    value={slippage}
                    onChange={(e) => setSlippage(Number(e.target.value))}
                />
            </div>
            
            <button
                onClick={handleSwap}
                disabled={!amountIn || loading}
                className="swap-button"
            >
                {loading ? "Swapping..." : "Swap"}
            </button>
        </div>
    );
}
```

### 6.3 çŠ¶æ€ç®¡ç†ï¼ˆä½¿ç”¨ React Contextï¼‰

```typescript
// contexts/DexContext.tsx
import React, { createContext, useContext, useState, useEffect } from "react";

interface DexContextType {
    pools: Pool[];
    refreshPools: () => Promise<void>;
    // ...
}

const DexContext = createContext<DexContextType | undefined>(undefined);

export function DexProvider({ children }) {
    const [pools, setPools] = useState<Pool[]>([]);
    
    const refreshPools = async () => {
        // æŸ¥è¯¢æ‰€æœ‰æ± å­
        const poolList = await fetchAllPools();
        setPools(poolList);
    };
    
    useEffect(() => {
        refreshPools();
        
        // æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡
        const interval = setInterval(refreshPools, 10000);
        return () => clearInterval(interval);
    }, []);
    
    return (
        <DexContext.Provider value={{ pools, refreshPools }}>
            {children}
        </DexContext.Provider>
    );
}

export function useDex() {
    const context = useContext(DexContext);
    if (!context) {
        throw new Error("useDex must be used within DexProvider");
    }
    return context;
}
```

---

## 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 Gas ä¼˜åŒ–

#### 7.1.1 å‡å°‘å­˜å‚¨æ“ä½œ

```move
// âŒ å¤šæ¬¡è¯»å†™
public fun swap(...) acquires LiquidityPool {
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    let reserve_x = coin::value(&pool.reserve_x);  // è¯» 1
    let reserve_y = coin::value(&pool.reserve_y);  // è¯» 2
    
    // è®¡ç®—...
    
    coin::merge(&mut pool.reserve_x, coins_in);   // å†™ 1
    coin::extract(&mut pool.reserve_y, amount_out); // å†™ 2
}

// âœ… æ‰¹é‡å¤„ç†
public fun swap(...) acquires LiquidityPool {
    let pool = borrow_global_mut<LiquidityPool<X, Y>>(@dex_addr);
    
    // ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰éœ€è¦çš„å€¼
    let (reserve_x, reserve_y) = get_reserves_internal(pool);
    
    // è®¡ç®—...
    
    // æ‰¹é‡æ›´æ–°
    update_reserves(pool, new_reserve_x, new_reserve_y);
}
```

#### 7.1.2 é¿å…ä¸å¿…è¦çš„è®¡ç®—

```move
// âŒ é‡å¤è®¡ç®—
public fun calculate_output(...): u64 {
    let amount_in_with_fee = amount_in * 997 / 1000;
    let numerator = amount_in_with_fee * reserve_out;
    let denominator = reserve_in * 1000 + amount_in_with_fee;
    let amount_out = numerator / denominator;
    
    // åˆè®¡ç®—äº†ä¸€é amount_in_with_fee
    let fee = amount_in - (amount_in * 997 / 1000);
    
    amount_out
}

// âœ… å¤ç”¨è®¡ç®—ç»“æœ
public fun calculate_output(...): (u64, u64) {
    let amount_in_with_fee = amount_in * 997 / 1000;
    let fee = amount_in - amount_in_with_fee;  // å¤ç”¨
    
    let numerator = amount_in_with_fee * reserve_out;
    let denominator = reserve_in * 1000 + amount_in_with_fee;
    let amount_out = numerator / denominator;
    
    (amount_out, fee)
}
```

### 7.2 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 7.2.1 è¯·æ±‚ç¼“å­˜

```typescript
// ä½¿ç”¨ React Query ç¼“å­˜æ•°æ®
import { useQuery } from "react-query";

function usePoolReserves(tokenX: string, tokenY: string) {
    return useQuery(
        ["pool-reserves", tokenX, tokenY],
        () => getPoolReserves(tokenX, tokenY),
        {
            staleTime: 5000,  // 5 ç§’å†…ä¸é‡æ–°è¯·æ±‚
            cacheTime: 30000,  // ç¼“å­˜ 30 ç§’
        }
    );
}
```

#### 7.2.2 æ‰¹é‡æŸ¥è¯¢

```typescript
// âŒ é€ä¸ªæŸ¥è¯¢
async function loadPools() {
    const pool1 = await getPoolReserves("USDC", "APT");
    const pool2 = await getPoolReserves("USDC", "BTC");
    const pool3 = await getPoolReserves("APT", "BTC");
    return [pool1, pool2, pool3];
}

// âœ… å¹¶è¡ŒæŸ¥è¯¢
async function loadPools() {
    const pools = await Promise.all([
        getPoolReserves("USDC", "APT"),
        getPoolReserves("USDC", "BTC"),
        getPoolReserves("APT", "BTC"),
    ]);
    return pools;
}
```

---

## ğŸ“š æ€»ç»“

### å…³é”®è¦ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**
   - èŒè´£å•ä¸€
   - ä½è€¦åˆé«˜å†…èš
   - ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤

2. **æ•°æ®æµæ¸…æ™°**
   - å…¨å±€çŠ¶æ€ vs å±€éƒ¨çŠ¶æ€
   - åŸå­æ€§ä¿è¯
   - äº‹ä»¶é©±åŠ¨æ›´æ–°

3. **å®‰å…¨ç¬¬ä¸€**
   - è¾“å…¥éªŒè¯
   - æƒé™æ§åˆ¶
   - ç´§æ€¥æš‚åœ
   - é˜²é‡å…¥æ”»å‡»

4. **å®Œå–„çš„äº‹ä»¶ç³»ç»Ÿ**
   - è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
   - åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
   - ä¾¿äºå‰ç«¯ç›‘å¬

5. **å‰åç«¯é›†æˆ**
   - ä½¿ç”¨ TypeScript SDK
   - React ç»„ä»¶åŒ–
   - çŠ¶æ€ç®¡ç†
   - é”™è¯¯å¤„ç†

### ä¸‹ä¸€æ­¥

- å®ç°å®Œæ•´çš„ DEX åˆçº¦
- å¼€å‘ç”¨æˆ·å‹å¥½çš„å‰ç«¯
- éƒ¨ç½²åˆ°æµ‹è¯•ç½‘
- å……åˆ†æµ‹è¯•å’Œä¼˜åŒ–

---

**è®°ä½**ï¼šä¸€ä¸ªå¥½çš„ DEX ä¸ä»…è¦åŠŸèƒ½å®Œæ•´ï¼Œè¿˜è¦å®‰å…¨å¯é ã€ç”¨æˆ·ä½“éªŒå¥½ã€æ€§èƒ½ä¼˜å¼‚ï¼

**ç‰ˆæƒå£°æ˜**: æœ¬æ–‡æ¡£ä»…ä¾›å­¦ä¹ ä½¿ç”¨ã€‚
