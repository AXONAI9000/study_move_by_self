# 抵押品管理与健康因子 - 核心概念

## 📚 目录

1. [抵押品管理基础](#1-抵押品管理基础)
2. [健康因子深度解析](#2-健康因子深度解析)
3. [多资产抵押管理](#3-多资产抵押管理)
4. [风险参数设计](#4-风险参数设计)
5. [价格预言机集成](#5-价格预言机集成)
6. [风险预警系统](#6-风险预警系统)
7. [实际案例分析](#7-实际案例分析)

---

## 1. 抵押品管理基础

### 1.1 什么是抵押品管理？

抵押品管理是借贷协议的**核心风险控制模块**，负责：

```
核心职责：
├── 抵押品启用/禁用
├── 抵押品价值计算
├── 借款能力评估
├── 提取限制检查
└── 风险实时监控
```

### 1.2 抵押品生命周期

```
完整流程：

1. 存款阶段
   用户存入资产 → 获得存款凭证
   状态：未启用为抵押品

2. 启用抵押品
   用户选择启用 → 计入抵押品价值
   状态：可用于借款

3. 借款阶段
   基于抵押品 → 借出其他资产
   限制：必须保持健康因子 > 1.0

4. 禁用抵押品
   用户选择禁用 → 不再计入抵押能力
   条件：禁用后健康因子仍 > 1.0

5. 提取阶段
   提取存款 → 减少抵押品
   检查：提取后健康因子 > 1.0
```

### 1.3 抵押品 vs 存款

```
重要区别：

存款（Deposit）:
  - 仅表示在协议中有资金
  - 不自动成为抵押品
  - 可以随时提取（无借款时）
  - 赚取存款利息

抵押品（Collateral）:
  - 已启用的存款
  - 用于支撑借款
  - 提取受限（需检查健康因子）
  - 同样赚取存款利息
  
示例：
  用户 A:
    - 存款 1000 USDC (未启用抵押品)
    - 无法借款
    - 可随时提取
    
  用户 B:
    - 存款 1000 USDC (已启用抵押品)
    - 可借 750 USDC (假设 75% 抵押率)
    - 提取受限
```

### 1.4 抵押品操作

#### 启用抵押品 (Enable Collateral)

```
操作：将存款启用为抵押品

前置条件：
  ✅ 用户有该资产的存款
  ✅ 该资产支持作为抵押品
  ✅ 存款余额 > 0

执行步骤：
  1. 验证用户权限
  2. 检查资产是否支持抵押
  3. 更新用户抵押品列表
  4. 重新计算借款能力
  5. 发出事件

影响：
  ✅ 增加借款额度
  ✅ 提取受到限制
  ⚠️ 可能被清算（如果借款）
```

#### 禁用抵押品 (Disable Collateral)

```
操作：将抵押品恢复为普通存款

前置条件：
  ✅ 该资产已启用为抵押品
  ✅ 禁用后健康因子 > 1.0

执行步骤：
  1. 计算禁用后的健康因子
  2. 验证健康因子安全
  3. 从抵押品列表移除
  4. 重新计算借款能力
  5. 发出事件

影响：
  ❌ 减少借款额度
  ✅ 可以自由提取
  ✅ 不会被清算
```

---

## 2. 健康因子深度解析

### 2.1 健康因子的本质

健康因子（Health Factor）是借贷协议中**最重要的风险指标**：

```
定义：
  衡量借款人偿债能力的综合指标

物理意义：
  HF = 1.0 表示恰好在清算临界点
  HF > 1.0 表示安全
  HF < 1.0 表示不安全，触发清算
  
数学本质：
  抵押覆盖率 = 调整后的抵押品价值 / 债务价值
```

### 2.2 基础计算公式

#### 单资产场景

```
场景：用户只抵押一种资产

公式：
  HF = (抵押品价值 × 抵押率) / 债务价值

示例：
  抵押：1 ETH = $2000
  抵押率：75%
  借款：1200 USDC = $1200
  
  HF = ($2000 × 75%) / $1200
     = $1500 / $1200
     = 1.25
  
  解读：健康因子 1.25，表示抵押品价值可以覆盖债务的 125%
```

#### 多资产场景

```
场景：用户抵押多种资产

公式：
  HF = Σ(抵押品i × 价格i × 抵押率i) / Σ(债务j × 价格j)
  
  简化：
  HF = 总抵押能力 / 总债务价值

示例：
  抵押品：
    - 1 ETH ($2000) × 75% = $1500
    - 1000 USDC ($1000) × 80% = $800
    - 0.1 BTC ($3500) × 70% = $2450
    总抵押能力 = $4750
  
  债务：
    - 2000 USDC = $2000
    - 0.05 ETH = $100
    总债务 = $2100
  
  HF = $4750 / $2100 = 2.26
```

### 2.3 详细计算步骤

#### Step 1: 计算抵押品总价值

```move
function calculate_total_collateral_value(user: address): u128 {
    let total_value = 0;
    
    // 遍历所有抵押品
    for each collateral_asset in user.collaterals {
        // 获取存款余额（含利息）
        let balance = get_balance_with_interest(user, collateral_asset);
        
        // 获取资产价格
        let price = oracle::get_price(collateral_asset);
        
        // 获取抵押率
        let collateral_factor = get_collateral_factor(collateral_asset);
        
        // 计算该资产的抵押能力
        let asset_value = balance × price × collateral_factor;
        
        total_value += asset_value;
    }
    
    return total_value;
}
```

#### Step 2: 计算债务总价值

```move
function calculate_total_debt_value(user: address): u128 {
    let total_debt = 0;
    
    // 遍历所有债务
    for each debt_asset in user.borrows {
        // 获取借款余额（含利息）
        let balance = get_borrow_balance_with_interest(user, debt_asset);
        
        // 获取资产价格
        let price = oracle::get_price(debt_asset);
        
        // 计算该债务的价值
        let debt_value = balance × price;
        
        total_debt += debt_value;
    }
    
    return total_debt;
}
```

#### Step 3: 计算健康因子

```move
function calculate_health_factor(user: address): u128 {
    let collateral_value = calculate_total_collateral_value(user);
    let debt_value = calculate_total_debt_value(user);
    
    // 边界情况：无债务
    if (debt_value == 0) {
        return MAX_U128;  // 无限大
    }
    
    // 健康因子 = 抵押能力 / 债务
    // 使用高精度计算
    let health_factor = (collateral_value × PRECISION) / debt_value;
    
    return health_factor;
}
```

### 2.4 精度处理详解

健康因子计算涉及大量乘除法，精度处理至关重要：

```
精度体系：

1. 价格精度：1e8
   $1 = 100,000,000
   $2000 = 200,000,000,000

2. 抵押率精度：1e6
   75% = 750,000
   80% = 800,000

3. 健康因子精度：1e18
   1.0 = 1,000,000,000,000,000,000
   1.25 = 1,250,000,000,000,000,000

计算示例：
  抵押品：1 ETH
  余额：100,000,000 (1e8，ETH 有 8 位小数)
  价格：200,000,000,000 ($2000，精度 1e8)
  抵押率：750,000 (75%，精度 1e6)
  
  抵押能力计算：
    = 100,000,000 × 200,000,000,000 × 750,000 / 1,000,000
    = 15,000,000,000,000,000,000
    = $1500 × 1e8
  
  债务：1200 USDC
  价格：100,000,000 ($1)
  债务价值：
    = 1,200,000,000 × 100,000,000
    = 120,000,000,000
    = $1200 × 1e8
  
  健康因子：
    = (15,000,000,000,000,000,000 × 1e18) / 120,000,000,000
    = 1.25 × 1e18
```

### 2.5 健康因子等级

```
安全等级划分：

HF ≥ 2.0 (200%)
  🟢 极其安全
  - 抵押品远超债务
  - 可以承受大幅价格波动
  - 建议：可以考虑增加借款

1.5 ≤ HF < 2.0 (150%-200%)
  🟢 安全
  - 抵押充足
  - 正常风险范围
  - 建议：保持当前状态

1.2 ≤ HF < 1.5 (120%-150%)
  🟡 注意
  - 抵押偏紧
  - 需要关注市场波动
  - 建议：考虑增加抵押或减少借款

1.05 ≤ HF < 1.2 (105%-120%)
  🟠 警告
  - 接近清算线
  - 市场小幅波动可能触发清算
  - 建议：立即增加抵押或还款

1.0 ≤ HF < 1.05 (100%-105%)
  🔴 危险
  - 极度接近清算
  - 随时可能被清算
  - 建议：紧急操作

HF < 1.0 (<100%)
  ⚫ 清算
  - 已触发清算条件
  - 清算人可以执行清算
  - 后果：损失清算惩罚
```

---

## 3. 多资产抵押管理

### 3.1 加权平均抵押率

当用户抵押多种资产时，需要计算加权平均抵押率：

```
公式：
  加权抵押率 = Σ(资产价值i × 抵押率i) / Σ(资产价值i)

示例：
  资产 A：价值 $1000，抵押率 75%
  资产 B：价值 $2000，抵押率 60%
  资产 C：价值 $500，抵押率 80%
  
  总价值 = $1000 + $2000 + $500 = $3500
  
  加权抵押率 = ($1000×75% + $2000×60% + $500×80%) / $3500
             = ($750 + $1200 + $400) / $3500
             = $2350 / $3500
             = 67.14%
  
  解读：
    虽然有资产的抵押率高达 80%，
    但因为大部分价值集中在抵押率 60% 的资产上，
    整体加权抵押率为 67.14%
```

### 3.2 抵押品组合优化

用户可以通过调整抵押品组合来优化借款能力：

```
优化策略：

策略 1：高抵押率资产优先
  优先启用抵押率高的资产
  
  示例：
    有 USDC (80%) 和 小币 (40%)
    优先启用 USDC 作为抵押品
    
  优点：相同价值下借款额度更高
  缺点：高抵押率资产通常收益更稳定但回报较低

策略 2：价值稳定性优先
  优先启用价格稳定的资产
  
  示例：
    有 BTC 和稳定币
    优先启用稳定币
    
  优点：降低被清算风险
  缺点：可能损失价格上涨收益

策略 3：流动性优先
  优先启用高流动性资产
  
  优点：清算时损失较小
  缺点：可能抵押率较低

策略 4：分散风险
  多种资产混合抵押
  
  优点：单一资产价格波动影响较小
  缺点：管理复杂度增加
```

### 3.3 抵押品重平衡

市场变化可能需要调整抵押品组合：

```
场景 1：某资产大幅升值
  
  初始状态：
    ETH: $1000 (抵押率 75%)
    USDC: $1000 (抵押率 80%)
    借款: $1200
    HF = ($1000×75% + $1000×80%) / $1200 = 1.29
  
  ETH 升值到 $2000：
    HF = ($2000×75% + $1000×80%) / $1200 = 1.92 ↑
  
  优化操作：
    - 可以增加借款（利用新增借款能力）
    - 或禁用部分 USDC 抵押品（降低清算风险）

场景 2：某资产下跌
  
  初始状态：
    ETH: $2000 (75%)
    借款: $1200
    HF = ($2000×75%) / $1200 = 1.25
  
  ETH 跌到 $1600：
    HF = ($1600×75%) / $1200 = 1.0 ← 触发清算!
  
  紧急操作：
    - 立即还款
    - 或增加其他抵押品
    - 或被清算（损失清算惩罚）
```

---

## 4. 风险参数设计

### 4.1 抵押率 (Loan-to-Value, LTV)

抵押率是风险管理的核心参数：

```
定义：
  资产可以借出的最大比例
  
设置原则：
  
  1. 价格波动性
     波动性越高 → 抵押率越低
     
     示例：
       稳定币 (波动 <1%) → 80%
       BTC/ETH (波动 10-30%) → 70-75%
       小币 (波动 >50%) → 30-50%
  
  2. 流动性
     流动性越好 → 抵押率越高
     
     原因：清算时容易快速卖出
  
  3. 市场深度
     深度越好 → 抵押率越高
     
     原因：大额清算不会严重影响价格
  
  4. 去中心化程度
     越去中心化 → 抵押率越高
     
     原因：操纵难度大
```

#### 抵押率计算方法

```
统计方法：

1. 历史波动率
   σ = sqrt(Σ(ri - r̄)² / (n-1))
   
   其中：
     ri = 第i天的收益率
     r̄ = 平均收益率
     n = 天数

2. VaR (Value at Risk)
   95% 置信度下的最大损失
   
   示例：
     95% VaR = 15%
     表示 95% 的情况下，
     损失不会超过 15%

3. 压力测试
   模拟极端场景
   
   场景：
     - 2020 年 3 月崩盘 (-50%)
     - 2022 年 Terra 崩盘 (-99%)
     - 假设性极端场景 (-70%)

4. 抵押率公式
   LTV = 100% - (VaR × 安全系数)
   
   示例：
     95% VaR = 20%
     安全系数 = 2.0
     
     LTV = 100% - (20% × 2.0)
         = 100% - 40%
         = 60%
```

### 4.2 清算阈值 (Liquidation Threshold)

```
定义：
  触发清算的健康因子临界值
  
与抵押率的关系：
  清算阈值 ≥ 抵押率
  
  原因：需要安全缓冲区
  
典型设置：
  抵押率 = 75%
  清算阈值 = 80%
  
  缓冲区 = 80% - 75% = 5%
  
缓冲区作用：
  1. 应对价格小幅波动
  2. 给用户自救时间
  3. 避免频繁触碰清算线
```

### 4.3 清算惩罚 (Liquidation Penalty)

```
定义：
  清算时借款人额外损失的比例
  
组成部分：
  1. 清算奖励 (Liquidation Bonus)
     - 给清算人的激励
     - 典型值：5-10%
  
  2. 协议费用 (Protocol Fee)
     - 协议收取的费用
     - 典型值：0-2%
  
  总惩罚 = 清算奖励 + 协议费用

示例：
  债务：$1000
  清算奖励：8%
  协议费用：2%
  
  清算人支付：$1000
  清算人获得：$1000 × (1 + 8%) = $1080 抵押品
  协议获得：$1000 × 2% = $20 抵押品
  
  借款人损失：
    原本欠债 $1000
    实际损失 $1100 抵押品
    额外损失 $100 (10%)
```

### 4.4 动态风险参数

先进的协议会动态调整风险参数：

```
调整因素：

1. 市场波动性
   if 30日波动率 > 阈值:
       降低抵押率
       提高清算惩罚
   
2. 协议利用率
   if 利用率 > 90%:
       降低抵押率（抑制借款）
       提高清算奖励（激励清算）
   
3. 资产流动性
   if 24h交易量下降 > 50%:
       暂停新借款
       或降低借款上限
   
4. 预言机健康度
   if 价格偏差 > 5%:
       暂停操作
       或使用保守价格
```

---

## 5. 价格预言机集成

### 5.1 价格获取

健康因子计算依赖实时价格：

```move
// 从预言机获取价格
public fun get_asset_price<CoinType>(): (u128, u64) {
    // 从多个预言机获取价格
    let pyth_price = pyth::get_price<CoinType>();
    let switchboard_price = switchboard::get_price<CoinType>();
    
    // 价格偏差检查
    let deviation = calculate_deviation(pyth_price, switchboard_price);
    assert!(deviation < MAX_DEVIATION, E_PRICE_DEVIATION_TOO_HIGH);
    
    // 返回中位数价格和时间戳
    let price = (pyth_price + switchboard_price) / 2;
    let timestamp = timestamp::now_seconds();
    
    (price, timestamp)
}
```

### 5.2 价格验证

```
验证机制：

1. 时效性检查
   if (current_time - price_timestamp) > MAX_AGE:
       reject("Price too old")
   
   典型值：MAX_AGE = 300 秒 (5 分钟)

2. 偏差检查
   if |price1 - price2| / price1 > MAX_DEVIATION:
       reject("Price deviation too high")
   
   典型值：MAX_DEVIATION = 5%

3. 合理性检查
   if price < MIN_PRICE or price > MAX_PRICE:
       reject("Price out of range")
   
   防止预言机故障导致的异常价格

4. 变化率检查
   if |new_price - old_price| / old_price > MAX_CHANGE:
       trigger_circuit_breaker()
   
   防止价格暴涨暴跌
```

### 5.3 价格聚合策略

```
策略选择：

1. 简单平均
   price = (p1 + p2 + p3) / 3
   
   优点：简单
   缺点：异常值影响大

2. 加权平均
   price = (p1×w1 + p2×w2 + p3×w3) / (w1+w2+w3)
   
   权重依据：
     - 预言机可靠性
     - 数据源质量
     - 历史准确度

3. 中位数
   price = median(p1, p2, p3)
   
   优点：抗异常值
   缺点：需要排序（Gas 更高）

4. 时间加权平均 (TWAP)
   price = Σ(pi × ti) / Σti
   
   优点：平滑价格波动
   缺点：可能滞后

推荐：
  多源 + 中位数 + 偏差检查
```

---

## 6. 风险预警系统

### 6.1 预警等级

```
三级预警机制：

🟡 一级预警（注意）
  触发条件：1.2 ≤ HF < 1.5
  
  措施：
    - 发送通知
    - 显示警告信息
    - 建议操作
  
  用户响应时间：无限制

🟠 二级预警（警告）
  触发条件：1.05 ≤ HF < 1.2
  
  措施：
    - 高优先级通知
    - 醒目UI提示
    - 操作限制（如不能增加借款）
  
  用户响应时间：建议 24 小时内处理

🔴 三级预警（紧急）
  触发条件：1.0 ≤ HF < 1.05
  
  措施：
    - 紧急通知（邮件/短信/推送）
    - 闪烁警告
    - 禁止新增借款
    - 提示立即还款或增加抵押
  
  用户响应时间：立即处理（数小时内）
```

### 6.2 自动保护机制

```
保护策略：

1. 借款限制
   if HF < 1.5:
       禁止新增借款
       允许还款和增加抵押
   
2. 提取限制
   检查提取后HF：
       if HF_after < 1.2:
           reject("Would make health factor too low")
   
3. 抵押品禁用限制
   检查禁用后HF：
       if HF_after < 1.0:
           reject("Cannot disable while borrowed")
   
4. 利率惩罚
   if HF < 1.1:
       额外利率 = 基础利率 × 2
   
   目的：激励用户尽快改善健康状况
```

### 6.3 通知系统

```
多渠道通知：

1. 链上事件
   event HealthFactorWarning {
       user: address,
       health_factor: u128,
       level: u8,  // 1, 2, 3
       timestamp: u64
   }

2. 链下服务
   - 邮件通知
   - 短信通知
   - 移动 App 推送
   - Telegram/Discord Bot

3. UI 提示
   - 颜色编码
   - 进度条
   - 实时健康因子显示
   - 操作后预览
```

---

## 7. 实际案例分析

### 案例 1：正常借贷流程

```
用户 Alice 的借贷之旅：

初始状态：
  - 持有：10 ETH, 5000 USDC
  - 存款：0
  - 借款：0

Day 1：存款
  操作：存入 5 ETH 和 5000 USDC
  
  存款状态：
    - 5 ETH (未启用抵押品)
    - 5000 USDC (未启用抵押品)
  
  健康因子：N/A (无借款)

Day 2：启用抵押品
  操作：启用 5 ETH 作为抵押品
  
  市场价格：
    - ETH = $2000
    - USDC = $1
  
  抵押能力：
    - 5 ETH × $2000 × 75% = $7500
  
  可借额度：$7500

Day 3：借款
  操作：借出 5000 USDC
  
  债务：5000 USDC = $5000
  
  健康因子：
    HF = $7500 / $5000 = 1.5 ✅
  
  状态：🟡 注意（但在安全范围内）

Day 10：ETH 价格上涨
  市场变化：ETH = $2500 ↑
  
  抵押能力：
    5 ETH × $2500 × 75% = $9375 ↑
  
  健康因子：
    HF = $9375 / $5000 = 1.875 ✅
  
  状态：🟢 安全
  
  Alice 的选择：
    选项 A：增加借款（利用新增额度）
    选项 B：保持现状（更安全）

Day 15：部分还款
  操作：还款 2000 USDC
  
  债务：3000 USDC
  
  健康因子：
    HF = $9375 / $3000 = 3.125 ✅
  
  状态：🟢 极其安全
  
Day 20：提取部分抵押品
  操作：想要提取 2 ETH
  
  检查：
    剩余抵押：3 ETH × $2500 × 75% = $5625
    债务：$3000
    HF_after = $5625 / $3000 = 1.875 ✅
  
  结果：允许提取

最终状态：
  - 存款：3 ETH + 5000 USDC
  - 抵押：3 ETH
  - 借款：3000 USDC
  - 净持有：6 ETH + 7000 USDC
  
  (相比初始增加了 2000 USDC 的净资产)
```

### 案例 2：清算风险场景

```
用户 Bob 的清算经历：

初始状态：
  存款并抵押：1 BTC
  市场价格：BTC = $40000
  抵押率：70%
  借款：$24000 USDC

初始健康因子：
  HF = ($40000 × 70%) / $24000
     = $28000 / $24000
     = 1.167 🟡
  
  状态：注意（抵押偏紧）

Day 1：BTC 小幅下跌
  BTC = $38000 (-5%)
  
  HF = ($38000 × 70%) / $24000
     = $26600 / $24000
     = 1.108 🟠
  
  预警：二级预警
  建议：增加抵押或还款

Bob 的决定：观望（错误!）

Day 2：BTC 继续下跌
  BTC = $35000 (-12.5%)
  
  HF = ($35000 × 70%) / $24000
     = $24500 / $24000
     = 1.021 🔴
  
  预警：三级预警（紧急）
  协议：禁止新增借款

Bob 的决定：仍然观望（大错特错!）

Day 3：BTC 暴跌
  BTC = $33000 (-17.5%)
  
  HF = ($33000 × 70%) / $24000
     = $23100 / $24000
     = 0.9625 < 1.0 ⚫
  
  结果：触发清算!

清算执行：
  清算人 Charlie 发现机会
  
  操作：
    - 支付：$12000 USDC (50% 最大清算)
    - 获得：$12000 × (1 + 8%) / $33000 = 0.393 BTC
    - 价值：0.393 × $33000 = $12969
    - 利润：$969 (8% 清算奖励)
  
  Bob 的损失：
    - 原本欠债：$24000
    - 现在欠债：$12000
    - 损失抵押品：0.393 BTC ($12969)
    - 实际支付：$12969（而非$12000）
    - 额外损失：$969（清算惩罚）
  
  清算后状态：
    - 剩余抵押：0.607 BTC ($20031)
    - 剩余债务：$12000
    - HF = ($20031 × 70%) / $12000 = 1.168
  
  虽然恢复到安全状态，但Bob损失了清算惩罚

教训：
  ✅ 及时响应预警
  ✅ 保持健康的健康因子(>1.5)
  ✅ 不要过度杠杆
  ✅ 设置自动止损
```

### 案例 3：多资产组合管理

```
用户 Carol 的多资产策略：

初始持有：
  - 2 ETH
  - 1 BTC
  - 10000 USDC

市场价格：
  - ETH = $2000
  - BTC = $40000
  - USDC = $1

策略：多资产抵押
  
  全部存入并启用抵押：
    - 2 ETH × $2000 × 75% = $3000
    - 1 BTC × $40000 × 70% = $28000
    - 10000 USDC × 80% = $8000
    - 总抵押能力 = $39000
  
  借款：$26000 USDC
  
  健康因子：
    HF = $39000 / $26000 = 1.5 🟢

Day 30：ETH 上涨，BTC 下跌
  价格变化：
    - ETH = $2500 (+25%)
    - BTC = $35000 (-12.5%)
    - USDC = $1
  
  新抵押能力：
    - 2 ETH × $2500 × 75% = $3750 ↑
    - 1 BTC × $35000 × 70% = $24500 ↓
    - 10000 USDC × 80% = $8000
    - 总计 = $36250 ↓
  
  健康因子：
    HF = $36250 / $26000 = 1.394 🟡
  
  观察：
    虽然ETH上涨，但BTC下跌更多
    整体HF下降
    
  这就是多资产分散风险的价值！
  如果只抵押BTC，HF会更低

Carol 的优化：
  1. 部分还款（降低风险）
     还款 $6000
     新债务：$20000
     HF = $36250 / $20000 = 1.8125 🟢
  
  2. 调整抵押品组合
     禁用部分 BTC（波动大）
     增加 USDC 抵押（稳定）
```

---

## 8. 实现最佳实践

### 8.1 Gas 优化

```
优化技巧：

1. 缓存价格
   // ❌ 每次都查询
   for each asset:
       price = get_price(asset)
       ...
   
   // ✅ 批量查询缓存
   prices = batch_get_prices(all_assets)
   for each asset:
       price = prices[asset]
       ...

2. 延迟计算
   // ❌ 每次操作都重算HF
   function deposit():
       ...
       calculate_health_factor()  // 无借款时不需要
   
   // ✅ 只在需要时计算
   function deposit():
       ...
       if (has_borrows):
           calculate_health_factor()

3. 使用事件而非存储
   // ❌ 存储历史HF
   health_factor_history: vector<u128>
   
   // ✅ 发出事件，链下索引
   event HealthFactorUpdated {
       health_factor: u128
   }
```

### 8.2 安全检查

```
必要检查清单：

✅ 价格时效性检查
✅ 价格偏差检查
✅ 除零保护
✅ 溢出保护
✅ 重入保护（Move自动）
✅ 权限验证
✅ 参数范围验证
✅ 状态一致性检查
```

### 8.3 测试策略

```
测试场景：

1. 单元测试
   - 健康因子计算正确性
   - 边界条件（HF=1.0, HF=0.99）
   - 精度测试

2. 集成测试
   - 完整借贷流程
   - 抵押品启用/禁用
   - 多资产场景

3. 压力测试
   - 价格暴涨暴跌
   - 大额操作
   - 并发操作

4. 模糊测试
   - 随机价格
   - 随机操作顺序
   - 寻找边界 bug
```

---

## 9. 总结

### 核心要点

```
1. 健康因子是风险控制的核心
   - 公式：HF = 抵押能力 / 债务
   - 临界值：1.0
   - 安全值：>1.5

2. 多资产需要加权计算
   - 不同抵押率
   - 不同价格
   - 实时更新

3. 价格预言机至关重要
   - 多源验证
   - 时效性检查
   - 偏差保护

4. 用户体验优化
   - 实时预警
   - 操作预览
   - 清晰提示

5. 安全永远第一
   - 完善检查
   - 边界处理
   - 充分测试
```

### 下一步

在接下来的 Day 22，我们将学习：
- 利率模型的完整实现
- 清算机制的详细编码
- 实际部署和测试

---

**恭喜完成理论学习！现在查看代码示例，然后开始实践任务。** 🎉
