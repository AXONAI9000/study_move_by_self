# Day 09: é”™è¯¯å¤„ç†ä¸æ–­è¨€æœ€ä½³å®è·µ - å®è·µä»»åŠ¡

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

é€šè¿‡å®Œæˆä»¥ä¸‹å®è·µä»»åŠ¡,æŒæ¡:
1. è®¾è®¡æ¸…æ™°çš„é”™è¯¯ç ç³»ç»Ÿ
2. å®ç°å¥å£®çš„å‚æ•°éªŒè¯
3. å¤„ç†å¤æ‚çš„æƒé™æ£€æŸ¥
4. ä½¿ç”¨ Option å¤„ç†å¯é€‰å€¼
5. ç¼–å†™å¯æµ‹è¯•çš„é”™è¯¯å¤„ç†ä»£ç 

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### âœ… ä»»åŠ¡ 1: å®‰å…¨é’±åŒ…ç³»ç»Ÿ (åŸºç¡€)

**éš¾åº¦**: â­â­  
**é¢„è®¡æ—¶é—´**: 40 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
å®ç°ä¸€ä¸ªå¸¦å®Œæ•´é”™è¯¯å¤„ç†çš„å®‰å…¨é’±åŒ…ç³»ç»Ÿã€‚

#### å…·ä½“è¦æ±‚

åˆ›å»º `sources/safe_wallet.move`:

1. **é”™è¯¯ç å®šä¹‰** (10åˆ†)
   ```move
   // è´¦æˆ·é”™è¯¯ (100-199)
   const ERROR_ACCOUNT_NOT_FOUND: u64 = 101;
   const ERROR_ACCOUNT_ALREADY_EXISTS: u64 = 102;
   
   // é‡‘é¢é”™è¯¯ (200-299)
   const ERROR_INVALID_AMOUNT: u64 = 201;
   const ERROR_INSUFFICIENT_BALANCE: u64 = 202;
   const ERROR_ZERO_AMOUNT: u64 = 203;
   
   // æƒé™é”™è¯¯ (300-399)
   const ERROR_NOT_OWNER: u64 = 301;
   ```

2. **æ•°æ®ç»“æ„** (5åˆ†)
   ```move
   struct Wallet has key {
       owner: address,
       balance: u64,
   }
   ```

3. **æ ¸å¿ƒåŠŸèƒ½å®ç°** (25åˆ†)
   - `create_wallet(account: &signer)` - åˆ›å»ºé’±åŒ…
     - æ£€æŸ¥é’±åŒ…æ˜¯å¦å·²å­˜åœ¨
   - `deposit(account: &signer, amount: u64)` - å­˜æ¬¾
     - éªŒè¯é‡‘é¢ > 0
     - æ£€æŸ¥æº¢å‡º
   - `withdraw(account: &signer, amount: u64)` - å–æ¬¾
     - éªŒè¯é‡‘é¢ > 0
     - æ£€æŸ¥ä½™é¢å……è¶³
     - éªŒè¯æ‰€æœ‰è€…
   - `get_balance(addr: address): u64` - æŸ¥è¯¢ä½™é¢
     - æ£€æŸ¥é’±åŒ…å­˜åœ¨

#### æˆåŠŸæ ‡å‡†
- [ ] æ‰€æœ‰é”™è¯¯ç éƒ½æœ‰æ¸…æ™°å‘½å
- [ ] æ¯ä¸ªå‡½æ•°éƒ½æœ‰å®Œæ•´çš„å‚æ•°éªŒè¯
- [ ] ä½¿ç”¨ assert! è¿›è¡Œæ£€æŸ¥
- [ ] ä»£ç èƒ½ç¼–è¯‘é€šè¿‡

---

### âœ… ä»»åŠ¡ 2: å¤šå±‚æƒé™ç³»ç»Ÿ (ä¸­çº§)

**éš¾åº¦**: â­â­â­  
**é¢„è®¡æ—¶é—´**: 50 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
å®ç°ä¸€ä¸ªæ”¯æŒå¤šç§æƒé™çº§åˆ«çš„ç®¡ç†ç³»ç»Ÿã€‚

#### å…·ä½“è¦æ±‚

åˆ›å»º `sources/permission_system.move`:

1. **è§’è‰²å®šä¹‰** (10åˆ†)
   ```move
   const ROLE_ADMIN: u8 = 1;
   const ROLE_MODERATOR: u8 = 2;
   const ROLE_USER: u8 = 3;
   ```

2. **é”™è¯¯ç ** (10åˆ†)
   ```move
   const ERROR_NOT_ADMIN: u64 = 1;
   const ERROR_NOT_MODERATOR: u64 = 2;
   const ERROR_NOT_AUTHORIZED: u64 = 3;
   const ERROR_INVALID_ROLE: u64 = 4;
   const ERROR_CANNOT_MODIFY_ADMIN: u64 = 5;
   ```

3. **æ•°æ®ç»“æ„** (10åˆ†)
   ```move
   struct UserAccount has key {
       role: u8,
       created_at: u64,
       active: bool,
   }
   
   struct AdminCap has key, store {}
   ```

4. **æƒé™éªŒè¯å‡½æ•°** (10åˆ†)
   ```move
   // éªŒè¯ç®¡ç†å‘˜æƒé™
   fun require_admin(account: &signer) acquires UserAccount { }
   
   // éªŒè¯ç‰ˆä¸»æˆ–ä»¥ä¸Šæƒé™  
   fun require_moderator_or_above(account: &signer) acquires UserAccount { }
   
   // éªŒè¯ç‰¹å®šè§’è‰²
   fun require_role(account: &signer, required_role: u8) acquires UserAccount { }
   ```

5. **æ ¸å¿ƒåŠŸèƒ½** (10åˆ†)
   - `initialize(account: &signer)` - åˆå§‹åŒ–ç³»ç»Ÿ,åˆ›å»ºé¦–ä¸ªç®¡ç†å‘˜
   - `register(account: &signer)` - æ³¨å†Œä¸ºæ™®é€šç”¨æˆ·
   - `promote_user(admin: &signer, target: address, new_role: u8)` 
     - æå‡ç”¨æˆ·æƒé™(ä»…ç®¡ç†å‘˜)
   - `suspend_user(moderator: &signer, target: address)`
     - æš‚åœç”¨æˆ·(ç‰ˆä¸»æˆ–ç®¡ç†å‘˜)
   - `delete_user(admin: &signer, target: address)`
     - åˆ é™¤ç”¨æˆ·(ä»…ç®¡ç†å‘˜,ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜)

#### æˆåŠŸæ ‡å‡†
- [ ] æƒé™éªŒè¯ä¸¥æ ¼å‡†ç¡®
- [ ] é”™è¯¯æ¶ˆæ¯æ¸…æ™°
- [ ] ç®¡ç†å‘˜æƒé™å—ä¿æŠ¤
- [ ] æ‰€æœ‰æ“ä½œéƒ½æœ‰æƒé™æ£€æŸ¥

---

### âœ… ä»»åŠ¡ 3: å¸¦é™åˆ¶çš„ä»£å¸ç³»ç»Ÿ (é«˜çº§)

**éš¾åº¦**: â­â­â­â­  
**é¢„è®¡æ—¶é—´**: 60-75 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
å®ç°ä¸€ä¸ªå¸¦å¤šç§å®‰å…¨é™åˆ¶çš„ä»£å¸è½¬è´¦ç³»ç»Ÿã€‚

#### å…·ä½“è¦æ±‚

åˆ›å»º `sources/limited_token.move`:

1. **å®Œæ•´çš„é”™è¯¯ç ç³»ç»Ÿ** (15åˆ†)
   ```move
   // è´¦æˆ·é”™è¯¯ (100-199)
   const ERROR_ACCOUNT_NOT_FOUND: u64 = 101;
   const ERROR_ACCOUNT_FROZEN: u64 = 102;
   
   // é‡‘é¢é”™è¯¯ (200-299)  
   const ERROR_ZERO_AMOUNT: u64 = 201;
   const ERROR_INSUFFICIENT_BALANCE: u64 = 202;
   const ERROR_AMOUNT_TOO_SMALL: u64 = 203;
   const ERROR_AMOUNT_TOO_LARGE: u64 = 204;
   
   // é™åˆ¶é”™è¯¯ (300-399)
   const ERROR_DAILY_LIMIT_EXCEEDED: u64 = 301;
   const ERROR_RATE_LIMITED: u64 = 302;
   const ERROR_RECIPIENT_BLOCKED: u64 = 303;
   const ERROR_SELF_TRANSFER: u64 = 304;
   ```

2. **æ•°æ®ç»“æ„** (10åˆ†)
   ```move
   struct TokenAccount has key {
       balance: u64,
       frozen: bool,
       blocked: bool,
       daily_sent: u64,
       last_transfer_day: u64,
       last_transfer_time: u64,
       transfer_count: u64,
   }
   
   struct GlobalConfig has key {
       min_transfer: u64,
       max_transfer: u64,
       daily_limit: u64,
       min_interval: u64,  // æœ€å°è½¬è´¦é—´éš”(ç§’)
   }
   ```

3. **éªŒè¯å‡½æ•°** (20åˆ†)
   - `validate_amount(amount: u64, config: &GlobalConfig)` 
     - æ£€æŸ¥é‡‘é¢èŒƒå›´
   - `validate_rate_limit(account: &TokenAccount, config: &GlobalConfig)`
     - æ£€æŸ¥é€Ÿç‡é™åˆ¶
   - `validate_daily_limit(account: &TokenAccount, amount: u64, config: &GlobalConfig)`
     - æ£€æŸ¥æ¯æ—¥é™é¢
   - `validate_accounts(from: address, to: address)`
     - éªŒè¯è´¦æˆ·çŠ¶æ€

4. **æ ¸å¿ƒåŠŸèƒ½** (15åˆ†)
   - `initialize_config(admin: &signer, ...)` - åˆå§‹åŒ–é…ç½®
   - `create_account(account: &signer)` - åˆ›å»ºä»£å¸è´¦æˆ·
   - `mint(account: &signer, amount: u64)` - é“¸é€ ä»£å¸
   - `transfer(from: &signer, to: address, amount: u64)` - è½¬è´¦
     - å®Œæ•´çš„éªŒè¯æµç¨‹
     - æ›´æ–°æ‰€æœ‰é™åˆ¶è®¡æ•°å™¨
   - `freeze_account(admin: &signer, target: address)` - å†»ç»“è´¦æˆ·
   - `block_account(admin: &signer, target: address)` - æ‹‰é»‘è´¦æˆ·

#### æˆåŠŸæ ‡å‡†
- [ ] æ‰€æœ‰é™åˆ¶éƒ½æ­£ç¡®å®æ–½
- [ ] é”™è¯¯å¤„ç†å…¨é¢
- [ ] æ—¶é—´ç›¸å…³çš„é€»è¾‘æ­£ç¡®
- [ ] çŠ¶æ€æ›´æ–°å‡†ç¡®

---

### âœ… ä»»åŠ¡ 4: Option æ¨¡å¼å®è·µ (æŒ‘æˆ˜)

**éš¾åº¦**: â­â­â­â­  
**é¢„è®¡æ—¶é—´**: 45 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
ä½¿ç”¨ Option å®ç°ä¸€ä¸ªçµæ´»çš„ç”¨æˆ·æ¡£æ¡ˆæŸ¥è¯¢ç³»ç»Ÿã€‚

#### å…·ä½“è¦æ±‚

åˆ›å»º `sources/user_profiles.move`:

1. **æ•°æ®ç»“æ„** (10åˆ†)
   ```move
   struct UserProfile has key {
       username: vector<u8>,
       email: Option<vector<u8>>,  // å¯é€‰é‚®ç®±
       phone: Option<vector<u8>>,  // å¯é€‰ç”µè¯
       age: Option<u64>,           // å¯é€‰å¹´é¾„
       verified: bool,
   }
   ```

2. **æŸ¥è¯¢å‡½æ•°(ä½¿ç”¨ Option)** (20åˆ†)
   - `try_get_username(addr: address): Option<vector<u8>>`
     - è¿”å›ç”¨æˆ·å,å¦‚æœä¸å­˜åœ¨è¿”å› None
   - `try_get_email(addr: address): Option<vector<u8>>`
     - è¿”å›é‚®ç®±,å¦‚æœæœªè®¾ç½®æˆ–ä¸å­˜åœ¨è¿”å› None
   - `get_username_or_default(addr: address, default: vector<u8>): vector<u8>`
     - è¿”å›ç”¨æˆ·å,æˆ–é»˜è®¤å€¼
   - `batch_get_usernames(addresses: vector<address>): vector<Option<vector<u8>>>`
     - æ‰¹é‡æŸ¥è¯¢,å¤±è´¥çš„è¿”å› None

3. **ä¿®æ”¹å‡½æ•°(ä½¿ç”¨ assert)** (10åˆ†)
   - `create_profile(account: &signer, username: vector<u8>)`
     - å¿…é¡»ä¸å­˜åœ¨
   - `set_email(account: &signer, email: vector<u8>)`
     - å¿…é¡»å·²åˆ›å»º
   - `update_username(account: &signer, new_username: vector<u8>)`
     - å¿…é¡»æ˜¯æ‰€æœ‰è€…
     - å¿…é¡»å·²åˆ›å»º

4. **ç»„åˆå‡½æ•°** (5åˆ†)
   - `get_complete_info(addr: address): (vector<u8>, Option<vector<u8>>, Option<vector<u8>>)`
     - è¿”å›ç”¨æˆ·åå’Œå¯é€‰ä¿¡æ¯
     - å¦‚æœæ¡£æ¡ˆä¸å­˜åœ¨,ä½¿ç”¨ abort

#### æˆåŠŸæ ‡å‡†
- [ ] æ­£ç¡®åŒºåˆ† Option å’Œ abort çš„ä½¿ç”¨åœºæ™¯
- [ ] æŸ¥è¯¢å‡½æ•°ä¸ä¼š abort
- [ ] ä¿®æ”¹å‡½æ•°æœ‰é€‚å½“çš„ assert
- [ ] Option çš„ä½¿ç”¨ç¬¦åˆè¯­ä¹‰

---

## ğŸ§ª æµ‹è¯•è¦æ±‚

ä¸ºæ¯ä¸ªä»»åŠ¡ç¼–å†™æµ‹è¯•ç”¨ä¾‹:

### ä»»åŠ¡ 1 æµ‹è¯•ç¤ºä¾‹

```move
#[test_only]
module 0x1::safe_wallet_tests {
    use 0x1::safe_wallet;
    
    #[test(account = @0x1)]
    public fun test_create_wallet(account: &signer) {
        safe_wallet::create_wallet(account);
        let balance = safe_wallet::get_balance(signer::address_of(account));
        assert!(balance == 0, 0);
    }
    
    #[test(account = @0x1)]
    #[expected_failure(abort_code = 203)] // ERROR_ZERO_AMOUNT
    public fun test_zero_deposit_fails(account: &signer) {
        safe_wallet::create_wallet(account);
        safe_wallet::deposit(account, 0);
    }
    
    #[test(account = @0x1)]
    #[expected_failure(abort_code = 202)] // ERROR_INSUFFICIENT_BALANCE
    public fun test_insufficient_balance(account: &signer) {
        safe_wallet::create_wallet(account);
        safe_wallet::deposit(account, 100);
        safe_wallet::withdraw(account, 200);
    }
}
```

---

## âœ… æäº¤æ£€æŸ¥æ¸…å•

å®Œæˆä»»åŠ¡å,è¯·ç¡®ä¿:

- [ ] æ‰€æœ‰é”™è¯¯ç éƒ½ä½¿ç”¨å¸¸é‡å®šä¹‰
- [ ] é”™è¯¯ç æœ‰æ¸…æ™°çš„å‘½åå’Œåˆ†ç±»
- [ ] æ¯ä¸ªå‡½æ•°å¼€å§‹å¤„è¿›è¡Œå‚æ•°éªŒè¯
- [ ] ä½¿ç”¨ assert! è€Œä¸æ˜¯ if + abort
- [ ] åˆç†ä½¿ç”¨ Option å¤„ç†å¯é€‰æƒ…å†µ
- [ ] ç¼–å†™äº†åŸºæœ¬çš„æµ‹è¯•ç”¨ä¾‹
- [ ] ä»£ç æœ‰é€‚å½“çš„æ³¨é‡Š
- [ ] æ‰€æœ‰ä»£ç èƒ½ç¼–è¯‘é€šè¿‡

---

## ğŸ’¡ æç¤º

### ä»»åŠ¡ 1 æç¤º
- å…ˆå®šä¹‰æ‰€æœ‰é”™è¯¯ç 
- åœ¨æ¯ä¸ªå‡½æ•°å¼€å§‹å¤„éªŒè¯å‚æ•°
- ä½¿ç”¨ `assert!(condition, ERROR_CODE)` æ ¼å¼
- æ³¨æ„æº¢å‡ºæ£€æŸ¥: `new_balance >= old_balance`

### ä»»åŠ¡ 2 æç¤º
- ä½¿ç”¨è¾…åŠ©å‡½æ•°å°è£…æƒé™æ£€æŸ¥
- ç®¡ç†å‘˜åº”è¯¥æœ‰æœ€é«˜æƒé™
- ä¸èƒ½é™çº§æˆ–åˆ é™¤ç®¡ç†å‘˜
- è€ƒè™‘ä½¿ç”¨ Capability æ¨¡å¼

### ä»»åŠ¡ 3 æç¤º
- ä½¿ç”¨ `timestamp::now_seconds()` è·å–æ—¶é—´
- æ¯æ—¥é™é¢: `current_day = timestamp / 86400`
- é€Ÿç‡é™åˆ¶: `time_since_last >= min_interval`
- å…ˆæ£€æŸ¥æ‰€æœ‰æ¡ä»¶,å†æ‰§è¡Œæ“ä½œ

### ä»»åŠ¡ 4 æç¤º
- æŸ¥è¯¢æ“ä½œä½¿ç”¨ Option (ä¸ abort)
- ä¿®æ”¹æ“ä½œä½¿ç”¨ assert (ä¼š abort)
- Option ä½¿ç”¨: `option::none()`, `option::some(value)`
- æ£€æŸ¥: `option::is_some()`, `option::is_none()`
- æå–: `option::extract()`, `option::borrow()`

---

## ğŸ“ å­¦ä¹ æˆæœ

å®Œæˆè¿™äº›ä»»åŠ¡å,ä½ å°†èƒ½å¤Ÿ:
- âœ… è®¾è®¡æ¸…æ™°çš„é”™è¯¯ç ç³»ç»Ÿ
- âœ… å®ç°å¥å£®çš„å‚æ•°éªŒè¯
- âœ… æ­£ç¡®å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
- âœ… åŒºåˆ† abort å’Œ Option çš„ä½¿ç”¨åœºæ™¯
- âœ… ç¼–å†™å¯æµ‹è¯•çš„é”™è¯¯å¤„ç†ä»£ç 

**åŠ æ²¹!è®©ä½ çš„ä»£ç æ›´åŠ å¥å£®!** ğŸš€
