# Day 17 å®è·µä»»åŠ¡ï¼šå®ç°å®Œæ•´çš„ DEX Swap åŠŸèƒ½

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

é€šè¿‡æœ¬æ¬¡å®è·µï¼Œä½ å°†ï¼š
1. å®ç°ç”Ÿäº§çº§çš„ Swap åŠŸèƒ½
2. æŒæ¡æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶
3. å®ç°å¤šè·³è·¯ç”±
4. ç¼–å†™å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 1ï¼šåŸºç¡€ Swap å®ç°ï¼ˆ40åˆ†ï¼‰

#### 1.1 å®ç° `swap_exact_input` å‡½æ•°

åœ¨ `sources/swap.move` ä¸­å®ç°ç²¾ç¡®è¾“å…¥çš„äº¤æ¢åŠŸèƒ½ã€‚

**è¦æ±‚**ï¼š
- [ ] å‚æ•°éªŒè¯ï¼ˆé‡‘é¢ > 0ï¼Œæ± å­å­˜åœ¨ï¼‰
- [ ] ä½¿ç”¨å¸¦æ‰‹ç»­è´¹çš„å…¬å¼è®¡ç®—è¾“å‡º
- [ ] æ»‘ç‚¹æ£€æŸ¥ï¼ˆamount_out >= min_amount_outï¼‰
- [ ] æ­£ç¡®è½¬ç§»ä»£å¸
- [ ] æ›´æ–°å‚¨å¤‡
- [ ] K å€¼éªŒè¯
- [ ] å‘å‡ºå®Œæ•´äº‹ä»¶

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test(user = @0x123)]
public fun test_swap_exact_input(user: &signer) {
    // åˆ›å»ºæ± å­ï¼š1,000,000 USDC / 50,000 APT
    // ç”¨æˆ· swap: 10,000 USDC
    // é¢„æœŸè¾“å‡º: ~493.58 APTï¼ˆè€ƒè™‘ 0.3% æ‰‹ç»­è´¹ï¼‰
    // æ»‘ç‚¹å®¹å¿: 1% â†’ min_amount_out = 488.65 APT
}
```

#### 1.2 å®ç° `swap_exact_output` å‡½æ•°

å®ç°ç²¾ç¡®è¾“å‡ºçš„äº¤æ¢åŠŸèƒ½ã€‚

**è¦æ±‚**ï¼š
- [ ] è®¡ç®—æ‰€éœ€è¾“å…¥ï¼ˆä½¿ç”¨åå‘å…¬å¼ï¼‰
- [ ] æ£€æŸ¥è¾“å…¥ä¸è¶…è¿‡ max_amount_in
- [ ] ç¡®ä¿è¾“å‡ºä¸è¶…è¿‡å‚¨å¤‡
- [ ] å…¶ä»–è¦æ±‚åŒ 1.1

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test(user = @0x123)]
public fun test_swap_exact_output(user: &signer) {
    // ç”¨æˆ·æƒ³è¦: 500 APT
    // é¢„æœŸè¾“å…¥: ~10,203 USDC
    // æœ€å¤§è¾“å…¥: 10,300 USDC
}
```

---

### ä»»åŠ¡ 2ï¼šæ‰‹ç»­è´¹æœºåˆ¶ï¼ˆ20åˆ†ï¼‰

#### 2.1 å®ç°æ‰‹ç»­è´¹è®¡ç®—

**è¦æ±‚**ï¼š
- [ ] æ‰‹ç»­è´¹ç‡ï¼š0.3% (30 basis points)
- [ ] ä½¿ç”¨æ•´æ•°è¿ç®—é¿å…ç²¾åº¦æŸå¤±
- [ ] æ­£ç¡®å®ç° `calculate_fee()` å‡½æ•°

#### 2.2 éªŒè¯ K å€¼å¢é•¿

**è¦æ±‚**ï¼š
- [ ] å®ç° `verify_k_invariant()` å‡½æ•°
- [ ] ç¡®ä¿ k_new >= k_old
- [ ] K å€¼å¢é•¿ç‡åº”çº¦ç­‰äºæ‰‹ç»­è´¹ç‡

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
public fun test_k_value_increases() {
    // äº¤æ˜“å‰ K å€¼
    let k_before = reserve_x * reserve_y;
    
    // æ‰§è¡Œ swap
    swap_exact_input<X, Y>(...);
    
    // äº¤æ˜“å K å€¼
    let k_after = new_reserve_x * new_reserve_y;
    
    // éªŒè¯ K å€¼å¢åŠ 
    assert!(k_after > k_before, 0);
    
    // å¢é•¿ç‡åº”çº¦ä¸º 0.3%
    let growth = (k_after - k_before) * 10000 / k_before;
    assert!(growth >= 29 && growth <= 31, 0);
}
```

---

### ä»»åŠ¡ 3ï¼šæ»‘ç‚¹ä¿æŠ¤ï¼ˆ15åˆ†ï¼‰

#### 3.1 å®ç°ä»·æ ¼å½±å“è®¡ç®—

åœ¨ `sources/swap.move` ä¸­å®ç° `get_price_impact()` å‡½æ•°ã€‚

**è¦æ±‚**ï¼š
- [ ] è®¡ç®—äº¤æ˜“å‰ä»·æ ¼
- [ ] è®¡ç®—äº¤æ˜“åä»·æ ¼
- [ ] è¿”å›ä»·æ ¼å˜åŒ–ç™¾åˆ†æ¯”ï¼ˆåŸºç‚¹ï¼‰
- [ ] å¤„ç†è¾¹ç•Œæƒ…å†µ

**å…¬å¼**ï¼š
```
price_before = reserve_y / reserve_x
price_after = (reserve_y - amount_out) / (reserve_x + amount_in)
impact = |price_after - price_before| / price_before * 10000
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
public fun test_price_impact() {
    // æ± å­ï¼š1,000,000 USDC / 50,000 APT
    // è¾“å…¥ï¼š10,000 USDC
    // é¢„æœŸå½±å“ï¼šçº¦ 2.04% = 204 åŸºç‚¹
    let impact = get_price_impact<USDC, APT>(10000);
    assert!(impact >= 200 && impact <= 210, 0);
}
```

#### 3.2 å®ç°å‰ç«¯æ»‘ç‚¹è®¾ç½®

ç¼–å†™è¾…åŠ©å‡½æ•°å¸®åŠ©å‰ç«¯è®¡ç®—æ»‘ç‚¹å‚æ•°ã€‚

**è¦æ±‚**ï¼š
- [ ] `calculate_min_amount_out(amount_in, slippage_bps)`
- [ ] `calculate_max_amount_in(amount_out, slippage_bps)`
- [ ] æ”¯æŒä¸åŒçš„æ»‘ç‚¹å®¹å¿åº¦ï¼ˆ0.1% - 10%ï¼‰

---

### ä»»åŠ¡ 4ï¼šè·¯ç”±åŠŸèƒ½ï¼ˆ15åˆ†ï¼‰

#### 4.1 å®ç°ä¸¤è·³äº¤æ¢

åœ¨ `sources/router.move` ä¸­å®ç°å¤šè·³è·¯ç”±ã€‚

**è¦æ±‚**ï¼š
- [ ] å®ç° `swap_two_hop<X, Y, Z>()` å‡½æ•°
- [ ] ç¬¬ä¸€è·³ï¼šX â†’ Y
- [ ] ç¬¬äºŒè·³ï¼šY â†’ Z
- [ ] æœ€ç»ˆæ»‘ç‚¹æ£€æŸ¥
- [ ] æ­£ç¡®å¤„ç†ä¸­é—´ä»£å¸

**ç¤ºä¾‹**ï¼š
```move
// USDC â†’ APT â†’ TokenA
swap_two_hop<USDC, APT, TokenA>(
    user,
    10000_000000,  // 10,000 USDC
    4500_00000000, // æœ€å°‘ 4,500 TokenA
);
```

#### 4.2 è·¯å¾„æ¯”è¾ƒï¼ˆå¯é€‰æŒ‘æˆ˜ï¼‰

å®ç°å‡½æ•°æ¯”è¾ƒä¸åŒè·¯å¾„çš„è¾“å‡ºã€‚

**è¦æ±‚**ï¼š
- [ ] `compare_direct_vs_two_hop<X, Y, Z>(amount_in): (u64, u64)`
- [ ] è¿”å›ç›´æ¥è·¯å¾„å’Œä¸¤è·³è·¯å¾„çš„è¾“å‡º
- [ ] å¸®åŠ©ç”¨æˆ·é€‰æ‹©æœ€ä¼˜è·¯å¾„

---

### ä»»åŠ¡ 5ï¼šæŸ¥è¯¢æ¥å£ï¼ˆ10åˆ†ï¼‰

#### 5.1 å®ç°æ‰€æœ‰æŸ¥è¯¢å‡½æ•°

**è¦æ±‚**ï¼š
- [ ] `get_amount_out<X, Y>(amount_in): u64`
- [ ] `get_amount_in<X, Y>(amount_out): u64`
- [ ] `get_price<X, Y>(): u64`
- [ ] `get_reserves<X, Y>(): (u64, u64)`
- [ ] `get_price_impact<X, Y>(amount_in): u64`

**æµ‹è¯•æ‰€æœ‰æŸ¥è¯¢**ï¼š
```move
#[test]
public fun test_all_queries() {
    // æµ‹è¯•æ¯ä¸ªæŸ¥è¯¢å‡½æ•°çš„æ­£ç¡®æ€§
}
```

---

### ä»»åŠ¡ 6ï¼šå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆé¢å¤– 20åˆ†ï¼‰

#### 6.1 è¾¹ç•Œæƒ…å†µæµ‹è¯•

**è¦æ±‚æµ‹è¯•**ï¼š
- [ ] é›¶é‡‘é¢è¾“å…¥
- [ ] è¶…å¤§é‡‘é¢ï¼ˆæ¥è¿‘å‚¨å¤‡ï¼‰
- [ ] æ»‘ç‚¹è¶…é™
- [ ] æ± å­ä¸å­˜åœ¨
- [ ] å‚¨å¤‡ä¸ºé›¶

#### 6.2 é›†æˆæµ‹è¯•

**åœºæ™¯ 1ï¼šå®Œæ•´äº¤æ˜“æµç¨‹**
```move
#[test]
public fun test_full_swap_flow() {
    // 1. åˆ›å»ºæ± å­
    // 2. æ·»åŠ æµåŠ¨æ€§
    // 3. ç”¨æˆ· A swap Xâ†’Y
    // 4. éªŒè¯ä½™é¢å˜åŒ–
    // 5. éªŒè¯å‚¨å¤‡å˜åŒ–
    // 6. éªŒè¯ K å€¼å¢åŠ 
    // 7. ç”¨æˆ· B swap Yâ†’X
    // 8. éªŒè¯ä»·æ ¼å›å½’
}
```

**åœºæ™¯ 2ï¼šå¤šç”¨æˆ·å¹¶å‘äº¤æ˜“**
```move
#[test]
public fun test_concurrent_swaps() {
    // å¤šä¸ªç”¨æˆ·åŒæ—¶ swap
    // éªŒè¯æ‰€æœ‰äº¤æ˜“æ­£ç¡®æ‰§è¡Œ
    // éªŒè¯ K å€¼æŒç»­å¢åŠ 
}
```

**åœºæ™¯ 3ï¼šå¤§é¢äº¤æ˜“å½±å“**
```move
#[test]
public fun test_large_swap_impact() {
    // äº¤æ˜“é‡‘é¢ = å‚¨å¤‡çš„ 50%
    // éªŒè¯æ»‘ç‚¹ > 100%
    // éªŒè¯äº¤æ˜“ä»ç„¶æˆåŠŸ
}
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

å®Œæˆä»»åŠ¡åï¼Œä½ çš„é¡¹ç›®åº”è¯¥åŒ…å«ï¼š

```
sources/
â”œâ”€â”€ swap.move              # æ ¸å¿ƒ Swap å®ç°
â”œâ”€â”€ router.move            # è·¯ç”±åŠŸèƒ½
â”œâ”€â”€ fee_manager.move       # æ‰‹ç»­è´¹ç®¡ç†ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ math.move              # æ•°å­¦è®¡ç®—è¾…åŠ©å‡½æ•°

tests/
â”œâ”€â”€ swap_tests.move        # Swap å•å…ƒæµ‹è¯•
â”œâ”€â”€ router_tests.move      # è·¯ç”±æµ‹è¯•
â””â”€â”€ integration_tests.move # é›†æˆæµ‹è¯•

scripts/
â”œâ”€â”€ swap_exact_input.move  # ç²¾ç¡®è¾“å…¥è„šæœ¬
â”œâ”€â”€ swap_exact_output.move # ç²¾ç¡®è¾“å‡ºè„šæœ¬
â””â”€â”€ multi_hop_swap.move    # å¤šè·³äº¤æ¢è„šæœ¬
```

---

## ğŸ”§ å®ç°æç¤º

### æç¤º 1ï¼šç²¾åº¦å¤„ç†

```move
// ä½¿ç”¨ u128 é¿å…æº¢å‡º
fun mul_div(a: u64, b: u64, c: u64): u64 {
    let result = ((a as u128) * (b as u128)) / (c as u128);
    (result as u64)
}

// æ‰‹ç»­è´¹è®¡ç®—
let amount_in_with_fee = mul_div(
    amount_in,
    FEE_DENOMINATOR - FEE_RATE,
    FEE_DENOMINATOR
);
```

### æç¤º 2ï¼šäº‹ä»¶è®¾è®¡

```move
struct SwapEvent has drop, store {
    user: address,
    token_in: String,
    token_out: String,
    amount_in: u64,
    amount_out: u64,
    fee_amount: u64,
    reserve_in_after: u64,
    reserve_out_after: u64,
    price_before: u64,
    price_after: u64,
    timestamp: u64,
}
```

### æç¤º 3ï¼šé”™è¯¯å¤„ç†

```move
// è¯¦ç»†çš„é”™è¯¯ç 
const ERROR_ZERO_AMOUNT: u64 = 200;
const ERROR_INSUFFICIENT_OUTPUT: u64 = 201;
const ERROR_EXCESSIVE_INPUT: u64 = 202;
const ERROR_SLIPPAGE_EXCEEDED: u64 = 203;

// ä½¿ç”¨æè¿°æ€§æ–­è¨€
assert!(amount_out >= min_amount_out, ERROR_SLIPPAGE_EXCEEDED);
```

### æç¤º 4ï¼šGas ä¼˜åŒ–

```move
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è¯»å–
let reserve_x = get_reserve_x();
// ... ä½¿ç”¨
let reserve_x_again = get_reserve_x();

// âœ… å¥½ï¼šä¸€æ¬¡è¯»å–ï¼Œç¼“å­˜
let (reserve_x, reserve_y) = get_reserves();
// ... ä½¿ç”¨ä¸¤ä¸ªå‚¨å¤‡
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§ï¼ˆ60åˆ†ï¼‰
- [x] Exact Input Swap æ­£ç¡®å®ç°
- [x] Exact Output Swap æ­£ç¡®å®ç°
- [x] æ‰‹ç»­è´¹æ­£ç¡®è®¡ç®—å’Œæ”¶å–
- [x] æ»‘ç‚¹ä¿æŠ¤æœ‰æ•ˆ
- [x] å¤šè·³è·¯ç”±å·¥ä½œ
- [x] æ‰€æœ‰æŸ¥è¯¢æ¥å£å¯ç”¨

### ä»£ç è´¨é‡ï¼ˆ20åˆ†ï¼‰
- [x] ä»£ç ç»“æ„æ¸…æ™°
- [x] æ³¨é‡Šå……åˆ†
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] éµå¾ª Move æœ€ä½³å®è·µ

### æµ‹è¯•è¦†ç›–ï¼ˆ20åˆ†ï¼‰
- [x] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰å‡½æ•°
- [x] è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [x] é›†æˆæµ‹è¯•
- [x] æµ‹è¯•é€šè¿‡ç‡ 100%

---

## ğŸ“ å­¦ä¹ ç›®æ ‡æ£€æŸ¥

å®Œæˆä»»åŠ¡åï¼Œç¡®è®¤ä½ èƒ½å¤Ÿï¼š

- [ ] è§£é‡Š Exact Input å’Œ Exact Output çš„åŒºåˆ«
- [ ] æ‰‹å·¥è®¡ç®— Swap çš„è¾“å…¥/è¾“å‡º
- [ ] è§£é‡Šæ‰‹ç»­è´¹å¦‚ä½•å½±å“ K å€¼
- [ ] å®ç°æœ‰æ•ˆçš„æ»‘ç‚¹ä¿æŠ¤
- [ ] è®¾è®¡å¤šè·³è·¯ç”±ç®—æ³•
- [ ] ä¼˜åŒ– Gas æ¶ˆè€—
- [ ] ç¼–å†™å…¨é¢çš„æµ‹è¯•

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [Uniswap V2 Core - Swap](https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair#swap)
- [Aptos Coin Framework](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/framework/aptos-framework/sources)

### å¼€æºå®ç°
- [Liquidswap Router](https://github.com/pontem-network/liquidswap/blob/main/sources/router.move)
- [Uniswap V2 Pair](https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol)

---

## ğŸ’¡ é¢å¤–æŒ‘æˆ˜ï¼ˆå¯é€‰ï¼‰

### æŒ‘æˆ˜ 1ï¼šé—ªç”µäº¤æ¢
å®ç°ç±»ä¼¼ Uniswap çš„ Flash Swapï¼Œå…è®¸å…ˆå€Ÿå‡ºä»£å¸å†è¿˜æ¬¾ã€‚

### æŒ‘æˆ˜ 2ï¼šTWAP é¢„è¨€æœº
åŸºäº Swap å®ç°æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰ã€‚

### æŒ‘æˆ˜ 3ï¼šé™ä»·å•
åœ¨ AMM åŸºç¡€ä¸Šå®ç°é“¾ä¸Šé™ä»·å•åŠŸèƒ½ã€‚

### æŒ‘æˆ˜ 4ï¼šMEV ä¿æŠ¤
å®ç° Commit-Reveal æ–¹æ¡ˆé˜²æ­¢ä¸‰æ˜æ²»æ”»å‡»ã€‚

---

## ğŸš€ æäº¤è¯´æ˜

å®Œæˆä»»åŠ¡åï¼š

1. **è‡ªæµ‹**ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡
   ```bash
   aptos move test
   ```

2. **ç¼–è¯‘**ï¼šç¡®ä¿ä»£ç æ— é”™è¯¯
   ```bash
   aptos move compile
   ```

3. **éƒ¨ç½²åˆ°æµ‹è¯•ç½‘**ï¼ˆå¯é€‰ï¼‰
   ```bash
   aptos move publish --network testnet
   ```

4. **è®°å½•å­¦ä¹ **ï¼šå¡«å†™å­¦ä¹ æ€»ç»“

---

**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š3-4 å°æ—¶

**éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­ (ä¸­é«˜)

**å¼€å§‹æ—¶é—´**ï¼š__________

**å®Œæˆæ—¶é—´**ï¼š__________

**é‡åˆ°çš„ä¸»è¦æŒ‘æˆ˜**ï¼š
1. 
2. 
3. 

**æ”¶è·å’Œå¿ƒå¾—**ï¼š


---

**ç¥ä½ å¥½è¿ï¼è®°ä½ï¼šç†è§£æ¯”å®ç°æ›´é‡è¦ï¼Œæµ‹è¯•æ¯”åŠŸèƒ½æ›´å…³é”®ã€‚ğŸ¯**
