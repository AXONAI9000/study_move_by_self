# Day 21 实践任务

## 📋 任务概述

通过完成以下任务，你将掌握抵押品管理和健康因子计算的实际应用。

---

## 🎯 任务清单

### 任务 1：实现多资产抵押品管理 ⭐⭐⭐

**目标**：实现一个支持多资产抵押的完整管理系统

**要求**：

1. 支持至少 3 种不同资产（ETH, BTC, USDC）
2. 实现抵押品启用/禁用功能
3. 实现存款和提取功能
4. 每次操作后自动检查健康因子

**文件位置**：`sources/multi_asset_collateral.move`

**提示**：
```move
// 资产配置示例
ETH:  抵押率 75%, 清算阈值 80%
BTC:  抵押率 70%, 清算阈值 75%
USDC: 抵押率 80%, 清算阈值 85%
```

**验收标准**：
- ✅ 用户可以存入多种资产
- ✅ 用户可以选择性启用某些资产作为抵押品
- ✅ 提取时正确检查健康因子
- ✅ 禁用抵押品时验证安全性

---

### 任务 2：实现精确的健康因子计算器 ⭐⭐⭐⭐

**目标**：实现一个高精度的健康因子计算模块

**要求**：

1. 正确处理多资产的加权计算
2. 使用 1e18 精度避免精度损失
3. 处理边界情况（无债务、无抵押等）
4. 实现计算结果的格式化输出

**文件位置**：`sources/health_factor_calculator.move`

**核心公式**：
```
HF = Σ(抵押品i × 价格i × 抵押率i) / Σ(债务j × 价格j)
```

**测试用例**：
```move
// 测试案例 1：单资产
抵押：1 ETH ($2000, 75%)
借款：$1200
预期 HF：1.25

// 测试案例 2：多资产
抵押：
  - 1 ETH ($2000, 75%) = $1500
  - 1000 USDC ($1, 80%) = $800
  - 总抵押能力 = $2300
借款：$1500
预期 HF：1.533...

// 测试案例 3：边界情况
抵押：任意
借款：0
预期 HF：MAX_U128（无限大）
```

**验收标准**：
- ✅ 所有测试用例通过
- ✅ 精度误差 < 0.000001%
- ✅ 正确处理溢出
- ✅ Gas 效率优化

---

### 任务 3：实现价格预言机集成 ⭐⭐⭐

**目标**：集成多源价格预言机并实现价格验证

**要求**：

1. 模拟至少 2 个价格源
2. 实现价格偏差检测
3. 实现价格时效性检查
4. 实现价格聚合策略（中位数或加权平均）

**文件位置**：`sources/price_oracle.move`

**验证规则**：
```move
// 时效性
MAX_PRICE_AGE = 300 秒 (5 分钟)

// 偏差检查
MAX_DEVIATION = 5%
if |price1 - price2| / price1 > 5%:
    reject

// 价格范围
MIN_PRICE > 0
MAX_PRICE 根据资产设定
```

**验收标准**：
- ✅ 能够从多个源获取价格
- ✅ 正确检测并拒绝过期价格
- ✅ 正确检测并拒绝偏差过大的价格
- ✅ 价格聚合逻辑正确

---

### 任务 4：实现健康因子预警系统 ⭐⭐⭐⭐

**目标**：建立三级预警系统，实时监控用户健康状况

**要求**：

1. 实现三级预警机制
2. 每次影响健康因子的操作后发出事件
3. 提供健康因子状态查询
4. 实现预警级别判断

**文件位置**：`sources/health_monitor.move`

**预警等级**：
```
🟢 安全：HF ≥ 1.5
  - 无需预警
  - 允许所有操作

🟡 注意：1.2 ≤ HF < 1.5
  - 一级预警
  - 建议增加抵押或减少借款

🟠 警告：1.05 ≤ HF < 1.2
  - 二级预警
  - 限制新增借款
  - 强烈建议立即处理

🔴 紧急：1.0 ≤ HF < 1.05
  - 三级预警
  - 禁止所有增加风险的操作
  - 用户必须立即增加抵押或还款

⚫ 清算：HF < 1.0
  - 触发清算
  - 清算人可以执行清算
```

**事件定义**：
```move
#[event]
struct HealthFactorWarning {
    user: address,
    health_factor: u128,
    level: u8,          // 1, 2, 3
    collateral_value: u128,
    debt_value: u128,
    timestamp: u64,
}
```

**验收标准**：
- ✅ 正确识别所有预警等级
- ✅ 在适当时机发出预警事件
- ✅ 根据预警等级限制操作
- ✅ 提供清晰的状态查询接口

---

### 任务 5：实现风险参数动态调整 ⭐⭐⭐⭐⭐

**目标**：根据市场条件动态调整风险参数

**要求**：

1. 监控资产价格波动率
2. 根据波动率调整抵押率
3. 根据协议利用率调整参数
4. 实现参数调整的平滑过渡

**文件位置**：`sources/risk_parameter_manager.move`

**动态调整策略**：
```move
// 波动率监控
if 30日波动率 > 50%:
    降低抵押率 10%
    提高清算奖励 2%

// 利用率监控
if 总利用率 > 90%:
    降低抵押率 5%
    提高借款利率

// 流动性监控
if 24h 交易量下降 > 50%:
    暂停新借款
    或降低借款上限 50%
```

**验收标准**：
- ✅ 能够计算历史波动率
- ✅ 根据规则正确调整参数
- ✅ 参数调整有合理的上下限
- ✅ 调整过程平滑，避免突变

---

### 任务 6：实现操作模拟功能 ⭐⭐⭐

**目标**：在实际执行前模拟操作对健康因子的影响

**要求**：

1. 模拟存款后的健康因子
2. 模拟提取后的健康因子
3. 模拟借款后的健康因子
4. 模拟还款后的健康因子
5. 模拟价格变化对健康因子的影响

**文件位置**：`sources/operation_simulator.move`

**功能接口**：
```move
// 模拟存款
public fun simulate_deposit(
    user: address,
    asset: vector<u8>,
    amount: u128,
): (u128, u128) // (新健康因子, 新可借额度)

// 模拟提取
public fun simulate_withdraw(
    user: address,
    asset: vector<u8>,
    amount: u128,
): (u128, bool) // (新健康因子, 是否允许)

// 模拟价格变化
public fun simulate_price_change(
    user: address,
    asset: vector<u8>,
    new_price: u128,
): u128 // 新健康因子
```

**验收标准**：
- ✅ 模拟结果准确
- ✅ 不影响实际状态
- ✅ 性能优化（避免复制大量数据）
- ✅ 提供用户友好的操作建议

---

### 任务 7：实现完整的测试套件 ⭐⭐⭐⭐

**目标**：编写全面的单元测试和集成测试

**要求**：

1. 测试所有核心功能
2. 测试边界条件
3. 测试错误处理
4. 测试精度计算

**文件位置**：`tests/collateral_tests.move`

**测试场景**：

#### 场景 1：正常流程
```move
#[test]
fun test_normal_flow() {
    // 1. 存款
    // 2. 启用抵押品
    // 3. 借款
    // 4. 还款
    // 5. 提取
}
```

#### 场景 2：健康因子边界
```move
#[test]
fun test_health_factor_boundary() {
    // 测试 HF = 1.0, 0.99, 1.01
}
```

#### 场景 3：多资产
```move
#[test]
fun test_multi_asset() {
    // 测试多种资产的组合
}
```

#### 场景 4：价格波动
```move
#[test]
fun test_price_volatility() {
    // 测试价格大幅波动的影响
}
```

#### 场景 5：错误处理
```move
#[test]
#[expected_failure(abort_code = E_HEALTH_FACTOR_TOO_LOW)]
fun test_borrow_too_much() {
    // 测试过度借款被拒绝
}
```

**验收标准**：
- ✅ 测试覆盖率 > 90%
- ✅ 所有测试通过
- ✅ 边界条件充分测试
- ✅ 错误路径充分测试

---

## 📊 任务评分标准

### 基础分（60 分）
- 任务 1 完成：15 分
- 任务 2 完成：20 分
- 任务 3 完成：15 分
- 任务 7 基本测试：10 分

### 进阶分（30 分）
- 任务 4 完成：10 分
- 任务 5 完成：10 分
- 任务 6 完成：10 分

### 优化分（10 分）
- Gas 优化：3 分
- 代码质量：3 分
- 文档完善：2 分
- 创新实现：2 分

---

## 🚀 提交要求

### 文件组织
```
sources/
├── multi_asset_collateral.move       # 任务 1
├── health_factor_calculator.move     # 任务 2
├── price_oracle.move                 # 任务 3
├── health_monitor.move               # 任务 4
├── risk_parameter_manager.move       # 任务 5
└── operation_simulator.move          # 任务 6

tests/
└── collateral_tests.move             # 任务 7

scripts/
├── deploy.move                       # 部署脚本
└── demo.move                         # 演示脚本
```

### 测试要求
```bash
# 运行所有测试
aptos move test

# 查看测试覆盖率
aptos move test --coverage

# 运行特定测试
aptos move test --filter test_health_factor
```

### 文档要求
每个模块需要包含：
1. 模块功能说明
2. 公开函数文档
3. 使用示例
4. 注意事项

---

## 💡 实现提示

### 提示 1：精度处理
```move
// ❌ 错误：先除后乘，精度损失
let result = (a / b) * c;

// ✅ 正确：先乘后除，保持精度
let result = (a * c) / b;

// ✅ 更好：使用更高精度
let result = (a * c * PRECISION) / b / PRECISION;
```

### 提示 2：溢出保护
```move
// 检查乘法溢出
public fun safe_mul(a: u128, b: u128): u128 {
    if (a == 0 || b == 0) {
        return 0
    };
    let result = a * b;
    assert!(result / a == b, E_OVERFLOW);
    result
}
```

### 提示 3：Gas 优化
```move
// ❌ 低效：每次循环都访问存储
for i in 0..len {
    let x = *table::borrow(&storage, i);
    // ...
}

// ✅ 高效：批量读取
let data = copy_table_to_vector(&storage);
for i in 0..len {
    let x = *vector::borrow(&data, i);
    // ...
}
```

### 提示 4：事件设计
```move
// 设计完整的事件，方便链下索引
#[event]
struct OperationExecuted {
    user: address,
    operation: u8,     // 操作类型
    asset: vector<u8>,
    amount: u128,
    health_factor_before: u128,
    health_factor_after: u128,
    timestamp: u64,
}
```

---

## 🎓 学习资源

### 推荐阅读
1. Aave V3 技术文档 - 健康因子机制
2. Compound Finance - 抵押品管理
3. MakerDAO - 清算机制
4. 《精通 DeFi 风险管理》

### 参考实现
- Aave Protocol V3
- Compound V2
- Venus Protocol

---

## ❓ 常见问题

**Q1：健康因子计算中的精度如何选择？**

A：建议使用 1e18 精度。这是行业标准，可以避免大部分精度问题。

**Q2：如何处理价格预言机失败的情况？**

A：应该实现多级降级策略：
1. 使用备用预言机
2. 使用 TWAP 缓存价格
3. 暂停操作（最后手段）

**Q3：健康因子为无限大时如何表示？**

A：使用 `MAX_U128` 表示无限大。在实际显示时，可以显示为 "∞" 或 "Safe"。

**Q4：如何优化 Gas 消耗？**

A：
1. 批量操作
2. 延迟计算（只在必要时计算）
3. 缓存中间结果
4. 使用高效的数据结构

**Q5：测试时如何模拟不同的价格？**

A：使用 `#[test_only]` 函数创建测试用的价格更新接口。

---

## 🏆 挑战任务（可选）

### 挑战 1：实现自动化清算防护 ⭐⭐⭐⭐⭐
实现一个机器人，当健康因子接近 1.0 时自动执行防护操作。

### 挑战 2：实现跨链抵押品 ⭐⭐⭐⭐⭐
支持使用其他链上的资产作为抵押品（使用跨链桥）。

### 挑战 3：实现 NFT 抵押 ⭐⭐⭐⭐⭐
支持使用 NFT 作为抵押品，实现 NFT 估值机制。

---

**祝你编码愉快！如有问题，请查阅理论学习文档或寻求帮助。** 🚀
