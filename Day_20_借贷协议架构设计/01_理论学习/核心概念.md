# å€Ÿè´·åè®®æ¶æ„è®¾è®¡ - æ ¸å¿ƒæ¦‚å¿µ

## ğŸ“š ç›®å½•

1. [å€Ÿè´·åè®®åŸºç¡€](#1-å€Ÿè´·åè®®åŸºç¡€)
2. [æ ¸å¿ƒæ¦‚å¿µè¯¦è§£](#2-æ ¸å¿ƒæ¦‚å¿µè¯¦è§£)
3. [åˆ©ç‡æ¨¡å‹](#3-åˆ©ç‡æ¨¡å‹)
4. [æ¸…ç®—æœºåˆ¶](#4-æ¸…ç®—æœºåˆ¶)
5. [ä¸»æµåè®®åˆ†æ](#5-ä¸»æµåè®®åˆ†æ)
6. [æ¶æ„è®¾è®¡åŸåˆ™](#6-æ¶æ„è®¾è®¡åŸåˆ™)
7. [Move è¯­è¨€å®ç°è¦ç‚¹](#7-move-è¯­è¨€å®ç°è¦ç‚¹)

---

## 1. å€Ÿè´·åè®®åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯ DeFi å€Ÿè´·ï¼Ÿ

DeFi å€Ÿè´·åè®®æ˜¯ä¸€ä¸ª**å»ä¸­å¿ƒåŒ–çš„èµ„é‡‘å¸‚åœº**ï¼Œå…è®¸ç”¨æˆ·ï¼š
- **å­˜æ¬¾ï¼ˆSupply/Depositï¼‰**: å°†èµ„é‡‘å­˜å…¥åè®®ï¼Œèµšå–åˆ©æ¯
- **å€Ÿæ¬¾ï¼ˆBorrowï¼‰**: æŠµæŠ¼èµ„äº§ï¼Œå€Ÿå‡ºå…¶ä»–èµ„äº§
- **è¿˜æ¬¾ï¼ˆRepayï¼‰**: å½’è¿˜å€Ÿæ¬¾å’Œåˆ©æ¯
- **ææ¬¾ï¼ˆWithdrawï¼‰**: å–å‡ºå­˜æ¬¾å’Œæ”¶ç›Š

### 1.2 å€Ÿè´·åè®®çš„ä»·å€¼

#### å¯¹å­˜æ¬¾äººï¼ˆLendersï¼‰
- ğŸ’° **è¢«åŠ¨æ”¶ç›Š**: é—²ç½®èµ„äº§äº§ç”Ÿåˆ©æ¯
- ğŸ”’ **æµåŠ¨æ€§**: éšæ—¶å­˜å–ï¼ˆåœ¨æµåŠ¨æ€§å……è¶³æ—¶ï¼‰
- ğŸ“ˆ **é€æ˜æ”¶ç›Š**: é“¾ä¸Šå¯éªŒè¯çš„åˆ©ç‡

#### å¯¹å€Ÿæ¬¾äººï¼ˆBorrowersï¼‰
- ğŸ¦ **æ— éœ€ä¿¡ç”¨å®¡æŸ¥**: åŸºäºæŠµæŠ¼å“ï¼Œæ— éœ€ KYC
- âš¡ **å³æ—¶å€Ÿæ¬¾**: é“¾ä¸Šè‡ªåŠ¨æ‰§è¡Œ
- ğŸ’¡ **èµ„é‡‘æ•ˆç‡**: æ— éœ€å–å‡ºèµ„äº§å³å¯è·å¾—æµåŠ¨æ€§
- ğŸ“Š **æ æ†**: æ”¾å¤§æŠ•èµ„å¤´å¯¸

#### å…¸å‹åº”ç”¨åœºæ™¯
```
åœºæ™¯ 1: åšå¤šæŸèµ„äº§
  1. å­˜å…¥ 1000 USDC
  2. æŠµæŠ¼å€Ÿå‡º 0.5 ETHï¼ˆå‡è®¾æŠµæŠ¼ç‡ 80%ï¼‰
  3. å–å‡º ETH æ¢æˆ USDCï¼Œå†æ¬¡å­˜å…¥
  4. é‡å¤æ“ä½œï¼Œå®ç°æ æ†åšå¤š USDC

åœºæ™¯ 2: é¿ç¨ç­–ç•¥
  1. æŒæœ‰å¤§é‡ BTCï¼Œä½†ä¸æƒ³å–å‡ºç¼´ç¨
  2. æŠµæŠ¼ BTC å€Ÿå‡º USDC
  3. ä½¿ç”¨ USDC è¿›è¡Œæ¶ˆè´¹æˆ–æŠ•èµ„

åœºæ™¯ 3: å¥—åˆ©
  1. å‘ç°æŸ DEX çš„ APY é«˜äºå€Ÿè´·æˆæœ¬
  2. å€Ÿå‡ºèµ„äº§è¿›è¡ŒæµåŠ¨æ€§æŒ–çŸ¿
  3. èµšå–åˆ©å·®
```

### 1.3 è¶…é¢æŠµæŠ¼ vs æ— æŠµæŠ¼

#### è¶…é¢æŠµæŠ¼ï¼ˆOver-Collateralizedï¼‰
```
ç‰¹ç‚¹:
- æŠµæŠ¼å“ä»·å€¼ > å€Ÿæ¬¾ä»·å€¼
- æ— éœ€ä¿¡ç”¨è¯„ä¼°
- å®‰å…¨æ€§é«˜ï¼Œé€‚åˆä¸»æµ DeFi

ç¤ºä¾‹:
  æŠµæŠ¼ $15,000 ETH
  â†’ æœ€å¤šå€Ÿ $10,000 USDCï¼ˆæŠµæŠ¼ç‡ 75%ï¼‰
  â†’ è¶…é¢æŠµæŠ¼æ¯”ä¾‹: 150%
```

#### æ— æŠµæŠ¼/ä¿¡ç”¨è´·æ¬¾ï¼ˆUnder-Collateralizedï¼‰
```
ç‰¹ç‚¹:
- æŠµæŠ¼å“ä»·å€¼ < å€Ÿæ¬¾ä»·å€¼ æˆ– æ— æŠµæŠ¼
- éœ€è¦ä¿¡ç”¨è¯„ä¼°æˆ–é—ªç”µè´·
- é£é™©é«˜ï¼Œé€‚åˆä¸“ä¸šåœºæ™¯

ç±»å‹:
  1. é—ªç”µè´·ï¼ˆFlash Loanï¼‰: å•ç¬”äº¤æ˜“å†…å€Ÿè¿˜
  2. ä¿¡ç”¨å§”æ‰˜ï¼ˆCredit Delegationï¼‰: åŸºäºé“¾ä¸‹ä¿¡ä»»
  3. é“¾ä¸Šä¿¡ç”¨è¯„åˆ†: åŸºäºå†å²è¡Œä¸º
```

---

## 2. æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 2.1 æµåŠ¨æ€§æ± ï¼ˆLiquidity Poolï¼‰

æ¯ä¸ªæ”¯æŒçš„èµ„äº§éƒ½æœ‰ç‹¬ç«‹çš„æµåŠ¨æ€§æ± ï¼š

```
USDC æ± çŠ¶æ€:
â”œâ”€â”€ æ€»å­˜æ¬¾ï¼ˆTotal Depositsï¼‰: 1,000,000 USDC
â”œâ”€â”€ æ€»å€Ÿæ¬¾ï¼ˆTotal Borrowsï¼‰: 600,000 USDC
â”œâ”€â”€ å¯ç”¨æµåŠ¨æ€§ï¼ˆAvailable Liquidityï¼‰: 400,000 USDC
â”œâ”€â”€ åˆ©ç”¨ç‡ï¼ˆUtilization Rateï¼‰: 60%
â””â”€â”€ å‚¨å¤‡é‡‘ï¼ˆReservesï¼‰: 5,000 USDC
```

**å…³é”®æŒ‡æ ‡**:
```rust
åˆ©ç”¨ç‡ = æ€»å€Ÿæ¬¾ / æ€»å­˜æ¬¾
å¯ç”¨æµåŠ¨æ€§ = æ€»å­˜æ¬¾ - æ€»å€Ÿæ¬¾
å‚¨å¤‡é‡‘å› å­ = 10-20%ï¼ˆä»åˆ©æ¯ä¸­æå–ï¼‰
```

### 2.2 æŠµæŠ¼ç‡ï¼ˆCollateral Factor / LTVï¼‰

**å®šä¹‰**: æŠµæŠ¼å“å¯ä»¥å€Ÿå‡ºçš„æœ€å¤§æ¯”ä¾‹

```
ç¤ºä¾‹:
  èµ„äº§ A: æŠµæŠ¼ç‡ = 75%
  å«ä¹‰: $100 çš„ A æœ€å¤šå¯å€Ÿ $75 çš„å…¶ä»–èµ„äº§

æŠµæŠ¼ç‡è®¾ç½®ä¾æ®:
  âœ… é«˜æµåŠ¨æ€§ã€ä½æ³¢åŠ¨æ€§èµ„äº§ â†’ é«˜æŠµæŠ¼ç‡ï¼ˆ75%-80%ï¼‰
     ä¾‹å¦‚: USDC, USDT, WBTC
  
  âš ï¸ ä¸­ç­‰æµåŠ¨æ€§ã€ä¸­æ³¢åŠ¨æ€§ â†’ ä¸­æŠµæŠ¼ç‡ï¼ˆ50%-70%ï¼‰
     ä¾‹å¦‚: ETH, BNB
  
  âŒ ä½æµåŠ¨æ€§ã€é«˜æ³¢åŠ¨æ€§ â†’ ä½æŠµæŠ¼ç‡ï¼ˆ0%-50%ï¼‰
     ä¾‹å¦‚: å°å¸‚å€¼ä»£å¸
```

### 2.3 å¥åº·å› å­ï¼ˆHealth Factorï¼‰

**å®šä¹‰**: è¡¡é‡å€Ÿæ¬¾äººå¿å€ºèƒ½åŠ›çš„ç»¼åˆæŒ‡æ ‡

#### è®¡ç®—å…¬å¼

```
å¥åº·å› å­ = (æ€»æŠµæŠ¼å“ä»·å€¼ Ã— åŠ æƒå¹³å‡æŠµæŠ¼ç‡) / æ€»å€Ÿæ¬¾ä»·å€¼

è¯¦ç»†è®¡ç®—:
  æŠµæŠ¼èµ„äº§ 1: $10,000 ETH Ã— 75% = $7,500
  æŠµæŠ¼èµ„äº§ 2: $5,000 BTC Ã— 80% = $4,000
  æ€»æŠµæŠ¼èƒ½åŠ› = $7,500 + $4,000 = $11,500
  
  å€Ÿæ¬¾èµ„äº§ 1: $6,000 USDC
  å€Ÿæ¬¾èµ„äº§ 2: $2,000 DAI
  æ€»å€Ÿæ¬¾ = $8,000
  
  å¥åº·å› å­ = $11,500 / $8,000 = 1.4375
```

#### å¥åº·å› å­ç­‰çº§

| å¥åº·å› å­ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| > 1.5 | ğŸŸ¢ å®‰å…¨ | æŠµæŠ¼å……è¶³ï¼Œé£é™©ä½ |
| 1.2 - 1.5 | ğŸŸ¡ è­¦å‘Š | å»ºè®®å¢åŠ æŠµæŠ¼æˆ–è¿˜æ¬¾ |
| 1.0 - 1.2 | ğŸŸ  å±é™© | æ¥è¿‘æ¸…ç®—çº¿ |
| < 1.0 | ğŸ”´ æ¸…ç®— | è§¦å‘æ¸…ç®—æœºåˆ¶ |

### 2.4 åˆ©ç”¨ç‡ï¼ˆUtilization Rateï¼‰

**å®šä¹‰**: èµ„é‡‘æ± ä¸­è¢«å€Ÿå‡ºçš„æ¯”ä¾‹

```rust
åˆ©ç”¨ç‡ = æ€»å€Ÿæ¬¾ / (æ€»å€Ÿæ¬¾ + å¯ç”¨æµåŠ¨æ€§)
       = æ€»å€Ÿæ¬¾ / æ€»å­˜æ¬¾

ç¤ºä¾‹:
  æ± ä¸­æœ‰ 100 ä¸‡ USDC
  å€Ÿå‡º 60 ä¸‡ USDC
  åˆ©ç”¨ç‡ = 60 ä¸‡ / 100 ä¸‡ = 60%
```

**å½±å“**:
- ğŸ“ˆ åˆ©ç”¨ç‡ â†‘ â†’ å­˜æ¬¾åˆ©ç‡ â†‘ï¼Œå€Ÿæ¬¾åˆ©ç‡ â†‘
- ğŸ“‰ åˆ©ç”¨ç‡ â†“ â†’ å­˜æ¬¾åˆ©ç‡ â†“ï¼Œå€Ÿæ¬¾åˆ©ç‡ â†“

**æœ€ä¼˜åˆ©ç”¨ç‡**: é€šå¸¸è®¾ç½®ä¸º 80-90%
- è¿‡ä½ï¼šèµ„é‡‘åˆ©ç”¨æ•ˆç‡ä½
- è¿‡é«˜ï¼šææ¬¾é£é™©ï¼ˆæŒ¤å…‘ï¼‰

---

## 3. åˆ©ç‡æ¨¡å‹

### 3.1 åˆ©ç‡çš„ä½œç”¨

åˆ©ç‡æ˜¯å€Ÿè´·åè®®çš„**æ ¸å¿ƒè°ƒèŠ‚æœºåˆ¶**ï¼š
- ğŸ¯ **å¹³è¡¡ä¾›éœ€**: è°ƒèŠ‚å­˜æ¬¾å’Œå€Ÿæ¬¾çš„åŠ¨æ€å¹³è¡¡
- ğŸ’° **æ¿€åŠ±æœºåˆ¶**: å¸å¼•å­˜æ¬¾äººï¼Œæ§åˆ¶å€Ÿæ¬¾éœ€æ±‚
- ğŸ”’ **é£é™©æ§åˆ¶**: é«˜åˆ©ç”¨ç‡æ—¶æé«˜åˆ©ç‡ï¼Œä¿è¯æµåŠ¨æ€§

### 3.2 çº¿æ€§åˆ©ç‡æ¨¡å‹ï¼ˆLinear Modelï¼‰

**æœ€ç®€å•çš„åˆ©ç‡æ¨¡å‹**ï¼Œé€‚åˆç¨³å®šå¸ï¼š

```
å€Ÿæ¬¾åˆ©ç‡è®¡ç®—:
  if åˆ©ç”¨ç‡ <= æœ€ä¼˜åˆ©ç”¨ç‡:
      å€Ÿæ¬¾åˆ©ç‡ = åŸºç¡€åˆ©ç‡ + (åˆ©ç”¨ç‡ / æœ€ä¼˜åˆ©ç”¨ç‡) Ã— æ–œç‡1
  else:
      å€Ÿæ¬¾åˆ©ç‡ = åŸºç¡€åˆ©ç‡ + æ–œç‡1 + 
                 ((åˆ©ç”¨ç‡ - æœ€ä¼˜åˆ©ç”¨ç‡) / (1 - æœ€ä¼˜åˆ©ç”¨ç‡)) Ã— æ–œç‡2

å‚æ•°ç¤ºä¾‹:
  åŸºç¡€åˆ©ç‡ = 2%
  æ–œç‡1 = 10%
  æ–œç‡2 = 60%
  æœ€ä¼˜åˆ©ç”¨ç‡ = 80%
```

#### ç¤ºä¾‹è®¡ç®—

```
åœºæ™¯ 1: åˆ©ç”¨ç‡ = 40%
  å€Ÿæ¬¾åˆ©ç‡ = 2% + (40% / 80%) Ã— 10%
           = 2% + 5% = 7%

åœºæ™¯ 2: åˆ©ç”¨ç‡ = 90%
  å€Ÿæ¬¾åˆ©ç‡ = 2% + 10% + ((90% - 80%) / (1 - 80%)) Ã— 60%
           = 12% + (10% / 20%) Ã— 60%
           = 12% + 30% = 42%
```

#### åˆ©ç‡æ›²çº¿å›¾

```
åˆ©ç‡
 |
42% |                    â•±
    |                  â•±
    |                â•±
12% |______________â•±
    |            â•±
 7% |      â•±
    |    â•±
 2% |__â•±________________
    0%  40%  80%  100%  åˆ©ç”¨ç‡
         â†‘     â†‘
      å½“å‰  æœ€ä¼˜
```

### 3.3 åˆ†æ®µåˆ©ç‡æ¨¡å‹ï¼ˆKinked Modelï¼‰

**Compound å’Œ Aave é‡‡ç”¨çš„æ¨¡å‹**ï¼š

```move
// ä¼ªä»£ç 
fun calculate_borrow_rate(utilization: u64, optimal_utilization: u64): u64 {
    let base_rate = 20_000; // 2% (åŸºæ•° 1_000_000)
    let slope1 = 100_000;   // 10%
    let slope2 = 600_000;   // 60%
    
    if (utilization <= optimal_utilization) {
        base_rate + (utilization * slope1 / optimal_utilization)
    } else {
        let excess_util = utilization - optimal_utilization;
        let normal_rate = base_rate + slope1;
        normal_rate + (excess_util * slope2 / (1_000_000 - optimal_utilization))
    }
}
```

### 3.4 å­˜æ¬¾åˆ©ç‡è®¡ç®—

```
å­˜æ¬¾åˆ©ç‡ = å€Ÿæ¬¾åˆ©ç‡ Ã— åˆ©ç”¨ç‡ Ã— (1 - å‚¨å¤‡é‡‘å› å­)

ç¤ºä¾‹:
  å€Ÿæ¬¾åˆ©ç‡ = 10%
  åˆ©ç”¨ç‡ = 80%
  å‚¨å¤‡é‡‘å› å­ = 10%
  
  å­˜æ¬¾åˆ©ç‡ = 10% Ã— 80% Ã— (1 - 10%)
           = 10% Ã— 80% Ã— 90%
           = 7.2%
```

**ç†è§£**:
- åªæœ‰å€Ÿå‡ºçš„èµ„é‡‘äº§ç”Ÿåˆ©æ¯
- éƒ¨åˆ†åˆ©æ¯ä½œä¸ºåè®®å‚¨å¤‡é‡‘
- å­˜æ¬¾äººåˆ†äº«å¤§éƒ¨åˆ†åˆ©æ¯æ”¶ç›Š

### 3.5 å¤åˆ©è®¡ç®—

å€Ÿè´·åè®®é€šå¸¸ä½¿ç”¨**è¿ç»­å¤åˆ©**ï¼š

```
ç´¯è®¡åˆ©æ¯æŒ‡æ•°ï¼ˆInterest Indexï¼‰:

  Index_new = Index_old Ã— (1 + rate Ã— Î”t)

å…¶ä¸­:
  rate = å¹´åŒ–åˆ©ç‡
  Î”t = æ—¶é—´å·®ï¼ˆå¹´ï¼‰

ç¤ºä¾‹:
  åˆå§‹ Index = 1.0
  å¹´åŒ–åˆ©ç‡ = 10%
  ç»è¿‡ 1 å¹´
  
  Index_new = 1.0 Ã— (1 + 0.1 Ã— 1) = 1.1
  
  ç”¨æˆ·å­˜å…¥ 100 ä»£å¸æ—¶ Index = 1.0
  ç°åœ¨ Index = 1.1
  ç”¨æˆ·ä½™é¢ = 100 Ã— (1.1 / 1.0) = 110
```

---

## 4. æ¸…ç®—æœºåˆ¶

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç®—ï¼Ÿ

æ¸…ç®—æ˜¯å€Ÿè´·åè®®çš„**é£é™©æ§åˆ¶æ ¸å¿ƒ**ï¼š

```
é—®é¢˜åœºæ™¯:
  1. ç”¨æˆ·æŠµæŠ¼ $1000 ETHï¼Œå€Ÿå‡º $750 USDCï¼ˆæŠµæŠ¼ç‡ 75%ï¼‰
  2. ETH ä»·æ ¼æš´è·Œ 30%ï¼ŒæŠµæŠ¼å“ä»·å€¼é™è‡³ $700
  3. å¥åº·å› å­ = $700 Ã— 75% / $750 = 0.7 < 1.0
  4. å¦‚æœä¸æ¸…ç®—ï¼Œåè®®å°†é¢ä¸´åè´¦é£é™©

è§£å†³æ–¹æ¡ˆ:
  â†’ è§¦å‘æ¸…ç®—ï¼Œæ‹å–æŠµæŠ¼å“
  â†’ ç¡®ä¿åè®®å’Œå­˜æ¬¾äººçš„èµ„é‡‘å®‰å…¨
```

### 4.2 æ¸…ç®—è§¦å‘æ¡ä»¶

```
æ¸…ç®—æ¡ä»¶: å¥åº·å› å­ < 1.0

å³:
  (æ€»æŠµæŠ¼å“ä»·å€¼ Ã— åŠ æƒå¹³å‡æŠµæŠ¼ç‡) < æ€»å€Ÿæ¬¾ä»·å€¼
```

### 4.3 æ¸…ç®—æµç¨‹

#### æ ‡å‡†æ¸…ç®—æµç¨‹

```
Step 1: æ¸…ç®—æ£€æµ‹
  â”œâ”€ ç›‘æ§æ‰€æœ‰å€Ÿæ¬¾äººçš„å¥åº·å› å­
  â”œâ”€ å‘ç°å¥åº·å› å­ < 1.0
  â””â”€ æ ‡è®°ä¸ºå¯æ¸…ç®—

Step 2: æ¸…ç®—æ‰§è¡Œ
  â”œâ”€ æ¸…ç®—äººè°ƒç”¨ liquidate() å‡½æ•°
  â”œâ”€ æŒ‡å®šè¦æ¸…ç®—çš„å€Ÿæ¬¾å’ŒæŠµæŠ¼å“ç±»å‹
  â””â”€ æœ€å¤§æ¸…ç®—æ¯”ä¾‹: é€šå¸¸ä¸º 50%

Step 3: æ¸…ç®—è®¡ç®—
  â”œâ”€ è®¡ç®—æ¸…ç®—é‡‘é¢ = min(å€Ÿæ¬¾ Ã— 50%, æ¸…ç®—äººæ”¯ä»˜èƒ½åŠ›)
  â”œâ”€ è®¡ç®—æŠµæŠ¼å“è·å¾— = æ¸…ç®—é‡‘é¢ Ã— (1 + æ¸…ç®—å¥–åŠ±) / æŠµæŠ¼å“ä»·æ ¼
  â””â”€ æ¸…ç®—å¥–åŠ±: é€šå¸¸ä¸º 5-10%

Step 4: èµ„äº§è½¬ç§»
  â”œâ”€ æ¸…ç®—äººæ”¯ä»˜å€Ÿæ¬¾ä»£å¸
  â”œâ”€ æ¸…ç®—äººè·å¾—æŠµæŠ¼å“ï¼ˆå«å¥–åŠ±ï¼‰
  â”œâ”€ åè®®æ”¶å–æ¸…ç®—è´¹ç”¨ï¼ˆå¯é€‰ï¼‰
  â””â”€ æ›´æ–°å€Ÿæ¬¾äººçš„å€ºåŠ¡å’ŒæŠµæŠ¼å“
```

#### æ¸…ç®—ç¤ºä¾‹

```
åˆå§‹çŠ¶æ€:
  æŠµæŠ¼: 1 ETH = $2000
  å€Ÿæ¬¾: 1500 USDC
  æŠµæŠ¼ç‡: 75%
  å¥åº·å› å­ = $2000 Ã— 75% / $1500 = 1.0 (ä¸´ç•Œå€¼)

ä»·æ ¼æ³¢åŠ¨:
  ETH ä»·æ ¼è·Œè‡³ $1800
  å¥åº·å› å­ = $1800 Ã— 75% / $1500 = 0.9 < 1.0
  â†’ è§¦å‘æ¸…ç®—

æ¸…ç®—æ‰§è¡Œ:
  æ¸…ç®—æ¯”ä¾‹ = 50%
  æ¸…ç®—å€Ÿæ¬¾é‡‘é¢ = 1500 Ã— 50% = 750 USDC
  æ¸…ç®—å¥–åŠ± = 8%
  
  æŠµæŠ¼å“ä»·å€¼éœ€æ±‚ = 750 Ã— (1 + 8%) = 810 USDC
  ETH æ•°é‡ = 810 / 1800 = 0.45 ETH

ç»“æœ:
  æ¸…ç®—äºº:
    â”œâ”€ æ”¯ä»˜: 750 USDC
    â””â”€ è·å¾—: 0.45 ETH (ä»·å€¼ $810)
         â†’ åˆ©æ¶¦: $60 (8%)
  
  å€Ÿæ¬¾äºº:
    â”œâ”€ å‰©ä½™å€Ÿæ¬¾: 750 USDC
    â”œâ”€ å‰©ä½™æŠµæŠ¼: 0.55 ETH = $990
    â””â”€ æ–°å¥åº·å› å­ = $990 Ã— 75% / $750 = 0.99
       (ä»éœ€è¿›ä¸€æ­¥è¿˜æ¬¾æˆ–å¢åŠ æŠµæŠ¼)
```

### 4.4 æ¸…ç®—æ¿€åŠ±è®¾è®¡

#### æ¸…ç®—å¥–åŠ±ï¼ˆLiquidation Bonusï¼‰

```
ä½œç”¨: æ¿€åŠ±æ¸…ç®—äººåŠæ—¶æ¸…ç®—

è®¾ç½®åŸåˆ™:
  âœ… è¶³å¤Ÿé«˜: å¸å¼•æ¸…ç®—äººå‚ä¸
  âœ… è¶³å¤Ÿä½: é¿å…å€Ÿæ¬¾äººæŸå¤±è¿‡å¤§
  
å…¸å‹å€¼:
  - ç¨³å®šå¸: 5%
  - ä¸»æµå¸: 8%
  - å±±å¯¨å¸: 10-15%
```

#### æ¸…ç®—ä¿æŠ¤

```
1. æ¸è¿›å¼æ¸…ç®—
   - ä¸æ˜¯ä¸€æ¬¡æ€§æ¸…ç®—æ‰€æœ‰å€ºåŠ¡
   - é€šå¸¸é™åˆ¶ä¸º 50% æˆ–æ¥è¿‘æ¸…ç®—é˜ˆå€¼çš„éƒ¨åˆ†
   - ç»™å€Ÿæ¬¾äººæœºä¼šè‡ªæ•‘

2. æ¸…ç®—ç¼“å†²åŒº
   - æ¸…ç®—é˜ˆå€¼ < æŠµæŠ¼ç‡
   - ä¾‹å¦‚: æŠµæŠ¼ç‡ 75%ï¼Œæ¸…ç®—é˜ˆå€¼ 80%
   - é¿å…æ­£å¸¸æ³¢åŠ¨å¯¼è‡´æ¸…ç®—

3. æ¸…ç®—ä¼˜å…ˆçº§
   - ä¼˜å…ˆæ¸…ç®—å¥åº·å› å­æœ€ä½çš„å¤´å¯¸
   - æˆ–æŒ‰å€Ÿæ¬¾é‡‘é¢é™åºæ¸…ç®—
```

### 4.5 æç«¯æƒ…å†µå¤„ç†

#### å¿«é€Ÿä¸‹è·Œï¼ˆFlash Crashï¼‰

```
é—®é¢˜:
  ä»·æ ¼ç¬é—´æš´è·Œï¼Œå¤§é‡æ¸…ç®—ï¼ŒGas è´¹æš´æ¶¨

è§£å†³æ–¹æ¡ˆ:
  1. é¢„è¨€æœºå¹³æ»‘å¤„ç†ï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼‰
  2. æ¸…ç®—ä¼˜å…ˆçº§é˜Ÿåˆ—
  3. åè®®æš‚åœæœºåˆ¶
  4. å‚¨å¤‡é‡‘è¡¥å¿
```

#### æ­»äº¡èºæ—‹ï¼ˆDeath Spiralï¼‰

```
åœºæ™¯:
  æ¸…ç®— â†’ æŠµæŠ¼å“æŠ›å”® â†’ ä»·æ ¼ä¸‹è·Œ â†’ æ›´å¤šæ¸…ç®— â†’ ...

é˜²æŠ¤æªæ–½:
  1. ä¿å®ˆçš„æŠµæŠ¼ç‡è®¾ç½®
  2. å¤šæ ·åŒ–çš„æŠµæŠ¼å“
  3. æ–­è·¯å™¨ï¼ˆCircuit Breakerï¼‰
  4. ç¤¾åŒºæ²»ç†å¿«é€Ÿå“åº”
```

---

## 5. ä¸»æµåè®®åˆ†æ

### 5.1 Compound Protocol

#### æ ¸å¿ƒç‰¹ç‚¹

```
1. ç®€æ´è®¾è®¡
   - æ¯ä¸ªèµ„äº§ä¸€ä¸ª cToken åˆçº¦
   - ç”¨æˆ·å­˜æ¬¾è‡ªåŠ¨è·å¾— cToken
   - cToken ä»£è¡¨å­˜æ¬¾ä»½é¢å’Œæ”¶ç›Š

2. åˆ©ç‡æ¨¡å‹
   - Kinked åˆ©ç‡æ¨¡å‹
   - åŸºäºåˆ©ç”¨ç‡è‡ªåŠ¨è°ƒæ•´

3. æ²»ç†
   - COMP ä»£å¸æ²»ç†
   - ç¤¾åŒºæŠ•ç¥¨å†³å®šå‚æ•°

4. åˆ›æ–°
   - é¦–åˆ›æµåŠ¨æ€§æŒ–çŸ¿ï¼ˆYield Farmingï¼‰
   - cToken å¯ç»„åˆæ€§
```

#### æ¶æ„è®¾è®¡

```
Compound æ¶æ„:
â”œâ”€â”€ cToken åˆçº¦ï¼ˆæ¯ä¸ªèµ„äº§ï¼‰
â”‚   â”œâ”€â”€ mint(): å­˜æ¬¾
â”‚   â”œâ”€â”€ redeem(): ææ¬¾
â”‚   â”œâ”€â”€ borrow(): å€Ÿæ¬¾
â”‚   â”œâ”€â”€ repayBorrow(): è¿˜æ¬¾
â”‚   â””â”€â”€ liquidateBorrow(): æ¸…ç®—
â”œâ”€â”€ Comptrollerï¼ˆæ§åˆ¶å™¨ï¼‰
â”‚   â”œâ”€â”€ æŠµæŠ¼å“ç®¡ç†
â”‚   â”œâ”€â”€ å€Ÿæ¬¾èƒ½åŠ›è®¡ç®—
â”‚   â”œâ”€â”€ æ¸…ç®—æ£€æŸ¥
â”‚   â””â”€â”€ æ²»ç†å‚æ•°
â”œâ”€â”€ InterestRateModelï¼ˆåˆ©ç‡æ¨¡å‹ï¼‰
â”‚   â””â”€â”€ è®¡ç®—å€Ÿæ¬¾å’Œå­˜æ¬¾åˆ©ç‡
â””â”€â”€ PriceOracleï¼ˆä»·æ ¼é¢„è¨€æœºï¼‰
    â””â”€â”€ æä¾›èµ„äº§ä»·æ ¼
```

#### cToken æœºåˆ¶

```
å·¥ä½œåŸç†:
  1. ç”¨æˆ·å­˜å…¥ 100 USDC
  2. è·å¾— 4,950 cUSDCï¼ˆæ±‡ç‡ 1:0.0202ï¼‰
  3. cUSDC æ•°é‡ä¸å˜ï¼Œä½†æ±‡ç‡ä¸Šå‡
  4. ä¸€å¹´åæ±‡ç‡å˜ä¸º 1:0.0222
  5. ç”¨æˆ·èµå›: 4,950 Ã— 0.0222 = 109.89 USDC
     â†’ æ”¶ç›Š: 9.89 USDC (9.89%)

ä¼˜åŠ¿:
  âœ… è‡ªåŠ¨å¤åˆ©
  âœ… cToken å¯è½¬è®©
  âœ… cToken å¯åœ¨å…¶ä»– DeFi ä¸­ä½¿ç”¨
```

### 5.2 Aave Protocol

#### æ ¸å¿ƒç‰¹ç‚¹

```
1. ä¸°å¯ŒåŠŸèƒ½
   - æ ‡å‡†å€Ÿè´·
   - é—ªç”µè´·ï¼ˆFlash Loansï¼‰
   - åˆ©ç‡åˆ‡æ¢ï¼ˆç¨³å®š/æµ®åŠ¨ï¼‰
   - ä¿¡ç”¨å§”æ‰˜ï¼ˆCredit Delegationï¼‰

2. åˆ›æ–°æœºåˆ¶
   - aToken ä½™é¢è‡ªåŠ¨å¢é•¿
   - å€ºåŠ¡ä»£å¸åŒ–ï¼ˆdebtTokenï¼‰
   - éš”ç¦»æ¨¡å¼ï¼ˆIsolation Modeï¼‰
   - é«˜æ•ˆæ¨¡å¼ï¼ˆeModeï¼‰

3. é£é™©ç®¡ç†
   - å¤šå±‚æ¬¡æ¸…ç®—
   - å‚¨å¤‡é‡‘ä¿é™©
   - å®‰å…¨æ¨¡å—ï¼ˆSafety Moduleï¼‰
```

#### æ¶æ„è®¾è®¡

```
Aave V3 æ¶æ„:
â”œâ”€â”€ Poolï¼ˆæµåŠ¨æ€§æ± æ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ supply(): å­˜æ¬¾
â”‚   â”œâ”€â”€ withdraw(): ææ¬¾
â”‚   â”œâ”€â”€ borrow(): å€Ÿæ¬¾
â”‚   â”œâ”€â”€ repay(): è¿˜æ¬¾
â”‚   â”œâ”€â”€ flashLoan(): é—ªç”µè´·
â”‚   â””â”€â”€ liquidationCall(): æ¸…ç®—
â”œâ”€â”€ PoolConfiguratorï¼ˆé…ç½®ç®¡ç†ï¼‰
â”‚   â””â”€â”€ ç®¡ç†èµ„äº§å‚æ•°
â”œâ”€â”€ aTokenï¼ˆå­˜æ¬¾å‡­è¯ï¼‰
â”‚   â””â”€â”€ ä½™é¢è‡ªåŠ¨å¢é•¿
â”œâ”€â”€ variableDebtTokenï¼ˆæµ®åŠ¨åˆ©ç‡å€ºåŠ¡ï¼‰
â”‚   â””â”€â”€ å€ºåŠ¡å‡­è¯
â”œâ”€â”€ stableDebtTokenï¼ˆå›ºå®šåˆ©ç‡å€ºåŠ¡ï¼‰
â”‚   â””â”€â”€ ç¨³å®šåˆ©ç‡å€ºåŠ¡
â”œâ”€â”€ InterestRateStrategyï¼ˆåˆ©ç‡ç­–ç•¥ï¼‰
â”‚   â””â”€â”€ åŠ¨æ€åˆ©ç‡è®¡ç®—
â””â”€â”€ PriceOracleSentinelï¼ˆä»·æ ¼é¢„è¨€æœºå“¨å…µï¼‰
    â””â”€â”€ é¢„è¨€æœºå¥åº·æ£€æŸ¥
```

#### aToken æœºåˆ¶

```
aToken ç‰¹æ€§:
  1. ä½™é¢å®æ—¶å¢é•¿ï¼ˆæ— éœ€æ±‡ç‡è®¡ç®—ï¼‰
  2. 1:1 é”šå®šåº•å±‚èµ„äº§
  3. å¯è½¬è®©ï¼ˆä½†ä¼šè½¬ç§»æœªé¢†å–åˆ©æ¯ï¼‰

å·¥ä½œåŸç†:
  å­˜å…¥ 100 USDC â†’ è·å¾— 100 aUSDC
  å¹´åŒ–æ”¶ç›Š 5%
  å®æ—¶ç´¯ç§¯åˆ©æ¯
  ä½™é¢æ˜¾ç¤º: 100 â†’ 100.0137 â†’ 100.0274 â†’ ...
  ä¸€å¹´å: 105 aUSDC
```

#### é—ªç”µè´·

```
é—ªç”µè´·ç‰¹ç‚¹:
  âœ… æ— æŠµæŠ¼å€Ÿæ¬¾
  âœ… å•ç¬”äº¤æ˜“å†…å€Ÿè¿˜
  âœ… é€‚åˆå¥—åˆ©ã€æ¸…ç®—ã€å€ºåŠ¡è½¬ç§»

æµç¨‹:
  1. è°ƒç”¨ flashLoan()
  2. åè®®å°†èµ„é‡‘å€Ÿç»™è°ƒç”¨è€…
  3. è°ƒç”¨è€…æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
  4. è°ƒç”¨è€…å½’è¿˜æœ¬é‡‘ + æ‰‹ç»­è´¹ï¼ˆ0.09%ï¼‰
  5. å¦‚æœæœªå½’è¿˜ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š

åº”ç”¨:
  - è·¨ DEX å¥—åˆ©
  - è‡ªæ¸…ç®—ï¼ˆæ— éœ€æŒæœ‰èµ„äº§ï¼‰
  - æŠµæŠ¼å“äº¤æ¢
```

### 5.3 Compound vs Aave å¯¹æ¯”

| ç‰¹æ€§ | Compound | Aave |
|------|----------|------|
| **å­˜æ¬¾å‡­è¯** | cTokenï¼ˆæ±‡ç‡æ¨¡å‹ï¼‰ | aTokenï¼ˆä½™é¢å¢é•¿ï¼‰ |
| **åˆ©ç‡ç±»å‹** | æµ®åŠ¨ | æµ®åŠ¨ + ç¨³å®š |
| **é—ªç”µè´·** | âŒ | âœ… |
| **æ²»ç†ä»£å¸** | COMP | AAVE |
| **éƒ¨ç½²é“¾** | ä»¥å¤ªåŠç­‰ | å¤šé“¾éƒ¨ç½² |
| **Gas æ•ˆç‡** | ä¸­ç­‰ | è¾ƒé«˜ï¼ˆV3 ä¼˜åŒ–ï¼‰ |
| **ç”¨æˆ·ä½“éªŒ** | ç®€æ´ | åŠŸèƒ½ä¸°å¯Œ |
| **åˆ›æ–°æ€§** | é¦–åˆ› cToken | é¦–åˆ›é—ªç”µè´· |

---

## 6. æ¶æ„è®¾è®¡åŸåˆ™

### 6.1 æ¨¡å—åŒ–è®¾è®¡

```
æ ¸å¿ƒæ¨¡å—åˆ’åˆ†:
â”œâ”€â”€ èµ„äº§ç®¡ç†æ¨¡å—ï¼ˆAsset Managerï¼‰
â”‚   â”œâ”€â”€ èµ„äº§æ³¨å†Œ
â”‚   â”œâ”€â”€ å‚æ•°é…ç½®
â”‚   â””â”€â”€ èµ„äº§å¯ç”¨/ç¦ç”¨
â”œâ”€â”€ å­˜æ¬¾æ¨¡å—ï¼ˆDeposit Moduleï¼‰
â”‚   â”œâ”€â”€ å­˜æ¬¾å¤„ç†
â”‚   â”œâ”€â”€ ææ¬¾å¤„ç†
â”‚   â””â”€â”€ åˆ©æ¯è®¡ç®—
â”œâ”€â”€ å€Ÿæ¬¾æ¨¡å—ï¼ˆBorrow Moduleï¼‰
â”‚   â”œâ”€â”€ å€Ÿæ¬¾å¤„ç†
â”‚   â”œâ”€â”€ è¿˜æ¬¾å¤„ç†
â”‚   â””â”€â”€ å€ºåŠ¡è¿½è¸ª
â”œâ”€â”€ æŠµæŠ¼å“æ¨¡å—ï¼ˆCollateral Moduleï¼‰
â”‚   â”œâ”€â”€ æŠµæŠ¼å“ç®¡ç†
â”‚   â”œâ”€â”€ å¥åº·å› å­è®¡ç®—
â”‚   â””â”€â”€ å€Ÿæ¬¾èƒ½åŠ›è®¡ç®—
â”œâ”€â”€ æ¸…ç®—æ¨¡å—ï¼ˆLiquidation Moduleï¼‰
â”‚   â”œâ”€â”€ æ¸…ç®—æ£€æµ‹
â”‚   â”œâ”€â”€ æ¸…ç®—æ‰§è¡Œ
â”‚   â””â”€â”€ æ¸…ç®—æ¿€åŠ±
â”œâ”€â”€ åˆ©ç‡æ¨¡å—ï¼ˆInterest Rate Moduleï¼‰
â”‚   â”œâ”€â”€ åˆ©ç‡æ¨¡å‹å®ç°
â”‚   â”œâ”€â”€ åˆ©ç‡æ›´æ–°
â”‚   â””â”€â”€ åˆ©æ¯ç´¯ç§¯
â”œâ”€â”€ é¢„è¨€æœºæ¨¡å—ï¼ˆOracle Moduleï¼‰
â”‚   â”œâ”€â”€ ä»·æ ¼è·å–
â”‚   â”œâ”€â”€ å¤šæºèšåˆ
â”‚   â””â”€â”€ ä»·æ ¼éªŒè¯
â””â”€â”€ æ²»ç†æ¨¡å—ï¼ˆGovernance Moduleï¼‰
    â”œâ”€â”€ å‚æ•°è°ƒæ•´
    â”œâ”€â”€ ææ¡ˆæŠ•ç¥¨
    â””â”€â”€ æ—¶é—´é”æ‰§è¡Œ
```

### 6.2 æ•°æ®ç»“æ„è®¾è®¡

#### èµ„äº§æ± ï¼ˆAsset Poolï¼‰

```move
struct AssetPool has key {
    // åŸºæœ¬ä¿¡æ¯
    asset_type: TypeInfo,              // èµ„äº§ç±»å‹
    total_deposits: u64,               // æ€»å­˜æ¬¾
    total_borrows: u64,                // æ€»å€Ÿæ¬¾
    
    // åˆ©ç‡ç›¸å…³
    deposit_index: u128,               // å­˜æ¬¾åˆ©æ¯æŒ‡æ•°
    borrow_index: u128,                // å€Ÿæ¬¾åˆ©æ¯æŒ‡æ•°
    last_update_timestamp: u64,        // æœ€åæ›´æ–°æ—¶é—´
    
    // åˆ©ç‡æ¨¡å‹å‚æ•°
    base_rate: u64,                    // åŸºç¡€åˆ©ç‡
    slope1: u64,                       // æ–œç‡1
    slope2: u64,                       // æ–œç‡2
    optimal_utilization: u64,          // æœ€ä¼˜åˆ©ç”¨ç‡
    
    // é£é™©å‚æ•°
    collateral_factor: u64,            // æŠµæŠ¼ç‡
    liquidation_threshold: u64,        // æ¸…ç®—é˜ˆå€¼
    liquidation_bonus: u64,            // æ¸…ç®—å¥–åŠ±
    reserve_factor: u64,               // å‚¨å¤‡é‡‘å› å­
    
    // å‚¨å¤‡é‡‘
    reserves: Coin<AssetType>,         // åè®®å‚¨å¤‡é‡‘
}
```

#### ç”¨æˆ·è´¦æˆ·ï¼ˆUser Accountï¼‰

```move
struct UserAccount has key {
    // å­˜æ¬¾ä¿¡æ¯
    deposits: Table<TypeInfo, DepositInfo>,
    
    // å€Ÿæ¬¾ä¿¡æ¯
    borrows: Table<TypeInfo, BorrowInfo>,
    
    // æŠµæŠ¼å“
    collaterals: vector<TypeInfo>,
    
    // è´¦æˆ·ç»Ÿè®¡
    total_collateral_value: u128,     // æ€»æŠµæŠ¼å“ä»·å€¼ï¼ˆUSDï¼‰
    total_borrow_value: u128,         // æ€»å€Ÿæ¬¾ä»·å€¼ï¼ˆUSDï¼‰
    health_factor: u128,              // å¥åº·å› å­
}

struct DepositInfo has store {
    amount: u64,                       // å­˜æ¬¾æ•°é‡
    index: u128,                       // å­˜å…¥æ—¶çš„åˆ©æ¯æŒ‡æ•°
    enabled_as_collateral: bool,      // æ˜¯å¦ç”¨ä½œæŠµæŠ¼
}

struct BorrowInfo has store {
    amount: u64,                       // å€Ÿæ¬¾æ•°é‡
    index: u128,                       // å€Ÿå…¥æ—¶çš„åˆ©æ¯æŒ‡æ•°
    interest_rate_mode: u8,           // åˆ©ç‡æ¨¡å¼ï¼ˆæµ®åŠ¨/ç¨³å®šï¼‰
}
```

### 6.3 æ¥å£è®¾è®¡

#### ç”¨æˆ·æ¥å£

```move
// å­˜æ¬¾
public entry fun deposit<CoinType>(
    user: &signer,
    amount: u64,
    enable_as_collateral: bool
)

// ææ¬¾
public entry fun withdraw<CoinType>(
    user: &signer,
    amount: u64
)

// å€Ÿæ¬¾
public entry fun borrow<CoinType>(
    user: &signer,
    amount: u64,
    interest_rate_mode: u8
)

// è¿˜æ¬¾
public entry fun repay<CoinType>(
    user: &signer,
    amount: u64
)

// è®¾ç½®æŠµæŠ¼å“
public entry fun set_collateral<CoinType>(
    user: &signer,
    enable: bool
)
```

#### æ¸…ç®—æ¥å£

```move
// æ¸…ç®—
public entry fun liquidate<CollateralCoin, DebtCoin>(
    liquidator: &signer,
    borrower: address,
    debt_amount: u64
): u64  // è¿”å›è·å¾—çš„æŠµæŠ¼å“æ•°é‡
```

#### æŸ¥è¯¢æ¥å£

```move
// æŸ¥è¯¢ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
public fun get_user_account_data(user: address): (
    u128,  // total_collateral_usd
    u128,  // total_debt_usd
    u128,  // available_borrow_usd
    u128,  // health_factor
)

// æŸ¥è¯¢èµ„äº§æ± ä¿¡æ¯
public fun get_pool_data<CoinType>(): (
    u64,   // total_deposits
    u64,   // total_borrows
    u64,   // deposit_rate
    u64,   // borrow_rate
    u64,   // utilization_rate
)
```

### 6.4 å®‰å…¨æ€§è€ƒè™‘

#### 1. é‡å…¥é˜²æŠ¤

```move
// ä½¿ç”¨èµ„æºæ¨¡å‹å¤©ç„¶é˜²æŠ¤é‡å…¥
struct ReentrancyGuard has key {
    locked: bool,
}

public fun acquire_lock(account: &signer) acquires ReentrancyGuard {
    let guard = borrow_global_mut<ReentrancyGuard>(signer::address_of(account));
    assert!(!guard.locked, E_REENTRANT_CALL);
    guard.locked = true;
}
```

#### 2. æº¢å‡ºä¿æŠ¤

```move
// ä½¿ç”¨ u128 é¿å…æº¢å‡º
// å…³é”®è®¡ç®—ä½¿ç”¨å®‰å…¨æ•°å­¦åº“
use aptos_std::math64;
use aptos_std::math128;

// ä¹˜æ³•æº¢å‡ºä¿æŠ¤
let result = math128::mul_div(a, b, c);
```

#### 3. é¢„è¨€æœºå®‰å…¨

```move
// å¤šæºä»·æ ¼éªŒè¯
public fun get_verified_price<CoinType>(): u128 {
    let price1 = pyth::get_price<CoinType>();
    let price2 = switchboard::get_price<CoinType>();
    
    // ä»·æ ¼åå·®æ£€æŸ¥
    let deviation = calculate_deviation(price1, price2);
    assert!(deviation < MAX_DEVIATION, E_PRICE_DEVIATION_TOO_HIGH);
    
    // è¿”å›ä¸­ä½æ•°æˆ–å¹³å‡å€¼
    (price1 + price2) / 2
}
```

#### 4. æš‚åœæœºåˆ¶

```move
struct PauseGuardian has key {
    paused: bool,
    guardian: address,
}

public fun check_not_paused() acquires PauseGuardian {
    let guardian = borrow_global<PauseGuardian>(@lending_addr);
    assert!(!guardian.paused, E_PROTOCOL_PAUSED);
}
```

---

## 7. Move è¯­è¨€å®ç°è¦ç‚¹

### 7.1 æ³›å‹è®¾è®¡

```move
// é€šç”¨æ± ç»“æ„
struct Pool<phantom CoinType> has key {
    coins: Coin<CoinType>,
    metadata: PoolMetadata,
}

// æ³›å‹å­˜æ¬¾å‡½æ•°
public fun deposit<CoinType>(
    user: &signer,
    coins: Coin<CoinType>
) acquires Pool<CoinType> {
    let pool = borrow_global_mut<Pool<CoinType>>(@lending_addr);
    coin::merge(&mut pool.coins, coins);
    // ... æ›´æ–°çŠ¶æ€
}
```

### 7.2 èƒ½åŠ›ç³»ç»Ÿåˆ©ç”¨

```move
// åˆ©ç”¨ store èƒ½åŠ›å­˜å‚¨ç”¨æˆ·æ•°æ®
struct UserPosition has key {
    deposits: SimpleMap<TypeInfo, DepositData>,  // store
    borrows: SimpleMap<TypeInfo, BorrowData>,    // store
}

// åˆ©ç”¨ drop èƒ½åŠ›ç®€åŒ–èµ„æºç®¡ç†
struct CalculationResult has drop {
    value: u128,
    timestamp: u64,
}
```

### 7.3 äº‹ä»¶ç³»ç»Ÿ

```move
struct DepositEvent has drop, store {
    user: address,
    asset: TypeInfo,
    amount: u64,
    timestamp: u64,
}

struct BorrowEvent has drop, store {
    user: address,
    asset: TypeInfo,
    amount: u64,
    interest_rate: u64,
    timestamp: u64,
}

struct LiquidationEvent has drop, store {
    liquidator: address,
    borrower: address,
    collateral_asset: TypeInfo,
    debt_asset: TypeInfo,
    collateral_amount: u64,
    debt_amount: u64,
    bonus: u64,
    timestamp: u64,
}
```

### 7.4 ç²¾åº¦å¤„ç†

```move
// ä½¿ç”¨å›ºå®šç²¾åº¦
const PRECISION: u128 = 1_000_000_000_000_000_000; // 1e18

// è®¡ç®—å¥åº·å› å­
public fun calculate_health_factor(
    collateral_value: u128,
    debt_value: u128,
    collateral_factor: u64
): u128 {
    if (debt_value == 0) {
        return MAX_HEALTH_FACTOR;
    };
    
    let adjusted_collateral = (collateral_value * (collateral_factor as u128)) / 
                              (COLLATERAL_FACTOR_PRECISION as u128);
    (adjusted_collateral * PRECISION) / debt_value
}
```

### 7.5 Gas ä¼˜åŒ–

```move
// 1. ä½¿ç”¨ Table è€Œé SimpleMapï¼ˆå¤§æ•°æ®é›†ï¼‰
use aptos_std::table::Table;

struct UserData has key {
    positions: Table<TypeInfo, Position>,  // æ¯” SimpleMap æ›´çœ Gas
}

// 2. æ‰¹é‡æ“ä½œ
public entry fun batch_update_interest_rates(
    assets: vector<TypeInfo>
) {
    let i = 0;
    while (i < vector::length(&assets)) {
        update_interest_rate(*vector::borrow(&assets, i));
        i = i + 1;
    }
}

// 3. å»¶è¿Ÿè®¡ç®—
// åªåœ¨éœ€è¦æ—¶è®¡ç®—åˆ©æ¯ï¼Œè€Œéæ¯æ¬¡æ“ä½œ
public fun get_user_balance_with_interest(
    user: address,
    asset: TypeInfo
): u64 {
    let position = get_user_position(user, asset);
    calculate_balance_with_accrued_interest(position)
}
```

---

## 8. æ€»ç»“ä¸å±•æœ›

### 8.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

```
1. å€Ÿè´·åè®®æ˜¯ DeFi åŸºç¡€è®¾æ–½
   - ä¸ºèµ„é‡‘æä¾›æ–¹å’Œéœ€æ±‚æ–¹æ­å»ºæ¡¥æ¢
   - é€šè¿‡è¶…é¢æŠµæŠ¼ç¡®ä¿å®‰å…¨æ€§

2. æ ¸å¿ƒæœºåˆ¶
   - åˆ©ç‡æ¨¡å‹: è°ƒèŠ‚ä¾›éœ€å¹³è¡¡
   - å¥åº·å› å­: è¡¡é‡é£é™©æ°´å¹³
   - æ¸…ç®—æœºåˆ¶: ä¿æŠ¤åè®®å®‰å…¨

3. è®¾è®¡åŸåˆ™
   - æ¨¡å—åŒ–: ä¾¿äºç»´æŠ¤å’Œæ‰©å±•
   - å®‰å…¨æ€§: å¤šé‡é˜²æŠ¤æœºåˆ¶
   - æ•ˆç‡: Gas å’Œèµ„æœ¬æ•ˆç‡ä¼˜åŒ–

4. Move ä¼˜åŠ¿
   - èµ„æºå®‰å…¨: å¤©ç„¶é˜²é‡å…¥
   - æ³›å‹ç³»ç»Ÿ: ä»£ç å¤ç”¨
   - ç±»å‹å®‰å…¨: ç¼–è¯‘æ—¶æ£€æŸ¥
```

### 8.2 ä¸‹ä¸€æ­¥å­¦ä¹ 

åœ¨æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ï¼š

- **Day 21**: æ·±å…¥æŠµæŠ¼å“ç®¡ç†å’Œå¥åº·å› å­è®¡ç®—
- **Day 22**: å®ç°åˆ©ç‡æ¨¡å‹å’Œæ¸…ç®—æœºåˆ¶
- **Day 23-26**: NFT å’Œæ›´å¤š DeFi åŠŸèƒ½
- **Week 5**: MEV å’Œé«˜çº§ç­–ç•¥

### 8.3 å®è·µå»ºè®®

```
1. ç ”ç©¶ä¸»æµåè®®
   - é˜…è¯» Aaveã€Compound æºç 
   - åˆ†æå®ƒä»¬çš„ä¼˜ç¼ºç‚¹
   - æ€è€ƒæ”¹è¿›æ–¹æ¡ˆ

2. åŠ¨æ‰‹è®¾è®¡
   - ç”»å‡ºè‡ªå·±çš„æ¶æ„å›¾
   - å®šä¹‰æ•°æ®ç»“æ„
   - è®¾è®¡æ¥å£

3. å®‰å…¨ç¬¬ä¸€
   - è€ƒè™‘å„ç§æ”»å‡»åœºæ™¯
   - è®¾è®¡é˜²æŠ¤æªæ–½
   - è¿›è¡Œå‹åŠ›æµ‹è¯•

4. æŒç»­ä¼˜åŒ–
   - ç›‘æ§ Gas æ¶ˆè€—
   - ä¼˜åŒ–å­˜å‚¨ç»“æ„
   - æå‡ç”¨æˆ·ä½“éªŒ
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. [Compound Protocol Documentation](https://docs.compound.finance/)
2. [Aave V3 Technical Paper](https://github.com/aave/aave-v3-core)
3. [DeFi Lending: An Introduction](https://www.paradigm.xyz/)
4. [Move Language Book](https://move-language.github.io/move/)
5. [Aptos Framework Reference](https://aptos.dev/reference/move)

---

**æ­å–œå®Œæˆç†è®ºå­¦ä¹ ï¼ç°åœ¨æŸ¥çœ‹ä»£ç ç¤ºä¾‹ï¼Œç„¶åå¼€å§‹å®è·µä»»åŠ¡ã€‚** ğŸ‰
