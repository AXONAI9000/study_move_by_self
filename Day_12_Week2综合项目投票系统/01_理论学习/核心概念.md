# é“¾ä¸ŠæŠ•ç¥¨ç³»ç»Ÿï¼šæ ¸å¿ƒæ¦‚å¿µä¸è®¾è®¡

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæŠ•ç¥¨ç³»ç»ŸåŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯é“¾ä¸ŠæŠ•ç¥¨

**é“¾ä¸ŠæŠ•ç¥¨ï¼ˆOn-chain Votingï¼‰** æ˜¯åœ¨åŒºå—é“¾ä¸Šæ‰§è¡Œçš„æŠ•ç¥¨æœºåˆ¶ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- **é€æ˜æ€§**ï¼šæ‰€æœ‰æŠ•ç¥¨è®°å½•å…¬å¼€å¯æŸ¥
- **ä¸å¯ç¯¡æ”¹**ï¼šæŠ•ç¥¨ä¸€æ—¦æäº¤æ— æ³•æ›´æ”¹
- **å»ä¸­å¿ƒåŒ–**ï¼šæ— éœ€ä¸­å¿ƒåŒ–æœºæ„ç®¡ç†
- **è‡ªåŠ¨æ‰§è¡Œ**ï¼šæŠ•ç¥¨ç»“æœå¯è§¦å‘é“¾ä¸Šæ“ä½œ

**å¯¹æ¯”ä¼ ç»ŸæŠ•ç¥¨**ï¼š

| ç‰¹æ€§ | ä¼ ç»ŸæŠ•ç¥¨ | é“¾ä¸ŠæŠ•ç¥¨ |
|------|---------|---------|
| é€æ˜åº¦ | ä½ | é«˜ï¼ˆæ‰€æœ‰è®°å½•å¯æŸ¥ï¼‰ |
| å¯ä¿¡åº¦ | ä¾èµ–ç»„ç»‡è€… | ä¾èµ–ä»£ç å’Œå…±è¯† |
| æ•ˆç‡ | æ…¢ï¼ˆäººå·¥ç»Ÿè®¡ï¼‰ | å¿«ï¼ˆè‡ªåŠ¨ç»Ÿè®¡ï¼‰ |
| æˆæœ¬ | é«˜ï¼ˆåœºåœ°ã€äººåŠ›ï¼‰ | ä½ï¼ˆä»… Gas è´¹ç”¨ï¼‰ |
| å‚ä¸é—¨æ§› | é«˜ï¼ˆéœ€åˆ°åœºï¼‰ | ä½ï¼ˆç½‘ç»œå³å¯ï¼‰ |

### 1.2 æŠ•ç¥¨ç³»ç»Ÿçš„åº”ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šDAO æ²»ç†
```
ç”¨é€”ï¼šåè®®å‚æ•°è°ƒæ•´ã€èµ„é‡‘åˆ†é…ã€å‡çº§å†³ç­–
ç¤ºä¾‹ï¼š
- Aptos DAO æŠ•ç¥¨å†³å®šç½‘ç»œå‚æ•°
- DeFi åè®®æŠ•ç¥¨è°ƒæ•´æ‰‹ç»­è´¹ç‡
- Treasury èµ„é‡‘ä½¿ç”¨æŠ•ç¥¨
```

#### åœºæ™¯ 2ï¼šNFT ç¤¾åŒºæ²»ç†
```
ç”¨é€”ï¼šç¤¾åŒºæ´»åŠ¨ã€è‰ºæœ¯å“é€‰æ‹©ã€æ”¶ç›Šåˆ†é…
ç¤ºä¾‹ï¼š
- NFT æŒæœ‰è€…æŠ•ç¥¨å†³å®šä¸‹ä¸€æœŸè‰ºæœ¯é£æ ¼
- æŠ•ç¥¨å†³å®šç¤¾åŒºé‡‘åº“ä½¿ç”¨æ–¹å¼
- Roadmap ä¼˜å…ˆçº§æŠ•ç¥¨
```

#### åœºæ™¯ 3ï¼šé¡¹ç›®å†³ç­–
```
ç”¨é€”ï¼šåŠŸèƒ½å¼€å‘ã€åˆä½œä¼™ä¼´é€‰æ‹©ã€å“ç‰Œå†³ç­–
ç¤ºä¾‹ï¼š
- ä»£å¸æŒæœ‰è€…æŠ•ç¥¨å†³å®šæ–°åŠŸèƒ½
- æŠ•ç¥¨é€‰æ‹©é›†æˆçš„ç¬¬ä¸‰æ–¹åè®®
- ç¤¾åŒºæŠ•ç¥¨å†³å®šè¥é”€ç­–ç•¥
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ•ç¥¨ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ ¸å¿ƒç»„ä»¶

ä¸€ä¸ªå®Œæ•´çš„æŠ•ç¥¨ç³»ç»Ÿé€šå¸¸åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æŠ•ç¥¨ç³»ç»Ÿæ¶æ„               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ææ¡ˆç®¡ç† â”‚â”€â”€â”€â–¶â”‚ æŠ•ç¥¨æœºåˆ¶ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚               â”‚            â”‚
â”‚       â–¼               â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æƒé™æ§åˆ¶ â”‚    â”‚ ç»“æœç»Ÿè®¡ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚               â”‚            â”‚
â”‚       â–¼               â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ äº‹ä»¶æ—¥å¿— â”‚    â”‚ ææ¡ˆæ‰§è¡Œ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®ç»“æ„è®¾è®¡

#### ææ¡ˆï¼ˆProposalï¼‰

```move
struct Proposal has store, drop, copy {
    // åŸºæœ¬ä¿¡æ¯
    id: u64,                    // ææ¡ˆ ID
    title: String,              // ææ¡ˆæ ‡é¢˜
    description: String,        // ææ¡ˆæè¿°
    proposer: address,          // ææ¡ˆäºº
    
    // æ—¶é—´ä¿¡æ¯
    created_at: u64,            // åˆ›å»ºæ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰
    voting_start: u64,          // æŠ•ç¥¨å¼€å§‹æ—¶é—´
    voting_end: u64,            // æŠ•ç¥¨ç»“æŸæ—¶é—´
    
    // æŠ•ç¥¨ç»Ÿè®¡
    yes_votes: u64,             // èµæˆç¥¨æ•°
    no_votes: u64,              // åå¯¹ç¥¨æ•°
    abstain_votes: u64,         // å¼ƒæƒç¥¨æ•°
    
    // çŠ¶æ€
    status: u8,                 // 0=å¾…å®š, 1=æŠ•ç¥¨ä¸­, 2=é€šè¿‡, 3=å¦å†³, 4=å·²æ‰§è¡Œ
    
    // æ‰§è¡Œä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    executable: bool,           // æ˜¯å¦å¯æ‰§è¡Œ
    executed: bool,             // æ˜¯å¦å·²æ‰§è¡Œ
}
```

#### æŠ•ç¥¨è®°å½•ï¼ˆVoteï¼‰

```move
struct Vote has store, drop, copy {
    proposal_id: u64,           // å…³è”çš„ææ¡ˆ ID
    voter: address,             // æŠ•ç¥¨äººåœ°å€
    vote_type: u8,              // 0=åå¯¹, 1=èµæˆ, 2=å¼ƒæƒ
    voting_power: u64,          // æŠ•ç¥¨æƒé‡
    timestamp: u64,             // æŠ•ç¥¨æ—¶é—´
}
```

#### æ²»ç†é…ç½®ï¼ˆGovernanceConfigï¼‰

```move
struct GovernanceConfig has key {
    // æŠ•ç¥¨å‚æ•°
    min_voting_period: u64,     // æœ€å°æŠ•ç¥¨æœŸé™ï¼ˆç§’ï¼‰
    max_voting_period: u64,     // æœ€å¤§æŠ•ç¥¨æœŸé™
    min_proposal_threshold: u64, // ææ¡ˆé—¨æ§›ï¼ˆæœ€å°ä»£å¸æ•°ï¼‰
    quorum: u64,                // æ³•å®šç¥¨æ•°ï¼ˆç™¾åˆ†æ¯”ï¼Œå¦‚ 50 è¡¨ç¤º 50%ï¼‰
    
    // æƒé™
    admin: address,             // ç®¡ç†å‘˜åœ°å€
    
    // ç»Ÿè®¡
    total_proposals: u64,       // æ€»ææ¡ˆæ•°
    active_proposals: u64,      // æ´»è·ƒææ¡ˆæ•°
}
```

#### æŠ•ç¥¨ç³»ç»ŸçŠ¶æ€ï¼ˆVotingSystemï¼‰

```move
struct VotingSystem has key {
    proposals: SmartTable<u64, Proposal>,       // æ‰€æœ‰ææ¡ˆ
    votes: Table<u64, Table<address, Vote>>,    // æŠ•ç¥¨è®°å½•ï¼ˆææ¡ˆID -> åœ°å€ -> æŠ•ç¥¨ï¼‰
    voter_proposals: Table<address, vector<u64>>, // ç”¨æˆ·æŠ•ç¥¨çš„ææ¡ˆåˆ—è¡¨
    config: GovernanceConfig,                   // æ²»ç†é…ç½®
}
```

### 2.3 çŠ¶æ€è½¬æ¢å›¾

```
ææ¡ˆç”Ÿå‘½å‘¨æœŸï¼š

    åˆ›å»º
     â”‚
     â–¼
  â”Œâ”€â”€â”€â”€â”€â”
  â”‚å¾…å®š â”‚ Pending
  â””â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ æŠ•ç¥¨å¼€å§‹æ—¶é—´åˆ°è¾¾
     â–¼
  â”Œâ”€â”€â”€â”€â”€â”
  â”‚æ´»è·ƒ â”‚ Active (å¯ä»¥æŠ•ç¥¨)
  â””â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ æŠ•ç¥¨ç»“æŸæ—¶é—´åˆ°è¾¾
     â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ç»Ÿè®¡ç»“æœ  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚          â”‚
     â–¼          â–¼
  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
  â”‚é€šè¿‡ â”‚  â”‚å¦å†³ â”‚
  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ (å¦‚æœå¯æ‰§è¡Œ)
     â–¼
  â”Œâ”€â”€â”€â”€â”€â”
  â”‚å·²æ‰§è¡Œâ”‚
  â””â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°

### 3.1 åˆ›å»ºææ¡ˆ

**æµç¨‹**ï¼š
1. éªŒè¯ææ¡ˆäººæƒé™ï¼ˆæŒæœ‰è¶³å¤Ÿä»£å¸/æ˜¯ç®¡ç†å‘˜ï¼‰
2. éªŒè¯æŠ•ç¥¨æœŸé™åˆæ³•æ€§
3. åˆ›å»ºææ¡ˆå¯¹è±¡
4. å­˜å‚¨åˆ°å…¨å±€çŠ¶æ€
5. å‘å°„åˆ›å»ºäº‹ä»¶

**å…³é”®æ£€æŸ¥**ï¼š
```move
// æ£€æŸ¥æŠ•ç¥¨æœŸé™
assert!(voting_period >= config.min_voting_period, ERROR_VOTING_PERIOD_TOO_SHORT);
assert!(voting_period <= config.max_voting_period, ERROR_VOTING_PERIOD_TOO_LONG);

// æ£€æŸ¥ææ¡ˆæƒé™
assert!(has_proposal_permission(proposer), ERROR_INSUFFICIENT_PERMISSION);
```

### 3.2 æŠ•ç¥¨

**æµç¨‹**ï¼š
1. éªŒè¯ææ¡ˆå­˜åœ¨ä¸”å¤„äºæ´»è·ƒçŠ¶æ€
2. æ£€æŸ¥æŠ•ç¥¨äººæ˜¯å¦å·²æŠ•ç¥¨
3. è®¡ç®—æŠ•ç¥¨æƒé‡
4. è®°å½•æŠ•ç¥¨
5. æ›´æ–°ææ¡ˆç»Ÿè®¡
6. å‘å°„æŠ•ç¥¨äº‹ä»¶

**æŠ•ç¥¨ç±»å‹**ï¼š
```move
const VOTE_NO: u8 = 0;      // åå¯¹
const VOTE_YES: u8 = 1;     // èµæˆ
const VOTE_ABSTAIN: u8 = 2; // å¼ƒæƒ
```

**å…³é”®æ£€æŸ¥**ï¼š
```move
// æ£€æŸ¥ææ¡ˆçŠ¶æ€
assert!(proposal.status == STATUS_ACTIVE, ERROR_PROPOSAL_NOT_ACTIVE);

// æ£€æŸ¥æŠ•ç¥¨æ—¶é—´
let now = timestamp::now_seconds();
assert!(now >= proposal.voting_start, ERROR_VOTING_NOT_STARTED);
assert!(now < proposal.voting_end, ERROR_VOTING_ENDED);

// æ£€æŸ¥é‡å¤æŠ•ç¥¨
assert!(!has_voted(proposal_id, voter), ERROR_ALREADY_VOTED);
```

### 3.3 ç»Ÿè®¡ç»“æœ

**åˆ¤æ–­æ ‡å‡†**ï¼š
1. **æ³•å®šäººæ•°ï¼ˆQuorumï¼‰**ï¼šå‚ä¸æŠ•ç¥¨çš„æ€»ç¥¨æ•°å¿…é¡»è¾¾åˆ°ä¸€å®šæ¯”ä¾‹
2. **é€šè¿‡æ¯”ä¾‹**ï¼šèµæˆç¥¨å æ¯”å¿…é¡»è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 50%ï¼‰

```move
// è®¡ç®—æ€»ç¥¨æ•°
let total_votes = proposal.yes_votes + proposal.no_votes + proposal.abstain_votes;

// æ£€æŸ¥æ³•å®šäººæ•°ï¼ˆå‡è®¾æ€»ä¾›åº”é‡ä¸º total_supplyï¼‰
let quorum_threshold = (total_supply * config.quorum) / 100;
assert!(total_votes >= quorum_threshold, ERROR_QUORUM_NOT_REACHED);

// åˆ¤æ–­æ˜¯å¦é€šè¿‡ï¼ˆç®€å•å¤šæ•°ï¼‰
let passed = proposal.yes_votes > proposal.no_votes;
```

### 3.4 æ‰§è¡Œææ¡ˆ

**æµç¨‹**ï¼š
1. éªŒè¯ææ¡ˆå·²é€šè¿‡
2. éªŒè¯ææ¡ˆå¯æ‰§è¡Œ
3. éªŒè¯æœªè¢«æ‰§è¡Œè¿‡
4. æ‰§è¡Œé“¾ä¸Šæ“ä½œ
5. æ ‡è®°ä¸ºå·²æ‰§è¡Œ
6. å‘å°„æ‰§è¡Œäº‹ä»¶

**å¯æ‰§è¡Œææ¡ˆç¤ºä¾‹**ï¼š
```move
// ç¤ºä¾‹ï¼šä¿®æ”¹æ²»ç†å‚æ•°
struct ExecutableProposal has store {
    proposal_id: u64,
    action_type: u8,        // 0=ä¿®æ”¹å‚æ•°, 1=è½¬è´¦, 2=å‡çº§
    target: address,
    data: vector<u8>,       // æ‰§è¡Œæ•°æ®
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šæŠ•ç¥¨æƒé‡æœºåˆ¶

### 4.1 ç®€å•æŠ•ç¥¨ï¼ˆä¸€äººä¸€ç¥¨ï¼‰

æœ€ç®€å•çš„æ¨¡å¼ï¼Œæ¯ä¸ªåœ°å€ä¸€ç¥¨ï¼š

```move
fun get_voting_power(voter: address): u64 {
    1  // æ¯ä¸ªåœ°å€å›ºå®š 1 ç¥¨
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ã€å…¬å¹³
**ç¼ºç‚¹**ï¼šå¯èƒ½è¢«å¥³å·«æ”»å‡»ï¼ˆåˆ›å»ºå¤šä¸ªåœ°å€ï¼‰

### 4.2 åŸºäºä»£å¸çš„æŠ•ç¥¨æƒ

æ ¹æ®æŒæœ‰ä»£å¸æ•°é‡å†³å®šæŠ•ç¥¨æƒï¼š

```move
fun get_voting_power(voter: address): u64 acquires TokenBalances {
    let balance = coin::balance<GovernanceToken>(voter);
    balance  // æŒæœ‰çš„ä»£å¸æ•°é‡ = æŠ•ç¥¨æƒ
}
```

**ä¼˜ç‚¹**ï¼šä¸åˆ©ç›Šç›¸å…³ã€é˜²æ­¢å¥³å·«æ”»å‡»
**ç¼ºç‚¹**ï¼šå¤§æˆ·æ§åˆ¶é£é™©

### 4.3 äºŒæ¬¡æ–¹æŠ•ç¥¨ï¼ˆQuadratic Votingï¼‰

æŠ•ç¥¨æˆæœ¬éšç¥¨æ•°å¹³æ–¹å¢é•¿ï¼š

```move
fun calculate_quadratic_cost(votes: u64): u64 {
    votes * votes  // æŠ• n ç¥¨éœ€è¦ nÂ² ä»£å¸
}
```

**ç¤ºä¾‹**ï¼š
- æŠ• 1 ç¥¨ â†’ æ¶ˆè€— 1 ä»£å¸
- æŠ• 2 ç¥¨ â†’ æ¶ˆè€— 4 ä»£å¸
- æŠ• 3 ç¥¨ â†’ æ¶ˆè€— 9 ä»£å¸

**ä¼˜ç‚¹**ï¼šå¹³è¡¡å¤§æˆ·å’Œæ•£æˆ·çš„å½±å“åŠ›
**ç¼ºç‚¹**ï¼šå®ç°å¤æ‚ã€ç”¨æˆ·ç†è§£æˆæœ¬é«˜

### 4.4 æ—¶é—´åŠ æƒæŠ•ç¥¨

æ ¹æ®æŒå¸æ—¶é—´å¢åŠ æƒé‡ï¼š

```move
struct TimeWeightedBalance has store {
    amount: u64,
    locked_since: u64,
}

fun get_time_weighted_power(voter: address): u64 acquires TimeWeightedBalance {
    let balance = borrow_global<TimeWeightedBalance>(voter);
    let now = timestamp::now_seconds();
    let lock_duration = now - balance.locked_since;
    
    // æ¯é”å®š 1 å¤©å¢åŠ  1% æƒé‡ï¼ˆæœ€å¤š 100%ï¼‰
    let bonus = min(lock_duration / 86400, 100);  // 86400 ç§’ = 1 å¤©
    balance.amount * (100 + bonus) / 100
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®‰å…¨è€ƒè™‘

### 5.1 é˜²æ­¢é‡å¤æŠ•ç¥¨

**æ–¹æ³• 1ï¼šä½¿ç”¨ Table è®°å½•**
```move
struct VoteRecords has key {
    records: Table<u64, Table<address, bool>>,  // ææ¡ˆID -> åœ°å€ -> æ˜¯å¦å·²æŠ•ç¥¨
}

fun has_voted(proposal_id: u64, voter: address): bool acquires VoteRecords {
    let records = borrow_global<VoteRecords>(@module_addr);
    if (table::contains(&records.records, proposal_id)) {
        let proposal_votes = table::borrow(&records.records, proposal_id);
        table::contains(proposal_votes, voter)
    } else {
        false
    }
}
```

**æ–¹æ³• 2ï¼šä½¿ç”¨èµ„æºæ ‡è®°**
```move
struct VoteReceipt has key {
    proposal_id: u64,
    voter: address,
}

// æŠ•ç¥¨æ—¶åˆ›å»º receipt
move_to(voter, VoteReceipt { proposal_id, voter });

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
exists<VoteReceipt>(voter)
```

### 5.2 æ—¶é—´æ“çºµé˜²æŠ¤

**é—®é¢˜**ï¼šæ¶æ„èŠ‚ç‚¹å¯èƒ½æ“çºµåŒºå—æ—¶é—´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨åŒºå—é«˜åº¦è€Œéæ—¶é—´æˆ³ï¼ˆæ›´å®‰å…¨ä½†ä¸å¤Ÿç›´è§‚ï¼‰
2. è®¾ç½®åˆç†çš„æ—¶é—´çª—å£ï¼ˆé¿å…æç«¯å€¼ï¼‰
3. ä½¿ç”¨æ—¶é—´é”å»¶è¿Ÿæ‰§è¡Œ

```move
const MIN_DELAY: u64 = 86400;  // è‡³å°‘ 1 å¤©å»¶è¿Ÿ

assert!(
    proposal.voting_end + MIN_DELAY < timestamp::now_seconds(),
    ERROR_EXECUTION_TOO_EARLY
);
```

### 5.3 é—ªç”µè´·æ”»å‡»é˜²æŠ¤

**é—®é¢˜**ï¼šæ”»å‡»è€…å¯èƒ½é€šè¿‡é—ªç”µè´·ä¸´æ—¶è·å¾—å¤§é‡ä»£å¸è¿›è¡ŒæŠ•ç¥¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **å¿«ç…§æœºåˆ¶**ï¼šåœ¨ææ¡ˆåˆ›å»ºæ—¶è®°å½•ä»£å¸ä½™é¢
2. **é”å®šæœŸ**ï¼šæŠ•ç¥¨çš„ä»£å¸éœ€è¦é”å®šä¸€æ®µæ—¶é—´
3. **æœ€å°æŒæœ‰æ—¶é—´**ï¼šè¦æ±‚ä»£å¸æŒæœ‰ä¸€å®šæ—¶é—´æ‰æœ‰æŠ•ç¥¨æƒ

```move
struct VotingSnapshot has store {
    proposal_id: u64,
    snapshot_time: u64,
    balances: Table<address, u64>,  // å¿«ç…§æ—¶çš„ä½™é¢
}

fun create_snapshot(proposal_id: u64): VotingSnapshot {
    // è®°å½•å½“å‰æ‰€æœ‰æŒå¸è€…çš„ä½™é¢
    // æŠ•ç¥¨æ—¶ä½¿ç”¨å¿«ç…§ä½™é¢è€Œéå®æ—¶ä½™é¢
}
```

### 5.4 æƒé™æ§åˆ¶

```move
// åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œç‰¹å®šæ“ä½œ
fun assert_admin(caller: address) acquires GovernanceConfig {
    let config = borrow_global<GovernanceConfig>(@module_addr);
    assert!(caller == config.admin, ERROR_NOT_ADMIN);
}

// åªæœ‰ææ¡ˆäººå¯ä»¥å–æ¶ˆææ¡ˆ
fun assert_proposer(proposal_id: u64, caller: address) acquires VotingSystem {
    let system = borrow_global<VotingSystem>(@module_addr);
    let proposal = smart_table::borrow(&system.proposals, proposal_id);
    assert!(caller == proposal.proposer, ERROR_NOT_PROPOSER);
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šäº‹ä»¶ç³»ç»Ÿ

### 6.1 äº‹ä»¶å®šä¹‰

```move
struct ProposalCreatedEvent has drop, store {
    proposal_id: u64,
    proposer: address,
    title: String,
    voting_end: u64,
}

struct VoteCastEvent has drop, store {
    proposal_id: u64,
    voter: address,
    vote_type: u8,
    voting_power: u64,
}

struct ProposalExecutedEvent has drop, store {
    proposal_id: u64,
    executor: address,
    success: bool,
}

struct GovernanceEvents has key {
    proposal_created_events: EventHandle<ProposalCreatedEvent>,
    vote_cast_events: EventHandle<VoteCastEvent>,
    proposal_executed_events: EventHandle<ProposalExecutedEvent>,
}
```

### 6.2 å‘å°„äº‹ä»¶

```move
use aptos_framework::event;

public fun create_proposal(...) acquires GovernanceEvents {
    // ... åˆ›å»ºææ¡ˆé€»è¾‘ ...
    
    // å‘å°„äº‹ä»¶
    let events = borrow_global_mut<GovernanceEvents>(@module_addr);
    event::emit_event(
        &mut events.proposal_created_events,
        ProposalCreatedEvent {
            proposal_id,
            proposer,
            title,
            voting_end,
        }
    );
}
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šGas ä¼˜åŒ–

### 7.1 æ‰¹é‡æ“ä½œ

å¦‚æœéœ€è¦å¤„ç†å¤šä¸ªææ¡ˆ/æŠ•ç¥¨ï¼Œä½¿ç”¨æ‰¹é‡æ“ä½œï¼š

```move
// âŒ ä¸å¥½ï¼šé€ä¸ªå¤„ç†
public fun vote_on_multiple(proposal_ids: vector<u64>, vote_types: vector<u8>) {
    let i = 0;
    while (i < vector::length(&proposal_ids)) {
        vote(*vector::borrow(&proposal_ids, i), *vector::borrow(&vote_types, i));
        i = i + 1;
    };
}

// âœ… æ›´å¥½ï¼šæ‰¹é‡éªŒè¯åä¸€æ¬¡æ€§å¤„ç†
public fun vote_on_multiple_optimized(...) {
    // å…ˆæ‰¹é‡éªŒè¯
    verify_all_proposals(&proposal_ids);
    verify_not_voted(&proposal_ids, voter);
    
    // å†æ‰¹é‡å¤„ç†ï¼ˆå‡å°‘çŠ¶æ€è®¿é—®æ¬¡æ•°ï¼‰
    let system = borrow_global_mut<VotingSystem>(@module_addr);
    // ... æ‰¹é‡æ›´æ–° ...
}
```

### 7.2 ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„

```move
// å°æ•°æ®é‡ï¼ˆ< 100 ä¸ªææ¡ˆï¼‰ï¼šä½¿ç”¨ vector
proposals: vector<Proposal>

// å¤§æ•°æ®é‡ä¸”éœ€è¦è¿­ä»£ï¼šä½¿ç”¨ SmartTable
proposals: SmartTable<u64, Proposal>

// å¤§æ•°æ®é‡åªéœ€éšæœºè®¿é—®ï¼šä½¿ç”¨ Table
proposals: Table<u64, Proposal>
```

### 7.3 å»¶è¿Ÿè®¡ç®—

```move
// âŒ ä¸å¥½ï¼šæ¯æ¬¡æŠ•ç¥¨éƒ½è®¡ç®—æ€»æ•°
public fun vote(...) {
    // ...
    let total = calculate_total_votes(proposal_id);  // æ¯æ¬¡éƒ½éå†
}

// âœ… å¥½ï¼šç»´æŠ¤ç´¯è®¡å€¼
struct Proposal has store {
    // ...
    yes_votes: u64,   // ç›´æ¥ç´¯åŠ 
    no_votes: u64,
    abstain_votes: u64,
}
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šå®æˆ˜æ¨¡å¼

### 8.1 å§”æ‰˜æŠ•ç¥¨ï¼ˆDelegationï¼‰

å…è®¸ç”¨æˆ·å°†æŠ•ç¥¨æƒå§”æ‰˜ç»™ä»–äººï¼š

```move
struct Delegation has key {
    delegates: Table<address, address>,  // å§”æ‰˜äºº -> å—æ‰˜äºº
}

public fun delegate_vote(delegator: &signer, delegate_to: address) acquires Delegation {
    let delegator_addr = signer::address_of(delegator);
    let delegations = borrow_global_mut<Delegation>(@module_addr);
    table::upsert(&mut delegations.delegates, delegator_addr, delegate_to);
}

fun get_effective_voter(voter: address): address acquires Delegation {
    let delegations = borrow_global<Delegation>(@module_addr);
    if (table::contains(&delegations.delegates, voter)) {
        *table::borrow(&delegations.delegates, voter)
    } else {
        voter
    }
}
```

### 8.2 ææ¡ˆå–æ¶ˆ

å…è®¸ææ¡ˆäººåœ¨æŠ•ç¥¨å¼€å§‹å‰å–æ¶ˆææ¡ˆï¼š

```move
public fun cancel_proposal(proposer: &signer, proposal_id: u64) acquires VotingSystem {
    let proposer_addr = signer::address_of(proposer);
    let system = borrow_global_mut<VotingSystem>(@module_addr);
    let proposal = smart_table::borrow_mut(&mut system.proposals, proposal_id);
    
    // éªŒè¯æƒé™
    assert!(proposal.proposer == proposer_addr, ERROR_NOT_PROPOSER);
    
    // éªŒè¯çŠ¶æ€ï¼ˆåªèƒ½å–æ¶ˆå¾…å®šçŠ¶æ€çš„ææ¡ˆï¼‰
    assert!(proposal.status == STATUS_PENDING, ERROR_CANNOT_CANCEL);
    
    // æ›´æ–°çŠ¶æ€
    proposal.status = STATUS_CANCELLED;
}
```

### 8.3 ç´§æ€¥æš‚åœ

å…è®¸ç®¡ç†å‘˜åœ¨ç´§æ€¥æƒ…å†µä¸‹æš‚åœæŠ•ç¥¨ï¼š

```move
struct EmergencyControl has key {
    paused: bool,
    admin: address,
}

public fun pause(admin: &signer) acquires EmergencyControl {
    let control = borrow_global_mut<EmergencyControl>(@module_addr);
    assert!(signer::address_of(admin) == control.admin, ERROR_NOT_ADMIN);
    control.paused = true;
}

fun assert_not_paused() acquires EmergencyControl {
    let control = borrow_global<EmergencyControl>(@module_addr);
    assert!(!control.paused, ERROR_SYSTEM_PAUSED);
}
```

---

## ğŸ’¡ å…³é”®è¦ç‚¹æ€»ç»“

### æ¶æ„è®¾è®¡
- âœ… æ¸…æ™°çš„çŠ¶æ€è½¬æ¢
- âœ… åˆç†çš„æƒé™æ§åˆ¶
- âœ… å®Œå–„çš„äº‹ä»¶ç³»ç»Ÿ

### å®‰å…¨æ€§
- âœ… é˜²æ­¢é‡å¤æŠ•ç¥¨
- âœ… é˜²æ­¢æ—¶é—´æ“çºµ
- âœ… é˜²æ­¢é—ªç”µè´·æ”»å‡»
- âœ… ä¸¥æ ¼çš„æƒé™éªŒè¯

### æ€§èƒ½ä¼˜åŒ–
- âœ… é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„
- âœ… æ‰¹é‡æ“ä½œ
- âœ… å»¶è¿Ÿè®¡ç®—

### ç”¨æˆ·ä½“éªŒ
- âœ… æ¸…æ™°çš„æŠ•ç¥¨æµç¨‹
- âœ… å®Œæ•´çš„äº‹ä»¶è®°å½•
- âœ… çµæ´»çš„æŠ•ç¥¨æœºåˆ¶

---

## ğŸ¯ è®¾è®¡æ£€æŸ¥æ¸…å•

åœ¨å®ç°æŠ•ç¥¨ç³»ç»Ÿå‰ï¼Œç¡®è®¤ä»¥ä¸‹é—®é¢˜ï¼š

**åŸºç¡€åŠŸèƒ½**
- [ ] ææ¡ˆå¦‚ä½•åˆ›å»ºï¼Ÿè°æœ‰æƒé™ï¼Ÿ
- [ ] æŠ•ç¥¨æœŸé™å¦‚ä½•è®¾å®šï¼Ÿ
- [ ] æ”¯æŒå“ªäº›æŠ•ç¥¨ç±»å‹ï¼Ÿ
- [ ] å¦‚ä½•ç»Ÿè®¡ç»“æœï¼Ÿ

**æŠ•ç¥¨æƒé‡**
- [ ] ä½¿ç”¨å“ªç§æŠ•ç¥¨æƒé‡æœºåˆ¶ï¼Ÿ
- [ ] å¦‚ä½•é˜²æ­¢é—ªç”µè´·æ”»å‡»ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦é”å®šä»£å¸ï¼Ÿ

**å®‰å…¨æ€§**
- [ ] å¦‚ä½•é˜²æ­¢é‡å¤æŠ•ç¥¨ï¼Ÿ
- [ ] å¦‚ä½•é˜²æ­¢æ—¶é—´æ“çºµï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ç´§æ€¥æš‚åœåŠŸèƒ½ï¼Ÿ

**å¯æ‰©å±•æ€§**
- [ ] å¦‚ä½•æ”¯æŒä¸åŒç±»å‹çš„ææ¡ˆï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦å§”æ‰˜æŠ•ç¥¨ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ææ¡ˆå–æ¶ˆåŠŸèƒ½ï¼Ÿ

**Gas ä¼˜åŒ–**
- [ ] ä½¿ç”¨äº†åˆé€‚çš„æ•°æ®ç»“æ„å—ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ä¸å¿…è¦çš„é‡å¤è®¡ç®—ï¼Ÿ
- [ ] æ‰¹é‡æ“ä½œæ˜¯å¦ä¼˜åŒ–ï¼Ÿ

---

**ä¸‹ä¸€æ­¥**ï¼šé˜…è¯»ä»£ç ç¤ºä¾‹ï¼Œç„¶åå¼€å§‹å®ç°ä½ çš„æŠ•ç¥¨ç³»ç»Ÿï¼ğŸš€
