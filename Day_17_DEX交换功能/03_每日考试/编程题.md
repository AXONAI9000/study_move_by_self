# Day 17 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

**è€ƒè¯•æ—¶é—´**ï¼š30 åˆ†é’Ÿ  
**é¢˜ç›®æ•°é‡**ï¼š3 é¢˜  
**æ€»åˆ†**ï¼š60 åˆ†  
**åŠæ ¼åˆ†æ•°**ï¼š42 åˆ†ï¼ˆ70%ï¼‰

---

## ğŸ“ ç­”é¢˜è¯´æ˜

1. åœ¨ `sources/` ç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„ `.move` æ–‡ä»¶
2. å®ç°è¦æ±‚çš„æ‰€æœ‰å‡½æ•°
3. ç¡®ä¿ä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡
4. ç¼–å†™æµ‹è¯•éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§
5. å®Œæˆåå¯¹ç…§ç­”æ¡ˆè§£æè¯„åˆ†

---

## ç¼–ç¨‹é¢˜ 1ï¼šå®ç°å¸¦æ‰‹ç»­è´¹çš„è¾“å‡ºè®¡ç®—ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—ç»™å®šè¾“å…¥æ•°é‡åèƒ½è·å¾—çš„è¾“å‡ºæ•°é‡ï¼ˆè€ƒè™‘æ‰‹ç»­è´¹ï¼‰ã€‚

### è¦æ±‚

åœ¨ `sources/swap_calculator.move` ä¸­å®ç°ä»¥ä¸‹å‡½æ•°ï¼š

```move
module swap_addr::swap_calculator {
    /// è®¡ç®—å¸¦æ‰‹ç»­è´¹çš„è¾“å‡ºæ•°é‡
    /// 
    /// # å‚æ•°
    /// - amount_in: è¾“å…¥ä»£å¸æ•°é‡
    /// - reserve_in: è¾“å…¥ä»£å¸å‚¨å¤‡
    /// - reserve_out: è¾“å‡ºä»£å¸å‚¨å¤‡
    /// 
    /// # è¿”å›
    /// è¾“å‡ºä»£å¸æ•°é‡
    /// 
    /// # å…¬å¼
    /// amount_in_with_fee = amount_in * 997 / 1000
    /// amount_out = (reserve_out * amount_in_with_fee) / (reserve_in + amount_in_with_fee)
    public fun get_amount_out(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64,
    ): u64 {
        // TODO: å®ç°æ­¤å‡½æ•°
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

ä½ çš„å®ç°åº”è¯¥é€šè¿‡ä»¥ä¸‹æµ‹è¯•ï¼š

```move
#[test]
fun test_get_amount_out_basic() {
    // æ± å­ï¼š1,000,000 USDC / 50,000 APT
    // è¾“å…¥ï¼š10,000 USDC
    // é¢„æœŸè¾“å‡ºï¼š~493.58 APT
    let amount_out = get_amount_out(10000, 1000000, 50000);
    assert!(amount_out >= 493 && amount_out <= 494, 0);
}

#[test]
fun test_get_amount_out_small() {
    // å°é¢äº¤æ˜“
    let amount_out = get_amount_out(100, 1000000, 50000);
    assert!(amount_out == 4, 0); // çº¦ 4.985ï¼Œå‘ä¸‹å–æ•´ä¸º 4
}

#[test]
fun test_get_amount_out_large() {
    // å¤§é¢äº¤æ˜“ï¼ˆ50% of reserveï¼‰
    let amount_out = get_amount_out(500000, 1000000, 50000);
    assert!(amount_out >= 16600 && amount_out <= 16700, 0);
}

#[test]
#[expected_failure]
fun test_get_amount_out_zero_reserve() {
    // å‚¨å¤‡ä¸ºé›¶åº”è¯¥å¤±è´¥
    get_amount_out(100, 0, 50000);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ20åˆ†ï¼‰

- **åŸºç¡€å®ç°ï¼ˆ10åˆ†ï¼‰**ï¼šæ­£ç¡®å®ç°å…¬å¼
- **ç²¾åº¦å¤„ç†ï¼ˆ5åˆ†ï¼‰**ï¼šä½¿ç”¨ u128 é¿å…æº¢å‡º
- **é”™è¯¯æ£€æŸ¥ï¼ˆ3åˆ†ï¼‰**ï¼šéªŒè¯å‚æ•°æœ‰æ•ˆæ€§
- **æµ‹è¯•é€šè¿‡ï¼ˆ2åˆ†ï¼‰**ï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

---

## ç¼–ç¨‹é¢˜ 2ï¼šå®ç°å®Œæ•´çš„ Swap å‡½æ•°ï¼ˆ25åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå®Œæ•´çš„ `swap_exact_input` å‡½æ•°ï¼ŒåŒ…æ‹¬æ»‘ç‚¹ä¿æŠ¤ã€K å€¼éªŒè¯å’Œäº‹ä»¶å‘å°„ã€‚

### è¦æ±‚

åœ¨ `sources/simple_swap.move` ä¸­å®ç°ï¼š

```move
module swap_addr::simple_swap {
    use std::signer;
    use aptos_framework::coin::{Self, Coin};
    
    /// é”™è¯¯ç 
    const ERROR_ZERO_AMOUNT: u64 = 1;
    const ERROR_INSUFFICIENT_LIQUIDITY: u64 = 2;
    const ERROR_SLIPPAGE_EXCEEDED: u64 = 3;
    const ERROR_K_INVARIANT: u64 = 4;
    
    /// æ‰‹ç»­è´¹ç‡ï¼ˆ30 åŸºç‚¹ = 0.3%ï¼‰
    const FEE_RATE: u64 = 30;
    const FEE_DENOMINATOR: u64 = 10000;
    
    /// ç®€åŒ–çš„æµåŠ¨æ€§æ± 
    struct Pool<phantom X, phantom Y> has key {
        reserve_x: Coin<X>,
        reserve_y: Coin<Y>,
    }
    
    /// ç²¾ç¡®è¾“å…¥äº¤æ¢
    /// 
    /// # å‚æ•°
    /// - user: ç”¨æˆ·è´¦æˆ·
    /// - amount_in: è¾“å…¥æ•°é‡
    /// - min_amount_out: æœ€å°è¾“å‡ºæ•°é‡ï¼ˆæ»‘ç‚¹ä¿æŠ¤ï¼‰
    /// 
    /// # ä¸­æ­¢æ¡ä»¶
    /// - amount_in == 0
    /// - æ± å­ä¸å­˜åœ¨
    /// - å‚¨å¤‡ä¸è¶³
    /// - è¾“å‡º < min_amount_out
    /// - K å€¼å‡å°‘
    public entry fun swap_exact_input<X, Y>(
        user: &signer,
        amount_in: u64,
        min_amount_out: u64,
    ) acquires Pool {
        // TODO: å®ç°å®Œæ•´çš„ Swap é€»è¾‘
        // 1. å‚æ•°éªŒè¯
        // 2. è®¡ç®—è¾“å‡º
        // 3. æ»‘ç‚¹æ£€æŸ¥
        // 4. è½¬ç§»ä»£å¸
        // 5. æ›´æ–°å‚¨å¤‡
        // 6. K å€¼éªŒè¯
    }
    
    /// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—è¾“å‡º
    fun calculate_amount_out(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64,
    ): u64 {
        // TODO: å®ç°
    }
    
    /// è¾…åŠ©å‡½æ•°ï¼šéªŒè¯ K å€¼
    fun verify_k_invariant<X, Y>(
        old_reserve_in: u64,
        old_reserve_out: u64,
    ) acquires Pool {
        // TODO: å®ç°
    }
}
```

### æµ‹è¯•åœºæ™¯

```move
#[test(user = @0x123, swap_addr = @swap_addr)]
fun test_swap_exact_input_success(user: &signer, swap_addr: &signer) {
    // 1. åˆå§‹åŒ–æ± å­ï¼š100,000 USDC / 5,000 APT
    // 2. ç»™ç”¨æˆ· 10,000 USDC
    // 3. æ‰§è¡Œ swapï¼š10,000 USDC â†’ APT
    // 4. éªŒè¯ç”¨æˆ·æ”¶åˆ°çº¦ 454 APT
    // 5. éªŒè¯æ± å­å‚¨å¤‡æ­£ç¡®æ›´æ–°
    // 6. éªŒè¯ K å€¼å¢åŠ 
}

#[test(user = @0x123)]
#[expected_failure(abort_code = ERROR_SLIPPAGE_EXCEEDED)]
fun test_swap_slippage_protection(user: &signer) {
    // è®¾ç½® min_amount_out = 500
    // å®é™…è¾“å‡ºåªæœ‰ 454
    // åº”è¯¥å¤±è´¥
}

#[test(user = @0x123)]
#[expected_failure(abort_code = ERROR_ZERO_AMOUNT)]
fun test_swap_zero_amount(user: &signer) {
    swap_exact_input<USDC, APT>(user, 0, 0);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ25åˆ†ï¼‰

- **å‚æ•°éªŒè¯ï¼ˆ5åˆ†ï¼‰**ï¼šå®Œæ•´çš„é”™è¯¯æ£€æŸ¥
- **è¾“å‡ºè®¡ç®—ï¼ˆ8åˆ†ï¼‰**ï¼šæ­£ç¡®ä½¿ç”¨å¸¦æ‰‹ç»­è´¹çš„å…¬å¼
- **ä»£å¸è½¬ç§»ï¼ˆ5åˆ†ï¼‰**ï¼šæ­£ç¡®çš„ withdraw å’Œ deposit
- **K å€¼éªŒè¯ï¼ˆ4åˆ†ï¼‰**ï¼šç¡®ä¿ K å€¼ä¸å‡å°‘
- **æµ‹è¯•é€šè¿‡ï¼ˆ3åˆ†ï¼‰**ï¼šæ‰€æœ‰åœºæ™¯é€šè¿‡

---

## ç¼–ç¨‹é¢˜ 3ï¼šå®ç°ä»·æ ¼å½±å“è®¡ç®—å™¨ï¼ˆ15åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå·¥å…·ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨äº¤æ˜“å‰äº†è§£ä»·æ ¼å½±å“ã€‚

### è¦æ±‚

åœ¨ `sources/price_calculator.move` ä¸­å®ç°ï¼š

```move
module swap_addr::price_calculator {
    
    /// ä»·æ ¼å½±å“ä¿¡æ¯
    struct PriceImpact has drop {
        price_before: u64,      // äº¤æ˜“å‰ä»·æ ¼ï¼ˆ8ä½å°æ•°ï¼‰
        price_after: u64,       // äº¤æ˜“åä»·æ ¼ï¼ˆ8ä½å°æ•°ï¼‰
        impact_bps: u64,        // å½±å“ï¼ˆåŸºç‚¹ï¼Œ100 = 1%ï¼‰
        amount_out: u64,        // è¾“å‡ºæ•°é‡
    }
    
    /// è®¡ç®—å®Œæ•´çš„ä»·æ ¼å½±å“ä¿¡æ¯
    /// 
    /// # å‚æ•°
    /// - amount_in: è¾“å…¥æ•°é‡
    /// - reserve_in: è¾“å…¥ä»£å¸å‚¨å¤‡
    /// - reserve_out: è¾“å‡ºä»£å¸å‚¨å¤‡
    /// 
    /// # è¿”å›
    /// PriceImpact ç»“æ„ä½“
    public fun calculate_price_impact(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64,
    ): PriceImpact {
        // TODO: å®ç°
        // 1. è®¡ç®—äº¤æ˜“å‰ä»·æ ¼
        // 2. è®¡ç®—è¾“å‡ºæ•°é‡
        // 3. è®¡ç®—äº¤æ˜“åä»·æ ¼
        // 4. è®¡ç®—ä»·æ ¼å½±å“ç™¾åˆ†æ¯”
    }
    
    /// æ¨èæ»‘ç‚¹è®¾ç½®
    /// è¿”å›å»ºè®®çš„ min_amount_out
    public fun recommend_slippage(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64,
    ): u64 {
        // TODO: å®ç°
        // æ ¹æ®ä»·æ ¼å½±å“æ¨èåˆç†çš„æ»‘ç‚¹
        // - å½±å“ < 1%: 0.5% æ»‘ç‚¹
        // - å½±å“ 1-5%: 1% æ»‘ç‚¹
        // - å½±å“ 5-10%: 2% æ»‘ç‚¹
        // - å½±å“ > 10%: 5% æ»‘ç‚¹
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test]
fun test_price_impact_small_trade() {
    // æ± å­ï¼š1,000,000 / 50,000
    // è¾“å…¥ï¼š1,000ï¼ˆ0.1% of reserveï¼‰
    let impact = calculate_price_impact(1000, 1000000, 50000);
    
    // ä»·æ ¼å½±å“åº”è¯¥å¾ˆå°ï¼ˆ< 0.5%ï¼‰
    assert!(impact.impact_bps < 50, 0);
}

#[test]
fun test_price_impact_large_trade() {
    // è¾“å…¥ï¼š100,000ï¼ˆ10% of reserveï¼‰
    let impact = calculate_price_impact(100000, 1000000, 50000);
    
    // ä»·æ ¼å½±å“åº”è¯¥æ˜¾è‘—ï¼ˆ> 5%ï¼‰
    assert!(impact.impact_bps > 500, 0);
}

#[test]
fun test_recommend_slippage() {
    // å°é¢äº¤æ˜“æ¨è 0.5% æ»‘ç‚¹
    let min_out = recommend_slippage(1000, 1000000, 50000);
    let expected_out = get_amount_out(1000, 1000000, 50000);
    
    // min_out åº”è¯¥æ˜¯ expected_out * 99.5%
    assert!(min_out >= expected_out * 995 / 1000, 0);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ15åˆ†ï¼‰

- **ä»·æ ¼è®¡ç®—ï¼ˆ6åˆ†ï¼‰**ï¼šæ­£ç¡®è®¡ç®—äº¤æ˜“å‰åä»·æ ¼
- **å½±å“è®¡ç®—ï¼ˆ5åˆ†ï¼‰**ï¼šå‡†ç¡®è®¡ç®—ç™¾åˆ†æ¯”
- **æ»‘ç‚¹æ¨èï¼ˆ4åˆ†ï¼‰**ï¼šåˆç†çš„æ¨èé€»è¾‘

---

## ğŸ“Š æ€»ä½“è¯„åˆ†

| é¢˜ç›® | æ»¡åˆ† | å¾—åˆ† |
|------|------|------|
| ç¼–ç¨‹é¢˜ 1 | 20 | ____ |
| ç¼–ç¨‹é¢˜ 2 | 25 | ____ |
| ç¼–ç¨‹é¢˜ 3 | 15 | ____ |
| **æ€»è®¡** | **60** | ____ |

---

## ğŸ¯ è¯„çº§æ ‡å‡†

- **54-60 åˆ†ï¼ˆ90%+ï¼‰**ï¼šå“è¶Šï¼ä»£ç è´¨é‡è¾¾åˆ°ç”Ÿäº§çº§åˆ«
- **48-53 åˆ†ï¼ˆ80-89%ï¼‰**ï¼šä¼˜ç§€ï¼Œæœ‰äº›ç»†èŠ‚å¯ä»¥æ”¹è¿›
- **42-47 åˆ†ï¼ˆ70-79%ï¼‰**ï¼šè‰¯å¥½ï¼ŒåŸºæœ¬åŠŸèƒ½æ­£ç¡®
- **42 åˆ†ä»¥ä¸‹ï¼ˆ<70%ï¼‰**ï¼šéœ€è¦æ›´å¤šç»ƒä¹ 

---

## ğŸ’¡ å®ç°æç¤º

### æç¤º 1ï¼šé¿å…æº¢å‡º

```move
// âŒ å¯èƒ½æº¢å‡º
let result = a * b / c;

// âœ… å®‰å…¨
let result = ((a as u128) * (b as u128)) / (c as u128);
let final_result = (result as u64);
```

### æç¤º 2ï¼šç²¾åº¦å¤„ç†

```move
// ä»·æ ¼ä»¥ 8 ä½å°æ•°è¡¨ç¤º
let price = (reserve_out * 100000000) / reserve_in;
```

### æç¤º 3ï¼šK å€¼éªŒè¯

```move
let k_before = (reserve_x as u128) * (reserve_y as u128);
// ... æ‰§è¡Œ swap
let k_after = (new_reserve_x as u128) * (new_reserve_y as u128);
assert!(k_after >= k_before, ERROR_K_INVARIANT);
```

---

## ğŸš€ å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å‡½æ•°éƒ½å®ç°äº†
- [ ] ä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æ·»åŠ äº†é€‚å½“çš„æ³¨é‡Š
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] è€ƒè™‘äº†è¾¹ç•Œæƒ…å†µ

---

**å®Œæˆåè¯·æŸ¥çœ‹ `ç­”æ¡ˆè§£æ.md` è·å–å‚è€ƒå®ç°å’Œè¯¦ç»†è§£é‡Šï¼**

**è®°ä½**ï¼šä»£ç çš„å¯è¯»æ€§å’Œå¥å£®æ€§æ¯”ç®€æ´æ›´é‡è¦ã€‚
