# Day 04: ç»“æ„ä½“ä¸èµ„æºæ¦‚å¿µ - å®è·µä»»åŠ¡

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

é€šè¿‡å®è·µæŒæ¡ Move ä¸­çš„ç»“æ„ä½“å’Œèµ„æºç®¡ç†ï¼ŒåŒ…æ‹¬ï¼š
- å®šä¹‰å’Œä½¿ç”¨ç»“æ„ä½“
- ç†è§£èƒ½åŠ›ç³»ç»Ÿ
- ç®¡ç†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ
- å®ç°å¤æ‚çš„æ•°æ®ç»“æ„

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### ä»»åŠ¡ 1ï¼šå›¾ä¹¦ç®¡ç†ç³»ç»Ÿï¼ˆåŸºç¡€ â­ï¼‰

**ç›®æ ‡**ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨ç»“æ„ä½“ç»„ç»‡æ•°æ®ã€‚

**è¦æ±‚**ï¼š
1. å®šä¹‰ `Book` ç»“æ„ä½“ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
   - `title`: ä¹¦åï¼ˆvector<u8>ï¼‰
   - `author`: ä½œè€…ï¼ˆvector<u8>ï¼‰
   - `isbn`: ISBNç¼–å·ï¼ˆu64ï¼‰
   - `available`: æ˜¯å¦å¯å€Ÿï¼ˆboolï¼‰

2. å®šä¹‰ `Library` èµ„æºï¼ŒåŒ…å«ï¼š
   - `name`: å›¾ä¹¦é¦†åç§°
   - `books`: å›¾ä¹¦åˆ—è¡¨ï¼ˆvector<Book>ï¼‰
   - `total_books`: æ€»å›¾ä¹¦æ•°é‡

3. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `create_library`: åˆ›å»ºå›¾ä¹¦é¦†
   - `add_book`: æ·»åŠ å›¾ä¹¦
   - `find_book`: æ ¹æ®ISBNæŸ¥æ‰¾å›¾ä¹¦
   - `borrow_book`: å€Ÿä¹¦ï¼ˆä¿®æ”¹å¯å€ŸçŠ¶æ€ï¼‰
   - `return_book`: è¿˜ä¹¦ï¼ˆä¿®æ”¹å¯å€ŸçŠ¶æ€ï¼‰
   - `available_books_count`: ç»Ÿè®¡å¯å€Ÿå›¾ä¹¦æ•°é‡

**æç¤º**ï¼š
```move
module day04_tasks::library {
    use std::signer;
    use std::vector;
    
    struct Book has store, drop, copy {
        title: vector<u8>,
        author: vector<u8>,
        isbn: u64,
        available: bool,
    }
    
    struct Library has key {
        name: vector<u8>,
        books: vector<Book>,
        total_books: u64,
    }
    
    // å®ç°ä½ çš„å‡½æ•°...
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test(admin = @0x1)]
public fun test_library_operations(admin: &signer) {
    // åˆ›å»ºå›¾ä¹¦é¦†
    create_library(admin, b"City Library");
    
    // æ·»åŠ å›¾ä¹¦
    add_book(admin, b"Move Programming", b"Author A", 12345);
    add_book(admin, b"Blockchain Basics", b"Author B", 67890);
    
    // æ£€æŸ¥å›¾ä¹¦æ•°é‡
    let addr = signer::address_of(admin);
    assert!(available_books_count(addr) == 2, 0);
    
    // å€Ÿä¹¦
    borrow_book(admin, 12345);
    assert!(available_books_count(addr) == 1, 1);
    
    // è¿˜ä¹¦
    return_book(admin, 12345);
    assert!(available_books_count(addr) == 2, 2);
}
```

---

### ä»»åŠ¡ 2ï¼šæ•°å­—é’±åŒ…ç³»ç»Ÿï¼ˆä¸­çº§ â­â­ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä¸€ä¸ªæ”¯æŒå¤šç§ä»£å¸çš„æ•°å­—é’±åŒ…ã€‚

**è¦æ±‚**ï¼š
1. å®šä¹‰ `Coin<phantom CoinType>` æ³›å‹ç»“æ„ä½“ï¼š
   - `value`: ä»£å¸æ•°é‡ï¼ˆu64ï¼‰
   - å…·æœ‰ `store` èƒ½åŠ›

2. å®šä¹‰è´§å¸ç±»å‹æ ‡è®°ï¼š
   - `USD` - ç©ºç»“æ„ä½“ï¼Œå¸¦ `drop`
   - `EUR` - ç©ºç»“æ„ä½“ï¼Œå¸¦ `drop`
   - `CNY` - ç©ºç»“æ„ä½“ï¼Œå¸¦ `drop`

3. å®šä¹‰ `Wallet` èµ„æºï¼š
   - `usd_balance`: USDä½™é¢
   - `eur_balance`: EURä½™é¢
   - `cny_balance`: CNYä½™é¢

4. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `create_wallet`: åˆ›å»ºé’±åŒ…
   - `deposit_usd/eur/cny`: å­˜å…¥ä¸åŒè´§å¸
   - `withdraw_usd/eur/cny`: æå–ä¸åŒè´§å¸
   - `get_balance`: æŸ¥è¯¢æŒ‡å®šè´§å¸ä½™é¢
   - `transfer_usd/eur/cny`: åœ¨ä¸¤ä¸ªé’±åŒ…é—´è½¬è´¦

**æç¤º**ï¼š
```move
module day04_tasks::multi_currency_wallet {
    use std::signer;
    
    struct Coin<phantom CoinType> has store {
        value: u64,
    }
    
    struct USD has drop {}
    struct EUR has drop {}
    struct CNY has drop {}
    
    struct Wallet has key {
        usd_balance: u64,
        eur_balance: u64,
        cny_balance: u64,
    }
    
    // å®ç°ä½ çš„å‡½æ•°...
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test(user1 = @0x1, user2 = @0x2)]
public fun test_multi_currency(user1: &signer, user2: &signer) {
    // åˆ›å»ºé’±åŒ…
    create_wallet(user1);
    create_wallet(user2);
    
    // å­˜æ¬¾
    deposit_usd(user1, 1000);
    deposit_eur(user1, 500);
    
    // è½¬è´¦
    transfer_usd(user1, signer::address_of(user2), 300);
    
    // éªŒè¯ä½™é¢
    assert!(get_balance<USD>(signer::address_of(user1)) == 700, 0);
    assert!(get_balance<USD>(signer::address_of(user2)) == 300, 1);
}
```

---

### ä»»åŠ¡ 3ï¼šNFT æ”¶è—ç³»ç»Ÿï¼ˆé«˜çº§ â­â­â­ï¼‰

**ç›®æ ‡**ï¼šåˆ›å»ºä¸€ä¸ª NFTï¼ˆéåŒè´¨åŒ–ä»£å¸ï¼‰æ”¶è—å’Œäº¤æ˜“ç³»ç»Ÿã€‚

**è¦æ±‚**ï¼š
1. å®šä¹‰ `NFT` ç»“æ„ä½“ï¼ˆä¸å¯å¤åˆ¶ï¼‰ï¼š
   - `id`: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆu64ï¼‰
   - `name`: NFTåç§°ï¼ˆvector<u8>ï¼‰
   - `description`: æè¿°ï¼ˆvector<u8>ï¼‰
   - `creator`: åˆ›å»ºè€…åœ°å€ï¼ˆaddressï¼‰
   - `metadata`: å…ƒæ•°æ®ï¼ˆvector<u8>ï¼‰

2. å®šä¹‰ `Collection` èµ„æºï¼š
   - `owner`: æ‰€æœ‰è€…åœ°å€
   - `nfts`: NFTåˆ—è¡¨
   - `next_id`: ä¸‹ä¸€ä¸ªNFT ID

3. å®šä¹‰ `Marketplace` å…¨å±€èµ„æºï¼š
   - `listings`: å¾…å”®NFTä¿¡æ¯
   - `total_sales`: æ€»äº¤æ˜“æ•°

4. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `create_collection`: åˆ›å»ºæ”¶è—é›†
   - `mint_nft`: é“¸é€ æ–°çš„NFT
   - `transfer_nft`: è½¬ç§»NFTæ‰€æœ‰æƒ
   - `list_for_sale`: å°†NFTæŒ‚ç‰Œå‡ºå”®
   - `buy_nft`: è´­ä¹°æŒ‚ç‰Œçš„NFT
   - `get_nft_count`: è·å–æ”¶è—é›†ä¸­NFTæ•°é‡
   - `nft_exists`: æ£€æŸ¥NFTæ˜¯å¦å­˜åœ¨

**æç¤º**ï¼š
```move
module day04_tasks::nft_collection {
    use std::signer;
    use std::vector;
    use std::option::{Self, Option};
    
    struct NFT has store {
        id: u64,
        name: vector<u8>,
        description: vector<u8>,
        creator: address,
        metadata: vector<u8>,
    }
    
    struct Collection has key {
        owner: address,
        nfts: vector<NFT>,
        next_id: u64,
    }
    
    struct Listing has store, drop {
        nft_id: u64,
        seller: address,
        price: u64,
    }
    
    struct Marketplace has key {
        listings: vector<Listing>,
        total_sales: u64,
    }
    
    // å®ç°ä½ çš„å‡½æ•°...
    
    // è¾…åŠ©å‡½æ•°ï¼šä»æ”¶è—ä¸­ç§»é™¤NFT
    fun remove_nft_by_id(nfts: &mut vector<NFT>, id: u64): NFT {
        let len = vector::length(nfts);
        let i = 0;
        while (i < len) {
            let nft = vector::borrow(nfts, i);
            if (nft.id == id) {
                return vector::remove(nfts, i)
            };
            i = i + 1;
        };
        abort 404 // NFT not found
    }
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test(creator = @0x1, buyer = @0x2, marketplace_admin = @0x3)]
public fun test_nft_marketplace(
    creator: &signer,
    buyer: &signer,
    marketplace_admin: &signer
) {
    // åˆ›å»ºæ”¶è—é›†å’Œå¸‚åœº
    create_collection(creator);
    create_collection(buyer);
    init_marketplace(marketplace_admin);
    
    // é“¸é€ NFT
    let creator_addr = signer::address_of(creator);
    mint_nft(creator, b"Cool NFT", b"A very cool NFT", b"ipfs://...");
    assert!(get_nft_count(creator_addr) == 1, 0);
    
    // æŒ‚ç‰Œå‡ºå”®
    list_for_sale(creator, 0, 1000);
    
    // è´­ä¹°NFT
    buy_nft(buyer, creator_addr, 0);
    
    // éªŒè¯æ‰€æœ‰æƒè½¬ç§»
    let buyer_addr = signer::address_of(buyer);
    assert!(get_nft_count(creator_addr) == 0, 1);
    assert!(get_nft_count(buyer_addr) == 1, 2);
}
```

---

### ä»»åŠ¡ 4ï¼šçƒ­åœŸè±†æ¨¡å¼å®è·µï¼ˆæŒ‘æˆ˜ â­â­â­â­ï¼‰

**ç›®æ ‡**ï¼šå®ç°ä¸€ä¸ªä½¿ç”¨"çƒ­åœŸè±†"æ¨¡å¼çš„æƒé™éªŒè¯ç³»ç»Ÿã€‚

**è¦æ±‚**ï¼š
1. å®šä¹‰ `AccessRequest` ç»“æ„ä½“ï¼ˆæ— ä»»ä½•èƒ½åŠ›ï¼‰ï¼š
   - `user`: è¯·æ±‚è€…åœ°å€
   - `resource_id`: èµ„æºID
   - `timestamp`: æ—¶é—´æˆ³

2. å®šä¹‰ `AccessToken` ç»“æ„ä½“ï¼ˆæ— ä»»ä½•èƒ½åŠ›ï¼‰ï¼š
   - `request_id`: è¯·æ±‚ID
   - `granted`: æ˜¯å¦æˆæƒ

3. å®šä¹‰ `PermissionManager` èµ„æºï¼š
   - `admin`: ç®¡ç†å‘˜åœ°å€
   - `authorized_users`: æˆæƒç”¨æˆ·åˆ—è¡¨

4. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `init_manager`: åˆå§‹åŒ–æƒé™ç®¡ç†å™¨
   - `create_access_request`: åˆ›å»ºè®¿é—®è¯·æ±‚ï¼ˆè¿”å› AccessRequestï¼‰
   - `grant_access`: æˆäºˆè®¿é—®æƒé™ï¼ˆæ¥æ”¶ AccessRequestï¼Œè¿”å› AccessTokenï¼‰
   - `deny_access`: æ‹’ç»è®¿é—®ï¼ˆæ¥æ”¶ AccessRequestï¼Œå¿…é¡»å¤„ç†ï¼‰
   - `use_token`: ä½¿ç”¨è®¿é—®ä»¤ç‰Œï¼ˆæ¥æ”¶ AccessTokenï¼Œå¿…é¡»å¤„ç†ï¼‰

**å…³é”®ç‚¹**ï¼š
- `AccessRequest` å’Œ `AccessToken` æ²¡æœ‰ `drop` èƒ½åŠ›ï¼Œå¿…é¡»è¢«æ˜¾å¼å¤„ç†
- è¿™ç¡®ä¿äº†æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¾—åˆ°å“åº”ï¼Œæ‰€æœ‰ä»¤ç‰Œéƒ½ä¼šè¢«ä½¿ç”¨

**æç¤º**ï¼š
```move
module day04_tasks::hot_potato_auth {
    use std::signer;
    use std::vector;
    
    // çƒ­åœŸè±†ï¼šå¿…é¡»è¢«å¤„ç†
    struct AccessRequest {
        user: address,
        resource_id: u64,
        timestamp: u64,
    }
    
    struct AccessToken {
        request_id: u64,
        granted: bool,
    }
    
    struct PermissionManager has key {
        admin: address,
        authorized_users: vector<address>,
        request_counter: u64,
    }
    
    // å®ç°ä½ çš„å‡½æ•°...
    
    public fun create_access_request(
        user: address,
        resource_id: u64,
        timestamp: u64
    ): AccessRequest {
        AccessRequest { user, resource_id, timestamp }
    }
    
    // å¿…é¡»æˆäºˆæˆ–æ‹’ç»è®¿é—®
    public fun grant_access(
        admin: &signer,
        request: AccessRequest,
        manager_addr: address
    ): AccessToken acquires PermissionManager {
        // éªŒè¯ç®¡ç†å‘˜æƒé™
        // è¿”å›æˆæƒä»¤ç‰Œ
    }
    
    public fun deny_access(request: AccessRequest) {
        // é”€æ¯è¯·æ±‚
        let AccessRequest { user: _, resource_id: _, timestamp: _ } = request;
    }
    
    // ä½¿ç”¨ä»¤ç‰Œè®¿é—®èµ„æº
    public fun use_token(token: AccessToken): bool {
        let AccessToken { request_id: _, granted } = token;
        granted
    }
}
```

---

## ğŸ§ª æµ‹è¯•ä½ çš„ä»£ç 

### ç¼–è¯‘æµ‹è¯•
```bash
aptos move compile
```

### è¿è¡Œæµ‹è¯•
```bash
aptos move test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
aptos move test --filter test_library_operations
```

---

## ğŸ“ æäº¤è¦æ±‚

1. **ä»£ç æ–‡ä»¶**ï¼š
   - `sources/task1_library.move`
   - `sources/task2_wallet.move`
   - `sources/task3_nft.move`
   - `sources/task4_auth.move`

2. **æµ‹è¯•è¦†ç›–**ï¼š
   - æ¯ä¸ªä»»åŠ¡è‡³å°‘åŒ…å«3ä¸ªæµ‹è¯•ç”¨ä¾‹
   - æµ‹è¯•æ­£å¸¸æµç¨‹å’Œè¾¹ç•Œæƒ…å†µ

3. **æ–‡æ¡£**ï¼š
   - ä¸ºæ¯ä¸ªå…¬å…±å‡½æ•°æ·»åŠ æ³¨é‡Š
   - è¯´æ˜èƒ½åŠ›é€‰æ‹©çš„åŸå› 

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### 1. èƒ½åŠ›é€‰æ‹©æŒ‡å—

```move
// å€¼ç±»å‹ï¼ˆå¯å¤åˆ¶ï¼‰
struct Config has copy, drop, store { }

// å”¯ä¸€èµ„äº§ï¼ˆä¸å¯å¤åˆ¶ï¼‰
struct NFT has store { }

// å…¨å±€èµ„æº
struct Account has key { }

// çƒ­åœŸè±†ï¼ˆå¼ºåˆ¶å¤„ç†ï¼‰
struct Request { }
```

### 2. èµ„æºç®¡ç†æ¨¡å¼

```move
// åˆ›å»ºå¹¶å­˜å‚¨
public fun create_resource(account: &signer) {
    let resource = Resource { ... };
    move_to(account, resource);
}

// å€Ÿç”¨ä½¿ç”¨
public fun use_resource(addr: address) acquires Resource {
    let resource = borrow_global<Resource>(addr);
    // ä½¿ç”¨èµ„æº
}

// ç§»å‡ºé”€æ¯
public fun destroy_resource(account: &signer) acquires Resource {
    let Resource { ... } = move_from<Resource>(signer::address_of(account));
}
```

### 3. å¸¸è§é”™è¯¯

```move
// âŒ é”™è¯¯ï¼šèµ„æºæœªè¢«ä½¿ç”¨
public fun wrong(account: &signer) {
    let coin = Coin { value: 100 };
    // ç¼–è¯‘é”™è¯¯ï¼šcoin æœªä½¿ç”¨
}

// âœ… æ­£ç¡®ï¼šæ˜¾å¼å¤„ç†èµ„æº
public fun correct(account: &signer) {
    let coin = Coin { value: 100 };
    move_to(account, coin);  // æˆ–è€…é”€æ¯å®ƒ
}

// âŒ é”™è¯¯ï¼šèƒ½åŠ›ä¸åŒ¹é…
struct Inner { }
struct Outer has copy {  // ç¼–è¯‘é”™è¯¯
    inner: Inner,  // Inner æ²¡æœ‰ copy
}

// âœ… æ­£ç¡®ï¼šèƒ½åŠ›ä¸€è‡´
struct Inner has copy { }
struct Outer has copy {
    inner: Inner,
}
```

---

## ğŸ“ è¿›é˜¶æŒ‘æˆ˜

å®ŒæˆåŸºç¡€ä»»åŠ¡åï¼Œå°è¯•ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **æ‰©å±•å›¾ä¹¦é¦†ç³»ç»Ÿ**ï¼š
   - æ·»åŠ å€Ÿé˜…å†å²è®°å½•
   - å®ç°é€¾æœŸç½šæ¬¾æœºåˆ¶
   - æ”¯æŒå›¾ä¹¦é¢„çº¦

2. **å¢å¼ºé’±åŒ…åŠŸèƒ½**ï¼š
   - å®ç°è´§å¸å…‘æ¢
   - æ·»åŠ äº¤æ˜“å†å²
   - æ”¯æŒæ‰¹é‡è½¬è´¦

3. **å®Œå–„NFTå¸‚åœº**ï¼š
   - å®ç°æ‹å–åŠŸèƒ½
   - æ·»åŠ ç‰ˆç¨æœºåˆ¶
   - æ”¯æŒNFTæ‰¹é‡æ“ä½œ

4. **åˆ›æ–°åº”ç”¨**ï¼š
   - è®¾è®¡ä¸€ä¸ªæŠ•ç¥¨ç³»ç»Ÿ
   - å®ç°ä¾›åº”é“¾è¿½è¸ª
   - åˆ›å»ºæ¸¸æˆé“å…·ç³»ç»Ÿ

---

## ğŸ“š å‚è€ƒèµ„æº

- [Move Book - Structs](https://move-language.github.io/move/structs-and-resources.html)
- [Move Book - Abilities](https://move-language.github.io/move/abilities.html)
- [Aptos Move Examples](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/move-examples)

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å®Œæˆä»»åŠ¡ 1ï¼šå›¾ä¹¦ç®¡ç†ç³»ç»Ÿ
- [ ] å®Œæˆä»»åŠ¡ 2ï¼šæ•°å­—é’±åŒ…ç³»ç»Ÿ
- [ ] å®Œæˆä»»åŠ¡ 3ï¼šNFT æ”¶è—ç³»ç»Ÿ
- [ ] å®Œæˆä»»åŠ¡ 4ï¼šçƒ­åœŸè±†æƒé™ç³»ç»Ÿ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç æœ‰é€‚å½“çš„æ³¨é‡Š
- [ ] ç†è§£èƒ½åŠ›ç³»ç»Ÿçš„åº”ç”¨åœºæ™¯

**å®Œæˆåï¼Œä½ å°†æŒæ¡ Move ä¸­ç»“æ„ä½“å’Œèµ„æºçš„æ ¸å¿ƒæ¦‚å¿µï¼** ğŸ‰
