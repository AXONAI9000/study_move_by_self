# Day 26 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

## ğŸ“ è€ƒè¯•è¯´æ˜

- **é¢˜ç›®æ•°é‡**ï¼š5 é“ç¼–ç¨‹é¢˜
- **æ¯é¢˜åˆ†å€¼**ï¼š1 åˆ†
- **æ€»åˆ†**ï¼š5 åˆ†
- **åŠæ ¼åˆ†æ•°**ï¼š3.5 åˆ†ï¼ˆ70%ï¼‰
- **è€ƒè¯•æ—¶é—´**ï¼š60 åˆ†é’Ÿ

---

## ç¼–ç¨‹é¢˜

### ç¬¬ 1 é¢˜ï¼šå¥åº·å› å­è®¡ç®—ï¼ˆ1 åˆ†ï¼‰

å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—ç”¨æˆ·çš„å¥åº·å› å­ã€‚

**å‡½æ•°ç­¾å**ï¼š
```move
public fun calculate_health_factor(
    collateral_value: u128,      // æŠµæŠ¼å“ä»·å€¼
    liquidation_threshold: u64,   // æ¸…ç®—é˜ˆå€¼ï¼ˆåŸºç‚¹ï¼Œ10000 = 100%ï¼‰
    borrow_value: u128            // å€Ÿæ¬¾ä»·å€¼
): u128
```

**è¦æ±‚**ï¼š
- å¥åº·å› å­å…¬å¼ï¼šHF = (æŠµæŠ¼å“ä»·å€¼ Ã— æ¸…ç®—é˜ˆå€¼) / å€Ÿæ¬¾ä»·å€¼
- ä½¿ç”¨ 10^18 ä½œä¸ºç²¾åº¦åŸºå‡†
- å¦‚æœæ²¡æœ‰å€Ÿæ¬¾ï¼Œè¿”å›æœ€å¤§å€¼ï¼ˆtype_info::max_value<u128>()ï¼‰
- å¤„ç†é™¤é›¶æƒ…å†µ

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
fun test_health_factor() {
    // æ¡ˆä¾‹ 1: æ­£å¸¸æƒ…å†µ
    // æŠµæŠ¼å“: $100, æ¸…ç®—é˜ˆå€¼: 85%, å€Ÿæ¬¾: $70
    let hf = calculate_health_factor(
        100_000_000_000_000_000_000, 
        8500, 
        70_000_000_000_000_000_000
    );
    assert!(hf == 1_214_285_714_285_714_285, 0); // HF = 1.214...
    
    // æ¡ˆä¾‹ 2: æ²¡æœ‰å€Ÿæ¬¾
    let hf_no_borrow = calculate_health_factor(
        100_000_000_000_000_000_000, 
        8500, 
        0
    );
    assert!(hf_no_borrow == 340282366920938463463374607431768211455, 0); // MAX_U128
}
```

**ä½ çš„ç­”æ¡ˆ**ï¼š
```move
public fun calculate_health_factor(
    collateral_value: u128,
    liquidation_threshold: u64,
    borrow_value: u128
): u128 {
    // TODO: å®ç°å¥åº·å› å­è®¡ç®—
}
```

---

### ç¬¬ 2 é¢˜ï¼šåˆ©ç‡è®¡ç®—ï¼ˆ1 åˆ†ï¼‰

å®ç°çº¿æ€§åˆ©ç‡æ¨¡å‹çš„å€Ÿæ¬¾åˆ©ç‡è®¡ç®—ã€‚

**å‡½æ•°ç­¾å**ï¼š
```move
public fun calculate_borrow_rate(
    utilization_rate: u64,        // èµ„é‡‘ä½¿ç”¨ç‡ï¼ˆåŸºç‚¹ï¼Œ10000 = 100%ï¼‰
    base_rate: u64,               // åŸºç¡€åˆ©ç‡ï¼ˆåŸºç‚¹ï¼‰
    slope1: u64,                  // ç¬¬ä¸€æ®µæ–œç‡ï¼ˆåŸºç‚¹ï¼‰
    slope2: u64,                  // ç¬¬äºŒæ®µæ–œç‡ï¼ˆåŸºç‚¹ï¼‰
    optimal_utilization: u64      // æœ€ä¼˜ä½¿ç”¨ç‡ï¼ˆåŸºç‚¹ï¼‰
): u64
```

**ç®—æ³•**ï¼š
```
å½“ U â‰¤ U_optimal:
  Borrow_Rate = base_rate + (U / U_optimal) Ã— slope1

å½“ U > U_optimal:
  Borrow_Rate = base_rate + slope1 + 
                ((U - U_optimal) / (10000 - U_optimal)) Ã— slope2
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
fun test_borrow_rate() {
    // æ¡ˆä¾‹ 1: U = 50%, U_optimal = 80%
    let rate1 = calculate_borrow_rate(
        5000,  // 50%
        0,     // 0%
        400,   // 4%
        7500,  // 75%
        8000   // 80%
    );
    assert!(rate1 == 250, 0); // 2.5%
    
    // æ¡ˆä¾‹ 2: U = 90%, U_optimal = 80%
    let rate2 = calculate_borrow_rate(
        9000,  // 90%
        0,     // 0%
        400,   // 4%
        7500,  // 75%
        8000   // 80%
    );
    assert!(rate2 == 4150, 0); // 41.5%
}
```

**ä½ çš„ç­”æ¡ˆ**ï¼š
```move
public fun calculate_borrow_rate(
    utilization_rate: u64,
    base_rate: u64,
    slope1: u64,
    slope2: u64,
    optimal_utilization: u64
): u64 {
    // TODO: å®ç°åˆ©ç‡è®¡ç®—
}
```

---

### ç¬¬ 3 é¢˜ï¼šæ¸…ç®—æ•°é‡è®¡ç®—ï¼ˆ1 åˆ†ï¼‰

è®¡ç®—æ¸…ç®—æ—¶éœ€è¦è½¬ç§»çš„æŠµæŠ¼å“æ•°é‡ã€‚

**å‡½æ•°ç­¾å**ï¼š
```move
public fun calculate_collateral_to_liquidate(
    debt_to_cover: u64,           // è¦å¿è¿˜çš„å€ºåŠ¡æ•°é‡
    debt_price: u64,              // å€ºåŠ¡èµ„äº§ä»·æ ¼ï¼ˆç²¾åº¦ 10^8ï¼‰
    collateral_price: u64,        // æŠµæŠ¼å“èµ„äº§ä»·æ ¼ï¼ˆç²¾åº¦ 10^8ï¼‰
    liquidation_bonus: u64        // æ¸…ç®—å¥–åŠ±ï¼ˆåŸºç‚¹ï¼Œ500 = 5%ï¼‰
): u64
```

**ç®—æ³•**ï¼š
```
collateral_value = debt_to_cover Ã— debt_price Ã— (10000 + liquidation_bonus) / 10000
collateral_amount = collateral_value / collateral_price
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
fun test_liquidation_calculation() {
    // å¿è¿˜ 100 USDC å€ºåŠ¡
    // USDC ä»·æ ¼ = $1, APT ä»·æ ¼ = $10
    // æ¸…ç®—å¥–åŠ± = 5%
    let collateral = calculate_collateral_to_liquidate(
        100_00000000,    // 100 USDC
        1_00000000,      // $1
        10_00000000,     // $10
        500              // 5%
    );
    assert!(collateral == 10_50000000, 0); // 10.5 APT
}
```

**ä½ çš„ç­”æ¡ˆ**ï¼š
```move
public fun calculate_collateral_to_liquidate(
    debt_to_cover: u64,
    debt_price: u64,
    collateral_price: u64,
    liquidation_bonus: u64
): u64 {
    // TODO: å®ç°æ¸…ç®—æ•°é‡è®¡ç®—
}
```

---

### ç¬¬ 4 é¢˜ï¼šå€Ÿæ¬¾èƒ½åŠ›è®¡ç®—ï¼ˆ1 åˆ†ï¼‰

è®¡ç®—ç”¨æˆ·è¿˜å¯ä»¥å€Ÿå‡ºçš„æœ€å¤§é‡‘é¢ã€‚

**å‡½æ•°ç­¾å**ï¼š
```move
public fun calculate_available_borrow(
    total_collateral_value: u128,  // æ€»æŠµæŠ¼å“ä»·å€¼
    total_borrow_value: u128,      // å½“å‰å€Ÿæ¬¾ä»·å€¼
    ltv: u64                       // æŠµæŠ¼ç‡ï¼ˆåŸºç‚¹ï¼‰
): u64
```

**ç®—æ³•**ï¼š
```
max_borrow = total_collateral_value Ã— LTV / 10000
available_borrow = max(0, max_borrow - total_borrow_value)
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
fun test_available_borrow() {
    // æŠµæŠ¼å“ä»·å€¼ $100, LTV 75%, å·²å€Ÿ $50
    let available = calculate_available_borrow(
        100_000_000_000_000_000_000,
        50_000_000_000_000_000_000,
        7500
    );
    assert!(available == 25_000_000_000_000_000_000, 0); // $25
    
    // å·²å€Ÿè¶…è¿‡æœ€å¤§é¢åº¦
    let no_available = calculate_available_borrow(
        100_000_000_000_000_000_000,
        80_000_000_000_000_000_000,
        7500
    );
    assert!(no_available == 0, 0);
}
```

**ä½ çš„ç­”æ¡ˆ**ï¼š
```move
public fun calculate_available_borrow(
    total_collateral_value: u128,
    total_borrow_value: u128,
    ltv: u64
): u64 {
    // TODO: å®ç°å€Ÿæ¬¾èƒ½åŠ›è®¡ç®—
}
```

---

### ç¬¬ 5 é¢˜ï¼šåˆ©æ¯ç´¯ç§¯ï¼ˆ1 åˆ†ï¼‰

è®¡ç®—ç»è¿‡ä¸€æ®µæ—¶é—´åçš„ç´¯ç§¯ç´¢å¼•ã€‚

**å‡½æ•°ç­¾å**ï¼š
```move
public fun calculate_linear_index(
    current_index: u128,           // å½“å‰ç´¢å¼•ï¼ˆç²¾åº¦ 10^27ï¼‰
    rate: u64,                     // å¹´åŒ–åˆ©ç‡ï¼ˆåŸºç‚¹ï¼‰
    time_delta: u64                // ç»è¿‡çš„ç§’æ•°
): u128
```

**ç®—æ³•**ï¼š
```
rate_per_second = rate / SECONDS_PER_YEAR / 10000
accumulation = 1 + rate_per_second Ã— time_delta
new_index = current_index Ã— accumulation

ä½¿ç”¨ RAY (10^27) ç²¾åº¦
```

**å¸¸é‡**ï¼š
```move
const RAY: u128 = 1_000_000_000_000_000_000_000_000_000;
const SECONDS_PER_YEAR: u128 = 31536000; // 365 days
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```move
#[test]
fun test_index_calculation() {
    // 10% å¹´åŒ–åˆ©ç‡ï¼Œç»è¿‡ 1 å¹´
    let new_index = calculate_linear_index(
        RAY,           // åˆå§‹ç´¢å¼• 1.0
        1000,          // 10%
        31536000       // 1 å¹´
    );
    assert!(new_index == 1_100_000_000_000_000_000_000_000_000, 0); // 1.1
}
```

**ä½ çš„ç­”æ¡ˆ**ï¼š
```move
const RAY: u128 = 1_000_000_000_000_000_000_000_000_000;
const SECONDS_PER_YEAR: u128 = 31536000;

public fun calculate_linear_index(
    current_index: u128,
    rate: u64,
    time_delta: u64
): u128 {
    // TODO: å®ç°ç´¢å¼•ç´¯ç§¯è®¡ç®—
}
```

---

## æäº¤è¯´æ˜

1. å°†ä½ çš„ç­”æ¡ˆå†™åœ¨ `ä½ çš„ç­”æ¡ˆ/exam_solutions.move` æ–‡ä»¶ä¸­
2. ç¡®ä¿æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
3. æäº¤å‰è¿è¡Œ `aptos move test`

---

## è¯„åˆ†æ ‡å‡†

æ¯é¢˜è¯„åˆ†ç»†åˆ™ï¼š
- **åŠŸèƒ½æ­£ç¡®ï¼ˆ60%ï¼‰**ï¼šé€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
- **ä»£ç è´¨é‡ï¼ˆ20%ï¼‰**ï¼šä»£ç æ¸…æ™°ã€æ˜“è¯»
- **è¾¹ç•Œå¤„ç†ï¼ˆ20%ï¼‰**ï¼šå¤„ç†è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

**å®Œæˆåè¯·æŸ¥çœ‹ã€Šç­”æ¡ˆè§£æ.mdã€‹æ ¸å¯¹ç­”æ¡ˆï¼**
