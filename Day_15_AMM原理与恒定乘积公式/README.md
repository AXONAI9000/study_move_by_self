# Day 15: AMM 原理与恒定乘积公式

## 📋 学习目标

今天我们将深入学习自动做市商（AMM）的核心原理，这是 DeFi 世界中最重要的创新之一。

### 核心目标
1. 🎯 **理解恒定乘积公式** - 掌握 x * y = k 的数学原理
2. 📊 **流动性份额计算** - 理解 LP Token 的铸造和销毁机制
3. 💰 **价格影响分析** - 计算大额交易对价格的影响
4. 🔧 **实现 AMM 核心算法** - 用 Move 语言实现完整的 AMM 数学模型

### 学习成果
- ✅ 能够解释 AMM 的工作原理
- ✅ 能够手工计算交换数量和价格影响
- ✅ 能够实现恒定乘积算法
- ✅ 理解 DEX 与传统订单簿的区别

---

## 📚 学习路线图

```
09:00 - 10:30  📖 理论学习
               ├─ AMM 基础概念
               ├─ 恒定乘积公式推导
               └─ 流动性池原理

10:30 - 11:30  💻 代码学习
               ├─ 分析代码示例
               ├─ 理解算法实现
               └─ 测试计算逻辑

11:30 - 14:30  🔨 实践任务
               ├─ 实现 AMM 核心模块
               ├─ 添加价格计算函数
               └─ 编写单元测试

14:30 - 15:30  📝 每日考试
               ├─ 选择题（20 题）
               ├─ 编程题（3 题）
               └─ 自我评分
```

**预计学习时间**：6-7 小时

---

## 🎓 前置知识

在开始今天的学习之前，请确保你已经掌握：

- ✅ Day 13: Fungible Token 标准
- ✅ Day 14: 代币管理功能
- ✅ 基本的数学运算（平方根、百分比）
- ✅ 资源管理和全局存储

---

## 📖 核心概念预览

### 什么是 AMM？

**自动做市商（Automated Market Maker）** 是一种不依赖订单簿的交易机制，通过数学公式自动为交易提供流动性。

### 核心公式

```
x * y = k

其中：
x = 代币 A 的储备量
y = 代币 B 的储备量
k = 恒定乘积（常数）
```

### 关键概念

1. **流动性池（Liquidity Pool）**
   - 存储两种代币的储备
   - 任何人都可以提供流动性

2. **LP Token（流动性提供者代币）**
   - 代表流动性份额
   - 可以赎回对应的代币

3. **价格发现**
   - 价格由储备比例决定：`Price = y / x`
   - 交易会改变储备比例，从而改变价格

4. **价格影响（Price Impact）**
   - 大额交易导致的价格变化
   - 与流动性深度成反比

---

## 📁 今日文件结构

```
Day_15_AMM原理与恒定乘积公式/
├── README.md                          # 📘 本文件 - 学习指南
├── Move.toml                          # ⚙️ 项目配置
├── 01_理论学习/
│   ├── 核心概念.md                    # 📚 详细理论讲解
│   └── 代码示例.move                  # 💡 完整代码示例
├── 02_实践任务/
│   └── 任务说明.md                    # 🎯 实践任务要求
├── 03_每日考试/
│   ├── 选择题.md                      # ✏️ 20道选择题
│   ├── 编程题.md                      # 💻 3道编程题
│   └── 答案解析.md                    # ✅ 完整答案和解析
└── sources/
    └── amm_core.move                  # 🔧 你的实现代码
```

---

## 🚀 开始学习

### Step 1: 理论学习（90分钟）

阅读 `01_理论学习/核心概念.md`，重点理解：
- AMM 的历史和意义
- 恒定乘积公式的数学推导
- 流动性添加和移除的计算
- 价格影响的计算方法

**学习建议**：
- 📝 手工推导一遍公式
- 🧮 用计算器验证示例
- 🤔 思考为什么需要 k 保持恒定

### Step 2: 代码学习（60分钟）

研究 `01_理论学习/代码示例.move`，理解：
- 如何存储流动性池数据
- 交换算法的实现
- 流动性份额的计算
- 安全检查和错误处理

**学习建议**：
- 🔍 逐行阅读代码
- 💭 理解每个函数的作用
- 📊 画出数据流程图

### Step 3: 实践任务（3小时）

完成 `02_实践任务/任务说明.md` 中的要求：
- 实现完整的 AMM 核心模块
- 添加流动性计算函数
- 实现价格查询功能
- 编写测试用例

**实践建议**：
- ⚡ 先实现基础功能
- 🧪 每完成一个函数就测试
- 🛡️ 添加充分的错误检查

### Step 4: 每日考试（60分钟）

完成 `03_每日考试/` 中的所有题目：
- 20 道选择题（每题 2 分）
- 3 道编程题（每题 20 分）

**考试要求**：
- ✅ 独立完成，不查看答案
- ⏱️ 限时 60 分钟
- 🎯 目标分数 ≥ 70 分

---

## 💡 重点提示

### ⚠️ 常见陷阱

1. **整数溢出**
   ```move
   // ❌ 错误：可能溢出
   let k = reserve_x * reserve_y;
   
   // ✅ 正确：使用 u128
   let k = (reserve_x as u128) * (reserve_y as u128);
   ```

2. **除零错误**
   ```move
   // 始终检查分母是否为零
   assert!(reserve_x > 0 && reserve_y > 0, ERROR_ZERO_RESERVE);
   ```

3. **精度损失**
   ```move
   // 先乘后除，减少精度损失
   let amount_out = (amount_in * reserve_out) / (reserve_in + amount_in);
   ```

### 🔑 关键要点

1. **恒定乘积公式的本质**
   - k 保持恒定确保流动性不会凭空消失
   - 交易越大，价格滑点越大（保护流动性提供者）

2. **流动性份额的公平性**
   - 按比例铸造 LP Token
   - 确保每个 LP 获得公平的交易手续费

3. **价格影响的计算**
   - 价格影响 = (新价格 - 旧价格) / 旧价格
   - 可以通过增加流动性来降低价格影响

---

## 🎯 学习检查清单

完成今天的学习后，你应该能够：

- [ ] 解释 AMM 与订单簿的区别
- [ ] 推导恒定乘积公式
- [ ] 计算给定输入的输出数量
- [ ] 计算添加流动性时应铸造的 LP Token
- [ ] 计算移除流动性时应返还的代币数量
- [ ] 分析交易对价格的影响
- [ ] 用 Move 实现 AMM 核心算法
- [ ] 编写测试验证算法正确性

---

## 📚 扩展阅读

### 必读
- [Uniswap V2 白皮书](https://uniswap.org/whitepaper.pdf)
- [恒定函数做市商原理](https://arxiv.org/abs/2003.10001)

### 选读
- [AMM 的演进：从 V1 到 V3](https://medium.com/@0xdoug/amm-evolution)
- [无常损失详解](https://finematics.com/impermanent-loss-explained/)
- [Curve Finance 的稳定币 AMM](https://curve.fi/whitepaper)

### 代码参考
- [Liquidswap AMM 实现](https://github.com/pontem-network/liquidswap)
- [PancakeSwap V2](https://github.com/pancakeswap/pancake-smart-contracts)

---

## 🔗 相关资源

### 工具
- [Uniswap Analytics](https://info.uniswap.org/)
- [DEX Screener](https://dexscreener.com/)
- [AMM 计算器](https://www.desmos.com/calculator/amm)

### 社区
- [Aptos DeFi Discord](https://discord.gg/aptosdefi)
- [Move Developers Forum](https://forum.aptosfoundation.org/)

---

## 📝 每日总结模板

学习完成后，请用以下模板总结今天的学习：

```markdown
## Day 15 学习总结

### 学到的关键概念
1. 
2. 
3. 

### 完成的任务
- [ ] 理论学习
- [ ] 代码示例研究
- [ ] 实践任务
- [ ] 每日考试

### 考试成绩
- 选择题：___/40 分
- 编程题：___/60 分
- 总分：___/100 分

### 遇到的困难
1. 
2. 

### 解决方案
1. 
2. 

### 明天的计划
- 
```

---

## 🎓 下一步

完成今天的学习后：

1. **如果得分 ≥ 70 分**
   - ✅ 继续学习 Day 16: 简单 DEX - 流动性池
   - 💡 思考如何优化 AMM 算法

2. **如果得分 < 70 分**
   - 🔄 重新学习今天的理论
   - 💻 重做实践任务
   - 📖 阅读扩展资料

---

**准备好了吗？让我们开始深入理解 AMM 的奥秘！🚀**

---

## ⚡ 快速参考

### 核心公式速查

```
1. 恒定乘积：x * y = k

2. 交换输出：Δy = (y * Δx) / (x + Δx)

3. LP份额：LP_minted = (Δx / x) * total_supply
           或 LP_minted = √(Δx * Δy)  (首次添加)

4. 价格：P = y / x

5. 价格影响：Impact = |P_new - P_old| / P_old
```

### 错误码速查

```
ERROR_ZERO_AMOUNT = 1
ERROR_INSUFFICIENT_LIQUIDITY = 2
ERROR_INSUFFICIENT_OUTPUT = 3
ERROR_ZERO_RESERVE = 4
ERROR_OVERFLOW = 5
```

---

**版权声明**: 本课程材料仅供学习使用。

**更新日期**: 2025-01-09
