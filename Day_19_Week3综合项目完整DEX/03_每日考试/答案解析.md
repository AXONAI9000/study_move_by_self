# Day 19 æ¯æ—¥è€ƒè¯• - ç­”æ¡ˆè§£æ

## é€‰æ‹©é¢˜ç­”æ¡ˆè§£æ

### 1. B - x * y = k
**è§£æ**ï¼šUniswap V2 ä½¿ç”¨æ’å®šä¹˜ç§¯åšå¸‚å•†æ¨¡å‹ï¼Œæ ¸å¿ƒå…¬å¼æ˜¯ x * y = kï¼Œå…¶ä¸­ x å’Œ y åˆ†åˆ«æ˜¯ä¸¤ç§ä»£å¸çš„å‚¨å¤‡é‡ï¼Œk æ˜¯å¸¸æ•°ã€‚

### 2. B - min(amount_x / reserve_x, amount_y / reserve_y) * total_supply
**è§£æ**ï¼šåç»­æ·»åŠ æµåŠ¨æ€§æ—¶ï¼ŒLP Token æ•°é‡æŒ‰ç…§ä»£å¸æ¯”ä¾‹è®¡ç®—ï¼Œå–è¾ƒå°å€¼ä»¥ä¿æŒæ¯”ä¾‹ä¸€è‡´ã€‚

### 3. B - ä»è¾“å…¥ä»£å¸ä¸­æ‰£é™¤
**è§£æ**ï¼šDEX é€šå¸¸ä»ç”¨æˆ·è¾“å…¥çš„ä»£å¸ä¸­æ‰£é™¤æ‰‹ç»­è´¹ï¼Œä¾‹å¦‚ Uniswap V2 æ˜¯ 0.3%ã€‚

### 4. B - 0.3%
**è§£æ**ï¼šUniswap V2 çš„æ ‡å‡†æ‰‹ç»­è´¹ç‡æ˜¯ 0.3%ï¼ˆ30 ä¸ªåŸºç‚¹ï¼‰ã€‚

### 5. B - é˜²æ­¢é™¤é›¶é”™è¯¯å’Œåˆå§‹ LP æ”»å‡»
**è§£æ**ï¼šé”å®šæœ€å°æµåŠ¨æ€§ï¼ˆé€šå¸¸æ˜¯ 1000ï¼‰å¯ä»¥é˜²æ­¢æ± å­è¢«å®Œå…¨æŠ½ç©ºå¯¼è‡´é™¤é›¶ï¼Œä¹Ÿèƒ½é˜²æ­¢æ”»å‡»è€…é€šè¿‡æå°çš„åˆå§‹æµåŠ¨æ€§æ“çºµä»·æ ¼ã€‚

### 6. C - key
**è§£æ**ï¼šåœ¨ Move ä¸­ï¼Œ`key` èƒ½åŠ›å…è®¸ç»“æ„ä½“ä½œä¸ºå…¨å±€å­˜å‚¨çš„é¡¶å±‚å¯¹è±¡ã€‚

### 7. C - å¢åŠ æˆ–ä¿æŒä¸å˜
**è§£æ**ï¼šç”±äºæ”¶å–äº†æ‰‹ç»­è´¹ï¼ŒSwap å K å€¼ä¼šç•¥å¾®å¢åŠ ã€‚å…¬å¼å˜ä¸º `(x + dx * 0.997) * (y - dy) >= x * y`ã€‚

### 8. C - é˜²æ­¢ä»·æ ¼å‰§çƒˆæ³¢åŠ¨å¯¼è‡´ç”¨æˆ·æŸå¤±
**è§£æ**ï¼šæ»‘ç‚¹ä¿æŠ¤é€šè¿‡è®¾ç½®æœ€å°è¾“å‡ºé‡ï¼Œé˜²æ­¢äº¤æ˜“æäº¤å’Œæ‰§è¡Œä¹‹é—´ä»·æ ¼å˜åŠ¨è¿‡å¤§å¯¼è‡´ç”¨æˆ·æŸå¤±ã€‚

### 9. B - äº¤æ˜“é‡‘é¢ç›¸å¯¹äºæ± å­å¤§å°
**è§£æ**ï¼šä»·æ ¼å½±å“ä¸»è¦ç”±äº¤æ˜“é‡‘é¢å æ± å­å‚¨å¤‡çš„æ¯”ä¾‹å†³å®šã€‚äº¤æ˜“é‡è¶Šå¤§ï¼Œä»·æ ¼å½±å“è¶Šå¤§ã€‚

### 10. B - è¾“å…¥æ•°é‡
**è§£æ**ï¼šExact Input Swap ä¸­ï¼Œç”¨æˆ·æŒ‡å®šè¾“å…¥å¤šå°‘ä»£å¸ï¼Œç³»ç»Ÿè®¡ç®—è¾“å‡ºæ•°é‡ã€‚

### 11. B - äº¤æ˜“æ‰‹ç»­è´¹
**è§£æ**ï¼šLP çš„æ”¶ç›Šä¸»è¦æ¥è‡ªæ¯ç¬”äº¤æ˜“çš„æ‰‹ç»­è´¹åˆ†æˆï¼ˆå¦‚ 0.3%ï¼‰ã€‚

### 12. B - ä»£å¸ä»·æ ¼ç›¸å¯¹å˜åŒ–
**è§£æ**ï¼šæ— å¸¸æŸå¤±å‘ç”Ÿåœ¨æ± å­ä¸­ä¸¤ç§ä»£å¸çš„ä»·æ ¼æ¯”ä¾‹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLP æŒæœ‰çš„ä»£å¸ä»·å€¼ç›¸æ¯”ç›´æ¥æŒæœ‰ä¼šæœ‰æŸå¤±ã€‚

### 13. B - Move çš„èµ„æºæ¨¡å‹å¤©ç„¶é˜²æ­¢
**è§£æ**ï¼šMove çš„èµ„æºæ‰€æœ‰æƒå’Œå€Ÿç”¨æ£€æŸ¥æœºåˆ¶åœ¨ç¼–è¯‘æ—¶å°±é˜²æ­¢äº†é‡å…¥æ”»å‡»ã€‚

### 14. B - è®°å½•å†å²æ“ä½œä¾›é“¾ä¸‹æŸ¥è¯¢
**è§£æ**ï¼šäº‹ä»¶ä¸»è¦ç”¨äºè®°å½•é“¾ä¸Šæ“ä½œï¼Œæ–¹ä¾¿å‰ç«¯ç›‘å¬å’Œé“¾ä¸‹ç´¢å¼•å™¨æŸ¥è¯¢å†å²æ•°æ®ã€‚

### 15. B - æä¾›å¤–éƒ¨ä»·æ ¼æ•°æ®
**è§£æ**ï¼šé¢„è¨€æœºå°†é“¾ä¸‹ä»·æ ¼æ•°æ®ï¼ˆå¦‚ CEX ä»·æ ¼ï¼‰æä¾›ç»™é“¾ä¸Šåˆçº¦ä½¿ç”¨ã€‚

### 16. B - äº¤æ˜“é€Ÿåº¦æ›´å¿«
**è§£æ**ï¼šDEX çš„äº¤æ˜“é€Ÿåº¦å—é™äºåŒºå—ç¡®è®¤æ—¶é—´ï¼Œé€šå¸¸æ¯”ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€æ…¢ã€‚

### 17. B - æ‰£é™¤ 0.3% æ‰‹ç»­è´¹åçš„ç³»æ•°
**è§£æ**ï¼š997/1000 = 0.997ï¼Œè¡¨ç¤ºæ‰£é™¤ 0.3% æ‰‹ç»­è´¹åå‰©ä½™ 99.7%ã€‚

### 18. B - é”å®šçš„æ€»ä»·å€¼
**è§£æ**ï¼šTVLï¼ˆTotal Value Lockedï¼‰è¡¨ç¤ºé”å®šåœ¨åè®®ä¸­çš„èµ„äº§æ€»ä»·å€¼ï¼Œé€šå¸¸ä»¥ç¾å…ƒè®¡ä»·ã€‚

### 19. B - #[view]
**è§£æ**ï¼šAptos ä¸­ï¼Œåªè¯»æŸ¥è¯¢å‡½æ•°ä½¿ç”¨ `#[view]` æ ‡æ³¨ï¼Œè¡¨ç¤ºä¸ä¿®æ”¹çŠ¶æ€ã€‚

### 20. B - é™ä½ä»·æ ¼å½±å“ï¼Œè·å¾—æ›´å¥½çš„ä»·æ ¼
**è§£æ**ï¼šå¤šè·³è·¯ç”±é€šè¿‡å¤šä¸ªæ± å­è¿›è¡Œäº¤æ¢ï¼Œå¯ä»¥è·å¾—æ¯”å•ä¸€æ± å­æ›´å¥½çš„ä»·æ ¼ã€‚

---

## ç¼–ç¨‹é¢˜ç­”æ¡ˆ

### ç¼–ç¨‹é¢˜ 1ï¼šLP Token è®¡ç®—

```move
module dex_addr::liquidity_calculator {
    use dex_addr::math;
    
    const MINIMUM_LIQUIDITY: u64 = 1000;
    
    /// è®¡ç®—åº”é“¸é€ çš„ LP Token æ•°é‡
    public fun calculate_liquidity_to_mint(
        amount_x: u64,
        amount_y: u64,
        reserve_x: u64,
        reserve_y: u64,
        total_supply: u64
    ): u64 {
        if (total_supply == 0) {
            // ç¬¬ä¸€æ¬¡æ·»åŠ æµåŠ¨æ€§
            let initial_liquidity = math::sqrt(
                (amount_x as u128) * (amount_y as u128)
            );
            assert!(
                initial_liquidity > MINIMUM_LIQUIDITY,
                ERROR_INSUFFICIENT_LIQUIDITY
            );
            initial_liquidity - MINIMUM_LIQUIDITY
        } else {
            // åç»­æ·»åŠ æµåŠ¨æ€§
            let liquidity_x = math::safe_mul_div(
                amount_x,
                total_supply,
                reserve_x
            );
            let liquidity_y = math::safe_mul_div(
                amount_y,
                total_supply,
                reserve_y
            );
            math::min(liquidity_x, liquidity_y)
        }
    }
}
```

**è¯„åˆ†è¦ç‚¹**ï¼š
- âœ… æ­£ç¡®å¤„ç†é¦–æ¬¡æ·»åŠ ï¼ˆtotal_supply == 0ï¼‰
- âœ… ä½¿ç”¨ sqrt è®¡ç®—åˆå§‹æµåŠ¨æ€§
- âœ… å‡å» MINIMUM_LIQUIDITY
- âœ… åç»­æ·»åŠ ä½¿ç”¨æ¯”ä¾‹è®¡ç®—
- âœ… å–ä¸¤ä¸ªå€¼çš„æœ€å°å€¼
- âœ… ä½¿ç”¨ u128 é¿å…æº¢å‡º

---

### ç¼–ç¨‹é¢˜ 2ï¼šSwap è¾“å‡ºè®¡ç®—

```move
module dex_addr::swap_calculator {
    const ERROR_ZERO_AMOUNT: u64 = 1;
    const ERROR_INSUFFICIENT_LIQUIDITY: u64 = 2;
    
    /// è®¡ç®— Swap è¾“å‡ºæ•°é‡
    public fun get_amount_out(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64
    ): u64 {
        // è¾“å…¥éªŒè¯
        assert!(amount_in > 0, ERROR_ZERO_AMOUNT);
        assert!(reserve_in > 0, ERROR_INSUFFICIENT_LIQUIDITY);
        assert!(reserve_out > 0, ERROR_INSUFFICIENT_LIQUIDITY);
        
        // ä½¿ç”¨ u128 è®¡ç®—é¿å…æº¢å‡º
        // æ‰£é™¤ 0.3% æ‰‹ç»­è´¹ï¼šamount_in * 997 / 1000
        let amount_in_with_fee = (amount_in as u128) * 997;
        let numerator = amount_in_with_fee * (reserve_out as u128);
        let denominator = (reserve_in as u128) * 1000 + amount_in_with_fee;
        
        ((numerator / denominator) as u64)
    }
}
```

**å…¬å¼æ¨å¯¼**ï¼š
```
è®¾ï¼š
- x = reserve_inï¼ˆè¾“å…¥ä»£å¸å‚¨å¤‡ï¼‰
- y = reserve_outï¼ˆè¾“å‡ºä»£å¸å‚¨å¤‡ï¼‰
- dx = amount_inï¼ˆè¾“å…¥æ•°é‡ï¼‰
- dy = amount_outï¼ˆè¾“å‡ºæ•°é‡ï¼‰
- fee = 0.3% = 3/1000

æ’å®šä¹˜ç§¯ï¼š
(x + dx * (1 - fee)) * (y - dy) = x * y

å±•å¼€ï¼š
(x + dx * 997/1000) * (y - dy) = x * y

æ±‚è§£ dyï¼š
dy = y - (x * y) / (x + dx * 997/1000)
   = y - (x * y * 1000) / (x * 1000 + dx * 997)
   = (y * (x * 1000 + dx * 997) - x * y * 1000) / (x * 1000 + dx * 997)
   = (dx * 997 * y) / (x * 1000 + dx * 997)

å› æ­¤ï¼š
numerator = dx * 997 * y
denominator = x * 1000 + dx * 997
amount_out = numerator / denominator
```

**è¯„åˆ†è¦ç‚¹**ï¼š
- âœ… è¾“å…¥éªŒè¯ï¼ˆamount_in, reserve_in, reserve_out > 0ï¼‰
- âœ… æ­£ç¡®è®¡ç®— amount_in_with_fee = amount_in * 997
- âœ… æ­£ç¡®è®¡ç®— numerator å’Œ denominator
- âœ… ä½¿ç”¨ u128 é¿å…æº¢å‡º
- âœ… è¿”å› u64 ç»“æœ

---

### ç¼–ç¨‹é¢˜ 3ï¼šå¸¦æ»‘ç‚¹ä¿æŠ¤çš„ Swap

```move
module dex_addr::swap_with_slippage {
    use std::signer;
    use aptos_framework::coin::{Self, Coin};
    
    const ERROR_ZERO_AMOUNT: u64 = 100;
    const ERROR_SLIPPAGE_EXCEEDED: u64 = 200;
    const ERROR_K_INVARIANT_VIOLATED: u64 = 201;
    
    /// Swap å‡½æ•°ï¼ˆå¸¦æ»‘ç‚¹ä¿æŠ¤ï¼‰
    public fun swap_exact_input<X, Y>(
        user: &signer,
        amount_in: u64,
        min_amount_out: u64,
        reserve_x: &mut Coin<X>,
        reserve_y: &mut Coin<Y>
    ): u64 {
        // 1. è·å–å½“å‰å‚¨å¤‡
        let reserve_in = coin::value(reserve_x);
        let reserve_out = coin::value(reserve_y);
        
        // 2. è®¡ç®—è¾“å‡º
        let amount_out = get_amount_out(amount_in, reserve_in, reserve_out);
        
        // 3. æ»‘ç‚¹ä¿æŠ¤
        assert!(
            amount_out >= min_amount_out,
            ERROR_SLIPPAGE_EXCEEDED
        );
        
        // 4. è½¬å…¥ä»£å¸
        let coins_in = coin::withdraw<X>(user, amount_in);
        coin::merge(reserve_x, coins_in);
        
        // 5. è½¬å‡ºä»£å¸
        let coins_out = coin::extract(reserve_y, amount_out);
        coin::deposit(signer::address_of(user), coins_out);
        
        // 6. éªŒè¯ K å€¼
        verify_k_invariant(
            reserve_in,
            reserve_out,
            coin::value(reserve_x),
            coin::value(reserve_y)
        );
        
        amount_out
    }
    
    /// è®¡ç®—è¾“å‡ºæ•°é‡
    fun get_amount_out(
        amount_in: u64,
        reserve_in: u64,
        reserve_out: u64
    ): u64 {
        assert!(amount_in > 0, ERROR_ZERO_AMOUNT);
        assert!(reserve_in > 0, ERROR_ZERO_AMOUNT);
        assert!(reserve_out > 0, ERROR_ZERO_AMOUNT);
        
        let amount_in_with_fee = (amount_in as u128) * 997;
        let numerator = amount_in_with_fee * (reserve_out as u128);
        let denominator = (reserve_in as u128) * 1000 + amount_in_with_fee;
        
        ((numerator / denominator) as u64)
    }
    
    /// éªŒè¯ K å€¼ä¸å˜æ€§
    fun verify_k_invariant(
        reserve_in_before: u64,
        reserve_out_before: u64,
        reserve_in_after: u64,
        reserve_out_after: u64
    ) {
        let k_before = (reserve_in_before as u128) * (reserve_out_before as u128);
        let k_after = (reserve_in_after as u128) * (reserve_out_after as u128);
        
        // Swap å K å€¼åº”è¯¥å¢åŠ ï¼ˆå› ä¸ºæ”¶å–äº†æ‰‹ç»­è´¹ï¼‰
        assert!(k_after >= k_before, ERROR_K_INVARIANT_VIOLATED);
    }
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
1. åˆå§‹çŠ¶æ€:
   - reserve_x = 1000 USDC
   - reserve_y = 50 APT
   - K_before = 1000 * 50 = 50,000

2. ç”¨æˆ·æ“ä½œ:
   - amount_in = 100 USDC
   - min_amount_out = 4 APT

3. è®¡ç®—è¾“å‡º:
   - amount_in_with_fee = 100 * 997 = 99,700
   - numerator = 99,700 * 50 = 4,985,000
   - denominator = 1000 * 1000 + 99,700 = 1,099,700
   - amount_out = 4,985,000 / 1,099,700 â‰ˆ 4.53 APT

4. æ»‘ç‚¹æ£€æŸ¥:
   - 4.53 >= 4 âœ… é€šè¿‡

5. æ‰§è¡Œäº¤æ¢:
   - reserve_x = 1000 + 100 = 1100 USDC
   - reserve_y = 50 - 4.53 = 45.47 APT

6. K å€¼éªŒè¯:
   - K_after = 1100 * 45.47 â‰ˆ 50,017
   - 50,017 >= 50,000 âœ… é€šè¿‡
```

**è¯„åˆ†è¦ç‚¹**ï¼š
- âœ… æ­£ç¡®è®¡ç®—è¾“å‡ºæ•°é‡
- âœ… æ»‘ç‚¹ä¿æŠ¤æ–­è¨€
- âœ… æ­£ç¡®è½¬ç§»ä»£å¸
- âœ… K å€¼éªŒè¯
- âœ… ä½¿ç”¨ u128 é¿å…æº¢å‡º
- âœ… é”™è¯¯ç å®šä¹‰åˆç†

---

## å¸¸è§é”™è¯¯

### 1. æ•´æ•°æº¢å‡º
```move
// âŒ é”™è¯¯
let result = a * b / c;  // å¯èƒ½æº¢å‡º

// âœ… æ­£ç¡®
let result = ((a as u128) * (b as u128) / (c as u128) as u64);
```

### 2. é™¤é›¶é”™è¯¯
```move
// âŒ é”™è¯¯
let result = a / b;  // b å¯èƒ½ä¸º 0

// âœ… æ­£ç¡®
assert!(b > 0, ERROR_DIVISION_BY_ZERO);
let result = a / b;
```

### 3. ç²¾åº¦ä¸¢å¤±
```move
// âŒ é”™è¯¯ï¼ˆå…ˆé™¤åä¹˜ï¼‰
let result = (a / b) * c;

// âœ… æ­£ç¡®ï¼ˆå…ˆä¹˜åé™¤ï¼‰
let result = (a * c) / b;
```

### 4. å¿˜è®°æ£€æŸ¥æ»‘ç‚¹
```move
// âŒ é”™è¯¯
let amount_out = calculate_output(...);
// ç›´æ¥æ‰§è¡Œ

// âœ… æ­£ç¡®
let amount_out = calculate_output(...);
assert!(amount_out >= min_amount_out, ERROR_SLIPPAGE);
```

---

## æ€»ç»“

### å…³é”®çŸ¥è¯†ç‚¹

1. **æ’å®šä¹˜ç§¯å…¬å¼**ï¼šx * y = k
2. **æ‰‹ç»­è´¹å¤„ç†**ï¼šä»è¾“å…¥ä¸­æ‰£é™¤ 0.3%
3. **LP Token è®¡ç®—**ï¼šsqrt(x * y) æˆ–æŒ‰æ¯”ä¾‹
4. **æ»‘ç‚¹ä¿æŠ¤**ï¼šè®¾ç½®æœ€å°è¾“å‡º
5. **K å€¼éªŒè¯**ï¼šç¡®ä¿ä¸å‡å°‘

### å­¦ä¹ å»ºè®®

1. æ·±å…¥ç†è§£ AMM æ•°å­¦åŸç†
2. ç†Ÿç»ƒä½¿ç”¨ u128 é¿å…æº¢å‡º
3. é‡è§†è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†
4. ç¼–å†™å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹
5. é˜…è¯»ä¼˜ç§€å¼€æºé¡¹ç›®ä»£ç 

---

**æ­å–œä½ å®Œæˆ Week 3 çš„å­¦ä¹ ï¼ğŸ‰**

ä½ å·²ç»æŒæ¡ï¼š
- âœ… ä»£å¸æ ‡å‡†å’Œç®¡ç†
- âœ… AMM åŸç†å’Œå®ç°
- âœ… æµåŠ¨æ€§æ± ç®¡ç†
- âœ… Swap åŠŸèƒ½å¼€å‘
- âœ… é¢„è¨€æœºé›†æˆ
- âœ… å®Œæ•´ DEX å¼€å‘

ç»§ç»­åŠ æ²¹ï¼ğŸ’ª
