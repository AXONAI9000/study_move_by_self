# Day 23 实践任务：NFT Collection 与 Token 管理

## 任务概述

通过五个递进式任务，掌握 Aptos Token Standard v2 的核心功能，构建一个完整的 NFT 系统。

---

## 任务一：创建艺术品 NFT Collection（2小时）

### 任务目标
创建一个艺术品 NFT Collection，支持固定供应量和版税配置。

### 具体要求

1. **Collection 配置**
   - 名称：`Art Gallery Collection`
   - 最大供应量：1000
   - 版税：5%（500/10000）
   - 描述信息和 URI

2. **核心功能**
   ```move
   module art_nft::art_collection {
       use std::string::String;
       use aptos_token_objects::collection;
       use aptos_token_objects::royalty;
       
       public entry fun create_art_collection(
           creator: &signer,
           description: String,
           name: String,
           uri: String,
       );
   }
   ```

3. **技术要点**
   - 使用 `collection::create_fixed_collection`
   - 正确配置版税（numerator/denominator）
   - 存储 Collection 配置和统计信息
   - 发出 Collection 创建事件

4. **验收标准**
   - Collection 创建成功
   - 版税信息正确配置
   - 最大供应量限制生效
   - 事件正确发出

### 提示
- 版税比例 = royalty_numerator / royalty_denominator
- 需要保存 `MutatorRef` 用于后续修改
- Collection 地址可通过 `create_collection_address` 计算

---

## 任务二：实现 NFT 铸造系统（2.5小时）

### 任务目标
实现完整的 NFT 铸造功能，包括基础铸造、批量铸造和直接转移。

### 具体要求

1. **基础铸造**
   ```move
   public entry fun mint_artwork(
       creator: &signer,
       collection_name: String,
       artwork_name: String,
       description: String,
       uri: String,
       // 艺术品属性
       artist: String,
       created_year: u64,
       medium: String,
   ) acquires CollectionStats;
   ```

2. **批量铸造**
   ```move
   public entry fun batch_mint_artworks(
       creator: &signer,
       collection_name: String,
       artworks: vector<ArtworkData>,
   ) acquires CollectionStats;
   ```

3. **铸造并转移**
   ```move
   public entry fun mint_and_gift(
       creator: &signer,
       collection_name: String,
       artwork_name: String,
       description: String,
       uri: String,
       recipient: address,
   ) acquires CollectionStats;
   ```

4. **供应量检查**
   - 铸造前检查是否达到最大供应量
   - 更新 `CollectionStats.minted_count`
   - 发出 Token 铸造事件

5. **验收标准**
   - 单个铸造功能正常
   - 批量铸造成功
   - 供应量限制生效
   - 转移功能正确
   - 事件完整记录

### 数据结构参考
```move
struct ArtworkData has drop, store {
    name: String,
    description: String,
    uri: String,
    artist: String,
    created_year: u64,
    medium: String,
}
```

---

## 任务三：属性管理系统（2小时）

### 任务目标
实现完整的 NFT 属性（Property Map）管理功能。

### 具体要求

1. **初始化属性**
   ```move
   public entry fun initialize_artwork_properties(
       creator: &signer,
       token: Object<Token>,
       artist: String,
       created_year: u64,
       medium: String,
       edition: u64,
       is_signed: bool,
   ) acquires TokenRefs;
   ```

2. **更新属性**
   ```move
   // 更新所有权历史
   public entry fun add_ownership_record(
       owner: &signer,
       token: Object<Token>,
       previous_owner: address,
       sale_price: u64,
       sale_date: u64,
   ) acquires TokenRefs;
   
   // 更新展览历史
   public entry fun add_exhibition_record(
       curator: &signer,
       token: Object<Token>,
       exhibition_name: String,
       location: String,
       date: u64,
   ) acquires TokenRefs;
   ```

3. **查询属性**
   ```move
   public fun get_artwork_info(token: Object<Token>): ArtworkInfo;
   
   struct ArtworkInfo has drop {
       artist: String,
       created_year: u64,
       medium: String,
       edition: u64,
       ownership_count: u64,
       exhibition_count: u64,
   }
   ```

4. **验收标准**
   - 属性正确初始化
   - 不同类型属性（u64, String, bool, address）都能正确处理
   - 属性更新权限控制
   - 查询功能完整

### 技术要点
- 使用 `property_map::add_typed` 添加属性
- 使用 `property_map::update_typed` 更新属性
- 使用 `property_map::read_*` 读取属性
- 保存 `PropertyMutatorRef` 用于修改

---

## 任务四：NFT 转移与交易（2小时）

### 任务目标
实现 NFT 的转移、交易和版税分配功能。

### 具体要求

1. **基础转移**
   ```move
   public entry fun transfer_artwork(
       owner: &signer,
       token: Object<Token>,
       to: address,
   ) acquires TokenRefs;
   ```

2. **安全交易**
   ```move
   public entry fun safe_transfer_with_verification(
       owner: &signer,
       token: Object<Token>,
       to: address,
       expected_price: u64,
   ) acquires TokenRefs;
   ```

3. **版税支付**
   ```move
   public entry fun transfer_with_royalty(
       buyer: &signer,
       token: Object<Token>,
       seller: address,
       price: u64,
   ) acquires TokenRefs;
   ```
   - 计算版税金额
   - 分配给创作者
   - 剩余部分给卖家

4. **转移历史**
   - 记录每次转移的时间、价格、双方地址
   - 更新 Token 的 `ownership_count` 属性
   - 发出转移事件

5. **验收标准**
   - 所有权验证正确
   - 版税计算准确
   - 转移历史完整
   - 事件正确发出

---

## 任务五：NFT 查询与统计系统（1.5小时）

### 任务目标
实现全面的 NFT 查询和统计功能。

### 具体要求

1. **Collection 统计**
   ```move
   public fun get_collection_info(collection: Object<Collection>): CollectionInfo;
   
   struct CollectionInfo has drop {
       name: String,
       creator: address,
       description: String,
       uri: String,
       minted_count: u64,
       max_supply: u64,
       royalty_percentage: u64,
   }
   ```

2. **Token 查询**
   ```move
   // 获取 Token 详细信息
   public fun get_token_details(token: Object<Token>): TokenDetails;
   
   struct TokenDetails has drop {
       name: String,
       description: String,
       uri: String,
       owner: address,
       collection_name: String,
       properties: vector<PropertyInfo>,
   }
   
   struct PropertyInfo has drop, copy {
       key: String,
       value: vector<u8>,
       type: String,
   }
   ```

3. **所有权查询**
   ```move
   // 检查地址是否拥有特定 Token
   public fun is_owner(account: address, token: Object<Token>): bool;
   
   // 获取 Token 当前所有者
   public fun get_current_owner(token: Object<Token>): address;
   ```

4. **供应量查询**
   ```move
   // 获取剩余可铸造数量
   public fun get_remaining_supply(collection: Object<Collection>): u64 acquires CollectionStats;
   
   // 检查是否可以铸造
   public fun can_mint_more(collection: Object<Collection>): bool acquires CollectionStats;
   ```

5. **验收标准**
   - 所有查询函数返回正确数据
   - 统计信息准确
   - 性能优化（避免不必要的计算）

---

## 综合测试要求

### 完整流程测试
```move
#[test_only]
module art_nft::integration_test {
    #[test(creator = @0x123, user1 = @0x456, user2 = @0x789)]
    public fun test_full_workflow(
        creator: &signer,
        user1: &signer,
        user2: &signer,
    ) {
        // 1. 创建 Collection
        create_art_collection(...);
        
        // 2. 铸造 NFT
        mint_artwork(...);
        
        // 3. 设置属性
        initialize_artwork_properties(...);
        
        // 4. 转移给 user1
        transfer_artwork(creator, token, user1_addr);
        
        // 5. user1 转移给 user2（带版税）
        transfer_with_royalty(user2, token, user1_addr, price);
        
        // 6. 查询验证
        let info = get_token_details(token);
        assert!(info.owner == user2_addr, 1);
        
        // 7. 统计验证
        let (minted, max) = get_collection_stats(collection);
        assert!(minted == 1, 2);
    }
}
```

### 边界测试
1. **供应量限制**
   - 达到 max_supply 时铸造失败
   - minted_count 正确更新

2. **权限控制**
   - 非所有者无法转移
   - 非创建者无法修改某些属性

3. **版税计算**
   - 边界值测试（0%, 100%）
   - 精度测试

---

## 提交要求

### 代码组织
```
sources/
├── art_collection.move      # Collection 管理
├── artwork_token.move        # Token 铸造
├── property_manager.move     # 属性管理
├── transfer_handler.move     # 转移与交易
└── query_service.move        # 查询功能

tests/
├── collection_tests.move     # Collection 测试
├── minting_tests.move        # 铸造测试
├── property_tests.move       # 属性测试
├── transfer_tests.move       # 转移测试
└── integration_tests.move    # 集成测试
```

### 文档要求
1. **README.md**
   - 项目说明
   - 功能列表
   - 使用示例
   - 测试说明

2. **API文档**
   - 每个公共函数的说明
   - 参数说明
   - 返回值说明
   - 使用示例

3. **测试报告**
   - 测试覆盖率
   - 测试用例列表
   - 测试结果

---

## 评分标准

| 项目 | 分数 | 说明 |
|------|------|------|
| 任务一：Collection创建 | 15分 | 功能完整性、配置正确性 |
| 任务二：NFT铸造 | 20分 | 单个/批量铸造、供应量控制 |
| 任务三：属性管理 | 20分 | 属性增删改查、类型支持 |
| 任务四：转移与交易 | 20分 | 权限控制、版税计算 |
| 任务五：查询统计 | 15分 | 数据准确性、接口完整性 |
| 代码质量 | 5分 | 命名规范、注释完整 |
| 测试覆盖 | 5分 | 单元测试、集成测试 |
| **总分** | **100分** | |

---

## 学习资源

### 官方文档
- [Aptos Token Standard](https://aptos.dev/standards/aptos-token/)
- [Object Model Guide](https://aptos.dev/standards/aptos-object/)
- [Property Map API](https://aptos.dev/standards/aptos-token-objects/)

### 参考实现
- Aptos Token Objects 标准库源码
- 官方示例：Digital Asset Standard

### 调试技巧
1. 使用 `aptos move test` 运行测试
2. 使用 `--verbose` 查看详细输出
3. 使用 `#[expected_failure]` 测试错误场景

---

## 常见问题

### Q1: Collection 创建后如何获取地址？
```move
let collection_addr = collection::create_collection_address(
    &creator_addr,
    &collection_name
);
```

### Q2: 如何计算版税金额？
```move
let royalty_amount = (price * royalty_numerator) / royalty_denominator;
let seller_amount = price - royalty_amount;
```

### Q3: Property Map 支持哪些类型？
- `u8`, `u64`, `u128`, `u256`
- `bool`
- `address`
- `String`
- `vector<u8>`

### Q4: 如何禁止 Token 转移？
在创建 Token 时不生成 `TransferRef`，或者使用 `object::disable_ungated_transfer`。

---

## 扩展挑战（可选）

1. **拍卖系统**
   - 实现英式拍卖
   - 出价记录
   - 自动结算

2. **盲盒机制**
   - 随机属性生成
   - 开盒逻辑
   - 稀有度系统

3. **合成系统**
   - 多个 NFT 合成新 NFT
   - 销毁原 NFT
   - 属性继承

4. **租赁系统**
   - 临时使用权转移
   - 自动归还
   - 租金分配

---

**预计完成时间**：10小时  
**难度等级**：⭐⭐⭐⭐（中高级）
