# Day 10 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

## è¯´æ˜
- å…± 2 é“ç¼–ç¨‹é¢˜ï¼Œå…± 50 åˆ†
- éœ€è¦ç¼–å†™å®Œæ•´çš„ Move ä»£ç å’Œå½¢å¼åŒ–è§„çº¦
- ä»£ç å¿…é¡»é€šè¿‡ Move Prover éªŒè¯
- è¯„åˆ†æ ‡å‡†è§æ¯é¢˜æœ«å°¾

---

## ç¼–ç¨‹é¢˜ 1ï¼šéªŒè¯å®‰å…¨çš„æ•°å­¦åº“ï¼ˆ25 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå®‰å…¨çš„æ•°å­¦åº“æ¨¡å— `safe_math`ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼Œå¹¶ä¸ºæ¯ä¸ªå‡½æ•°ç¼–å†™å®Œæ•´çš„å½¢å¼åŒ–è§„çº¦ï¼š

1. **å®‰å…¨åŠ æ³•** `safe_add(a: u64, b: u64): u64`
   - å½“ä¼šæº¢å‡ºæ—¶ abort
   - è¿”å›æ­£ç¡®çš„å’Œ

2. **å®‰å…¨å‡æ³•** `safe_sub(a: u64, b: u64): u64`
   - å½“ä¼šä¸‹æº¢æ—¶ abort
   - è¿”å›æ­£ç¡®çš„å·®

3. **å®‰å…¨ä¹˜æ³•** `safe_mul(a: u64, b: u64): u64`
   - å½“ä¼šæº¢å‡ºæ—¶ abort
   - è¿”å›æ­£ç¡®çš„ç§¯

4. **ç™¾åˆ†æ¯”è®¡ç®—** `percentage(value: u64, percent: u64): u64`
   - è®¡ç®— value çš„ percent%
   - percent èŒƒå›´ï¼š0-100
   - ä¸æº¢å‡º
   - ç¤ºä¾‹ï¼š`percentage(200, 50)` è¿”å› 100

### è¦æ±‚

1. å®šä¹‰æ¸…æ™°çš„é”™è¯¯ç å¸¸é‡
2. æ¯ä¸ªå‡½æ•°éƒ½è¦æœ‰å®Œæ•´çš„è§„çº¦ï¼š
   - å‰ç½®æ¡ä»¶ï¼ˆrequiresï¼‰
   - åç½®æ¡ä»¶ï¼ˆensuresï¼‰
   - ä¸­æ­¢æ¡ä»¶ï¼ˆaborts_ifï¼‰
3. è§„çº¦è¦è¯æ˜ï¼š
   - æº¢å‡º/ä¸‹æº¢æ¡ä»¶
   - è¿”å›å€¼çš„æ­£ç¡®æ€§
   - åŸºæœ¬æ•°å­¦æ€§è´¨ï¼ˆå¦‚äº¤æ¢å¾‹ã€ç»“åˆå¾‹ç­‰ï¼Œå¦‚æœé€‚ç”¨ï¼‰
4. å¿…é¡»é€šè¿‡ `aptos move prove --dev`

### èµ·å§‹ä»£ç 

```move
module exam::safe_math {
    /// é”™è¯¯ç 
    const ERROR_OVERFLOW: u64 = 1;
    const ERROR_UNDERFLOW: u64 = 2;
    const ERROR_INVALID_PERCENT: u64 = 3;

    /// TODO: å®ç°å®‰å…¨åŠ æ³•å¹¶æ·»åŠ è§„çº¦
    public fun safe_add(a: u64, b: u64): u64 {
        // ä½ çš„ä»£ç 
    }

    spec safe_add {
        // ä½ çš„è§„çº¦
    }

    /// TODO: å®ç°å®‰å…¨å‡æ³•å¹¶æ·»åŠ è§„çº¦
    public fun safe_sub(a: u64, b: u64): u64 {
        // ä½ çš„ä»£ç 
    }

    spec safe_sub {
        // ä½ çš„è§„çº¦
    }

    /// TODO: å®ç°å®‰å…¨ä¹˜æ³•å¹¶æ·»åŠ è§„çº¦
    public fun safe_mul(a: u64, b: u64): u64 {
        // ä½ çš„ä»£ç 
    }

    spec safe_mul {
        // ä½ çš„è§„çº¦
    }

    /// TODO: å®ç°ç™¾åˆ†æ¯”è®¡ç®—å¹¶æ·»åŠ è§„çº¦
    public fun percentage(value: u64, percent: u64): u64 {
        // ä½ çš„ä»£ç 
    }

    spec percentage {
        // ä½ çš„è§„çº¦
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test]
public fun test_safe_add() {
    assert!(safe_add(100, 200) == 300, 0);
    assert!(safe_add(0, 0) == 0, 1);
}

#[test]
#[expected_failure(abort_code = ERROR_OVERFLOW)]
public fun test_safe_add_overflow() {
    safe_add(18446744073709551615, 1);
}

#[test]
public fun test_safe_sub() {
    assert!(safe_sub(200, 100) == 100, 0);
    assert!(safe_sub(100, 100) == 0, 1);
}

#[test]
#[expected_failure(abort_code = ERROR_UNDERFLOW)]
public fun test_safe_sub_underflow() {
    safe_sub(100, 200);
}

#[test]
public fun test_percentage() {
    assert!(percentage(200, 50) == 100, 0);
    assert!(percentage(1000, 10) == 100, 1);
    assert!(percentage(100, 0) == 0, 2);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ25 åˆ†ï¼‰

- **ä»£ç å®ç°ï¼ˆ10 åˆ†ï¼‰**
  - æ‰€æœ‰å‡½æ•°æ­£ç¡®å®ç°ï¼š6 åˆ†
  - é”™è¯¯å¤„ç†å®Œå–„ï¼š2 åˆ†
  - ä»£ç é£æ ¼è‰¯å¥½ï¼š2 åˆ†

- **è§„çº¦ç¼–å†™ï¼ˆ12 åˆ†ï¼‰**
  - å‰ç½®æ¡ä»¶æ­£ç¡®å®Œæ•´ï¼š4 åˆ†
  - åç½®æ¡ä»¶æ­£ç¡®å®Œæ•´ï¼š4 åˆ†
  - ä¸­æ­¢æ¡ä»¶æ­£ç¡®å®Œæ•´ï¼š4 åˆ†

- **éªŒè¯é€šè¿‡ï¼ˆ3 åˆ†ï¼‰**
  - é€šè¿‡ Move Prover éªŒè¯ï¼š3 åˆ†

---

## ç¼–ç¨‹é¢˜ 2ï¼šéªŒè¯è´¦æˆ·ç³»ç»Ÿçš„ä¸å˜é‡ï¼ˆ25 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªè´¦æˆ·ç³»ç»Ÿ `account_system`ï¼Œæ”¯æŒåˆ›å»ºè´¦æˆ·ã€å­˜æ¬¾ã€å–æ¬¾å’Œè½¬è´¦ã€‚å…³é”®è¦æ±‚ï¼š**è¯æ˜ç³»ç»Ÿçš„æ€»ä½™é¢ä¸å˜æ€§**ã€‚

### åŠŸèƒ½è¦æ±‚

1. **åˆ›å»ºè´¦æˆ·** `create_account(owner: &signer, initial_balance: u64)`
   - åˆ›å»ºæ–°è´¦æˆ·å¹¶è®¾ç½®åˆå§‹ä½™é¢
   - å¢åŠ ç³»ç»Ÿæ€»ä½™é¢

2. **å­˜æ¬¾** `deposit(addr: address, amount: u64)`
   - å¢åŠ è´¦æˆ·ä½™é¢
   - å¢åŠ ç³»ç»Ÿæ€»ä½™é¢

3. **å–æ¬¾** `withdraw(owner: &signer, amount: u64)`
   - å‡å°‘è´¦æˆ·ä½™é¢
   - å‡å°‘ç³»ç»Ÿæ€»ä½™é¢

4. **è½¬è´¦** `transfer(from: &signer, to: address, amount: u64)`
   - ä»ä¸€ä¸ªè´¦æˆ·è½¬åˆ°å¦ä¸€ä¸ªè´¦æˆ·
   - **å…³é”®**ï¼šç³»ç»Ÿæ€»ä½™é¢ä¸å˜

5. **æŸ¥è¯¢** `balance_of(addr: address): u64` å’Œ `total_balance(): u64`

### æ•°æ®ç»“æ„

```move
/// è´¦æˆ·èµ„æº
struct Account has key {
    balance: u64
}

/// å…¨å±€çŠ¶æ€ï¼ˆè·Ÿè¸ªæ€»ä½™é¢ï¼‰
struct GlobalState has key {
    total_balance: u64
}
```

### è¦æ±‚

1. å®šä¹‰é”™è¯¯ç å¸¸é‡
2. æ¯ä¸ªå‡½æ•°éƒ½è¦æœ‰å®Œæ•´çš„è§„çº¦
3. **æ ¸å¿ƒè¦æ±‚**ï¼š
   - å®šä¹‰æ¨¡å—çº§ä¸å˜é‡ï¼š`GlobalState.total_balance == æ‰€æœ‰è´¦æˆ·ä½™é¢ä¹‹å’Œ`
   - åœ¨è½¬è´¦å‡½æ•°ä¸­è¯æ˜æ€»ä½™é¢ä¸å˜
   - åœ¨å­˜æ¬¾/å–æ¬¾å‡½æ•°ä¸­æ­£ç¡®ç»´æŠ¤æ€»ä½™é¢
4. å¿…é¡»é€šè¿‡ `aptos move prove --dev`

### èµ·å§‹ä»£ç 

```move
module exam::account_system {
    use std::signer;

    /// é”™è¯¯ç 
    const ERROR_ACCOUNT_EXISTS: u64 = 1;
    const ERROR_ACCOUNT_NOT_FOUND: u64 = 2;
    const ERROR_INSUFFICIENT_BALANCE: u64 = 3;
    const ERROR_INVALID_AMOUNT: u64 = 4;
    const ERROR_OVERFLOW: u64 = 5;
    const ERROR_NOT_INITIALIZED: u64 = 6;

    /// è´¦æˆ·èµ„æº
    struct Account has key {
        balance: u64
    }

    /// å…¨å±€çŠ¶æ€
    struct GlobalState has key {
        total_balance: u64
    }

    /// TODO: å®šä¹‰æ¨¡å—çº§ä¸å˜é‡
    spec module {
        // ä¸å˜é‡ï¼šæ€»ä½™é¢ç­‰äºæ‰€æœ‰è´¦æˆ·ä½™é¢ä¹‹å’Œ
        // æç¤ºï¼šä½¿ç”¨ forall é‡è¯
    }

    /// TODO: åˆå§‹åŒ–å…¨å±€çŠ¶æ€
    public fun initialize(admin: &signer) {
        // ä½ çš„ä»£ç 
    }

    spec initialize {
        // ä½ çš„è§„çº¦
    }

    /// TODO: åˆ›å»ºè´¦æˆ·
    public fun create_account(owner: &signer, initial_balance: u64) acquires GlobalState {
        // ä½ çš„ä»£ç 
    }

    spec create_account {
        // ä½ çš„è§„çº¦
    }

    /// TODO: å­˜æ¬¾
    public fun deposit(addr: address, amount: u64) acquires Account, GlobalState {
        // ä½ çš„ä»£ç 
    }

    spec deposit {
        // ä½ çš„è§„çº¦
    }

    /// TODO: å–æ¬¾
    public fun withdraw(owner: &signer, amount: u64) acquires Account, GlobalState {
        // ä½ çš„ä»£ç 
    }

    spec withdraw {
        // ä½ çš„è§„çº¦
    }

    /// TODO: è½¬è´¦
    public fun transfer(from: &signer, to: address, amount: u64) acquires Account, GlobalState {
        // ä½ çš„ä»£ç 
        // å…³é”®ï¼šæ€»ä½™é¢ä¸å˜ï¼
    }

    spec transfer {
        // ä½ çš„è§„çº¦
        // å¿…é¡»è¯æ˜ï¼šglobal<GlobalState>(@exam).total_balance ä¸å˜
    }

    /// æŸ¥è¯¢ä½™é¢
    public fun balance_of(addr: address): u64 acquires Account {
        if (!exists<Account>(addr)) {
            0
        } else {
            borrow_global<Account>(addr).balance
        }
    }

    spec balance_of {
        ensures result == if (exists<Account>(addr)) {
            global<Account>(addr).balance
        } else {
            0
        };
        aborts_if false;
    }

    /// æŸ¥è¯¢æ€»ä½™é¢
    public fun total_balance(): u64 acquires GlobalState {
        assert!(exists<GlobalState>(@exam), ERROR_NOT_INITIALIZED);
        borrow_global<GlobalState>(@exam).total_balance
    }

    spec total_balance {
        requires exists<GlobalState>(@exam);
        ensures result == global<GlobalState>(@exam).total_balance;
        aborts_if !exists<GlobalState>(@exam);
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test(admin = @exam, user1 = @0x100, user2 = @0x200)]
public fun test_transfer_preserves_total(admin: &signer, user1: &signer, user2: &signer) {
    initialize(admin);
    create_account(user1, 1000);
    create_account(user2, 500);
    
    let total_before = total_balance();
    transfer(user1, signer::address_of(user2), 300);
    let total_after = total_balance();
    
    assert!(total_before == total_after, 0);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ25 åˆ†ï¼‰

- **ä»£ç å®ç°ï¼ˆ10 åˆ†ï¼‰**
  - æ‰€æœ‰å‡½æ•°æ­£ç¡®å®ç°ï¼š6 åˆ†
  - æ­£ç¡®ç»´æŠ¤ GlobalStateï¼š2 åˆ†
  - é”™è¯¯å¤„ç†å®Œå–„ï¼š2 åˆ†

- **è§„çº¦ç¼–å†™ï¼ˆ10 åˆ†ï¼‰**
  - æ¯ä¸ªå‡½æ•°çš„è§„çº¦æ­£ç¡®ï¼š5 åˆ†
  - æ¨¡å—çº§ä¸å˜é‡æ­£ç¡®ï¼š3 åˆ†
  - è½¬è´¦å‡½æ•°è¯æ˜æ€»ä½™é¢ä¸å˜ï¼š2 åˆ†

- **éªŒè¯é€šè¿‡ï¼ˆ5 åˆ†ï¼‰**
  - é€šè¿‡ Move Prover éªŒè¯ï¼š5 åˆ†

---

## æäº¤è¦æ±‚

### æ–‡ä»¶å‘½å
- ç¼–ç¨‹é¢˜ 1ï¼š`exam_safe_math.move`
- ç¼–ç¨‹é¢˜ 2ï¼š`exam_account_system.move`

### éªŒè¯è¦æ±‚

ä¸¤ä¸ªæ–‡ä»¶éƒ½å¿…é¡»é€šè¿‡å½¢å¼åŒ–éªŒè¯ï¼š
```bash
aptos move prove --dev
```

è¾“å‡ºåº”è¯¥ç±»ä¼¼ï¼š
```
âœ“ exam::safe_math::safe_add
âœ“ exam::safe_math::safe_sub
âœ“ exam::safe_math::safe_mul
âœ“ exam::safe_math::percentage
âœ“ exam::account_system::initialize
âœ“ exam::account_system::create_account
âœ“ exam::account_system::deposit
âœ“ exam::account_system::withdraw
âœ“ exam::account_system::transfer
All proofs succeeded!
```

---

## ğŸ’¡ æç¤º

### ç¼–ç¨‹é¢˜ 1 æç¤º
1. `safe_add` çš„æº¢å‡ºæ¡ä»¶ï¼š`a > MAX_U64 - b`
2. `safe_mul` å¯ä»¥ç”¨é™¤æ³•æ£€æŸ¥ï¼š`result / a == b`
3. `percentage` å…ˆä¹˜åé™¤ï¼Œæ³¨æ„æº¢å‡º

### ç¼–ç¨‹é¢˜ 2 æç¤º
1. æ¨¡å—çº§ä¸å˜é‡éœ€è¦ä½¿ç”¨é‡è¯éå†æ‰€æœ‰åœ°å€
2. è½¬è´¦æ—¶ GlobalState ä¸å˜ï¼Œåªæœ‰è´¦æˆ·ä½™é¢å˜åŒ–
3. å­˜æ¬¾/å–æ¬¾è¦åŒæ­¥æ›´æ–° GlobalState
4. ä½¿ç”¨ `old()` è¡¨è¾¾å¼æ¯”è¾ƒçŠ¶æ€å˜åŒ–

---

## æ—¶é—´åˆ†é…å»ºè®®

- **ç¼–ç¨‹é¢˜ 1ï¼ˆ30 åˆ†é’Ÿï¼‰**
  - å®ç°ä»£ç ï¼š10 åˆ†é’Ÿ
  - ç¼–å†™è§„çº¦ï¼š15 åˆ†é’Ÿ
  - è°ƒè¯•éªŒè¯ï¼š5 åˆ†é’Ÿ

- **ç¼–ç¨‹é¢˜ 2ï¼ˆ30 åˆ†é’Ÿï¼‰**
  - å®ç°ä»£ç ï¼š12 åˆ†é’Ÿ
  - ç¼–å†™è§„çº¦ï¼š15 åˆ†é’Ÿ
  - è°ƒè¯•éªŒè¯ï¼š3 åˆ†é’Ÿ

---

**ç¥ä½ è€ƒè¯•é¡ºåˆ©ï¼è®°ä½ï¼šè§„çº¦å°±æ˜¯ç”¨æ•°å­¦è¯­è¨€æè¿°ä»£ç çš„è¡Œä¸ºã€‚** ğŸ¯ğŸ’ª
