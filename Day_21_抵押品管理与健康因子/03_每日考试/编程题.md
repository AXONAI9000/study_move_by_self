# Day 21 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

## ğŸ“ è€ƒè¯•è¯´æ˜

- **é¢˜ç›®æ•°é‡**ï¼š5 é¢˜
- **è€ƒè¯•æ—¶é—´**ï¼š90 åˆ†é’Ÿ
- **æ€»åˆ†**ï¼š100 åˆ†
- **åŠæ ¼åˆ†æ•°**ï¼š60 åˆ†

---

## ç¼–ç¨‹é¢˜éƒ¨åˆ†

### ç¬¬ 1 é¢˜ï¼šå®ç°å¥åº·å› å­è®¡ç®—å™¨ï¼ˆ20 åˆ†ï¼‰â­â­â­

**é¢˜ç›®æè¿°**ï¼š

å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—ç”¨æˆ·çš„å¥åº·å› å­ã€‚è¦æ±‚æ”¯æŒå¤šèµ„äº§æŠµæŠ¼å’Œå¤šèµ„äº§å€Ÿæ¬¾ã€‚

**å‡½æ•°ç­¾å**ï¼š

```move
public fun calculate_health_factor(
    collaterals: vector<CollateralInfo>,
    borrows: vector<BorrowInfo>,
): u128
```

**æ•°æ®ç»“æ„**ï¼š

```move
struct CollateralInfo has drop {
    amount: u128,           // èµ„äº§æ•°é‡
    price: u128,            // ä»·æ ¼ï¼ˆç²¾åº¦ 1e8ï¼‰
    collateral_factor: u128, // æŠµæŠ¼ç‡ï¼ˆç²¾åº¦ 1e6ï¼‰
}

struct BorrowInfo has drop {
    amount: u128,           // å€Ÿæ¬¾æ•°é‡
    price: u128,            // ä»·æ ¼ï¼ˆç²¾åº¦ 1e8ï¼‰
}
```

**è¾“å…¥ç¤ºä¾‹**ï¼š

```move
// æŠµæŠ¼å“
let collaterals = vector[
    CollateralInfo {
        amount: 100_000_000,      // 1 ETH
        price: 200_000_000_000,   // $2000
        collateral_factor: 750_000, // 75%
    },
    CollateralInfo {
        amount: 1000_000_000,     // 1000 USDC
        price: 100_000_000,       // $1
        collateral_factor: 800_000, // 80%
    },
];

// å€Ÿæ¬¾
let borrows = vector[
    BorrowInfo {
        amount: 1500_000_000,     // 1500 USDC
        price: 100_000_000,       // $1
    },
];
```

**é¢„æœŸè¾“å‡º**ï¼š

```
å¥åº·å› å­ = 1.533... Ã— 1e18
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- åŸºç¡€å®ç°ï¼ˆ10 åˆ†ï¼‰ï¼šæ­£ç¡®è®¡ç®—å•èµ„äº§åœºæ™¯
- å®Œæ•´å®ç°ï¼ˆ15 åˆ†ï¼‰ï¼šæ­£ç¡®å¤„ç†å¤šèµ„äº§åœºæ™¯
- è¾¹ç•Œå¤„ç†ï¼ˆ5 åˆ†ï¼‰ï¼šæ­£ç¡®å¤„ç†æ— å€ºåŠ¡ã€æ— æŠµæŠ¼ç­‰æƒ…å†µ

**è¦æ±‚**ï¼š
- âœ… ä½¿ç”¨ 1e18 ç²¾åº¦è¡¨ç¤ºå¥åº·å› å­
- âœ… æ­£ç¡®å¤„ç†ç²¾åº¦è½¬æ¢
- âœ… å¤„ç†é™¤é›¶æƒ…å†µ
- âœ… åŒ…å«å•å…ƒæµ‹è¯•

---

### ç¬¬ 2 é¢˜ï¼šå®ç°æŠµæŠ¼å“å¯ç”¨/ç¦ç”¨ï¼ˆ25 åˆ†ï¼‰â­â­â­â­

**é¢˜ç›®æè¿°**ï¼š

å®ç°æŠµæŠ¼å“çš„å¯ç”¨å’Œç¦ç”¨åŠŸèƒ½ã€‚å¯ç”¨æ—¶æ·»åŠ åˆ°æŠµæŠ¼å“åˆ—è¡¨ï¼Œç¦ç”¨æ—¶éœ€è¦æ£€æŸ¥å¥åº·å› å­æ˜¯å¦å®‰å…¨ã€‚

**è¦æ±‚å®ç°**ï¼š

```move
module collateral_exam::collateral_manager {
    
    struct UserAccount has key {
        deposits: Table<vector<u8>, u128>,      // å­˜æ¬¾
        collaterals: vector<vector<u8>>,        // å·²å¯ç”¨çš„æŠµæŠ¼å“
        borrows: Table<vector<u8>, u128>,       // å€Ÿæ¬¾
    }
    
    /// å¯ç”¨æŠµæŠ¼å“
    public entry fun enable_collateral(
        user: &signer,
        asset: vector<u8>,
    )
    
    /// ç¦ç”¨æŠµæŠ¼å“
    public entry fun disable_collateral(
        user: &signer,
        asset: vector<u8>,
    )
}
```

**åŠŸèƒ½è¦æ±‚**ï¼š

1. **å¯ç”¨æŠµæŠ¼å“**ï¼š
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥èµ„äº§çš„å­˜æ¬¾
   - æ£€æŸ¥è¯¥èµ„äº§æ˜¯å¦æ”¯æŒä½œä¸ºæŠµæŠ¼å“
   - æ£€æŸ¥æ˜¯å¦å·²ç»å¯ç”¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
   - æ·»åŠ åˆ°æŠµæŠ¼å“åˆ—è¡¨
   - å‘å‡º `CollateralEnabled` äº‹ä»¶

2. **ç¦ç”¨æŠµæŠ¼å“**ï¼š
   - æ£€æŸ¥è¯¥èµ„äº§æ˜¯å¦å·²å¯ç”¨ä¸ºæŠµæŠ¼å“
   - å¦‚æœæœ‰å€Ÿæ¬¾ï¼Œè®¡ç®—ç¦ç”¨åçš„å¥åº·å› å­
   - å¦‚æœ HF < 1.0ï¼Œæ‹’ç»ç¦ç”¨
   - ä»æŠµæŠ¼å“åˆ—è¡¨ç§»é™¤
   - å‘å‡º `CollateralDisabled` äº‹ä»¶

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```move
#[test(user = @0x123)]
fun test_enable_collateral(user: &signer) {
    // 1. åˆå§‹åŒ–ç”¨æˆ·è´¦æˆ·
    // 2. å­˜å…¥ ETH
    // 3. å¯ç”¨ ETH ä½œä¸ºæŠµæŠ¼å“
    // 4. éªŒè¯æŠµæŠ¼å“åˆ—è¡¨åŒ…å« ETH
}

#[test(user = @0x123)]
#[expected_failure]
fun test_disable_collateral_with_borrow(user: &signer) {
    // 1. å­˜å…¥å¹¶å¯ç”¨æŠµæŠ¼å“
    // 2. å€Ÿæ¬¾
    // 3. å°è¯•ç¦ç”¨æŠµæŠ¼å“
    // 4. åº”è¯¥å¤±è´¥ï¼ˆå¥åº·å› å­è¿‡ä½ï¼‰
}
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- å¯ç”¨åŠŸèƒ½ï¼ˆ10 åˆ†ï¼‰
- ç¦ç”¨åŠŸèƒ½ï¼ˆ10 åˆ†ï¼‰
- å¥åº·å› å­æ£€æŸ¥ï¼ˆ5 åˆ†ï¼‰

---

### ç¬¬ 3 é¢˜ï¼šå®ç°ä»·æ ¼é¢„è¨€æœºéªŒè¯ï¼ˆ20 åˆ†ï¼‰â­â­â­

**é¢˜ç›®æè¿°**ï¼š

å®ç°ä¸€ä¸ªä»·æ ¼é¢„è¨€æœºæ¨¡å—ï¼Œæ”¯æŒå¤šæºä»·æ ¼éªŒè¯å’Œæ—¶æ•ˆæ€§æ£€æŸ¥ã€‚

**è¦æ±‚å®ç°**ï¼š

```move
module collateral_exam::price_oracle {
    
    struct PriceData has store, drop {
        price: u128,
        timestamp: u64,
    }
    
    /// æ›´æ–°ä»·æ ¼
    public fun update_price(
        asset: vector<u8>,
        price: u128,
        timestamp: u64,
    )
    
    /// è·å–ä»·æ ¼ï¼ˆå¸¦æ—¶æ•ˆæ€§æ£€æŸ¥ï¼‰
    public fun get_price(
        asset: vector<u8>,
        max_age: u64,
    ): (u128, u64)
    
    /// éªŒè¯å¤šä¸ªä»·æ ¼æºçš„åå·®
    public fun validate_price_deviation(
        prices: vector<u128>,
        max_deviation: u128,
    ): bool
    
    /// è·å–èšåˆä»·æ ¼ï¼ˆä¸­ä½æ•°ï¼‰
    public fun get_median_price(
        prices: vector<u128>,
    ): u128
}
```

**åŠŸèƒ½è¦æ±‚**ï¼š

1. **ä»·æ ¼æ›´æ–°**ï¼š
   - å­˜å‚¨ä»·æ ¼å’Œæ—¶é—´æˆ³
   - å‘å‡º `PriceUpdated` äº‹ä»¶

2. **ä»·æ ¼è·å–**ï¼š
   - æ£€æŸ¥ä»·æ ¼æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥ä»·æ ¼æ˜¯å¦è¿‡æœŸï¼ˆå½“å‰æ—¶é—´ - ä»·æ ¼æ—¶é—´ > max_ageï¼‰
   - è¿‡æœŸåˆ™æŠ¥é”™

3. **åå·®éªŒè¯**ï¼š
   - è®¡ç®—æ‰€æœ‰ä»·æ ¼çš„æœ€å¤§åå·®
   - åå·® = |max - min| / min
   - å¦‚æœåå·® > max_deviationï¼Œè¿”å› false

4. **ä¸­ä½æ•°è®¡ç®—**ï¼š
   - å¯¹ä»·æ ¼æ•°ç»„æ’åº
   - è¿”å›ä¸­é—´å€¼
   - å¦‚æœæ•°ç»„é•¿åº¦ä¸ºå¶æ•°ï¼Œè¿”å›ä¸­é—´ä¸¤ä¸ªå€¼çš„å¹³å‡å€¼

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```move
#[test]
fun test_price_validation() {
    let prices = vector[
        100_000_000,  // $100
        102_000_000,  // $102
        101_000_000,  // $101
    ];
    
    // æœ€å¤§åå·®ï¼š(102 - 100) / 100 = 2%
    let valid = validate_price_deviation(prices, 50_000); // 5%
    assert!(valid, 1);
    
    let median = get_median_price(prices);
    assert!(median == 101_000_000, 2);
}

#[test]
#[expected_failure(abort_code = E_PRICE_TOO_OLD)]
fun test_price_too_old() {
    // æ›´æ–°ä»·æ ¼ï¼Œæ—¶é—´æˆ³ä¸º 100
    // å½“å‰æ—¶é—´ä¸º 500
    // max_age = 300
    // åº”è¯¥å¤±è´¥ï¼ˆ500 - 100 > 300ï¼‰
}
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- ä»·æ ¼æ›´æ–°å’Œè·å–ï¼ˆ5 åˆ†ï¼‰
- æ—¶æ•ˆæ€§æ£€æŸ¥ï¼ˆ5 åˆ†ï¼‰
- åå·®éªŒè¯ï¼ˆ5 åˆ†ï¼‰
- ä¸­ä½æ•°è®¡ç®—ï¼ˆ5 åˆ†ï¼‰

---

### ç¬¬ 4 é¢˜ï¼šå®ç°å¥åº·å› å­é¢„è­¦ç³»ç»Ÿï¼ˆ20 åˆ†ï¼‰â­â­â­â­

**é¢˜ç›®æè¿°**ï¼š

å®ç°ä¸€ä¸ªå¥åº·å› å­ç›‘æ§å’Œé¢„è­¦ç³»ç»Ÿï¼Œæ ¹æ®ä¸åŒçš„å¥åº·å› å­æ°´å¹³å‘å‡ºä¸åŒçº§åˆ«çš„é¢„è­¦ã€‚

**è¦æ±‚å®ç°**ï¼š

```move
module collateral_exam::health_monitor {
    
    /// å¥åº·å› å­ç­‰çº§
    const LEVEL_SAFE: u8 = 0;       // â‰¥ 1.5
    const LEVEL_NOTICE: u8 = 1;     // 1.2 - 1.5
    const LEVEL_WARNING: u8 = 2;    // 1.05 - 1.2
    const LEVEL_CRITICAL: u8 = 3;   // 1.0 - 1.05
    const LEVEL_LIQUIDATION: u8 = 4; // < 1.0
    
    #[event]
    struct HealthFactorAlert has store, drop {
        user: address,
        health_factor: u128,
        level: u8,
        message: vector<u8>,
        timestamp: u64,
    }
    
    /// æ£€æŸ¥å¥åº·å› å­å¹¶å‘å‡ºé¢„è­¦
    public fun check_and_alert(
        user: address,
        health_factor: u128,
    )
    
    /// è·å–å¥åº·å› å­ç­‰çº§
    public fun get_health_factor_level(
        health_factor: u128,
    ): u8
    
    /// åˆ¤æ–­æ˜¯å¦å…è®¸æ“ä½œ
    public fun is_operation_allowed(
        health_factor: u128,
        operation: u8, // 0: deposit, 1: withdraw, 2: borrow, 3: repay
    ): bool
}
```

**åŠŸèƒ½è¦æ±‚**ï¼š

1. **ç­‰çº§åˆ¤æ–­**ï¼š
   - æ ¹æ®å¥åº·å› å­è¿”å›å¯¹åº”ç­‰çº§
   - ä½¿ç”¨å¸¸é‡å®šä¹‰çš„é˜ˆå€¼

2. **é¢„è­¦æ£€æŸ¥**ï¼š
   - å¦‚æœç­‰çº§ â‰¥ 1ï¼ˆæ³¨æ„çº§åˆ«ï¼‰ï¼Œå‘å‡ºé¢„è­¦äº‹ä»¶
   - äº‹ä»¶åŒ…å«ç”¨æˆ·åœ°å€ã€å¥åº·å› å­ã€ç­‰çº§ã€æç¤ºæ¶ˆæ¯

3. **æ“ä½œé™åˆ¶**ï¼š
   - SAFE (0)ï¼šå…è®¸æ‰€æœ‰æ“ä½œ
   - NOTICE (1)ï¼šå…è®¸æ‰€æœ‰æ“ä½œï¼Œä½†æç¤ºè­¦å‘Š
   - WARNING (2)ï¼šç¦æ­¢æ–°å¢å€Ÿæ¬¾
   - CRITICAL (3)ï¼šç¦æ­¢æå–å’Œå€Ÿæ¬¾
   - LIQUIDATION (4)ï¼šç¦æ­¢æ‰€æœ‰æ“ä½œï¼ˆé™¤è¿˜æ¬¾å’Œå­˜æ¬¾ï¼‰

**å®ç°æç¤º**ï¼š

```move
public fun is_operation_allowed(
    health_factor: u128,
    operation: u8,
): bool {
    let level = get_health_factor_level(health_factor);
    
    // æ ¹æ®ç­‰çº§å’Œæ“ä½œç±»å‹åˆ¤æ–­
    match (level, operation) {
        (0, _) => true,                    // SAFE: å…è®¸æ‰€æœ‰
        (1, _) => true,                    // NOTICE: å…è®¸æ‰€æœ‰
        (2, 2) => false,                   // WARNING: ç¦æ­¢å€Ÿæ¬¾
        (2, _) => true,
        (3, 0) => true,                    // CRITICAL: åªå…è®¸å­˜æ¬¾å’Œè¿˜æ¬¾
        (3, 3) => true,
        (3, _) => false,
        (4, 0) => true,                    // LIQUIDATION: åªå…è®¸å­˜æ¬¾å’Œè¿˜æ¬¾
        (4, 3) => true,
        (4, _) => false,
    }
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```move
#[test]
fun test_health_factor_levels() {
    // HF = 2.0 => SAFE
    assert!(get_health_factor_level(2_000_000_000_000_000_000) == LEVEL_SAFE, 1);
    
    // HF = 1.3 => NOTICE
    assert!(get_health_factor_level(1_300_000_000_000_000_000) == LEVEL_NOTICE, 2);
    
    // HF = 1.1 => WARNING
    assert!(get_health_factor_level(1_100_000_000_000_000_000) == LEVEL_WARNING, 3);
    
    // HF = 1.02 => CRITICAL
    assert!(get_health_factor_level(1_020_000_000_000_000_000) == LEVEL_CRITICAL, 4);
    
    // HF = 0.95 => LIQUIDATION
    assert!(get_health_factor_level(950_000_000_000_000_000) == LEVEL_LIQUIDATION, 5);
}

#[test]
fun test_operation_restrictions() {
    let hf_critical = 1_020_000_000_000_000_000; // 1.02
    
    // å…è®¸å­˜æ¬¾
    assert!(is_operation_allowed(hf_critical, 0), 1);
    
    // ç¦æ­¢æå–
    assert!(!is_operation_allowed(hf_critical, 1), 2);
    
    // ç¦æ­¢å€Ÿæ¬¾
    assert!(!is_operation_allowed(hf_critical, 2), 3);
    
    // å…è®¸è¿˜æ¬¾
    assert!(is_operation_allowed(hf_critical, 3), 4);
}
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- ç­‰çº§åˆ¤æ–­ï¼ˆ5 åˆ†ï¼‰
- é¢„è­¦å‘å‡ºï¼ˆ5 åˆ†ï¼‰
- æ“ä½œé™åˆ¶ï¼ˆ7 åˆ†ï¼‰
- æµ‹è¯•è¦†ç›–ï¼ˆ3 åˆ†ï¼‰

---

### ç¬¬ 5 é¢˜ï¼šå®ç°æ“ä½œæ¨¡æ‹Ÿå™¨ï¼ˆ15 åˆ†ï¼‰â­â­â­â­â­

**é¢˜ç›®æè¿°**ï¼š

å®ç°ä¸€ä¸ªæ“ä½œæ¨¡æ‹Ÿå™¨ï¼Œåœ¨ä¸æ”¹å˜å®é™…çŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œé¢„æµ‹æ“ä½œå¯¹å¥åº·å› å­çš„å½±å“ã€‚

**è¦æ±‚å®ç°**ï¼š

```move
module collateral_exam::operation_simulator {
    
    use collateral_exam::collateral_manager;
    
    struct SimulationResult has drop {
        new_health_factor: u128,
        is_safe: bool,
        warning_message: vector<u8>,
    }
    
    /// æ¨¡æ‹Ÿå­˜æ¬¾
    public fun simulate_deposit(
        user: address,
        asset: vector<u8>,
        amount: u128,
        enable_as_collateral: bool,
    ): SimulationResult
    
    /// æ¨¡æ‹Ÿæå–
    public fun simulate_withdraw(
        user: address,
        asset: vector<u8>,
        amount: u128,
    ): SimulationResult
    
    /// æ¨¡æ‹Ÿå€Ÿæ¬¾
    public fun simulate_borrow(
        user: address,
        asset: vector<u8>,
        amount: u128,
    ): SimulationResult
    
    /// æ¨¡æ‹Ÿè¿˜æ¬¾
    public fun simulate_repay(
        user: address,
        asset: vector<u8>,
        amount: u128,
    ): SimulationResult
    
    /// æ¨¡æ‹Ÿä»·æ ¼å˜åŒ–
    public fun simulate_price_change(
        user: address,
        asset: vector<u8>,
        new_price: u128,
    ): SimulationResult
}
```

**åŠŸèƒ½è¦æ±‚**ï¼š

1. **ä¸æ”¹å˜çŠ¶æ€**ï¼š
   - æ‰€æœ‰æ¨¡æ‹Ÿå‡½æ•°éƒ½æ˜¯ `public fun`ï¼ˆé `entry`ï¼‰
   - åªè¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹å­˜å‚¨
   - åœ¨å†…å­˜ä¸­è¿›è¡Œè®¡ç®—

2. **è¿”å›å®Œæ•´ç»“æœ**ï¼š
   - æ–°çš„å¥åº·å› å­
   - æ“ä½œæ˜¯å¦å®‰å…¨
   - è­¦å‘Šæˆ–å»ºè®®æ¶ˆæ¯

3. **æä¾›å»ºè®®**ï¼š
   - å¦‚æœæ“ä½œä¼šå¯¼è‡´ HF < 1.0ï¼Œå»ºè®®ä¸è¦æ‰§è¡Œ
   - å¦‚æœæ“ä½œä¼šå¯¼è‡´ HF < 1.2ï¼Œæç¤ºé£é™©
   - å¦‚æœæ“ä½œå®‰å…¨ï¼Œé¼“åŠ±æ‰§è¡Œ

**å®ç°ç¤ºä¾‹**ï¼š

```move
public fun simulate_withdraw(
    user: address,
    asset: vector<u8>,
    amount: u128,
): SimulationResult acquires ... {
    // 1. è·å–å½“å‰æŠµæŠ¼å“å’Œå€ºåŠ¡æ•°æ®
    let (current_collateral, current_debt) = get_account_data(user);
    
    // 2. è®¡ç®—è¯¥èµ„äº§å¯¹æŠµæŠ¼èƒ½åŠ›çš„è´¡çŒ®
    let (price, _) = get_price(asset);
    let config = get_asset_config(asset);
    let collateral_contribution = amount * price * config.collateral_factor / FACTOR_PRECISION;
    
    // 3. è®¡ç®—æ–°çš„æŠµæŠ¼èƒ½åŠ›
    let new_collateral = current_collateral - collateral_contribution;
    
    // 4. è®¡ç®—æ–°çš„å¥åº·å› å­
    let new_hf = if (current_debt == 0) {
        MAX_U128
    } else {
        (new_collateral * PRECISION) / current_debt
    };
    
    // 5. åˆ¤æ–­å®‰å…¨æ€§å¹¶ç”Ÿæˆæ¶ˆæ¯
    let is_safe = new_hf >= HEALTH_FACTOR_LIQUIDATION_THRESHOLD;
    let message = if (!is_safe) {
        b"Warning: This withdrawal would put you below liquidation threshold!"
    } else if (new_hf < HEALTH_FACTOR_WARNING_THRESHOLD) {
        b"Caution: Your health factor would be below 1.2"
    } else {
        b"Safe to withdraw"
    };
    
    SimulationResult {
        new_health_factor: new_hf,
        is_safe,
        warning_message: message,
    }
}
```

**æµ‹è¯•ç”¨ä¾‹**ï¼š

```move
#[test]
fun test_simulate_withdraw() {
    // è®¾ç½®ï¼šæŠµæŠ¼ 1 ETH ($2000, 75%), å€Ÿ $1200
    // å½“å‰ HF = 1.25
    
    let user = @0x123;
    
    // æ¨¡æ‹Ÿæå– 0.2 ETH
    let result = simulate_withdraw(user, b"ETH", 20_000_000);
    
    // æ–°æŠµæŠ¼ï¼š0.8 ETH Ã— $2000 Ã— 75% = $1200
    // æ–° HF = $1200 / $1200 = 1.0
    assert!(result.new_health_factor == 1_000_000_000_000_000_000, 1);
    assert!(!result.is_safe, 2); // HF = 1.0, ä¸´ç•Œå€¼ï¼Œæ ‡è®°ä¸ºä¸å®‰å…¨
}

#[test]
fun test_simulate_price_drop() {
    // è®¾ç½®ï¼šæŠµæŠ¼ 1 ETH ($2000, 75%), å€Ÿ $1200
    // å½“å‰ HF = 1.25
    
    let user = @0x123;
    
    // æ¨¡æ‹Ÿ ETH ä»·æ ¼è·Œåˆ° $1600
    let result = simulate_price_change(user, b"ETH", 160_000_000_000);
    
    // æ–°æŠµæŠ¼ï¼š1 ETH Ã— $1600 Ã— 75% = $1200
    // æ–° HF = $1200 / $1200 = 1.0
    assert!(result.new_health_factor == 1_000_000_000_000_000_000, 1);
}
```

**è¯„åˆ†æ ‡å‡†**ï¼š
- åŸºç¡€æ¨¡æ‹ŸåŠŸèƒ½ï¼ˆ8 åˆ†ï¼‰
- ä¸æ”¹å˜çŠ¶æ€ï¼ˆ3 åˆ†ï¼‰
- å»ºè®®æ¶ˆæ¯ï¼ˆ2 åˆ†ï¼‰
- æµ‹è¯•å®Œæ•´æ€§ï¼ˆ2 åˆ†ï¼‰

---

## ğŸ“Š æ€»åˆ†åˆ†é…

| é¢˜ç›® | åˆ†å€¼ | éš¾åº¦ |
|------|------|------|
| ç¬¬1é¢˜ï¼šå¥åº·å› å­è®¡ç®—å™¨ | 20 åˆ† | â­â­â­ |
| ç¬¬2é¢˜ï¼šæŠµæŠ¼å“å¯ç”¨/ç¦ç”¨ | 25 åˆ† | â­â­â­â­ |
| ç¬¬3é¢˜ï¼šä»·æ ¼é¢„è¨€æœºéªŒè¯ | 20 åˆ† | â­â­â­ |
| ç¬¬4é¢˜ï¼šå¥åº·å› å­é¢„è­¦ | 20 åˆ† | â­â­â­â­ |
| ç¬¬5é¢˜ï¼šæ“ä½œæ¨¡æ‹Ÿå™¨ | 15 åˆ† | â­â­â­â­â­ |
| **æ€»è®¡** | **100 åˆ†** | |

---

## ğŸ“ æäº¤è¦æ±‚

### æ–‡ä»¶ç»“æ„

```
sources/
â”œâ”€â”€ health_factor_calculator.move      # ç¬¬1é¢˜
â”œâ”€â”€ collateral_manager.move            # ç¬¬2é¢˜
â”œâ”€â”€ price_oracle.move                  # ç¬¬3é¢˜
â”œâ”€â”€ health_monitor.move                # ç¬¬4é¢˜
â””â”€â”€ operation_simulator.move           # ç¬¬5é¢˜

tests/
â””â”€â”€ exam_tests.move                    # æ‰€æœ‰æµ‹è¯•
```

### ä»£ç è¦æ±‚

1. **æ³¨é‡Šå®Œæ•´**ï¼šæ¯ä¸ªå‡½æ•°éƒ½åº”æœ‰æ¸…æ™°çš„æ³¨é‡Š
2. **æµ‹è¯•è¦†ç›–**ï¼šæ¯é¢˜è‡³å°‘ 2 ä¸ªæµ‹è¯•ç”¨ä¾‹
3. **é”™è¯¯å¤„ç†**ï¼šé€‚å½“ä½¿ç”¨ assert! å’Œè‡ªå®šä¹‰é”™è¯¯ç 
4. **ä»£ç é£æ ¼**ï¼šéµå¾ª Move ç¼–ç è§„èŒƒ

### è¿è¡Œæµ‹è¯•

```bash
# ç¼–è¯‘
aptos move compile

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
aptos move test

# è¿è¡Œç‰¹å®šæµ‹è¯•
aptos move test --filter test_health_factor

# æŸ¥çœ‹è¦†ç›–ç‡
aptos move test --coverage
```

---

## ğŸ’¡ æç¤ºå’Œå»ºè®®

### è°ƒè¯•æŠ€å·§

```move
// ä½¿ç”¨ debug::print è¾“å‡ºä¸­é—´å€¼
use std::debug;

debug::print(&health_factor);
debug::print(&collateral_value);
```

### å¸¸è§é”™è¯¯

1. **ç²¾åº¦é—®é¢˜**ï¼š
   - âŒ `let hf = collateral / debt;`
   - âœ… `let hf = (collateral * PRECISION) / debt;`

2. **é™¤é›¶é”™è¯¯**ï¼š
   ```move
   if (debt == 0) {
       return MAX_U128;
   };
   ```

3. **æº¢å‡ºé—®é¢˜**ï¼š
   ```move
   // æ£€æŸ¥ä¹˜æ³•æº¢å‡º
   assert!(result / a == b, E_OVERFLOW);
   ```

### æ—¶é—´åˆ†é…å»ºè®®

- ç¬¬1é¢˜ï¼š15 åˆ†é’Ÿ
- ç¬¬2é¢˜ï¼š20 åˆ†é’Ÿ
- ç¬¬3é¢˜ï¼š20 åˆ†é’Ÿ
- ç¬¬4é¢˜ï¼š20 åˆ†é’Ÿ
- ç¬¬5é¢˜ï¼š15 åˆ†é’Ÿ
- æµ‹è¯•å’Œè°ƒè¯•ï¼šä½™ä¸‹æ—¶é—´

---

**ç¥ä½ è€ƒè¯•é¡ºåˆ©ï¼å®ŒæˆåæŸ¥çœ‹"ç­”æ¡ˆè§£æ.md"å¯¹ç…§å‚è€ƒç­”æ¡ˆã€‚** ğŸš€
