# Day 14 å®è·µä»»åŠ¡ï¼šä»£å¸ç®¡ç†åŠŸèƒ½å¼€å‘

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

é€šè¿‡ä¸‰ä¸ªé€’è¿›å¼ä»»åŠ¡ï¼Œä½ å°†å®ç°å®Œæ•´çš„ä»£å¸ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬æƒé™æ§åˆ¶ã€ä¾›åº”é‡ç®¡ç†å’Œå¤šç­¾æœºåˆ¶ã€‚

**é¢„è®¡æ—¶é—´**ï¼š3.5 å°æ—¶

---

## ä»»åŠ¡ 1ï¼šå®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆåŸºç¡€ï¼‰â­â­â­â˜†â˜†

### ğŸ¯ ç›®æ ‡
å®ç°ä¸€ä¸ªå¸¦æœ‰å®Œæ•´æƒé™ç®¡ç†çš„ä»£å¸ç³»ç»Ÿï¼ŒåŒ…æ‹¬é“¸é€ ã€é”€æ¯å’Œå†»ç»“åŠŸèƒ½ã€‚

### ğŸ“ éœ€æ±‚

#### 1.1 ä»£å¸ä¿¡æ¯
åˆ›å»º `ManagedToken`ï¼š
- **åç§°**: "Managed Token"
- **ç¬¦å·**: "MGT"
- **å°æ•°ä½æ•°**: 8
- **è¿½è¸ªä¾›åº”é‡**: æ˜¯

#### 1.2 æƒé™å­˜å‚¨

```move
/// åˆ†ç¦»å­˜å‚¨ä¸‰ç§æƒé™
struct MintManager has key {
    mint_cap: MintCapability<ManagedToken>,
    daily_limit: u64,           // æ¯æ—¥é“¸é€ é™é¢
    minted_today: u64,          // ä»Šæ—¥å·²é“¸é€ æ•°é‡
    last_reset_day: u64,        // ä¸Šæ¬¡é‡ç½®æ—¥æœŸ
}

struct BurnManager has key {
    burn_cap: BurnCapability<ManagedToken>,
}

struct FreezeManager has key {
    freeze_cap: FreezeCapability<ManagedToken>,
    frozen_accounts: vector<address>,  // å†»ç»“è´¦æˆ·åˆ—è¡¨
}
```

#### 1.3 å¿…éœ€åŠŸèƒ½

**åˆå§‹åŒ–**
```move
fun init_module(account: &signer)
```
- åˆå§‹åŒ–ä»£å¸
- åˆ›å»ºä¸‰ä¸ªç®¡ç†å™¨
- è®¾ç½®åˆå§‹é™é¢

**é™é¢é“¸é€ **
```move
public entry fun mint(
    admin: &signer,
    recipient: address,
    amount: u64
) acquires MintManager
```
- æ£€æŸ¥æ—¥é™é¢
- é“¸é€ ä»£å¸
- æ›´æ–°ç»Ÿè®¡

**é”€æ¯ä»£å¸**
```move
public entry fun burn_from_account(
    admin: &signer,
    account: &signer,
    amount: u64
) acquires BurnManager
```
- ä»è´¦æˆ·æå–ä»£å¸
- æ‰§è¡Œé”€æ¯

**å†»ç»“è´¦æˆ·**
```move
public entry fun freeze_account(
    admin: &signer,
    account_addr: address
) acquires FreezeManager
```
- å†»ç»“æŒ‡å®šè´¦æˆ·
- è®°å½•åˆ°åˆ—è¡¨

**è§£å†»è´¦æˆ·**
```move
public entry fun unfreeze_account(
    admin: &signer,
    account_addr: address
) acquires FreezeManager
```
- è§£å†»è´¦æˆ·
- ä»åˆ—è¡¨ç§»é™¤

**æŸ¥è¯¢åŠŸèƒ½**
```move
#[view]
public fun get_daily_mint_info(): (u64, u64, u64)  // (é™é¢, å·²ç”¨, å‰©ä½™)

#[view]
public fun is_account_frozen(addr: address): bool

#[view]
public fun get_frozen_accounts(): vector<address>
```

### ğŸ’» èµ·å§‹ä»£ç 

åœ¨ `sources/managed_token.move` åˆ›å»ºï¼š

```move
module token_manager::managed_token {
    use std::signer;
    use std::string;
    use std::vector;
    use aptos_framework::coin::{Self, MintCapability, BurnCapability, FreezeCapability};
    use aptos_framework::timestamp;

    /// ä»£å¸ç±»å‹
    struct ManagedToken {}

    /// é”™è¯¯ç 
    const ERROR_NOT_ADMIN: u64 = 1;
    const ERROR_EXCEED_DAILY_LIMIT: u64 = 2;
    const ERROR_ACCOUNT_ALREADY_FROZEN: u64 = 3;
    const ERROR_ACCOUNT_NOT_FROZEN: u64 = 4;

    /// é“¸é€ ç®¡ç†å™¨
    struct MintManager has key {
        mint_cap: MintCapability<ManagedToken>,
        admin: address,
        daily_limit: u64,
        minted_today: u64,
        last_reset_day: u64,
    }

    /// é”€æ¯ç®¡ç†å™¨
    struct BurnManager has key {
        burn_cap: BurnCapability<ManagedToken>,
        admin: address,
    }

    /// å†»ç»“ç®¡ç†å™¨
    struct FreezeManager has key {
        freeze_cap: FreezeCapability<ManagedToken>,
        admin: address,
        frozen_accounts: vector<address>,
    }

    /// TODO: å®ç° init_module
    fun init_module(account: &signer) {
        // ä½ çš„ä»£ç 
    }

    /// TODO: å®ç°é™é¢é“¸é€ 
    public entry fun mint(
        admin: &signer,
        recipient: address,
        amount: u64
    ) acquires MintManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: å®ç°é”€æ¯
    public entry fun burn_from_account(
        admin: &signer,
        account: &signer,
        amount: u64
    ) acquires BurnManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: å®ç°å†»ç»“
    public entry fun freeze_account(
        admin: &signer,
        account_addr: address
    ) acquires FreezeManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: å®ç°è§£å†»
    public entry fun unfreeze_account(
        admin: &signer,
        account_addr: address
    ) acquires FreezeManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æŸ¥è¯¢é“¸é€ ä¿¡æ¯
    #[view]
    public fun get_daily_mint_info(): (u64, u64, u64) acquires MintManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æ£€æŸ¥æ˜¯å¦å†»ç»“
    #[view]
    public fun is_account_frozen(addr: address): bool acquires FreezeManager {
        // ä½ çš„ä»£ç 
    }

    /// è¾…åŠ©å‡½æ•°
    fun check_and_reset_daily_limit() acquires MintManager {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥é™é¢
    }
}
```

### âœ… éªŒè¯æ ‡å‡†
- [ ] å¯ä»¥é™é¢é“¸é€ 
- [ ] æ¯æ—¥é™é¢è‡ªåŠ¨é‡ç½®
- [ ] å¯ä»¥é”€æ¯ä»£å¸
- [ ] å¯ä»¥å†»ç»“/è§£å†»è´¦æˆ·
- [ ] æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸

---

## ä»»åŠ¡ 2ï¼šé€šç¼©ä»£å¸ç³»ç»Ÿï¼ˆä¸­çº§ï¼‰â­â­â­â­â˜†

### ğŸ¯ ç›®æ ‡
å®ç°ä¸€ä¸ªé€šç¼©ä»£å¸ï¼Œæ¯æ¬¡è½¬è´¦è‡ªåŠ¨é”€æ¯ä¸€å®šæ¯”ä¾‹çš„æ‰‹ç»­è´¹ã€‚

### ğŸ“ éœ€æ±‚

#### 2.1 é€šç¼©æœºåˆ¶

```move
struct DeflationaryConfig has key {
    burn_cap: BurnCapability<DeflationaryToken>,
    burn_rate: u64,              // é”€æ¯æ¯”ä¾‹ï¼ˆåŸºç‚¹ï¼Œå¦‚ 100 = 1%ï¼‰
    total_burned: u64,           // ç´¯è®¡é”€æ¯æ•°é‡
    is_active: bool,             // é€šç¼©æ˜¯å¦æ¿€æ´»
}
```

#### 2.2 æ ¸å¿ƒåŠŸèƒ½

**å¸¦é”€æ¯çš„è½¬è´¦**
```move
public entry fun transfer_with_burn(
    from: &signer,
    to: address,
    amount: u64
) acquires DeflationaryConfig
```
- è®¡ç®—é”€æ¯æ•°é‡ = amount * burn_rate / 10000
- å®é™…è½¬è´¦æ•°é‡ = amount - é”€æ¯æ•°é‡
- é”€æ¯æ‰‹ç»­è´¹éƒ¨åˆ†
- æ›´æ–°ç»Ÿè®¡

**åŠ¨æ€è°ƒæ•´é”€æ¯ç‡**
```move
public entry fun set_burn_rate(
    admin: &signer,
    new_rate: u64
) acquires DeflationaryConfig
```
- åªæœ‰ç®¡ç†å‘˜å¯è°ƒæ•´
- é™åˆ¶æœ€å¤§å€¼ï¼ˆå¦‚ 5%ï¼‰

**æŸ¥è¯¢ç»Ÿè®¡**
```move
#[view]
public fun get_burn_stats(): (u64, u64, bool)  // (é”€æ¯ç‡, ç´¯è®¡é”€æ¯, æ˜¯å¦æ¿€æ´»)
```

#### 2.3 å¥–åŠ±æœºåˆ¶ï¼ˆå¯é€‰ï¼‰

ä¸ºé•¿æœŸæŒæœ‰è€…æä¾›å¥–åŠ±ï¼š

```move
struct HolderReward has key {
    mint_cap: MintCapability<DeflationaryToken>,
    reward_pool: u64,            // å¥–åŠ±æ± ä½™é¢
}

/// æ ¹æ®æŒæœ‰æ—¶é—´å’Œæ•°é‡åˆ†å‘å¥–åŠ±
public fun claim_holder_reward(account: &signer) 
acquires HolderReward {
    // è®¡ç®—æŒæœ‰å¥–åŠ±
    // ä»å¥–åŠ±æ± é“¸é€ 
}
```

### ğŸ’» èµ·å§‹ä»£ç 

```move
module token_manager::deflationary_token {
    use std::signer;
    use aptos_framework::coin::{Self, BurnCapability, MintCapability};

    struct DeflationaryToken {}

    const ERROR_NOT_ADMIN: u64 = 1;
    const ERROR_BURN_RATE_TOO_HIGH: u64 = 2;
    const ERROR_DEFLATIONARY_DISABLED: u64 = 3;

    const MAX_BURN_RATE: u64 = 500;  // 5%
    const BASIS_POINTS: u64 = 10000;

    struct DeflationaryConfig has key {
        admin: address,
        burn_cap: BurnCapability<DeflationaryToken>,
        burn_rate: u64,
        total_burned: u64,
        is_active: bool,
    }

    /// TODO: å®ç° init_module
    fun init_module(account: &signer) {
        // ä½ çš„ä»£ç 
    }

    /// TODO: å®ç°å¸¦é”€æ¯çš„è½¬è´¦
    public entry fun transfer_with_burn(
        from: &signer,
        to: address,
        amount: u64
    ) acquires DeflationaryConfig {
        // ä½ çš„ä»£ç 
    }

    /// TODO: è®¾ç½®é”€æ¯ç‡
    public entry fun set_burn_rate(
        admin: &signer,
        new_rate: u64
    ) acquires DeflationaryConfig {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æ¿€æ´»/åœç”¨é€šç¼©
    public entry fun set_deflationary_active(
        admin: &signer,
        is_active: bool
    ) acquires DeflationaryConfig {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æŸ¥è¯¢ç»Ÿè®¡
    #[view]
    public fun get_burn_stats(): (u64, u64, u64) acquires DeflationaryConfig {
        // è¿”å›ï¼š(é”€æ¯ç‡, ç´¯è®¡é”€æ¯, å½“å‰ä¾›åº”é‡)
        // ä½ çš„ä»£ç 
    }
}
```

### âœ… éªŒè¯æ ‡å‡†
- [ ] è½¬è´¦æ—¶è‡ªåŠ¨é”€æ¯æ‰‹ç»­è´¹
- [ ] é”€æ¯ç‡å¯åŠ¨æ€è°ƒæ•´
- [ ] ç´¯è®¡é”€æ¯é‡æ­£ç¡®ç»Ÿè®¡
- [ ] å¯ä»¥æ¿€æ´»/åœç”¨é€šç¼©
- [ ] é”€æ¯ç‡æœ‰ä¸Šé™ä¿æŠ¤

---

## ä»»åŠ¡ 3ï¼šå¤šç­¾åä»£å¸ç®¡ç†ï¼ˆé«˜çº§ï¼‰â­â­â­â­â­

### ğŸ¯ ç›®æ ‡
å®ç°å¤šç­¾åæ§åˆ¶çš„ä»£å¸ç®¡ç†ç³»ç»Ÿï¼Œé‡è¦æ“ä½œéœ€è¦å¤šä¸ªç­¾åæ‰èƒ½æ‰§è¡Œã€‚

### ğŸ“ éœ€æ±‚

#### 3.1 å¤šç­¾é…ç½®

```move
struct MultiSigConfig has key {
    signers: vector<address>,          // ç­¾åè€…åˆ—è¡¨
    required_signatures: u64,          // éœ€è¦çš„ç­¾åæ•°
    nonce: u64,                        // é˜²é‡æ”¾æ”»å‡»
}

struct PendingMint has key, store {
    recipient: address,
    amount: u64,
    signatures: vector<address>,       // å·²ç­¾åè€…
    executed: bool,
}

struct MintProposals has key {
    proposals: Table<u64, PendingMint>,  // ææ¡ˆID -> ææ¡ˆ
    next_proposal_id: u64,
}
```

#### 3.2 æ ¸å¿ƒåŠŸèƒ½

**æ·»åŠ ç­¾åè€…**
```move
public entry fun add_signer(
    admin: &signer,
    new_signer: address
) acquires MultiSigConfig
```

**åˆ›å»ºé“¸é€ ææ¡ˆ**
```move
public entry fun propose_mint(
    proposer: &signer,
    recipient: address,
    amount: u64
) acquires MultiSigConfig, MintProposals
```
- éªŒè¯ææ¡ˆè€…æ˜¯ç­¾åè€…ä¹‹ä¸€
- åˆ›å»ºæ–°ææ¡ˆ
- è‡ªåŠ¨æ·»åŠ ææ¡ˆè€…çš„ç­¾å

**ç­¾ç½²ææ¡ˆ**
```move
public entry fun sign_proposal(
    signer: &signer,
    proposal_id: u64
) acquires MultiSigConfig, MintProposals
```
- éªŒè¯ç­¾åè€…èº«ä»½
- é˜²æ­¢é‡å¤ç­¾å
- è®°å½•ç­¾å

**æ‰§è¡Œææ¡ˆ**
```move
public entry fun execute_mint_proposal(
    executor: &signer,
    proposal_id: u64
) acquires MultiSigConfig, MintProposals, MintManager
```
- æ£€æŸ¥ç­¾åæ•°é‡
- æ‰§è¡Œé“¸é€ 
- æ ‡è®°ä¸ºå·²æ‰§è¡Œ

**æŸ¥è¯¢ææ¡ˆ**
```move
#[view]
public fun get_proposal_info(proposal_id: u64): (address, u64, u64, bool)
// è¿”å›ï¼š(æ¥æ”¶è€…, æ•°é‡, ç­¾åæ•°, æ˜¯å¦æ‰§è¡Œ)
```

#### 3.3 å®‰å…¨ç‰¹æ€§

**æ—¶é—´é”**
```move
struct TimeLockConfig has key {
    delay: u64,                        // å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰
    proposals: Table<u64, TimeLockProposal>,
}

struct TimeLockProposal has store {
    unlock_time: u64,
    proposal_id: u64,
}
```

**ç´§æ€¥æš‚åœ**
```move
struct EmergencyControl has key {
    paused: bool,
    emergency_admin: address,
}
```

### ğŸ’» èµ·å§‹ä»£ç 

```move
module token_manager::multisig_token {
    use std::signer;
    use std::vector;
    use aptos_framework::coin::{Self, MintCapability};
    use aptos_framework::timestamp;
    use aptos_std::table::{Self, Table};

    struct MultiSigToken {}

    const ERROR_NOT_SIGNER: u64 = 1;
    const ERROR_ALREADY_SIGNED: u64 = 2;
    const ERROR_INSUFFICIENT_SIGNATURES: u64 = 3;
    const ERROR_ALREADY_EXECUTED: u64 = 4;
    const ERROR_PROPOSAL_NOT_FOUND: u64 = 5;

    struct MultiSigConfig has key {
        signers: vector<address>,
        required_signatures: u64,
    }

    struct PendingMint has store {
        recipient: address,
        amount: u64,
        signatures: vector<address>,
        executed: bool,
        created_at: u64,
    }

    struct MintProposals has key {
        proposals: Table<u64, PendingMint>,
        next_proposal_id: u64,
    }

    struct MintManager has key {
        mint_cap: MintCapability<MultiSigToken>,
    }

    /// TODO: å®ç° init_module
    fun init_module(account: &signer) {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æ·»åŠ ç­¾åè€…
    public entry fun add_signer(
        admin: &signer,
        new_signer: address
    ) acquires MultiSigConfig {
        // ä½ çš„ä»£ç 
    }

    /// TODO: åˆ›å»ºé“¸é€ ææ¡ˆ
    public entry fun propose_mint(
        proposer: &signer,
        recipient: address,
        amount: u64
    ) acquires MultiSigConfig, MintProposals {
        // ä½ çš„ä»£ç 
    }

    /// TODO: ç­¾ç½²ææ¡ˆ
    public entry fun sign_proposal(
        signer_acc: &signer,
        proposal_id: u64
    ) acquires MultiSigConfig, MintProposals {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æ‰§è¡Œææ¡ˆ
    public entry fun execute_mint_proposal(
        executor: &signer,
        proposal_id: u64
    ) acquires MultiSigConfig, MintProposals, MintManager {
        // ä½ çš„ä»£ç 
    }

    /// TODO: æŸ¥è¯¢ææ¡ˆ
    #[view]
    public fun get_proposal_info(proposal_id: u64): (address, u64, u64, bool) 
    acquires MintProposals {
        // ä½ çš„ä»£ç 
    }

    /// è¾…åŠ©å‡½æ•°
    fun is_signer(addr: address, signers: &vector<address>): bool {
        vector::contains(signers, &addr)
    }

    fun has_signed(addr: address, signatures: &vector<address>): bool {
        vector::contains(signatures, &addr)
    }
}
```

### âœ… éªŒè¯æ ‡å‡†
- [ ] å¯ä»¥æ·»åŠ ç­¾åè€…
- [ ] å¯ä»¥åˆ›å»ºé“¸é€ ææ¡ˆ
- [ ] ç­¾åè€…å¯ä»¥ç­¾ç½²ææ¡ˆ
- [ ] è¾¾åˆ°ç­¾åæ•°åå¯æ‰§è¡Œ
- [ ] é˜²æ­¢é‡å¤ç­¾å
- [ ] é˜²æ­¢é‡å¤æ‰§è¡Œ

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```move
#[test_only]
module token_manager::managed_token_tests {
    use std::signer;
    use token_manager::managed_token;

    #[test(admin = @token_manager)]
    fun test_mint_with_limit(admin: &signer) {
        managed_token::init_module(admin);
        
        // æµ‹è¯•æ­£å¸¸é“¸é€ 
        managed_token::mint(admin, @0x123, 1000);
        
        // æµ‹è¯•è¶…é™é“¸é€ ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
        // managed_token::mint(admin, @0x123, 10000000000);
    }

    #[test(admin = @token_manager)]
    #[expected_failure]
    fun test_freeze_account(admin: &signer) {
        managed_token::init_module(admin);
        
        // å†»ç»“è´¦æˆ·
        managed_token::freeze_account(admin, @0x123);
        
        // å†»ç»“åè½¬è´¦åº”è¯¥å¤±è´¥
        // ...
    }
}
```

---

## ğŸ“Š è¯„åˆ†æ ‡å‡†

### ä»»åŠ¡ 1ï¼ˆ40 åˆ†ï¼‰
- æƒé™åˆ†ç¦»å­˜å‚¨ï¼ˆ10 åˆ†ï¼‰
- é™é¢é“¸é€ ï¼ˆ10 åˆ†ï¼‰
- é”€æ¯åŠŸèƒ½ï¼ˆ5 åˆ†ï¼‰
- å†»ç»“/è§£å†»ï¼ˆ10 åˆ†ï¼‰
- æŸ¥è¯¢åŠŸèƒ½ï¼ˆ5 åˆ†ï¼‰

### ä»»åŠ¡ 2ï¼ˆ30 åˆ†ï¼‰
- é€šç¼©è½¬è´¦ï¼ˆ15 åˆ†ï¼‰
- é”€æ¯ç‡è°ƒæ•´ï¼ˆ5 åˆ†ï¼‰
- ç»Ÿè®¡åŠŸèƒ½ï¼ˆ5 åˆ†ï¼‰
- æ¿€æ´»æ§åˆ¶ï¼ˆ5 åˆ†ï¼‰

### ä»»åŠ¡ 3ï¼ˆ30 åˆ†ï¼‰
- å¤šç­¾é…ç½®ï¼ˆ5 åˆ†ï¼‰
- ææ¡ˆç³»ç»Ÿï¼ˆ10 åˆ†ï¼‰
- ç­¾åæœºåˆ¶ï¼ˆ10 åˆ†ï¼‰
- æ‰§è¡Œé€»è¾‘ï¼ˆ5 åˆ†ï¼‰

**æ€»åˆ† 70 åˆ†ä»¥ä¸Šé€šè¿‡**

---

**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š
- ä»»åŠ¡ 1ï¼š1.5 å°æ—¶
- ä»»åŠ¡ 2ï¼š1 å°æ—¶
- ä»»åŠ¡ 3ï¼š1 å°æ—¶

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼** ğŸš€ğŸ”
