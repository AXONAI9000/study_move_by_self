# Day 06 å®è·µä»»åŠ¡

## ä»»åŠ¡æ¦‚è¿°

ä»Šå¤©ä½ éœ€è¦å®Œæˆä¸‰ä¸ªç”±æµ…å…¥æ·±çš„ç¼–ç¨‹ä»»åŠ¡ï¼Œå·©å›ºæ³›å‹ç¼–ç¨‹å’Œèƒ½åŠ›ç³»ç»Ÿçš„çŸ¥è¯†ã€‚

---

## ä»»åŠ¡ 1ï¼šæ³›å‹æ•°æ®ç»“æ„ï¼ˆ30 åˆ†ï¼‰

### ğŸ“‹ ä»»åŠ¡æè¿°

å®ç°ä¸€ä¸ªæ³›å‹çš„ `Stack`ï¼ˆæ ˆï¼‰æ•°æ®ç»“æ„ï¼Œæ”¯æŒ `push`ã€`pop`ã€`peek` ç­‰æ“ä½œã€‚

### ğŸ¯ åŠŸèƒ½è¦æ±‚

1. å®šä¹‰æ³›å‹ç»“æ„ä½“ `Stack<T>`
2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `create_stack<T>()`: åˆ›å»ºç©ºæ ˆ
   - `push<T>(stack: &mut Stack<T>, value: T)`: å‹å…¥å…ƒç´ 
   - `pop<T>(stack: &mut Stack<T>): T`: å¼¹å‡ºå…ƒç´ 
   - `peek<T: copy>(stack: &Stack<T>): T`: æŸ¥çœ‹æ ˆé¡¶ï¼ˆä¸ç§»é™¤ï¼‰
   - `is_empty<T>(stack: &Stack<T>): bool`: æ£€æŸ¥æ˜¯å¦ä¸ºç©º
   - `size<T>(stack: &Stack<T>): u64`: è·å–æ ˆå¤§å°

### ğŸ’¡ æç¤º

- ä½¿ç”¨ `vector` ä½œä¸ºåº•å±‚å­˜å‚¨
- æ³¨æ„ `peek` éœ€è¦ `T: copy` çº¦æŸ
- `pop` åœ¨ç©ºæ ˆæ—¶åº”è¯¥ `abort`

### âœ… æµ‹è¯•ç”¨ä¾‹

```move
#[test]
fun test_stack_operations() {
    let stack = create_stack<u64>();
    assert!(is_empty(&stack), 0);
    
    push(&mut stack, 10);
    push(&mut stack, 20);
    push(&mut stack, 30);
    
    assert!(size(&stack) == 3, 1);
    assert!(peek(&stack) == 30, 2);
    
    let val = pop(&mut stack);
    assert!(val == 30, 3);
    assert!(size(&stack) == 2, 4);
}
```

### ğŸ“ å¯åŠ¨ä»£ç 

åœ¨ `å¯åŠ¨ä»£ç /task1_stack.move` ä¸­å·²æä¾›åŸºç¡€æ¡†æ¶ã€‚

---

## ä»»åŠ¡ 2ï¼šèƒ½åŠ›ç³»ç»Ÿå®æˆ˜ - ä»£å¸ç³»ç»Ÿï¼ˆ40 åˆ†ï¼‰

### ğŸ“‹ ä»»åŠ¡æè¿°

å®ç°ä¸€ä¸ªç®€å•çš„ä»£å¸ç³»ç»Ÿï¼Œæ­£ç¡®ä½¿ç”¨èƒ½åŠ›ç³»ç»Ÿä¿è¯å®‰å…¨æ€§ã€‚

### ğŸ¯ åŠŸèƒ½è¦æ±‚

1. å®šä¹‰ä»¥ä¸‹ç»“æ„ä½“ï¼ˆ**æ³¨æ„èƒ½åŠ›å£°æ˜**ï¼‰ï¼š
   - `Coin`ï¼šä»£å¸ç»“æ„ï¼Œåº”è¯¥åªæœ‰ `store` èƒ½åŠ›
   - `CoinStore`ï¼šç”¨æˆ·çš„ä»£å¸å­˜å‚¨ï¼Œåº”è¯¥æœ‰ `key` èƒ½åŠ›
   - `MintCapability`ï¼šé“¸å¸æƒé™å‡­è¯ï¼Œä¸åº”è¯¥æœ‰ `copy` å’Œ `store`
   - `BurnCapability`ï¼šé”€æ¯æƒé™å‡­è¯ï¼Œä¸åº”è¯¥æœ‰ `copy` å’Œ `store`

2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `initialize(account: &signer): (MintCapability, BurnCapability)`: åˆå§‹åŒ–ä»£å¸æ¨¡å—
   - `register(account: &signer)`: æ³¨å†Œç”¨æˆ·è´¦æˆ·
   - `mint(cap: &MintCapability, amount: u64): Coin`: é“¸é€ ä»£å¸
   - `burn(cap: &BurnCapability, coin: Coin)`: é”€æ¯ä»£å¸
   - `deposit(account: &signer, coin: Coin)`: å­˜å…¥ä»£å¸
   - `withdraw(account: &signer, amount: u64): Coin`: å–å‡ºä»£å¸
   - `balance(addr: address): u64`: æŸ¥è¯¢ä½™é¢
   - `transfer(from: &signer, to: address, amount: u64)`: è½¬è´¦

### ğŸ” å®‰å…¨è¦æ±‚

1. `Coin` ä¸èƒ½æœ‰ `copy` èƒ½åŠ›ï¼ˆé˜²æ­¢åŒèŠ±ï¼‰
2. `Coin` ä¸èƒ½æœ‰ `drop` èƒ½åŠ›ï¼ˆé˜²æ­¢ä¸¢å¤±ï¼‰
3. `MintCapability` å’Œ `BurnCapability` ä¸èƒ½æœ‰ `store` èƒ½åŠ›ï¼ˆä¸èƒ½è¢«æŒä¹…åŒ–å­˜å‚¨ï¼‰
4. è½¬è´¦æ—¶è¦æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³

### ğŸ’¡ æç¤º

- ä½¿ç”¨ `vector::borrow_mut` è®¿é—® vector ä¸­çš„å…ƒç´ 
- è®°å¾—æ·»åŠ  `acquires` å£°æ˜
- ä½¿ç”¨ `assert!` è¿›è¡Œé”™è¯¯æ£€æŸ¥

### âœ… æµ‹è¯•ç”¨ä¾‹

```move
#[test(admin = @0x1, user1 = @0x2, user2 = @0x3)]
fun test_coin_system(admin: &signer, user1: &signer, user2: &signer) {
    // åˆå§‹åŒ–
    let (mint_cap, burn_cap) = initialize(admin);
    
    // æ³¨å†Œç”¨æˆ·
    register(user1);
    register(user2);
    
    // é“¸é€ å’Œå­˜å…¥
    let coin = mint(&mint_cap, 1000);
    deposit(user1, coin);
    
    // è½¬è´¦
    transfer(user1, signer::address_of(user2), 300);
    
    // éªŒè¯ä½™é¢
    assert!(balance(signer::address_of(user1)) == 700, 0);
    assert!(balance(signer::address_of(user2)) == 300, 1);
    
    // æ¸…ç†èƒ½åŠ›å‡­è¯
    destroy_capabilities(mint_cap, burn_cap);
}
```

### ğŸ“ å¯åŠ¨ä»£ç 

åœ¨ `å¯åŠ¨ä»£ç /task2_coin.move` ä¸­å·²æä¾›åŸºç¡€æ¡†æ¶ã€‚

---

## ä»»åŠ¡ 3ï¼šé«˜çº§åº”ç”¨ - é—ªç”µè´·ï¼ˆ30 åˆ†ï¼‰

### ğŸ“‹ ä»»åŠ¡æè¿°

ä½¿ç”¨ Hot Potato æ¨¡å¼å®ç°ä¸€ä¸ªç®€å•çš„é—ªç”µè´·ç³»ç»Ÿã€‚

### ğŸ¯ åŠŸèƒ½è¦æ±‚

1. å®šä¹‰ `Receipt` ç»“æ„ä½“ï¼ˆ**ä¸è¦ç»™ä»»ä½•èƒ½åŠ›**ï¼‰ï¼š
   ```move
   struct Receipt {
       borrowed_amount: u64,
       fee: u64,
       borrower: address
   }
   ```

2. å®ç°ä»¥ä¸‹å‡½æ•°ï¼š
   - `borrow(pool: &mut LiquidityPool, amount: u64, borrower: address): (Coin, Receipt)`: å€Ÿå‡ºä»£å¸
   - `repay(pool: &mut LiquidityPool, coin: Coin, receipt: Receipt)`: å½’è¿˜ä»£å¸
   - `get_pool_balance(pool: &LiquidityPool): u64`: æŸ¥è¯¢æ± å­ä½™é¢

3. ä¸šåŠ¡é€»è¾‘ï¼š
   - å€Ÿè´·æ”¶å– 0.3% æ‰‹ç»­è´¹
   - å¿…é¡»åœ¨åŒä¸€äº¤æ˜“å†…å®Œæˆå€Ÿè¿˜
   - å½’è¿˜é‡‘é¢ = å€Ÿå‡ºé‡‘é¢ + æ‰‹ç»­è´¹

### ğŸ” å®‰å…¨æœºåˆ¶

`Receipt` æ²¡æœ‰ä»»ä½•èƒ½åŠ›ï¼Œè¿™æ„å‘³ç€ï¼š
- âœ… ä¸èƒ½è¢«å¤åˆ¶ï¼ˆé˜²æ­¢é‡å¤å€Ÿæ¬¾ï¼‰
- âœ… ä¸èƒ½è¢«ä¸¢å¼ƒï¼ˆå¿…é¡»å½’è¿˜ï¼‰
- âœ… ä¸èƒ½è¢«å­˜å‚¨ï¼ˆå¿…é¡»åœ¨å½“å‰ä½œç”¨åŸŸå¤„ç†ï¼‰
- âœ… ç¼–è¯‘å™¨å¼ºåˆ¶ç”¨æˆ·å¿…é¡»è°ƒç”¨ `repay`

### ğŸ’¡ æç¤º

- æ‰‹ç»­è´¹è®¡ç®—ï¼š`borrowed_amount * 3 / 1000`
- ä½¿ç”¨ `coin::value()` è·å–ä»£å¸é‡‘é¢
- ä½¿ç”¨ `coin::merge()` å’Œ `coin::split()` å¤„ç†ä»£å¸

### âœ… æµ‹è¯•ç”¨ä¾‹

```move
#[test(user = @0x1)]
fun test_flash_loan(user: &signer) {
    // åˆ›å»ºæµåŠ¨æ€§æ± 
    let pool = create_pool_with_liquidity(10000);
    
    // é—ªç”µè´·ï¼šå€Ÿ 1000
    let (borrowed_coin, receipt) = borrow(&mut pool, 1000, signer::address_of(user));
    
    // åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨ borrowed_coin åšå¥—åˆ©...
    // å‡è®¾å¥—åˆ©è·å¾— 10 ä¸ªå¸
    let profit_coin = mint_for_test(10);
    let repay_coin = merge(borrowed_coin, profit_coin);
    
    // å½’è¿˜ï¼ˆæœ¬é‡‘ 1000 + æ‰‹ç»­è´¹ 3 = 1003ï¼‰
    repay(&mut pool, repay_coin, receipt);
    
    // éªŒè¯æ± å­ä½™é¢å¢åŠ äº†æ‰‹ç»­è´¹
    assert!(get_pool_balance(&pool) == 10003, 0);
    
    destroy_pool(pool);
}

#[test(user = @0x1)]
#[expected_failure]  // åº”è¯¥å¤±è´¥ï¼šå¿˜è®°å½’è¿˜
fun test_flash_loan_must_repay(user: &signer) {
    let pool = create_pool_with_liquidity(10000);
    let (borrowed_coin, receipt) = borrow(&mut pool, 1000, signer::address_of(user));
    
    // é”™è¯¯ï¼šæ²¡æœ‰è°ƒç”¨ repay
    // ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼šreceipt æ²¡æœ‰ drop èƒ½åŠ›
    
    destroy_coin(borrowed_coin);
    destroy_pool(pool);
    // receipt æ— æ³•å¤„ç†ï¼Œç¼–è¯‘å¤±è´¥ï¼
}
```

### ğŸ“ å¯åŠ¨ä»£ç 

åœ¨ `å¯åŠ¨ä»£ç /task3_flashloan.move` ä¸­å·²æä¾›åŸºç¡€æ¡†æ¶ã€‚

---

## æäº¤è¦æ±‚

### ğŸ“‚ æ–‡ä»¶ç»“æ„

```
02_å®è·µä»»åŠ¡/
â”œâ”€â”€ ä½ çš„ç­”æ¡ˆ/
â”‚   â”œâ”€â”€ task1_stack.move
â”‚   â”œâ”€â”€ task2_coin.move
â”‚   â””â”€â”€ task3_flashloan.move
â””â”€â”€ Move.toml  // é¡¹ç›®é…ç½®æ–‡ä»¶
```

### âœ… éªŒè¯æ–¹æ³•

åœ¨ `02_å®è·µä»»åŠ¡` ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
# æµ‹è¯•æ‰€æœ‰ä»»åŠ¡
aptos move test

# æµ‹è¯•ç‰¹å®šä»»åŠ¡
aptos move test --filter task1
aptos move test --filter task2
aptos move test --filter task3
```

### ğŸ“Š è¯„åˆ†æ ‡å‡†

| é¡¹ç›® | åˆ†æ•° | è¯„åˆ†è¦ç‚¹ |
|------|------|----------|
| **ä»»åŠ¡ 1** | 30 | åŠŸèƒ½å®Œæ•´æ€§ (15åˆ†) + ä»£ç è´¨é‡ (10åˆ†) + æµ‹è¯•é€šè¿‡ (5åˆ†) |
| **ä»»åŠ¡ 2** | 40 | èƒ½åŠ›å£°æ˜æ­£ç¡® (15åˆ†) + åŠŸèƒ½å®ç° (15åˆ†) + å®‰å…¨æ€§ (10åˆ†) |
| **ä»»åŠ¡ 3** | 30 | Hot Potato æ¨¡å¼æ­£ç¡® (15åˆ†) + é€»è¾‘æ­£ç¡® (10åˆ†) + æµ‹è¯•é€šè¿‡ (5åˆ†) |

**æ€»åˆ†**ï¼š100 åˆ†  
**åŠæ ¼çº¿**ï¼š70 åˆ†  
**ä¼˜ç§€çº¿**ï¼š85 åˆ†

---

## ğŸ’¡ å­¦ä¹ å»ºè®®

1. **ä»»åŠ¡ 1**ï¼šç†Ÿæ‚‰æ³›å‹çš„åŸºæœ¬ä½¿ç”¨ï¼Œç†è§£ç±»å‹å‚æ•°
2. **ä»»åŠ¡ 2**ï¼šé‡ç‚¹ç†è§£èƒ½åŠ›ç³»ç»Ÿå¦‚ä½•ä¿è¯èµ„æºå®‰å…¨
3. **ä»»åŠ¡ 3**ï¼šä½“ä¼š Hot Potato æ¨¡å¼çš„å¼ºå¤§çº¦æŸåŠ›

### å¸¸è§é”™è¯¯

âŒ **é”™è¯¯ 1**ï¼šç»™ `Coin` æ·»åŠ  `copy` èƒ½åŠ›
```move
struct Coin has copy, store { ... }  // é”™è¯¯ï¼
```

âŒ **é”™è¯¯ 2**ï¼šå¿˜è®°æ·»åŠ  `acquires` å£°æ˜
```move
public fun balance(addr: address): u64 {  // ç¼ºå°‘ acquires
    borrow_global<CoinStore>(addr).balance
}
```

âŒ **é”™è¯¯ 3**ï¼šHot Potato ç»™äº†èƒ½åŠ›
```move
struct Receipt has drop { ... }  // é”™è¯¯ï¼ä¸åº”è¯¥æœ‰ drop
```

---

## ğŸ¯ å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] ä»£ç ç¬¦åˆ Move ç¼–ç è§„èŒƒ
- [ ] æ­£ç¡®ä½¿ç”¨èƒ½åŠ›ç³»ç»Ÿ
- [ ] æ²¡æœ‰æœªå¤„ç†çš„èµ„æº

**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š3 å°æ—¶

åŠ æ²¹ï¼å®Œæˆè¿™äº›ä»»åŠ¡åï¼Œä½ å°†å¯¹æ³›å‹å’Œèƒ½åŠ›ç³»ç»Ÿæœ‰æ·±åˆ»çš„ç†è§£ï¼
