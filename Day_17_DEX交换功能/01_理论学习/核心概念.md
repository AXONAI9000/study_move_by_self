# Day 17 ç†è®ºå­¦ä¹ ï¼šDEX äº¤æ¢åŠŸèƒ½æ ¸å¿ƒæ¦‚å¿µ

## ğŸ“š ç›®å½•

1. [Swap åŸºç¡€æ¦‚å¿µ](#swap-åŸºç¡€æ¦‚å¿µ)
2. [æ’å®šä¹˜ç§¯ä¸æ‰‹ç»­è´¹](#æ’å®šä¹˜ç§¯ä¸æ‰‹ç»­è´¹)
3. [æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶](#æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶)
4. [è·¯ç”±ä¸æœ€ä¼˜è·¯å¾„](#è·¯ç”±ä¸æœ€ä¼˜è·¯å¾„)
5. [MEV ä¸å®‰å…¨æ€§](#mev-ä¸å®‰å…¨æ€§)
6. [å®ç°ç»†èŠ‚ä¸ä¼˜åŒ–](#å®ç°ç»†èŠ‚ä¸ä¼˜åŒ–)

---

## 1. Swap åŸºç¡€æ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯ Swapï¼Ÿ

**Swapï¼ˆäº¤æ¢ï¼‰** æ˜¯å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·åœ¨æ— éœ€è®¢å•ç°¿çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€ç§ä»£å¸äº¤æ¢å¦ä¸€ç§ä»£å¸ã€‚

### 1.2 Swap vs ä¼ ç»Ÿè®¢å•ç°¿

| ç‰¹æ€§ | è®¢å•ç°¿ DEX | AMM DEX (Swap) |
|------|----------|----------------|
| **ä»·æ ¼å‘ç°** | ä¹°å–è®¢å•åŒ¹é… | å‚¨å¤‡æ¯”ä¾‹è‡ªåŠ¨å®šä»· |
| **æµåŠ¨æ€§** | éœ€è¦æŒ‚å•è€… | æµåŠ¨æ€§æ± æä¾› |
| **æ‰§è¡Œé€Ÿåº¦** | éœ€ç­‰å¾…åŒ¹é… | å³æ—¶æ‰§è¡Œ |
| **ä»·æ ¼æ»‘ç‚¹** | è®¢å•æ·±åº¦å†³å®š | äº¤æ˜“é‡å†³å®š |
| **Gas æˆæœ¬** | è¾ƒä½ | è¾ƒé«˜ |
| **å¤æ‚åº¦** | é«˜ | ä½ |

### 1.3 Swap çš„ä¸¤ç§ç±»å‹

#### A. Exact Input Swapï¼ˆç²¾ç¡®è¾“å…¥ï¼‰

ç”¨æˆ·æŒ‡å®š**è¾“å…¥æ•°é‡**ï¼Œç³»ç»Ÿè®¡ç®—è¾“å‡ºæ•°é‡ã€‚

```
ç”¨æˆ·è¯´ï¼š"æˆ‘è¦ç”¨ 100 USDC æ¢ APT"
ç³»ç»Ÿè®¡ç®—ï¼š"ä½ å°†å¾—åˆ° 4.95 APT"
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·æƒ³èŠ±è´¹ç‰¹å®šæ•°é‡çš„ä»£å¸
- å–å‡ºèµ„äº§
- æœ€å¸¸è§çš„äº¤æ˜“ç±»å‹

#### B. Exact Output Swapï¼ˆç²¾ç¡®è¾“å‡ºï¼‰

ç”¨æˆ·æŒ‡å®š**è¾“å‡ºæ•°é‡**ï¼Œç³»ç»Ÿè®¡ç®—æ‰€éœ€è¾“å…¥ã€‚

```
ç”¨æˆ·è¯´ï¼š"æˆ‘è¦å¾—åˆ° 5 APT"
ç³»ç»Ÿè®¡ç®—ï¼š"ä½ éœ€è¦æ”¯ä»˜ 101.5 USDC"
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·éœ€è¦è·å¾—ç‰¹å®šæ•°é‡çš„ä»£å¸
- è´­ä¹°å›ºå®šæ•°é‡çš„èµ„äº§
- æ”¯ä»˜åœºæ™¯

---

## 2. æ’å®šä¹˜ç§¯ä¸æ‰‹ç»­è´¹

### 2.1 åŸºç¡€å…¬å¼å›é¡¾

**æ’å®šä¹˜ç§¯å…¬å¼ï¼ˆæ— æ‰‹ç»­è´¹ï¼‰**ï¼š

```
x * y = k

å…¶ä¸­ï¼š
x = ä»£å¸ X çš„å‚¨å¤‡é‡
y = ä»£å¸ Y çš„å‚¨å¤‡é‡
k = æ’å®šä¹˜ç§¯ï¼ˆå¸¸æ•°ï¼‰
```

**Swap è®¡ç®—**ï¼š

```
æ–°å‚¨å¤‡ï¼š
x' = x + Î”x  ï¼ˆç”¨æˆ·è¾“å…¥çš„ Xï¼‰
y' = y - Î”y  ï¼ˆç”¨æˆ·è·å¾—çš„ Yï¼‰

ä¿æŒ k ä¸å˜ï¼š
(x + Î”x) * (y - Î”y) = x * y

æ±‚è§£ Î”yï¼š
Î”y = y - (x * y) / (x + Î”x)
   = (y * Î”x) / (x + Î”x)
```

### 2.2 åŠ å…¥æ‰‹ç»­è´¹çš„å…¬å¼

**å®é™… DEX ä¸­çš„å…¬å¼**ï¼š

```
æ‰‹ç»­è´¹ç‡ï¼šfee_rate = 0.3% = 30 basis points

å®é™…ç”¨äºäº¤æ¢çš„è¾“å…¥ï¼š
amount_in_with_fee = amount_in * (1 - fee_rate)
                   = amount_in * 0.997
                   = amount_in * 997 / 1000

è¾“å‡ºè®¡ç®—ï¼š
amount_out = (reserve_out * amount_in_with_fee) / (reserve_in + amount_in_with_fee)

å®Œæ•´å…¬å¼ï¼š
amount_out = (reserve_out * amount_in * 997) / (reserve_in * 1000 + amount_in * 997)
```

### 2.3 æ‰‹ç»­è´¹å»å“ªé‡Œäº†ï¼Ÿ

```
è¾“å…¥ï¼š100 USDC
æ‰‹ç»­è´¹ï¼š100 * 0.003 = 0.3 USDC
å®é™…äº¤æ¢é‡‘é¢ï¼š99.7 USDC

æ‰‹ç»­è´¹åˆ†é…ï¼š
1. å½’å…¥æµåŠ¨æ€§æ± å‚¨å¤‡ â†’ æ‰€æœ‰ LP æŒ‰æ¯”ä¾‹å—ç›Š
2. å¯é€‰ï¼šåè®®è´¹ç”¨ï¼ˆä¾‹å¦‚ 0.05%ï¼‰â†’ åè®®é‡‘åº“
```

**å…³é”®ç†è§£**ï¼š
- æ‰‹ç»­è´¹**ä¸ä¼š**ä»è¾“å‡ºä¸­æ‰£é™¤
- æ‰‹ç»­è´¹**å‡å°‘**äº†å®é™…ç”¨äºäº¤æ¢çš„è¾“å…¥
- æ‰‹ç»­è´¹**å¢åŠ **äº†æ± å­çš„å‚¨å¤‡
- å› æ­¤ K å€¼ä¼šç•¥å¾®**å¢åŠ **

### 2.4 K å€¼çš„å˜åŒ–

```
äº¤æ˜“å‰ï¼šk_before = x * y
äº¤æ˜“åï¼šk_after = (x + amount_in) * (y - amount_out)

ç”±äºæ‰‹ç»­è´¹çš„å­˜åœ¨ï¼š
k_after > k_before

å¢åŠ é‡ = æ‰‹ç»­è´¹è´¡çŒ®
```

**ç¤ºä¾‹è®¡ç®—**ï¼š

```
æ± å­çŠ¶æ€ï¼š
reserve_x = 1,000,000 USDC
reserve_y = 50,000 APT
k_before = 50,000,000,000

ç”¨æˆ· Swapï¼š
amount_in = 10,000 USDC
fee = 30 USDC
amount_in_with_fee = 9,970 USDC

è®¡ç®—è¾“å‡ºï¼š
amount_out = (50,000 * 9,970) / (1,000,000 + 9,970)
           = 498,500,000 / 1,009,970
           â‰ˆ 493.58 APT

æ–°å‚¨å¤‡ï¼š
new_reserve_x = 1,000,000 + 10,000 = 1,010,000 USDC
new_reserve_y = 50,000 - 493.58 = 49,506.42 APT
k_after = 1,010,000 * 49,506.42 = 50,001,484,200

K å€¼å¢åŠ ï¼š
Î”k = 50,001,484,200 - 50,000,000,000 = 1,484,200
å¢é•¿ç‡ = 1,484,200 / 50,000,000,000 â‰ˆ 0.003% âœ“
```

---

## 3. æ»‘ç‚¹ä¿æŠ¤æœºåˆ¶

### 3.1 ä»€ä¹ˆæ˜¯æ»‘ç‚¹ï¼Ÿ

**æ»‘ç‚¹ï¼ˆSlippageï¼‰** æ˜¯æŒ‡é¢„æœŸä»·æ ¼ä¸å®é™…æ‰§è¡Œä»·æ ¼ä¹‹é—´çš„å·®å¼‚ã€‚

**äº§ç”ŸåŸå› **ï¼š
1. **äº¤æ˜“è§„æ¨¡** - å¤§é¢äº¤æ˜“å¯¼è‡´ä»·æ ¼ç§»åŠ¨
2. **å¹¶å‘äº¤æ˜“** - å…¶ä»–äººæŠ¢å…ˆäº¤æ˜“
3. **å»¶è¿Ÿ** - æäº¤å’Œæ‰§è¡Œä¹‹é—´çš„æ—¶é—´å·®

### 3.2 ä»·æ ¼æ»‘ç‚¹çš„è®¡ç®—

```
åˆå§‹ä»·æ ¼ï¼š
P_old = reserve_y / reserve_x

äº¤æ˜“åä»·æ ¼ï¼š
P_new = (reserve_y - amount_out) / (reserve_x + amount_in)

ä»·æ ¼å˜åŒ–ï¼š
Î”P = P_new - P_old

æ»‘ç‚¹ç™¾åˆ†æ¯”ï¼š
Slippage% = |Î”P| / P_old * 100%
```

**ç¤ºä¾‹**ï¼š

```
æ± å­ï¼š1,000,000 USDC / 50,000 APT
åˆå§‹ä»·æ ¼ï¼š1 APT = 20 USDC

ç”¨æˆ·ä¹°å…¥ 1,000 APTï¼š
éœ€è¦æ”¯ä»˜ï¼šâ‰ˆ 20,408 USDC
å¹³å‡ä»·æ ¼ï¼š20.408 USDC/APT
æ»‘ç‚¹ï¼š(20.408 - 20) / 20 = 2.04%
```

### 3.3 æ»‘ç‚¹ä¿æŠ¤çš„å®ç°

#### A. Exact Input çš„æ»‘ç‚¹ä¿æŠ¤

```move
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64,  // æœ€å°æ¥å—è¾“å‡º
) {
    // 1. è®¡ç®—å®é™…è¾“å‡º
    let amount_out = calculate_amount_out(amount_in);
    
    // 2. æ»‘ç‚¹æ£€æŸ¥
    assert!(
        amount_out >= min_amount_out, 
        ERROR_SLIPPAGE_EXCEEDED
    );
    
    // 3. æ‰§è¡Œäº¤æ¢
    execute_swap(user, amount_in, amount_out);
}
```

**ç”¨æˆ·è®¾ç½®æ»‘ç‚¹å®¹å¿åº¦**ï¼š

```
é¢„æœŸè¾“å‡ºï¼š100 APT
æ»‘ç‚¹å®¹å¿åº¦ï¼š1%
min_amount_out = 100 * (1 - 0.01) = 99 APT

å¦‚æœå®é™…è¾“å‡º < 99 APTï¼Œäº¤æ˜“å¤±è´¥
```

#### B. Exact Output çš„æ»‘ç‚¹ä¿æŠ¤

```move
public entry fun swap_exact_output<X, Y>(
    user: &signer,
    amount_out: u64,
    max_amount_in: u64,  // æœ€å¤§æ„¿æ„æ”¯ä»˜
) {
    // 1. è®¡ç®—æ‰€éœ€è¾“å…¥
    let amount_in = calculate_amount_in(amount_out);
    
    // 2. æ»‘ç‚¹æ£€æŸ¥
    assert!(
        amount_in <= max_amount_in, 
        ERROR_EXCESSIVE_INPUT
    );
    
    // 3. æ‰§è¡Œäº¤æ¢
    execute_swap(user, amount_in, amount_out);
}
```

**ç”¨æˆ·è®¾ç½®æ»‘ç‚¹å®¹å¿åº¦**ï¼š

```
æœŸæœ›è¾“å‡ºï¼š100 APT
é¢„æœŸè¾“å…¥ï¼š2000 USDC
æ»‘ç‚¹å®¹å¿åº¦ï¼š1%
max_amount_in = 2000 * (1 + 0.01) = 2020 USDC

å¦‚æœå®é™…éœ€è¦ > 2020 USDCï¼Œäº¤æ˜“å¤±è´¥
```

### 3.4 å‰ç«¯æ»‘ç‚¹è®¾ç½®æœ€ä½³å®è·µ

```typescript
// å‰ç«¯è®¡ç®—ç¤ºä¾‹
const slippageTolerance = 0.5; // 0.5%

// Exact Input
const expectedOutput = calculateOutput(amountIn);
const minAmountOut = expectedOutput * (1 - slippageTolerance / 100);

// Exact Output
const expectedInput = calculateInput(amountOut);
const maxAmountIn = expectedInput * (1 + slippageTolerance / 100);
```

**æ¨èæ»‘ç‚¹è®¾ç½®**ï¼š
- **ç¨³å®šå¸å¯¹** (USDC/USDT): 0.1% - 0.3%
- **ä¸»æµå¸å¯¹** (APT/USDC): 0.5% - 1%
- **ä½æµåŠ¨æ€§** (å°å¸‚å€¼ä»£å¸): 2% - 5%
- **æä½æµåŠ¨æ€§**: 5% - 10%

---

## 4. è·¯ç”±ä¸æœ€ä¼˜è·¯å¾„

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è·¯ç”±ï¼Ÿ

**é—®é¢˜**ï¼šå¹¶éæ‰€æœ‰ä»£å¸å¯¹éƒ½æœ‰ç›´æ¥çš„æµåŠ¨æ€§æ± ã€‚

```
ç”¨æˆ·æƒ³è¦ï¼šUSDC â†’ Token_A
ä½†æ˜¯ï¼šæ²¡æœ‰ USDC/Token_A æ± å­

è§£å†³æ–¹æ¡ˆï¼šå¤šè·³äº¤æ¢
USDC â†’ APT â†’ Token_A
```

### 4.2 å•è·³ vs å¤šè·³

#### å•è·³äº¤æ¢ï¼ˆDirect Swapï¼‰

```
Pool: X/Y
Input: X â†’ Output: Y

ä¼˜ç‚¹ï¼š
- Gas æˆæœ¬ä½
- æ»‘ç‚¹å°ï¼ˆåªæœ‰ä¸€æ¬¡äº¤æ˜“ï¼‰
- ç®€å•ç›´æ¥

ç¼ºç‚¹ï¼š
- éœ€è¦ç›´æ¥æ± å­å­˜åœ¨
```

#### å¤šè·³äº¤æ¢ï¼ˆMulti-Hop Swapï¼‰

```
Pool1: X/Z, Pool2: Z/Y
Input: X â†’ Z â†’ Y

ä¼˜ç‚¹ï¼š
- æ”¯æŒæ›´å¤šäº¤æ˜“å¯¹
- å¯èƒ½è·å¾—æ›´å¥½ä»·æ ¼ï¼ˆåˆ†æ•£æ»‘ç‚¹ï¼‰

ç¼ºç‚¹ï¼š
- Gas æˆæœ¬é«˜
- æ€»æ»‘ç‚¹ç´¯ç§¯
- å¤æ‚åº¦å¢åŠ 
```

### 4.3 è·¯ç”±ç®—æ³•

#### ç®€å•è·¯ç”±ï¼ˆ2è·³ï¼‰

```move
public entry fun swap_two_hop<X, Y, Z>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64,
) {
    // ç¬¬ä¸€è·³ï¼šX â†’ Z
    let amount_z = swap_internal<X, Z>(user, amount_in, 0);
    
    // ç¬¬äºŒè·³ï¼šZ â†’ Y
    let amount_out = swap_internal<Z, Y>(user, amount_z, 0);
    
    // æœ€ç»ˆæ»‘ç‚¹æ£€æŸ¥
    assert!(amount_out >= min_amount_out, ERROR_SLIPPAGE);
}
```

#### æ™ºèƒ½è·¯ç”±ï¼ˆå¯»æ‰¾æœ€ä¼˜è·¯å¾„ï¼‰

**è€ƒè™‘å› ç´ **ï¼š
1. **ä»·æ ¼å½±å“** - å“ªæ¡è·¯å¾„æ»‘ç‚¹æœ€å°ï¼Ÿ
2. **æµåŠ¨æ€§æ·±åº¦** - å“ªä¸ªæ± å­èƒ½å¤„ç†å¤§é¢äº¤æ˜“ï¼Ÿ
3. **æ‰‹ç»­è´¹** - å¤šè·³ç´¯ç§¯çš„æ‰‹ç»­è´¹
4. **Gas æˆæœ¬** - è·¯å¾„è¶Šé•¿ï¼ŒGas è¶Šé«˜

**è·¯å¾„æ¯”è¾ƒç¤ºä¾‹**ï¼š

```
ç›®æ ‡ï¼šç”¨ 10,000 USDC ä¹° Token_A

è·¯å¾„ 1ï¼ˆç›´æ¥ï¼‰ï¼šUSDC â†’ Token_A
- æ± å­æµåŠ¨æ€§ï¼š$50,000
- é¢„æœŸè¾“å‡ºï¼š450 Token_A
- æ»‘ç‚¹ï¼š2.5%
- æ‰‹ç»­è´¹ï¼š0.3%

è·¯å¾„ 2ï¼ˆä¸¤è·³ï¼‰ï¼šUSDC â†’ APT â†’ Token_A
- æ± å­1æµåŠ¨æ€§ï¼š$10,000,000
- æ± å­2æµåŠ¨æ€§ï¼š$100,000
- é¢„æœŸè¾“å‡ºï¼š455 Token_A
- æ»‘ç‚¹ï¼š1.2%
- æ‰‹ç»­è´¹ï¼š0.6%ï¼ˆç´¯ç§¯ï¼‰

é€‰æ‹©ï¼šè·¯å¾„ 2 æ›´ä¼˜ï¼ˆè¾“å‡ºæ›´å¤šï¼‰
```

### 4.4 Split Routingï¼ˆæ‹†åˆ†è·¯ç”±ï¼‰

**é«˜çº§ä¼˜åŒ–**ï¼šå°†å¤§é¢äº¤æ˜“æ‹†åˆ†åˆ°å¤šæ¡è·¯å¾„ã€‚

```
ç›®æ ‡ï¼šç”¨ 100,000 USDC ä¹° APT

ç­–ç•¥ï¼š
- 70% èµ° USDC â†’ APT ç›´æ¥æ± 
- 30% èµ° USDC â†’ WETH â†’ APT

åŸå› ï¼š
- é¿å…å•ä¸ªæ± å­æ»‘ç‚¹è¿‡å¤§
- åˆ†æ•£ä»·æ ¼å½±å“
- å¯èƒ½è·å¾—æ›´å¥½çš„æ€»ä½“ä»·æ ¼
```

**å®ç°ä¼ªä»£ç **ï¼š

```move
// é«˜çº§æ‹†åˆ†è·¯ç”±
public entry fun split_swap<X, Y>(
    user: &signer,
    amount_in: u64,
    paths: vector<Path>,
    percentages: vector<u64>, // [70, 30]
    min_amount_out: u64,
) {
    let total_out = 0;
    
    // æŒ‰ç™¾åˆ†æ¯”åˆ†é…åˆ°ä¸åŒè·¯å¾„
    for (i in 0..length(paths)) {
        let path_amount = amount_in * percentages[i] / 100;
        let path_out = execute_path(user, paths[i], path_amount);
        total_out = total_out + path_out;
    }
    
    assert!(total_out >= min_amount_out, ERROR_SLIPPAGE);
}
```

---

## 5. MEV ä¸å®‰å…¨æ€§

### 5.1 ä»€ä¹ˆæ˜¯ MEVï¼Ÿ

**MEVï¼ˆMaximal Extractable Valueï¼‰** - çŸ¿å·¥/éªŒè¯è€…é€šè¿‡é‡æ’ã€æ’å…¥æˆ–å®¡æŸ¥äº¤æ˜“æ¥æå–çš„ä»·å€¼ã€‚

åœ¨ DEX ä¸­æœ€å¸¸è§çš„ MEV ç±»å‹ï¼š

#### A. Front-Runningï¼ˆæŠ¢è·‘ï¼‰

```
1. Alice æäº¤å¤§é¢ä¹°å•ï¼šä¹°å…¥ 1000 APT
2. MEV Bot æ£€æµ‹åˆ°è¿™ç¬”äº¤æ˜“
3. Bot æŠ¢å…ˆä¹°å…¥ 500 APTï¼ˆæ¨é«˜ä»·æ ¼ï¼‰
4. Alice çš„äº¤æ˜“æ‰§è¡Œï¼ˆé«˜ä»·ä¹°å…¥ï¼‰
5. Bot ç«‹å³å–å‡º 500 APTï¼ˆè·åˆ©ï¼‰
```

#### B. Sandwich Attackï¼ˆä¸‰æ˜æ²»æ”»å‡»ï¼‰

```
äº¤æ˜“é¡ºåºï¼š
1. [MEV Bot] ä¹°å…¥ â†’ æ¨é«˜ä»·æ ¼
2. [å—å®³è€…] äº¤æ˜“æ‰§è¡Œ â†’ é«˜ä»·æˆäº¤
3. [MEV Bot] å–å‡º â†’ è·åˆ©

ç»“æœï¼š
- Bot è·åˆ©
- ç”¨æˆ·é­å—é¢å¤–æ»‘ç‚¹
```

**ç¤ºä¾‹**ï¼š

```
æ± å­ï¼š1,000,000 USDC / 50,000 APT
ä»·æ ¼ï¼š20 USDC/APT

1. MEV Bot çœ‹åˆ° Alice è¦ä¹° 1,000 APT
2. Bot å…ˆä¹°å…¥ 500 APTï¼ˆæ¶ˆè€—çº¦ 10,101 USDCï¼‰
   æ–°æ± å­ï¼š1,010,101 USDC / 49,500 APT
   æ–°ä»·æ ¼ï¼šâ‰ˆ 20.41 USDC/APT

3. Alice äº¤æ˜“æ‰§è¡Œï¼Œä¹°å…¥ 1,000 APTï¼ˆæ¶ˆè€—çº¦ 20,816 USDCï¼‰
   æ–°æ± å­ï¼š1,030,917 USDC / 48,500 APT
   æ–°ä»·æ ¼ï¼šâ‰ˆ 21.26 USDC/APT
   
4. Bot å–å‡º 500 APTï¼ˆè·å¾—çº¦ 10,650 USDCï¼‰
   åˆ©æ¶¦ï¼š10,650 - 10,101 = 549 USDC
   
Alice æŸå¤±ï¼šé¢å¤–æ”¯ä»˜çº¦ 400 USDCï¼ˆç›¸æ¯”æ— æ”»å‡»æƒ…å†µï¼‰
```

### 5.2 é˜²èŒƒ MEV çš„æ–¹æ³•

#### A. ç”¨æˆ·å±‚é¢

1. **è®¾ç½®åˆç†æ»‘ç‚¹**
   ```
   æ»‘ç‚¹è®¾ç½®å¤ªå¤§ = å®¹æ˜“è¢«æ”»å‡»
   æ»‘ç‚¹è®¾ç½®å¤ªå° = äº¤æ˜“å®¹æ˜“å¤±è´¥
   ```

2. **æ‹†åˆ†å¤§é¢äº¤æ˜“**
   ```
   ä¸è¦ï¼šä¸€æ¬¡æ€§ä¹°å…¥ 10,000 APT
   è€Œæ˜¯ï¼šåˆ†10æ¬¡ï¼Œæ¯æ¬¡ä¹°å…¥ 1,000 APT
   ```

3. **ä½¿ç”¨ç§æœ‰äº¤æ˜“æ± **
   ```
   ç»•è¿‡å…¬å¼€ Mempool
   ç›´æ¥å‘é€ç»™éªŒè¯è€…
   ```

#### B. åè®®å±‚é¢

1. **æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰**
   ```move
   // å¼ºåˆ¶äº¤æ˜“åˆ†æ‰¹æ‰§è¡Œ
   public entry fun twap_order<X, Y>(
       user: &signer,
       total_amount: u64,
       num_executions: u64,
       interval: u64,
   ) {
       // æ¯éš” interval ç§’æ‰§è¡Œä¸€æ¬¡
       // æ¯æ¬¡æ‰§è¡Œ total_amount / num_executions
   }
   ```

2. **Commit-Reveal æ–¹æ¡ˆ**
   ```
   ç¬¬1æ­¥ï¼šç”¨æˆ·æäº¤äº¤æ˜“å“ˆå¸Œï¼ˆéšè—å‚æ•°ï¼‰
   ç¬¬2æ­¥ï¼šç­‰å¾…ç¡®è®¤
   ç¬¬3æ­¥ï¼šæ­ç¤ºå‚æ•°å¹¶æ‰§è¡Œ
   
   æ”»å‡»è€…æ— æ³•æå‰çŸ¥é“äº¤æ˜“å†…å®¹
   ```

3. **æ‰¹é‡æ‹å–**
   ```
   å°†ä¸€æ®µæ—¶é—´å†…çš„æ‰€æœ‰äº¤æ˜“æ‰“åŒ…
   æŒ‰ç»Ÿä¸€æ¸…ç®—ä»·æ ¼æ‰§è¡Œ
   æ¶ˆé™¤äº¤æ˜“é¡ºåºä¼˜åŠ¿
   ```

### 5.3 Move çš„å¤©ç„¶ä¼˜åŠ¿

**èµ„æºæ¨¡å‹çš„ä¿æŠ¤**ï¼š

```move
// Move çš„èµ„æºä¸èƒ½è¢«å¤åˆ¶æˆ–ä¸¢å¼ƒ
struct LiquidityPool<X, Y> has key {
    reserve_x: Coin<X>,
    reserve_y: Coin<Y>,
    // ...
}

// é‡å…¥æ”»å‡»å¾ˆéš¾å‘ç”Ÿ
// å› ä¸ºèµ„æºåœ¨åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªå‡½æ•°æŒæœ‰
```

**é¡ºåºä¿è¯**ï¼š

```move
// Aptos çš„ Block-STM ç¡®ä¿
// å†²çªçš„äº¤æ˜“ä¼šä¸²è¡Œæ‰§è¡Œ
// å‡å°‘äº†æŸäº›ç±»å‹çš„ MEV æ”»å‡»
```

---

## 6. å®ç°ç»†èŠ‚ä¸ä¼˜åŒ–

### 6.1 ç²¾åº¦å¤„ç†

**é—®é¢˜**ï¼šæ•´æ•°é™¤æ³•ä¼šæŸå¤±ç²¾åº¦

```move
// âŒ ä¸å¥½ï¼šå¯èƒ½æŸå¤±ç²¾åº¦
let amount_out = (reserve_out * amount_in) / (reserve_in + amount_in);

// âœ… æ›´å¥½ï¼šä½¿ç”¨ u128 ä¸­é—´è®¡ç®—
let numerator = (reserve_out as u128) * (amount_in as u128);
let denominator = (reserve_in as u128) + (amount_in as u128);
let amount_out = (numerator / denominator as u64);

// âœ… æœ€å¥½ï¼šå…ˆä¹˜åé™¤ï¼Œä¿ç•™æœ€å¤§ç²¾åº¦
let amount_out = mul_div(
    reserve_out,
    amount_in,
    reserve_in + amount_in
);
```

**è‡ªå®šä¹‰ mul_div å‡½æ•°**ï¼š

```move
/// è®¡ç®— (a * b) / cï¼Œé¿å…æº¢å‡º
public fun mul_div(a: u64, b: u64, c: u64): u64 {
    assert!(c != 0, ERROR_DIVIDE_BY_ZERO);
    
    let result = ((a as u128) * (b as u128)) / (c as u128);
    
    // ç¡®ä¿ç»“æœä¸æº¢å‡º u64
    assert!(result <= (MAX_U64 as u128), ERROR_OVERFLOW);
    
    (result as u64)
}
```

### 6.2 Gas ä¼˜åŒ–æŠ€å·§

#### A. å‡å°‘å­˜å‚¨è¯»å†™

```move
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è¯»å–å‚¨å¤‡
let reserve_x = get_reserve_x<X, Y>();
let reserve_y = get_reserve_y<X, Y>();
// ... ä½¿ç”¨ reserve_x
// ... ä½¿ç”¨ reserve_y
let reserve_x_again = get_reserve_x<X, Y>(); // é‡å¤è¯»å–

// âœ… å¥½ï¼šä¸€æ¬¡è¯»å–ï¼Œç¼“å­˜ä½¿ç”¨
let (reserve_x, reserve_y) = get_reserves<X, Y>();
// ... ä½¿ç”¨ reserve_x å’Œ reserve_y
```

#### B. æ‰¹é‡æ“ä½œ

```move
// âœ… æ”¯æŒæ‰¹é‡ Swap
public entry fun batch_swap<X, Y>(
    user: &signer,
    amounts: vector<u64>,
) {
    let pool = borrow_global_mut<Pool<X, Y>>(@swap_address);
    
    // æ‰¹é‡å¤„ç†ï¼Œå‡å°‘çŠ¶æ€æ›´æ–°æ¬¡æ•°
    vector::for_each(amounts, |amount| {
        // å†…éƒ¨å¤„ç†...
    });
    
    // åªåœ¨æœ€åæ›´æ–°ä¸€æ¬¡å‚¨å¤‡
    update_reserves(pool);
}
```

#### C. é¿å…ä¸å¿…è¦çš„è®¡ç®—

```move
// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½è®¡ç®—
public fun get_price<X, Y>(): u64 {
    let (reserve_x, reserve_y) = get_reserves<X, Y>();
    reserve_y * PRECISION / reserve_x
}

// âœ… å¥½ï¼šç¼“å­˜å¸¸ç”¨ä»·æ ¼
struct Pool<X, Y> has key {
    reserve_x: Coin<X>,
    reserve_y: Coin<Y>,
    cached_price: u64,
    last_update: u64,
}
```

### 6.3 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```move
// å®šä¹‰æ¸…æ™°çš„é”™è¯¯ç 
const ERROR_ZERO_AMOUNT: u64 = 1;
const ERROR_INSUFFICIENT_OUTPUT: u64 = 2;
const ERROR_SLIPPAGE_EXCEEDED: u64 = 3;
const ERROR_POOL_NOT_EXISTS: u64 = 4;
const ERROR_INSUFFICIENT_LIQUIDITY: u64 = 5;
const ERROR_K_INVARIANT: u64 = 6;

// è¯¦ç»†çš„é”™è¯¯æ£€æŸ¥
public entry fun swap_exact_input<X, Y>(
    user: &signer,
    amount_in: u64,
    min_amount_out: u64,
) {
    // 1. åŸºç¡€éªŒè¯
    assert!(amount_in > 0, ERROR_ZERO_AMOUNT);
    
    // 2. æ± å­å­˜åœ¨æ€§æ£€æŸ¥
    assert!(pool_exists<X, Y>(), ERROR_POOL_NOT_EXISTS);
    
    // 3. æµåŠ¨æ€§å……è¶³æ€§æ£€æŸ¥
    let (reserve_x, reserve_y) = get_reserves<X, Y>();
    assert!(
        reserve_x > 0 && reserve_y > 0, 
        ERROR_INSUFFICIENT_LIQUIDITY
    );
    
    // 4. è®¡ç®—è¾“å‡º
    let amount_out = calculate_amount_out(
        amount_in, 
        reserve_x, 
        reserve_y
    );
    
    // 5. æ»‘ç‚¹æ£€æŸ¥
    assert!(
        amount_out >= min_amount_out, 
        ERROR_SLIPPAGE_EXCEEDED
    );
    
    // 6. K å€¼éªŒè¯ï¼ˆæ‰§è¡Œåï¼‰
    verify_k_invariant<X, Y>();
}
```

### 6.4 äº‹ä»¶è®¾è®¡

```move
/// Swap äº‹ä»¶
struct SwapEvent has drop, store {
    user: address,
    token_in: String,
    token_out: String,
    amount_in: u64,
    amount_out: u64,
    reserve_in: u64,
    reserve_out: u64,
    fee_amount: u64,
    timestamp: u64,
}

// å‘å‡ºè¯¦ç»†äº‹ä»¶
event::emit(SwapEvent {
    user: signer::address_of(user),
    token_in: type_info::type_name<X>(),
    token_out: type_info::type_name<Y>(),
    amount_in,
    amount_out,
    reserve_in: new_reserve_x,
    reserve_out: new_reserve_y,
    fee_amount: amount_in * 3 / 1000,
    timestamp: timestamp::now_seconds(),
});
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸åŒå®ç°çš„ Gas æ¶ˆè€—

| æ“ä½œ | ç®€å•å®ç° | ä¼˜åŒ–å®ç° | èŠ‚çœ |
|------|---------|---------|------|
| å•æ¬¡ Swap | ~8,000 gas | ~5,500 gas | 31% |
| ä¸¤è·³ Swap | ~15,000 gas | ~10,000 gas | 33% |
| æ‰¹é‡ Swap (10æ¬¡) | ~80,000 gas | ~45,000 gas | 44% |

### ç²¾åº¦æŸå¤±å¯¹æ¯”

| æ–¹æ³• | ç²¾åº¦æŸå¤± | ç¤ºä¾‹ |
|------|---------|------|
| ç›´æ¥é™¤æ³• (u64) | ~0.001% | å¯æ¥å— |
| u128 ä¸­é—´å€¼ | ~0.0000001% | æ¨è |
| è‡ªå®šä¹‰ mul_div | ~0.00000001% | æœ€ä½³ |

---

## ğŸ¯ å­¦ä¹ æ£€æŸ¥ç‚¹

å®Œæˆç†è®ºå­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿå›ç­”ï¼š

1. âœ… Exact Input å’Œ Exact Output æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
2. âœ… æ‰‹ç»­è´¹å¦‚ä½•å½±å“ K å€¼ï¼Ÿ
3. âœ… ä¸ºä»€ä¹ˆ K å€¼ä¼šå¢åŠ è€Œä¸æ˜¯ä¿æŒä¸å˜ï¼Ÿ
4. âœ… å¦‚ä½•è®¡ç®—æ»‘ç‚¹ç™¾åˆ†æ¯”ï¼Ÿ
5. âœ… ä»€ä¹ˆæ˜¯ä¸‰æ˜æ²»æ”»å‡»ï¼Ÿå¦‚ä½•é˜²èŒƒï¼Ÿ
6. âœ… å¤šè·³ Swap çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
7. âœ… å¦‚ä½•ä¼˜åŒ– Gas æ¶ˆè€—ï¼Ÿ
8. âœ… ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ u128 è¿›è¡Œä¸­é—´è®¡ç®—ï¼Ÿ

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

### æ·±å…¥ç ”ç©¶

1. **Uniswap V2 åˆçº¦**
   - [Swap å‡½æ•°æºç ](https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L159)
   - ç†è§£ `_swap` çš„å®ç°ç»†èŠ‚

2. **Uniswap V3 é›†ä¸­æµåŠ¨æ€§**
   - [ç™½çš®ä¹¦](https://uniswap.org/whitepaper-v3.pdf)
   - ç†è§£ tick å’Œ range order

3. **Curve Finance ç¨³å®šå¸ä¼˜åŒ–**
   - [StableSwap ç®—æ³•](https://curve.fi/files/stableswap-paper.pdf)
   - ä½æ»‘ç‚¹çš„ç¨³å®šå¸äº¤æ¢

### å®æˆ˜é¡¹ç›®åˆ†æ

1. **Liquidswap (Aptos)**
   - [Router å®ç°](https://github.com/pontem-network/liquidswap/blob/main/sources/router.move)
   - å­¦ä¹ è·¯ç”±é€»è¾‘

2. **PancakeSwap V2**
   - [Router åˆçº¦](https://github.com/pancakeswap/pancake-smart-contracts/blob/master/projects/exchange-protocol/contracts/PancakeRouter.sol)
   - å¤šé“¾ DEX çš„è®¾è®¡

3. **SushiSwap**
   - [Route Processor](https://github.com/sushiswap/sushiswap/tree/master/protocols/route-processor)
   - æ™ºèƒ½è·¯ç”±ç®—æ³•

---

## ğŸ§® ç»ƒä¹ è®¡ç®—

### ç»ƒä¹  1ï¼šåŸºç¡€ Swap

```
æ± å­çŠ¶æ€ï¼š
- Reserve X: 1,000,000 USDC
- Reserve Y: 50,000 APT
- æ‰‹ç»­è´¹ç‡: 0.3%

ç”¨æˆ·æ“ä½œï¼š
- è¾“å…¥: 10,000 USDC
- æœŸæœ›: ä¹°å…¥ APT

é—®é¢˜ï¼š
1. ä¸è€ƒè™‘æ‰‹ç»­è´¹ï¼Œç”¨æˆ·èƒ½å¾—åˆ°å¤šå°‘ APTï¼Ÿ
2. è€ƒè™‘æ‰‹ç»­è´¹ï¼Œç”¨æˆ·å®é™…å¾—åˆ°å¤šå°‘ APTï¼Ÿ
3. ä»·æ ¼æ»‘ç‚¹æ˜¯å¤šå°‘ï¼Ÿ
4. äº¤æ˜“åçš„ K å€¼æ˜¯å¤šå°‘ï¼Ÿ
```

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

```
1. æ— æ‰‹ç»­è´¹è¾“å‡ºï¼š
   amount_out = (50,000 * 10,000) / (1,000,000 + 10,000)
              = 500,000,000 / 1,010,000
              â‰ˆ 495.05 APT

2. æœ‰æ‰‹ç»­è´¹è¾“å‡ºï¼š
   amount_in_with_fee = 10,000 * 997 / 1000 = 9,970
   amount_out = (50,000 * 9,970) / (1,000,000 + 9,970)
              = 498,500,000 / 1,009,970
              â‰ˆ 493.58 APT

3. ä»·æ ¼æ»‘ç‚¹ï¼š
   åˆå§‹ä»·æ ¼ = 1,000,000 / 50,000 = 20 USDC/APT
   æ–°ä»·æ ¼ = 1,010,000 / 49,506.42 â‰ˆ 20.40 USDC/APT
   æ»‘ç‚¹ = (20.40 - 20) / 20 = 2.0%

4. æ–° K å€¼ï¼š
   k_new = 1,010,000 * 49,506.42 = 50,001,484,200
   k_old = 1,000,000 * 50,000 = 50,000,000,000
   å¢é•¿ = 0.003% (â‰ˆ æ‰‹ç»­è´¹ç‡)
```

</details>

### ç»ƒä¹  2ï¼šå¤šè·³ Swap

```
è·¯å¾„: USDC â†’ APT â†’ Token_A

Pool 1 (USDC/APT):
- Reserve: 1,000,000 USDC / 50,000 APT

Pool 2 (APT/Token_A):
- Reserve: 10,000 APT / 200,000 Token_A

ç”¨æˆ·è¾“å…¥: 10,000 USDC
æ‰‹ç»­è´¹: 0.3% per hop

è®¡ç®—æœ€ç»ˆå¾—åˆ°å¤šå°‘ Token_Aï¼Ÿ
```

<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

```
ç¬¬ä¸€è·³ (USDC â†’ APT):
amount_in_with_fee = 10,000 * 997 / 1000 = 9,970
amount_out_apt = (50,000 * 9,970) / (1,000,000 + 9,970)
                = 493.58 APT

ç¬¬äºŒè·³ (APT â†’ Token_A):
amount_in_with_fee = 493.58 * 997 / 1000 = 492.10
amount_out_token_a = (200,000 * 492.10) / (10,000 + 492.10)
                   = 98,420,000 / 10,492.10
                   â‰ˆ 9,381.25 Token_A

æ€»æ‰‹ç»­è´¹:
- ç¬¬ä¸€è·³: 30 USDC (in USDC)
- ç¬¬äºŒè·³: 1.48 APT (in APT)
```

</details>

---

**ä¸‹ä¸€æ­¥**: é˜…è¯» `ä»£ç ç¤ºä¾‹.move`ï¼ŒæŸ¥çœ‹å®Œæ•´çš„å®ç°ä»£ç ã€‚

**é¢„è®¡æ—¶é—´**: æœ¬æ–‡æ¡£é˜…è¯»æ—¶é—´çº¦ 60-90 åˆ†é’Ÿã€‚å»ºè®®åšç¬”è®°å¹¶å®Œæˆæ‰€æœ‰ç»ƒä¹ é¢˜ã€‚
