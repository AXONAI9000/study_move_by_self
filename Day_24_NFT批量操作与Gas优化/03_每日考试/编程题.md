# Day 24: NFT æ‰¹é‡æ“ä½œä¸ Gas ä¼˜åŒ– - ç¼–ç¨‹é¢˜

## ğŸ“ è€ƒè¯•è¯´æ˜

- **é¢˜ç›®æ•°é‡**: 5 é“ç¼–ç¨‹é¢˜
- **æ€»åˆ†**: 5 åˆ†ï¼ˆæ¯é¢˜ 1 åˆ†ï¼‰
- **åŠæ ¼åˆ†æ•°**: 3.5 åˆ†ï¼ˆ70%ï¼‰
- **è€ƒè¯•æ—¶é—´**: 60 åˆ†é’Ÿ

## ç­”é¢˜è¯´æ˜

è¯·åœ¨ä»£ç å—ä¸­å®Œæˆä½ çš„ç­”æ¡ˆã€‚ä»£ç åº”è¯¥èƒ½å¤Ÿç¼–è¯‘é€šè¿‡å¹¶æ»¡è¶³é¢˜ç›®è¦æ±‚ã€‚

---

## ç¼–ç¨‹é¢˜ 1: å®ç°æ‰¹é‡é“¸é€ å‡½æ•°ï¼ˆ1 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªæ‰¹é‡é“¸é€  NFT çš„å‡½æ•°ï¼Œè¦æ±‚ï¼š
- æ”¯æŒä¸€æ¬¡é“¸é€ å¤šä¸ª NFT
- éªŒè¯æ‰¹æ¬¡å¤§å°ä¸è¶…è¿‡æœ€å¤§é™åˆ¶
- è‡ªåŠ¨åˆ†é… Token ID
- å‘å°„æ‰¹é‡é“¸é€ äº‹ä»¶

### å‡½æ•°ç­¾å

```move
public entry fun batch_mint_nfts(
    creator: &signer,
    collection_name: String,
    recipients: vector<address>,
    count: u64,  // æ¯ä¸ªæ¥æ”¶è€…é“¸é€ çš„æ•°é‡
) acquires Collection {
    // ä½ çš„ä»£ç 
}
```

### è¦æ±‚

1. éªŒè¯ `vector::length(&recipients) * count <= MAX_BATCH_SIZE`
2. ä¸ºæ¯ä¸ªæ¥æ”¶è€…é“¸é€  `count` ä¸ª NFT
3. Token ID ä» `collection.next_token_id` å¼€å§‹é€’å¢
4. æ›´æ–° `collection.next_token_id` å’Œ `total_minted`
5. å‘å°„ä¸€ä¸ª `BatchMintEvent`

### ä½ çš„ç­”æ¡ˆ

```move
const MAX_BATCH_SIZE: u64 = 50;
const ERROR_BATCH_TOO_LARGE: u64 = 1;

struct Collection has key {
    next_token_id: u64,
    total_minted: u64,
    // ... å…¶ä»–å­—æ®µ
}

#[event]
struct BatchMintEvent has drop, store {
    start_id: u64,
    count: u64,
    timestamp: u64,
}

public entry fun batch_mint_nfts(
    creator: &signer,
    collection_name: String,
    recipients: vector<address>,
    count: u64,
) acquires Collection {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
    
    
    
    
    
    
    
    
    
}
```

---

## ç¼–ç¨‹é¢˜ 2: å®ç°å±æ€§æ‰“åŒ…å’Œè§£åŒ…ï¼ˆ1 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°å±æ€§æ‰“åŒ…å’Œè§£åŒ…å‡½æ•°ï¼Œå°†ä¸‰ä¸ª u8 å€¼æ‰“åŒ…åˆ°ä¸€ä¸ª u32 ä¸­ã€‚

### è¦æ±‚

1. `pack_attributes`: å°† rarity, level, category æ‰“åŒ…
2. `get_rarity`: ä»æ‰“åŒ…å€¼ä¸­æå– rarityï¼ˆbits 0-7ï¼‰
3. `get_level`: ä»æ‰“åŒ…å€¼ä¸­æå– levelï¼ˆbits 8-15ï¼‰
4. `get_category`: ä»æ‰“åŒ…å€¼ä¸­æå– categoryï¼ˆbits 16-23ï¼‰

### ä½ çš„ç­”æ¡ˆ

```move
/// æ‰“åŒ…ä¸‰ä¸ªå±æ€§åˆ°ä¸€ä¸ª u32
public fun pack_attributes(
    rarity: u8,
    level: u8,
    category: u8,
): u32 {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
    
}

/// æå– rarity (bits 0-7)
public fun get_rarity(packed: u32): u8 {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
}

/// æå– level (bits 8-15)
public fun get_level(packed: u32): u8 {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
}

/// æå– category (bits 16-23)
public fun get_category(packed: u32): u8 {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
}
```

---

## ç¼–ç¨‹é¢˜ 3: å®ç°æ‰¹é‡è½¬ç§»éªŒè¯ï¼ˆ1 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªæ‰¹é‡éªŒè¯ NFT æ‰€æœ‰æƒçš„å‡½æ•°ã€‚

### è¦æ±‚

1. éå†æ‰€æœ‰ token_addresses
2. éªŒè¯æ¯ä¸ª Token çš„æ‰€æœ‰è€…æ˜¯ expected_owner
3. ä»»ä¸€éªŒè¯å¤±è´¥ï¼ŒæŠ›å‡º ERROR_NOT_OWNER
4. å…¨éƒ¨éªŒè¯é€šè¿‡è¿”å› true

### ä½ çš„ç­”æ¡ˆ

```move
use aptos_framework::object;

const ERROR_NOT_OWNER: u64 = 2;

struct TokenData has key {
    id: u64,
    // ... å…¶ä»–å­—æ®µ
}

/// æ‰¹é‡éªŒè¯æ‰€æœ‰æƒ
public fun batch_verify_ownership(
    expected_owner: address,
    token_addresses: &vector<address>,
): bool acquires TokenData {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
    
    
    
    
    
    
    
}
```

---

## ç¼–ç¨‹é¢˜ 4: å®ç° URI æ¨¡æ¿ç”Ÿæˆï¼ˆ1 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆ Token URI çš„å‡½æ•°ï¼Œä½¿ç”¨æ¨¡æ¿åŒ–æ–¹å¼ã€‚

### è¦æ±‚

1. ä» Collection è·å– base_uri å’Œ uri_suffix
2. ç»„åˆ: `base_uri + token_id + uri_suffix`
3. ä¾‹å¦‚: `"ipfs://QmXxx.../" + "12345" + ".json"` = `"ipfs://QmXxx.../12345.json"`

### ä½ çš„ç­”æ¡ˆ

```move
use std::string::{Self, String};

struct Collection has key {
    base_uri: String,      // "ipfs://QmXxx.../"
    uri_suffix: String,    // ".json"
    // ... å…¶ä»–å­—æ®µ
}

struct Token has key {
    id: u64,
    collection_addr: address,
    // ... å…¶ä»–å­—æ®µ
}

/// è·å– Token URIï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
public fun get_token_uri(token_addr: address): String acquires Token, Collection {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
    
    
    
    
    
    
}

/// è¾…åŠ©å‡½æ•°ï¼šu64 è½¬ String
fun u64_to_string(value: u64): String {
    if (value == 0) {
        return string::utf8(b"0")
    };
    
    let buffer = vector::empty<u8>();
    while (value > 0) {
        vector::push_back(&mut buffer, ((value % 10) as u8) + 48);
        value = value / 10;
    };
    vector::reverse(&mut buffer);
    string::utf8(buffer)
}
```

---

## ç¼–ç¨‹é¢˜ 5: è®¡ç®— Gas èŠ‚çœï¼ˆ1 åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—æ‰¹é‡æ“ä½œç›¸æ¯”å•ä¸ªæ“ä½œèŠ‚çœçš„ Gas å’ŒèŠ‚çœç™¾åˆ†æ¯”ã€‚

### è¦æ±‚

1. è®¡ç®—èŠ‚çœçš„ Gas: `individual_total - batch_total`
2. è®¡ç®—èŠ‚çœç™¾åˆ†æ¯”: `(saved_gas * 100) / individual_total`
3. è¿”å› (saved_gas, savings_percent)

### ä½ çš„ç­”æ¡ˆ

```move
/// è®¡ç®— Gas èŠ‚çœ
/// 
/// # å‚æ•°
/// - individual_gas: å•ä¸ªæ“ä½œçš„ Gas æˆæœ¬
/// - batch_size: æ‰¹æ¬¡å¤§å°
/// - batch_total_gas: æ‰¹é‡æ“ä½œçš„æ€» Gas æˆæœ¬
/// 
/// # è¿”å›
/// (saved_gas, savings_percent)
public fun calculate_gas_savings(
    individual_gas: u64,
    batch_size: u64,
    batch_total_gas: u64,
): (u64, u64) {
    // === åœ¨æ­¤å¤„å®ç°ä½ çš„ä»£ç  ===
    
    
    
    
    
    
    
    
}
```

---

## ğŸ“Š è¯„åˆ†æ ‡å‡†

### æ¯é¢˜è¯„åˆ†ç»†åˆ™ï¼ˆ1 åˆ†ï¼‰

- **å®Œå…¨æ­£ç¡®**: 1.0 åˆ†
  - é€»è¾‘å®Œå…¨æ­£ç¡®
  - ä»£ç èƒ½ç¼–è¯‘
  - å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µ

- **åŸºæœ¬æ­£ç¡®**: 0.7 åˆ†
  - ä¸»è¦é€»è¾‘æ­£ç¡®
  - å¯èƒ½æœ‰å°é”™è¯¯
  - ç¼ºå°‘éƒ¨åˆ†è¾¹ç•Œå¤„ç†

- **éƒ¨åˆ†æ­£ç¡®**: 0.4 åˆ†
  - ç†è§£é¢˜æ„
  - éƒ¨åˆ†é€»è¾‘æ­£ç¡®
  - æœ‰æ˜æ˜¾é”™è¯¯

- **ä¸æ­£ç¡®**: 0 åˆ†
  - æœªç†è§£é¢˜æ„
  - é€»è¾‘é”™è¯¯
  - æ— æ³•ç¼–è¯‘

### æ€»åˆ†è®¡ç®—

- **5.0 åˆ†**: ä¼˜ç§€ï¼ˆ100%ï¼‰
- **4.0-4.9 åˆ†**: è‰¯å¥½ï¼ˆ80-99%ï¼‰
- **3.5-3.9 åˆ†**: åŠæ ¼ï¼ˆ70-79%ï¼‰
- **< 3.5 åˆ†**: ä¸åŠæ ¼ï¼ˆ< 70%ï¼‰

---

## ğŸ’¡ ç­”é¢˜å»ºè®®

### é€šç”¨å»ºè®®

1. **å…ˆç†è§£é¢˜æ„**: ä»”ç»†é˜…è¯»è¦æ±‚
2. **åˆ†æ­¥å®ç°**: ä¸€æ­¥æ­¥å®ŒæˆåŠŸèƒ½
3. **è€ƒè™‘è¾¹ç•Œ**: å¤„ç†ç‰¹æ®Šæƒ…å†µ
4. **æµ‹è¯•éªŒè¯**: åœ¨è„‘æµ·ä¸­æµ‹è¯•ä»£ç 
5. **ä»£ç è§„èŒƒ**: ä¿æŒä»£ç æ¸…æ™°

### å¸¸è§é™·é˜±

1. **ä½è¿ç®—**: æ³¨æ„ä½ç§»æ–¹å‘å’Œä½æ•°
2. **æº¢å‡º**: æ³¨æ„ u64 è®¡ç®—å¯èƒ½æº¢å‡º
3. **ç©ºå‘é‡**: å¤„ç† vector ä¸ºç©ºçš„æƒ…å†µ
4. **æ‰€æœ‰æƒ**: æ­£ç¡®ä½¿ç”¨ borrow å’Œ borrow_mut
5. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ assert! éªŒè¯æ¡ä»¶

---

## ğŸ§ª è‡ªæˆ‘æµ‹è¯•

å®Œæˆä»£ç åï¼Œé—®è‡ªå·±ï¼š

- [ ] ä»£ç èƒ½ç¼–è¯‘é€šè¿‡å—ï¼Ÿ
- [ ] é€»è¾‘æ­£ç¡®å—ï¼Ÿ
- [ ] å¤„ç†äº†é”™è¯¯æƒ…å†µå—ï¼Ÿ
- [ ] è€ƒè™‘äº†è¾¹ç•Œæƒ…å†µå—ï¼Ÿ
- [ ] ä»£ç å¤Ÿæ¸…æ™°å—ï¼Ÿ

---

## ğŸ“ æäº¤æ¸…å•

- [ ] ç¼–ç¨‹é¢˜ 1: æ‰¹é‡é“¸é€ 
- [ ] ç¼–ç¨‹é¢˜ 2: å±æ€§æ‰“åŒ…
- [ ] ç¼–ç¨‹é¢˜ 3: æ‰€æœ‰æƒéªŒè¯
- [ ] ç¼–ç¨‹é¢˜ 4: URI ç”Ÿæˆ
- [ ] ç¼–ç¨‹é¢˜ 5: Gas è®¡ç®—

---

**ç­”é¢˜å®Œæˆåï¼Œè¯·æŸ¥çœ‹ `ç­”æ¡ˆè§£æ.md` å¯¹ç…§ç­”æ¡ˆå¹¶è¯„åˆ†ã€‚**

**ç¥ä½ ç¼–ç¨‹é¡ºåˆ©ï¼ğŸ’»**
