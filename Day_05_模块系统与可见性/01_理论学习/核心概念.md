# Day 05: æ¨¡å—ç³»ç»Ÿä¸å¯è§æ€§

## ğŸ“š å­¦ä¹ ç›®æ ‡

- ç†è§£ Move çš„æ¨¡å—ç³»ç»Ÿè®¾è®¡ç†å¿µ
- æŒæ¡æ¨¡å—çš„å®šä¹‰ã€å¯¼å…¥å’Œä½¿ç”¨æ–¹æ³•
- æ·±å…¥ç†è§£ Move çš„å¯è§æ€§æ§åˆ¶æœºåˆ¶
- å­¦ä¼šä½¿ç”¨ `public`ã€`public(friend)`ã€`entry` ç­‰ä¿®é¥°ç¬¦
- æŒæ¡æ¨¡å—é—´çš„ä¾èµ–å…³ç³»å’Œæœ€ä½³å®è·µ

---

## 1. æ¨¡å—ç³»ç»Ÿæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ¨¡å—ï¼Ÿ

**æ¨¡å—ï¼ˆModuleï¼‰** æ˜¯ Move è¯­è¨€ä¸­ç»„ç»‡ä»£ç çš„åŸºæœ¬å•ä½ï¼Œç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„åŒ…ï¼ˆPackageï¼‰æˆ–å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- æ¨¡å—æ˜¯ä»£ç çš„å®¹å™¨ï¼ŒåŒ…å«ç»“æ„ä½“ã€å‡½æ•°ã€å¸¸é‡ç­‰
- æ¯ä¸ªæ¨¡å—æœ‰å”¯ä¸€çš„åœ°å€å’Œåç§°æ ‡è¯†
- æ¨¡å—ä¸€æ—¦éƒ¨ç½²åˆ°é“¾ä¸Šå°±æ˜¯ä¸å¯å˜çš„
- æ¨¡å—å¯ä»¥æ§åˆ¶å†…éƒ¨å…ƒç´ çš„å¯è§æ€§

### 1.2 æ¨¡å—çš„ç»“æ„

```move
module <address>::<module_name> {
    // å¯¼å…¥å…¶ä»–æ¨¡å—
    use std::vector;
    use aptos_framework::account;
    
    // å¸¸é‡å®šä¹‰
    const ERROR_NOT_AUTHORIZED: u64 = 1;
    
    // ç»“æ„ä½“å®šä¹‰
    struct MyResource has key {
        value: u64
    }
    
    // å‡½æ•°å®šä¹‰
    public fun public_function() { }
    fun private_function() { }
}
```

**æ¨¡å—åœ°å€çš„ä¸¤ç§å½¢å¼ï¼š**
1. **å‘½ååœ°å€**: `module my_addr::my_module { }`
2. **åå…­è¿›åˆ¶åœ°å€**: `module 0x1::my_module { }`

---

## 2. æ¨¡å—çš„å®šä¹‰ä¸å‘½å

### 2.1 æ¨¡å—å‘½åè§„èŒƒ

```move
// âœ… æ¨èï¼šä½¿ç”¨ snake_case å‘½å
module 0x1::token_manager { }
module my_addr::user_profile { }

// âŒ ä¸æ¨èï¼šé©¼å³°å‘½å
module 0x1::TokenManager { }
```

### 2.2 åœ°å€åˆ«åï¼ˆMove.toml é…ç½®ï¼‰

åœ¨ `Move.toml` ä¸­å®šä¹‰åœ°å€åˆ«åï¼š

```toml
[addresses]
std = "0x1"
aptos_framework = "0x1"
my_addr = "0x42"
deployer = "_"  # éƒ¨ç½²æ—¶åŠ¨æ€æŒ‡å®š
```

ä½¿ç”¨åˆ«åï¼š
```move
module my_addr::my_module {
    use std::vector;
    use aptos_framework::coin;
}
```

---

## 3. å¯è§æ€§æ§åˆ¶

### 3.1 å¯è§æ€§çº§åˆ«

Move æä¾›äº†å››ç§å¯è§æ€§çº§åˆ«ï¼š

| ä¿®é¥°ç¬¦ | å¯è§èŒƒå›´ | ä½¿ç”¨åœºæ™¯ |
|--------|----------|----------|
| **æ— ä¿®é¥°ç¬¦** | ä»…æ¨¡å—å†…éƒ¨ | ç§æœ‰è¾…åŠ©å‡½æ•° |
| **public** | æ‰€æœ‰æ¨¡å— | å…¬å…± API |
| **public(friend)** | å‹å…ƒæ¨¡å— | å—é™å…±äº« |
| **entry** | äº¤æ˜“å…¥å£ | ç”¨æˆ·ç›´æ¥è°ƒç”¨ |

### 3.2 ç§æœ‰å‡½æ•°ï¼ˆé»˜è®¤ï¼‰

```move
module 0x1::math {
    // ç§æœ‰å‡½æ•°ï¼Œä»…æ¨¡å—å†…éƒ¨å¯è°ƒç”¨
    fun calculate_internal(x: u64, y: u64): u64 {
        x + y
    }
    
    public fun public_calculate(x: u64, y: u64): u64 {
        // å¯ä»¥è°ƒç”¨ç§æœ‰å‡½æ•°
        calculate_internal(x, y)
    }
}
```

### 3.3 å…¬å…±å‡½æ•°ï¼ˆpublicï¼‰

```move
module 0x1::token {
    struct Token has key {
        value: u64
    }
    
    // ä»»ä½•æ¨¡å—éƒ½å¯ä»¥è°ƒç”¨
    public fun get_value(token: &Token): u64 {
        token.value
    }
    
    // å…¬å…±å‡½æ•°å¯ä»¥è¿”å›ä»»æ„ç±»å‹
    public fun create_token(value: u64): Token {
        Token { value }
    }
}
```

### 3.4 å…¥å£å‡½æ•°ï¼ˆentryï¼‰

```move
module 0x1::game {
    use std::signer;
    
    struct Player has key {
        score: u64
    }
    
    // entry å‡½æ•°å¯ä»¥ä½œä¸ºäº¤æ˜“çš„å…¥å£ç‚¹
    // ç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡äº¤æ˜“è°ƒç”¨
    entry fun register_player(account: &signer) {
        let player = Player { score: 0 };
        move_to(account, player);
    }
    
    // entry + public: æ—¢å¯ä»¥è¢«äº¤æ˜“è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å…¶ä»–æ¨¡å—è°ƒç”¨
    public entry fun update_score(account: &signer, new_score: u64) 
    acquires Player {
        let player = borrow_global_mut<Player>(signer::address_of(account));
        player.score = new_score;
    }
}
```

**entry å‡½æ•°çš„é™åˆ¶ï¼š**
- ä¸èƒ½æœ‰è¿”å›å€¼
- å‚æ•°ç±»å‹å—é™ï¼ˆåŸºæœ¬ç±»å‹ã€`&signer`ã€`vector` ç­‰ï¼‰
- ä¸èƒ½è¿”å›å¼•ç”¨

### 3.5 å‹å…ƒå‡½æ•°ï¼ˆpublic(friend)ï¼‰

```move
module 0x1::bank {
    // å£°æ˜å‹å…ƒæ¨¡å—
    friend 0x1::admin;
    friend 0x1::governance;
    
    struct Vault has key {
        balance: u64
    }
    
    // åªæœ‰å‹å…ƒæ¨¡å—å¯ä»¥è°ƒç”¨
    public(friend) fun privileged_withdraw(addr: address, amount: u64): u64 
    acquires Vault {
        let vault = borrow_global_mut<Vault>(addr);
        vault.balance = vault.balance - amount;
        amount
    }
}

module 0x1::admin {
    use 0x1::bank;
    
    // admin æ˜¯ bank çš„å‹å…ƒï¼Œå¯ä»¥è°ƒç”¨ privileged_withdraw
    public fun emergency_withdraw(addr: address) {
        bank::privileged_withdraw(addr, 1000);
    }
}
```

---

## 4. æ¨¡å—å¯¼å…¥ï¼ˆuse è¯­å¥ï¼‰

### 4.1 åŸºæœ¬å¯¼å…¥

```move
module 0x1::my_module {
    // å¯¼å…¥æ•´ä¸ªæ¨¡å—
    use std::vector;
    use aptos_framework::coin;
    
    public fun example() {
        let v = vector::empty<u64>();
        // ä½¿ç”¨ vector æ¨¡å—çš„å‡½æ•°
    }
}
```

### 4.2 å¯¼å…¥åˆ«å

```move
module 0x1::my_module {
    // ä¸ºå¯¼å…¥çš„æ¨¡å—è®¾ç½®åˆ«å
    use std::vector as vec;
    use aptos_framework::coin::{Self as money, Coin};
    
    public fun example() {
        let v = vec::empty<u64>();
        // ä½¿ç”¨åˆ«å
    }
}
```

### 4.3 å¯¼å…¥ç‰¹å®šæˆå‘˜

```move
module 0x1::my_module {
    // åªå¯¼å…¥ç‰¹å®šå‡½æ•°æˆ–ç»“æ„ä½“
    use std::vector::{push_back, pop_back, empty};
    use aptos_framework::coin::Coin;
    
    public fun example() {
        let v = empty<u64>();
        push_back(&mut v, 42);
    }
}
```

### 4.4 å¯¼å…¥é£æ ¼æœ€ä½³å®è·µ

```move
module 0x1::best_practices {
    // âœ… æ¨èï¼šæ˜ç¡®å¯¼å…¥ä½¿ç”¨çš„å†…å®¹
    use std::signer;
    use std::vector::{Self, push_back, length};
    use aptos_framework::coin::{Self, Coin};
    
    // âŒ é¿å…ï¼šå¯¼å…¥ä½†ä¸ä½¿ç”¨
    use std::option;  // å¦‚æœä¸ä½¿ç”¨ä¼šæœ‰è­¦å‘Š
    
    public fun example(account: &signer) {
        let addr = signer::address_of(account);
        let v = vector::empty<u64>();
        push_back(&mut v, 42);
    }
}
```

---

## 5. æ¨¡å—ä¾èµ–ä¸å‹å…ƒå…³ç³»

### 5.1 æ¨¡å—ä¾èµ–

```move
// æ¨¡å— A
module 0x1::module_a {
    public fun get_value(): u64 {
        100
    }
}

// æ¨¡å— B ä¾èµ–æ¨¡å— A
module 0x1::module_b {
    use 0x1::module_a;
    
    public fun double_value(): u64 {
        module_a::get_value() * 2
    }
}
```

### 5.2 å‹å…ƒå…³ç³»çš„ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šæƒé™æ§åˆ¶**
```move
module 0x1::treasury {
    friend 0x1::governance;
    
    public(friend) fun mint_tokens(amount: u64) {
        // åªæœ‰ governance æ¨¡å—å¯ä»¥é“¸é€ ä»£å¸
    }
}
```

**åœºæ™¯ 2ï¼šæµ‹è¯•è¾…åŠ©**
```move
module 0x1::production {
    friend 0x1::production_tests;
    
    public(friend) fun test_helper() {
        // æµ‹è¯•è¾…åŠ©å‡½æ•°ï¼Œåªå¯¹æµ‹è¯•æ¨¡å—å¯è§
    }
}
```

### 5.3 å‹å…ƒå£°æ˜è§„åˆ™

```move
module 0x1::my_module {
    // âœ… åœ¨æ¨¡å—é¡¶éƒ¨å£°æ˜å‹å…ƒ
    friend 0x1::friend_module_1;
    friend 0x1::friend_module_2;
    
    // å‹å…ƒå£°æ˜å¿…é¡»åœ¨æ‰€æœ‰å®šä¹‰ä¹‹å‰
    struct MyStruct { }
    
    public(friend) fun restricted_function() { }
}
```

---

## 6. ç»“æ„ä½“çš„å¯è§æ€§

### 6.1 ç»“æ„ä½“å®šä¹‰çš„å¯è§æ€§

```move
module 0x1::token {
    // ç§æœ‰ç»“æ„ä½“ï¼šåªæœ‰æœ¬æ¨¡å—å¯ä»¥åˆ›å»ºå’Œè§£æ„
    struct PrivateToken {
        value: u64
    }
    
    // å…¬å…±ç»“æ„ä½“ï¼šå…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨ç±»å‹ï¼Œä½†ä¸èƒ½åˆ›å»ºæˆ–è®¿é—®å­—æ®µ
    public struct PublicToken has drop {
        value: u64
    }
    
    // æä¾›å…¬å…±æ„é€ å‡½æ•°
    public fun create_token(value: u64): PublicToken {
        PublicToken { value }
    }
    
    // æä¾›å…¬å…±è®¿é—®å™¨
    public fun get_value(token: &PublicToken): u64 {
        token.value
    }
}
```

### 6.2 ç»“æ„ä½“å­—æ®µè®¿é—®æ§åˆ¶

```move
module 0x1::user {
    public struct User has drop {
        name: vector<u8>,  // å­—æ®µæ€»æ˜¯ç§æœ‰çš„
        age: u64
    }
    
    // å¿…é¡»æä¾›è®¿é—®å™¨
    public fun get_name(user: &User): vector<u8> {
        user.name
    }
    
    public fun get_age(user: &User): u64 {
        user.age
    }
    
    // å¿…é¡»æä¾›ä¿®æ”¹å™¨
    public fun set_age(user: &mut User, age: u64) {
        user.age = age;
    }
}
```

---

## 7. å®æˆ˜ï¼šè®¾è®¡æ¨¡å—æ¶æ„

### 7.1 å•ä¸€èŒè´£åŸåˆ™

```move
// âœ… å¥½çš„è®¾è®¡ï¼šæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
module 0x1::token_core {
    public struct Token has key { balance: u64 }
}

module 0x1::token_transfer {
    use 0x1::token_core::Token;
    public fun transfer(from: &signer, to: address, amount: u64) { }
}

module 0x1::token_mint {
    use 0x1::token_core::Token;
    friend 0x1::governance;
    public(friend) fun mint(to: address, amount: u64) { }
}
```

### 7.2 æ¥å£ä¸å®ç°åˆ†ç¦»

```move
// æ¥å£æ¨¡å—ï¼šå®šä¹‰å…¬å…± API
module 0x1::nft_interface {
    public struct NFT has key { id: u64 }
    
    public fun mint(account: &signer, id: u64);
    public fun transfer(from: &signer, to: address, id: u64);
    public fun burn(account: &signer, id: u64);
}

// å®ç°æ¨¡å—ï¼šå†…éƒ¨é€»è¾‘
module 0x1::nft_impl {
    friend 0x1::nft_interface;
    
    public(friend) fun mint_internal(account: &signer, id: u64) {
        // å®é™…å®ç°
    }
}
```

### 7.3 åˆ†å±‚æ¶æ„ç¤ºä¾‹

```
ğŸ“¦ DApp æ¶æ„
â”œâ”€â”€ 0x1::core           # æ ¸å¿ƒæ•°æ®ç»“æ„
â”œâ”€â”€ 0x1::storage        # å­˜å‚¨å±‚
â”œâ”€â”€ 0x1::logic          # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ 0x1::api            # å…¬å…± API å±‚
â””â”€â”€ 0x1::scripts        # è„šæœ¬å±‚ï¼ˆentry å‡½æ•°ï¼‰
```

---

## 8. å¸¸è§é”™è¯¯ä¸æœ€ä½³å®è·µ

### 8.1 å¸¸è§é”™è¯¯

**é”™è¯¯ 1ï¼šç§æœ‰å‡½æ•°åœ¨æ¨¡å—å¤–è°ƒç”¨**
```move
module 0x1::module_a {
    fun private_func() { }
}

module 0x1::module_b {
    use 0x1::module_a;
    
    public fun call_private() {
        module_a::private_func();  // âŒ ç¼–è¯‘é”™è¯¯
    }
}
```

**é”™è¯¯ 2ï¼šå¾ªç¯ä¾èµ–**
```move
// âŒ ä¸å…è®¸å¾ªç¯ä¾èµ–
module 0x1::a {
    use 0x1::b;  // A ä¾èµ– B
}

module 0x1::b {
    use 0x1::a;  // B ä¾èµ– A - ç¼–è¯‘é”™è¯¯ï¼
}
```

**é”™è¯¯ 3ï¼šentry å‡½æ•°è¿”å›å€¼**
```move
module 0x1::game {
    // âŒ entry å‡½æ•°ä¸èƒ½æœ‰è¿”å›å€¼
    entry fun get_score(): u64 {
        100
    }
}
```

### 8.2 æœ€ä½³å®è·µ

**âœ… DOï¼šæ˜ç¡®çš„å¯è§æ€§æ§åˆ¶**
```move
module 0x1::best_practices {
    // æ¸…æ™°åœ°æ ‡æ³¨æ¯ä¸ªå‡½æ•°çš„å¯è§æ€§
    public fun public_api() { }
    
    public(friend) fun friend_only() { }
    
    public entry fun user_entry() { }
    
    fun internal_helper() { }
}
```

**âœ… DOï¼šä½¿ç”¨å‘½ååœ°å€**
```move
// Move.toml
[addresses]
my_project = "0x123"

// ä»£ç ä¸­
module my_project::core {
    // æ˜“äºç†è§£å’Œç»´æŠ¤
}
```

**âœ… DOï¼šæœ€å°æƒé™åŸåˆ™**
```move
module 0x1::secure {
    // é»˜è®¤ä½¿ç”¨æœ€ä¸¥æ ¼çš„å¯è§æ€§
    fun helper() { }  // ç§æœ‰
    
    // åªåœ¨å¿…è¦æ—¶æš´éœ²
    public(friend) fun privileged_operation() { }
    
    // å…¬å…± API è¦ç»è¿‡æ·±æ€ç†Ÿè™‘
    public fun safe_public_api() { }
}
```

---

## 9. æ¨¡å—å‡çº§ç­–ç•¥

### 9.1 æ¨¡å—ä¸å¯å˜æ€§

Move æ¨¡å—ä¸€æ—¦éƒ¨ç½²å°±ä¸å¯ä¿®æ”¹ï¼Œä½†å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

**ç­–ç•¥ 1ï¼šç‰ˆæœ¬åŒ–æ¨¡å—**
```move
module 0x1::token_v1 { }
module 0x1::token_v2 { }  // æ–°ç‰ˆæœ¬
```

**ç­–ç•¥ 2ï¼šä»£ç†æ¨¡å¼**
```move
module 0x1::proxy {
    public fun get_implementation(): address {
        // è¿”å›å½“å‰å®ç°çš„åœ°å€
    }
}
```

**ç­–ç•¥ 3ï¼šå¯é…ç½®å‚æ•°**
```move
module 0x1::configurable {
    struct Config has key {
        parameter: u64
    }
    
    // é€šè¿‡ä¿®æ”¹é…ç½®è€Œä¸æ˜¯ä»£ç æ¥è°ƒæ•´è¡Œä¸º
    public entry fun update_config(admin: &signer, new_param: u64) {
        // æ›´æ–°é…ç½®
    }
}
```

---

## 10. æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ¨¡å—æ˜¯ä»£ç ç»„ç»‡çš„åŸºæœ¬å•ä½**ï¼ŒåŒ…å«ç»“æ„ä½“ã€å‡½æ•°ã€å¸¸é‡ç­‰
2. **å››ç§å¯è§æ€§çº§åˆ«**ï¼šç§æœ‰ã€publicã€public(friend)ã€entry
3. **use è¯­å¥**ç”¨äºå¯¼å…¥å…¶ä»–æ¨¡å—çš„åŠŸèƒ½
4. **å‹å…ƒæœºåˆ¶**æä¾›äº†ä»‹äº public å’Œ private ä¹‹é—´çš„è®¿é—®æ§åˆ¶
5. **æ¨¡å—ä¸å¯å˜**ï¼Œéœ€è¦æå‰è®¾è®¡å¥½æ¶æ„å’Œå‡çº§ç­–ç•¥

### å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿæ­£ç¡®å®šä¹‰å’Œå‘½åæ¨¡å—
- [ ] ç†è§£å¹¶èƒ½ä½¿ç”¨å››ç§å¯è§æ€§çº§åˆ«
- [ ] æŒæ¡ use è¯­å¥çš„å„ç§ç”¨æ³•
- [ ] äº†è§£å‹å…ƒæœºåˆ¶çš„ä½¿ç”¨åœºæ™¯
- [ ] èƒ½å¤Ÿè®¾è®¡åˆç†çš„æ¨¡å—æ¶æ„
- [ ] ç†è§£æ¨¡å—ä¸å¯å˜æ€§åŠåº”å¯¹ç­–ç•¥

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

- [Move Book - Modules and Scripts](https://move-language.github.io/move/modules-and-scripts.html)
- [Aptos Move Framework](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/framework)
- [Move Design Patterns](https://www.move-patterns.com/)

---

**ä¸‹ä¸€æ­¥ï¼š** å®Œæˆå®è·µä»»åŠ¡ï¼Œç¼–å†™åŒ…å«å¤šä¸ªæ¨¡å—çš„é¡¹ç›®ï¼
