# Mempool ç›‘æ§ä¸äº¤æ˜“è¿½è¸ª - æ ¸å¿ƒæ¦‚å¿µ

## ç›®å½•
1. [Mempool æ¶æ„æ·±å…¥](#1-mempool-æ¶æ„æ·±å…¥)
2. [äº¤æ˜“ç”Ÿå‘½å‘¨æœŸè¯¦è§£](#2-äº¤æ˜“ç”Ÿå‘½å‘¨æœŸè¯¦è§£)
3. [Mempool API ä½¿ç”¨](#3-mempool-api-ä½¿ç”¨)
4. [ç›‘æ§ç­–ç•¥è®¾è®¡](#4-ç›‘æ§ç­–ç•¥è®¾è®¡)
5. [MEV æœºä¼šè¯†åˆ«](#5-mev-æœºä¼šè¯†åˆ«)
6. [æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#6-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)

---

## 1. Mempool æ¶æ„æ·±å…¥

### 1.1 ä»€ä¹ˆæ˜¯ Mempool?

**Mempool (Memory Pool)** æ˜¯åŒºå—é“¾èŠ‚ç‚¹ä¸­ç”¨äºä¸´æ—¶å­˜å‚¨å¾…ç¡®è®¤äº¤æ˜“çš„å†…å­˜åŒºåŸŸã€‚å®ƒåœ¨äº¤æ˜“è¢«æ‰“åŒ…è¿›åŒºå—ä¹‹å‰å……å½“ç¼“å†²åŒºã€‚

```
Mempool åœ¨äº¤æ˜“æµç¨‹ä¸­çš„ä½ç½®ï¼š

å®¢æˆ·ç«¯ â”€â”€æäº¤äº¤æ˜“â”€â”€â–¶ èŠ‚ç‚¹ API â”€â”€éªŒè¯â”€â”€â–¶ Mempool â”€â”€é€‰æ‹©â”€â”€â–¶ éªŒè¯å™¨ â”€â”€æ‰“åŒ…â”€â”€â–¶ åŒºå—é“¾
                                    â”‚
                                    â””â”€â”€è¶…æ—¶/å¤±è´¥â”€â”€â–¶ ä¸¢å¼ƒ
```

### 1.2 Aptos Mempool ç‰¹ç‚¹

ä¸ä»¥å¤ªåŠç­‰å…¶ä»–åŒºå—é“¾ç›¸æ¯”ï¼ŒAptos Mempool æœ‰ç‹¬ç‰¹çš„ç‰¹ç‚¹ï¼š

#### ç‰¹ç‚¹å¯¹æ¯”è¡¨

| ç‰¹æ€§ | Aptos | ä»¥å¤ªåŠ |
|------|-------|--------|
| **Mempool å¯è§æ€§** | éƒ¨åˆ†ç§æœ‰ | å®Œå…¨å…¬å¼€ |
| **å‡ºå—æ—¶é—´** | äºšç§’çº§ (~400ms) | ~12ç§’ |
| **å¹¶è¡Œæ‰§è¡Œ** | æ”¯æŒ (Block-STM) | ä¸æ”¯æŒ |
| **äº¤æ˜“æ’åº** | Gas Price + å…¶ä»–å› ç´  | ä¸»è¦æ˜¯ Gas Price |
| **Mempool åœç•™æ—¶é—´** | å¾ˆçŸ­ | è¾ƒé•¿ |
| **MEV é˜²æŠ¤** | å†…ç½®ä¸€å®šé˜²æŠ¤ | éœ€è¦é¢å¤–æ–¹æ¡ˆ |

#### å…³é”®ç‰¹ç‚¹

**1. ç§æœ‰ Mempool**
```
Aptos èŠ‚ç‚¹é»˜è®¤ä¸å…¬å¼€æ‰€æœ‰å¾…å¤„ç†äº¤æ˜“ï¼š
- åªèƒ½æŸ¥è¯¢è‡ªå·±æäº¤çš„äº¤æ˜“
- æ— æ³•çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„å¾…å¤„ç†äº¤æ˜“
- é™ä½äº† MEV é£é™©ï¼Œä½†ä¹Ÿé™åˆ¶äº†ç›‘æ§èƒ½åŠ›
```

**2. å¿«é€Ÿç¡®è®¤**
```
å¹³å‡å‡ºå—æ—¶é—´ ~400msï¼š
- Mempool ä¸­çš„äº¤æ˜“å¾ˆå¿«è¢«æ‰“åŒ…
- ç›‘æ§çª—å£æœŸéå¸¸çŸ­
- éœ€è¦é«˜é¢‘æŸ¥è¯¢æˆ–å®æ—¶è®¢é˜…
```

**3. Block-STM å¹¶è¡Œæ‰§è¡Œ**
```
äº¤æ˜“å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼š
- ä¸å†²çªçš„äº¤æ˜“åŒæ—¶æ‰§è¡Œ
- æé«˜ååé‡
- å½±å“äº¤æ˜“é¡ºåºå’Œ MEV ç­–ç•¥
```

### 1.3 Mempool æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Aptos Fullnode                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              REST API / WebSocket               â”‚    â”‚
â”‚  â”‚  - æ¥æ”¶äº¤æ˜“æäº¤                                   â”‚    â”‚
â”‚  â”‚  - æä¾›äº¤æ˜“æŸ¥è¯¢                                   â”‚    â”‚
â”‚  â”‚  - å‘é€äº¤æ˜“çŠ¶æ€æ›´æ–°                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          Transaction Validator                  â”‚    â”‚
â”‚  â”‚  - ç­¾åéªŒè¯                                      â”‚    â”‚
â”‚  â”‚  - åºåˆ—å·æ£€æŸ¥                                    â”‚    â”‚
â”‚  â”‚  - ä½™é¢éªŒè¯                                      â”‚    â”‚
â”‚  â”‚  - Gas é™åˆ¶æ£€æŸ¥                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â”‚ éªŒè¯é€šè¿‡                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                Mempool Core                     â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  ä¼˜å…ˆçº§é˜Ÿåˆ— (æŒ‰ Gas Price æ’åº)          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Tx 1    â”‚  â”‚ Tx 2    â”‚  â”‚ Tx 3    â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Gas:200 â”‚  â”‚ Gas:150 â”‚  â”‚ Gas:100 â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Seq: 5  â”‚  â”‚ Seq: 10 â”‚  â”‚ Seq: 3  â”‚  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚  - äº¤æ˜“æ’åºå’Œç®¡ç†                                â”‚    â”‚
â”‚  â”‚  - è¿‡æœŸäº¤æ˜“æ¸…ç†                                  â”‚    â”‚
â”‚  â”‚  - å®¹é‡ç®¡ç† (é™åˆ¶å¤§å°)                           â”‚    â”‚
â”‚  â”‚  - äº¤æ˜“å¹¿æ’­åˆ°å…¶ä»–èŠ‚ç‚¹                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Consensus / Proposer                  â”‚    â”‚
â”‚  â”‚  - ä» Mempool é€‰æ‹©äº¤æ˜“                           â”‚    â”‚
â”‚  â”‚  - æ„å»ºåŒºå—ææ¡ˆ                                  â”‚    â”‚
â”‚  â”‚  - æ‰§è¡Œ Block-STM                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                    â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Blockchain  â”‚
              â”‚   (å·²ç¡®è®¤)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 äº¤æ˜“éªŒè¯æµç¨‹

å½“äº¤æ˜“è¿›å…¥ Mempool å‰ï¼Œéœ€è¦é€šè¿‡å¤šå±‚éªŒè¯ï¼š

```move
// ä¼ªä»£ç ï¼šäº¤æ˜“éªŒè¯é€»è¾‘
fun validate_transaction(tx: Transaction): Result<(), Error> {
    // 1. ç­¾åéªŒè¯
    if !verify_signature(tx.signature, tx.sender) {
        return Err(INVALID_SIGNATURE);
    }
    
    // 2. åºåˆ—å·æ£€æŸ¥
    let account_seq = get_account_sequence_number(tx.sender);
    if tx.sequence_number < account_seq {
        return Err(SEQUENCE_NUMBER_TOO_OLD);
    }
    if tx.sequence_number > account_seq + MAX_SEQUENCE_GAP {
        return Err(SEQUENCE_NUMBER_TOO_NEW);
    }
    
    // 3. ä½™é¢æ£€æŸ¥
    let max_gas_cost = tx.max_gas_amount * tx.gas_unit_price;
    if get_account_balance(tx.sender) < max_gas_cost {
        return Err(INSUFFICIENT_BALANCE_FOR_GAS);
    }
    
    // 4. è¿‡æœŸæ—¶é—´æ£€æŸ¥
    if tx.expiration_timestamp_secs < current_time() {
        return Err(TRANSACTION_EXPIRED);
    }
    
    // 5. Gas é™åˆ¶æ£€æŸ¥
    if tx.max_gas_amount > MAX_GAS_AMOUNT {
        return Err(MAX_GAS_AMOUNT_EXCEEDED);
    }
    if tx.gas_unit_price < MIN_GAS_PRICE {
        return Err(GAS_PRICE_TOO_LOW);
    }
    
    // 6. Payload éªŒè¯
    validate_payload(tx.payload)?;
    
    Ok(())
}
```

### 1.5 äº¤æ˜“æ’åºæœºåˆ¶

Mempool ä¸­çš„äº¤æ˜“æŒ‰ä»¥ä¸‹è§„åˆ™æ’åºï¼š

```
æ’åºä¼˜å…ˆçº§ï¼š
1. Gas Unit Price (ä¸»è¦å› ç´ )
   - æ›´é«˜çš„ Gas Price ä¼˜å…ˆ
   
2. Sequence Number (åŒä¸€å‘é€è€…)
   - å¿…é¡»æŒ‰åºåˆ—å·é¡ºåºæ‰§è¡Œ
   - Seq N å¿…é¡»åœ¨ Seq N+1 ä¹‹å‰
   
3. åˆ°è¾¾æ—¶é—´ (Gas Price ç›¸åŒæ—¶)
   - å…ˆåˆ°å…ˆæœåŠ¡ (FIFO)
   
4. å…¶ä»–å› ç´ 
   - äº¤æ˜“å¤§å°
   - ä¾èµ–å…³ç³»
```

**ç¤ºä¾‹**ï¼š
```
Mempool é˜Ÿåˆ—çŠ¶æ€ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Position â”‚ Sender  â”‚ Seq â”‚ Gas Price â”‚ Time â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚    1     â”‚ 0xAlice â”‚  5  â”‚   200     â”‚ 10:00â”‚ â† æœ€é«˜ Gas
â”‚    2     â”‚ 0xBob   â”‚  3  â”‚   150     â”‚ 10:01â”‚
â”‚    3     â”‚ 0xAlice â”‚  6  â”‚   200     â”‚ 10:02â”‚ â† ç­‰å¾… Seq 5
â”‚    4     â”‚ 0xCarol â”‚  1  â”‚   100     â”‚ 09:59â”‚
â”‚    5     â”‚ 0xDave  â”‚  8  â”‚   100     â”‚ 10:03â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œé¡ºåºï¼š
1. 0xAlice Seq 5  (Gas 200, å…ˆåˆ°)
2. 0xBob Seq 3    (Gas 150)
3. 0xAlice Seq 6  (Gas 200, ä¾èµ– Seq 5)
4. 0xCarol Seq 1  (Gas 100, æ—©åˆ°)
5. 0xDave Seq 8   (Gas 100, ååˆ°)
```

### 1.6 Mempool å®¹é‡ç®¡ç†

Mempool æœ‰å¤§å°é™åˆ¶ï¼Œéœ€è¦ç®¡ç†å®¹é‡ï¼š

```
å®¹é‡é™åˆ¶ï¼š
- æœ€å¤§äº¤æ˜“æ•°é‡ï¼š~100,000 ç¬”
- æœ€å¤§å†…å­˜å ç”¨ï¼š~500 MB
- å•è´¦æˆ·æœ€å¤§å¾…å¤„ç†äº¤æ˜“ï¼š100 ç¬”

æ¸…ç†ç­–ç•¥ï¼š
1. è¿‡æœŸäº¤æ˜“è‡ªåŠ¨æ¸…ç†
2. Gas Price è¿‡ä½çš„äº¤æ˜“è¢«ç§»é™¤
3. é•¿æ—¶é—´æœªæ‰“åŒ…çš„äº¤æ˜“è¢«ä¸¢å¼ƒ
4. å®¹é‡æ»¡æ—¶ï¼Œæ‹’ç»ä½ Gas Price äº¤æ˜“
```

### 1.7 äº¤æ˜“å¹¿æ’­

Mempool ä¸­çš„äº¤æ˜“éœ€è¦å¹¿æ’­åˆ°ç½‘ç»œï¼š

```
å¹¿æ’­æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node A  â”‚ æ¥æ”¶æ–°äº¤æ˜“
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ å¹¿æ’­
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Node B
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Node C
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Node D
     
æ¯ä¸ªèŠ‚ç‚¹ï¼š
1. æ¥æ”¶äº¤æ˜“
2. éªŒè¯äº¤æ˜“
3. æ·»åŠ åˆ°æœ¬åœ° Mempool
4. ç»§ç»­å¹¿æ’­ç»™é‚»å±…èŠ‚ç‚¹

å»é‡æœºåˆ¶ï¼š
- é€šè¿‡äº¤æ˜“å“ˆå¸Œè¯†åˆ«é‡å¤
- é¿å…æ— é™å¹¿æ’­å¾ªç¯
```

---

## 2. äº¤æ˜“ç”Ÿå‘½å‘¨æœŸè¯¦è§£

### 2.1 å®Œæ•´äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: åˆ›å»ºå’Œç­¾å (å®¢æˆ·ç«¯)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         1. æ„å»ºäº¤æ˜“ Payload
         2. è®¾ç½® Gas å‚æ•°
         3. è®¾ç½®è¿‡æœŸæ—¶é—´
         4. è®¡ç®—äº¤æ˜“å“ˆå¸Œ
         5. ç§é’¥ç­¾å
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: æäº¤ (å®¢æˆ·ç«¯ â†’ èŠ‚ç‚¹)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         POST /v1/transactions
         {ç­¾åçš„äº¤æ˜“æ•°æ®}
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: éªŒè¯ (èŠ‚ç‚¹)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  éªŒè¯ç­¾å     â”‚ â”€â”€â”€ å¤±è´¥ â”€â”€â–¶ è¿”å›é”™è¯¯
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ é€šè¿‡
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æ£€æŸ¥åºåˆ—å·    â”‚ â”€â”€â”€ å¤±è´¥ â”€â”€â–¶ è¿”å›é”™è¯¯
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ é€šè¿‡
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ éªŒè¯ä½™é¢      â”‚ â”€â”€â”€ å¤±è´¥ â”€â”€â–¶ è¿”å›é”™è¯¯
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ é€šè¿‡
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: è¿›å…¥ Mempool                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         æ·»åŠ åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—
         å¹¿æ’­åˆ°å…¶ä»–èŠ‚ç‚¹
         çŠ¶æ€: PENDING
                 â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â–¶ è¶…æ—¶ â”€â”€â–¶ ä¸¢å¼ƒ
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5: è¢«é€‰ä¸­æ‰“åŒ… (éªŒè¯å™¨)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         éªŒè¯å™¨ä» Mempool é€‰æ‹©äº¤æ˜“
         æŒ‰ Gas Price å’Œä¾èµ–å…³ç³»æ’åº
         æ„å»ºåŒºå—ææ¡ˆ
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 6: æ‰§è¡Œ (Block-STM)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         å¹¶è¡Œæ‰§è¡Œäº¤æ˜“
         æ£€æµ‹å†²çª
         é‡æ–°æ‰§è¡Œå†²çªäº¤æ˜“
                 â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â–¶ æ‰§è¡Œå¤±è´¥ â”€â”€â–¶ æ ‡è®°ä¸º FAILED (ä½†ä»ä¸Šé“¾)
                 â”‚
                 â–¼ æ‰§è¡ŒæˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 7: å…±è¯†å’Œç¡®è®¤                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         åŒºå—è¿›å…¥å…±è¯†æµç¨‹
         éªŒè¯å™¨æŠ•ç¥¨
         è¾¾æˆå…±è¯†
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 8: ä¸Šé“¾ç¡®è®¤                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         åŒºå—è¢«æ·»åŠ åˆ°é“¾ä¸Š
         çŠ¶æ€æ›´æ–°
         äº‹ä»¶å‘å‡º
         Mempool ä¸­åˆ é™¤
         çŠ¶æ€: SUCCESS æˆ– FAILED
```

### 2.2 å„é˜¶æ®µæ—¶é—´ä¼°ç®—

```
å…¸å‹äº¤æ˜“æ—¶é—´çº¿ï¼š

t = 0ms      åˆ›å»ºäº¤æ˜“
t = 10ms     ç­¾åå®Œæˆ
t = 50ms     æäº¤åˆ°èŠ‚ç‚¹
t = 100ms    é€šè¿‡éªŒè¯
t = 150ms    è¿›å…¥ Mempool
t = 400ms    è¢«é€‰ä¸­æ‰“åŒ…
t = 450ms    æ‰§è¡Œå®Œæˆ
t = 500ms    å…±è¯†è¾¾æˆ
t = 550ms    ä¸Šé“¾ç¡®è®¤

æ€»æ—¶é—´ï¼š~550ms (ä¸åˆ°1ç§’)

å¯¹æ¯”ä»¥å¤ªåŠï¼š~12-15ç§’
```

### 2.3 äº¤æ˜“çŠ¶æ€

```typescript
enum TransactionStatus {
  // æœ¬åœ°çŠ¶æ€ (å®¢æˆ·ç«¯)
  CREATED,           // äº¤æ˜“å·²åˆ›å»º
  SIGNED,            // äº¤æ˜“å·²ç­¾å
  SUBMITTED,         // å·²æäº¤åˆ°èŠ‚ç‚¹
  
  // Mempool çŠ¶æ€
  PENDING,           // åœ¨ Mempool ä¸­ç­‰å¾…
  
  // æ‰§è¡ŒçŠ¶æ€
  EXECUTING,         // æ­£åœ¨æ‰§è¡Œ
  
  // æœ€ç»ˆçŠ¶æ€
  SUCCESS,           // æˆåŠŸæ‰§è¡Œå¹¶ä¸Šé“¾
  FAILED,            // æ‰§è¡Œå¤±è´¥ä½†å·²ä¸Šé“¾
  DROPPED,           // è¢«ä¸¢å¼ƒ (æœªä¸Šé“¾)
  EXPIRED            // å·²è¿‡æœŸ
}
```

### 2.4 çŠ¶æ€æŸ¥è¯¢æ–¹æ³•

```typescript
// æ–¹æ³• 1: é€šè¿‡äº¤æ˜“å“ˆå¸ŒæŸ¥è¯¢
async function getTransactionByHash(txHash: string) {
  const response = await fetch(
    `${NODE_URL}/v1/transactions/by_hash/${txHash}`
  );
  
  if (response.status === 404) {
    // äº¤æ˜“è¿˜åœ¨ Mempool æˆ–ä¸å­˜åœ¨
    return { status: 'PENDING_OR_NOT_FOUND' };
  }
  
  const tx = await response.json();
  return {
    status: tx.success ? 'SUCCESS' : 'FAILED',
    version: tx.version,
    gas_used: tx.gas_used,
    vm_status: tx.vm_status
  };
}

// æ–¹æ³• 2: é€šè¿‡ç‰ˆæœ¬å·æŸ¥è¯¢
async function getTransactionByVersion(version: number) {
  const response = await fetch(
    `${NODE_URL}/v1/transactions/by_version/${version}`
  );
  return await response.json();
}

// æ–¹æ³• 3: æŸ¥è¯¢è´¦æˆ·æœ€è¿‘äº¤æ˜“
async function getAccountTransactions(address: string, limit: number = 25) {
  const response = await fetch(
    `${NODE_URL}/v1/accounts/${address}/transactions?limit=${limit}`
  );
  return await response.json();
}
```

---

## 3. Mempool API ä½¿ç”¨

### 3.1 REST API ç«¯ç‚¹

#### 3.1.1 æäº¤äº¤æ˜“
```http
POST /v1/transactions
Content-Type: application/json

{
  "sender": "0x1",
  "sequence_number": "0",
  "max_gas_amount": "1000",
  "gas_unit_price": "100",
  "expiration_timestamp_secs": "1699999999",
  "payload": {
    "type": "entry_function_payload",
    "function": "0x1::coin::transfer",
    "type_arguments": ["0x1::aptos_coin::AptosCoin"],
    "arguments": ["0x2", "1000000"]
  },
  "signature": {
    "type": "ed25519_signature",
    "public_key": "0x...",
    "signature": "0x..."
  }
}

Response:
{
  "hash": "0xabc123...",
  "sender": "0x1",
  "sequence_number": "0",
  ...
}
```

#### 3.1.2 æŸ¥è¯¢äº¤æ˜“çŠ¶æ€
```http
GET /v1/transactions/by_hash/{transaction_hash}

Response (æˆåŠŸä¸Šé“¾):
{
  "version": "12345",
  "hash": "0xabc123...",
  "success": true,
  "vm_status": "Executed successfully",
  "gas_used": "450",
  "sender": "0x1",
  ...
}

Response (404 - è¿˜åœ¨ Mempool æˆ–ä¸å­˜åœ¨):
{
  "message": "Transaction not found",
  "error_code": "transaction_not_found"
}
```

#### 3.1.3 æŸ¥è¯¢è´¦æˆ·äº¤æ˜“
```http
GET /v1/accounts/{address}/transactions?limit=100&start=0

Response:
[
  {
    "version": "12345",
    "hash": "0xabc...",
    "success": true,
    ...
  },
  ...
]
```

#### 3.1.4 æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯
```http
GET /v1/accounts/{address}

Response:
{
  "sequence_number": "5",
  "authentication_key": "0x...",
  ...
}
```

### 3.2 WebSocket API

è™½ç„¶ Aptos ç›®å‰æ²¡æœ‰å®˜æ–¹çš„ Mempool WebSocket APIï¼Œä½†å¯ä»¥ä½¿ç”¨è½®è¯¢æˆ–è®¢é˜…æœ€æ–°åŒºå—çš„æ–¹å¼ï¼š

```typescript
// æ–¹æ³• 1: è½®è¯¢æœ€æ–°äº¤æ˜“
class TransactionPoller {
  private lastVersion: number = 0;
  private interval: NodeJS.Timer;
  
  async start() {
    const ledger = await this.client.getLedgerInfo();
    this.lastVersion = Number(ledger.ledger_version);
    
    this.interval = setInterval(() => this.poll(), 1000);
  }
  
  async poll() {
    const ledger = await this.client.getLedgerInfo();
    const currentVersion = Number(ledger.ledger_version);
    
    if (currentVersion > this.lastVersion) {
      // è·å–æ–°äº¤æ˜“
      const newTxs = await this.client.getTransactions({
        start: this.lastVersion + 1,
        limit: currentVersion - this.lastVersion
      });
      
      for (const tx of newTxs) {
        this.onNewTransaction(tx);
      }
      
      this.lastVersion = currentVersion;
    }
  }
  
  stop() {
    clearInterval(this.interval);
  }
  
  onNewTransaction(tx: any) {
    console.log('New transaction:', tx.hash);
    // å¤„ç†æ–°äº¤æ˜“
  }
}
```

### 3.3 TypeScript SDK ä½¿ç”¨

```typescript
import { AptosClient, AptosAccount, TxnBuilderTypes, BCS } from 'aptos';

const NODE_URL = 'https://fullnode.testnet.aptoslabs.com/v1';
const client = new AptosClient(NODE_URL);

// 1. åˆ›å»ºå’Œæäº¤äº¤æ˜“
async function submitTransaction() {
  const account = new AptosAccount();
  
  const payload = {
    type: 'entry_function_payload',
    function: '0x1::coin::transfer',
    type_arguments: ['0x1::aptos_coin::AptosCoin'],
    arguments: ['0x2', '1000000']
  };
  
  const txnRequest = await client.generateTransaction(
    account.address(),
    payload
  );
  
  const signedTxn = await client.signTransaction(account, txnRequest);
  const txnHash = await client.submitTransaction(signedTxn);
  
  return txnHash.hash;
}

// 2. ç­‰å¾…äº¤æ˜“ç¡®è®¤
async function waitForTransaction(txHash: string) {
  await client.waitForTransaction(txHash);
  const tx = await client.getTransactionByHash(txHash);
  return tx;
}

// 3. æŸ¥è¯¢äº¤æ˜“çŠ¶æ€ï¼ˆä¸ç­‰å¾…ï¼‰
async function getTransactionStatus(txHash: string) {
  try {
    const tx = await client.getTransactionByHash(txHash);
    return {
      confirmed: true,
      success: (tx as any).success,
      version: (tx as any).version
    };
  } catch (error: any) {
    if (error.status === 404) {
      return { confirmed: false, pending: true };
    }
    throw error;
  }
}

// 4. ç›‘æ§è´¦æˆ·äº¤æ˜“
async function monitorAccountTransactions(address: string) {
  let lastSeqNum = -1;
  
  setInterval(async () => {
    const account = await client.getAccount(address);
    const currentSeqNum = Number(account.sequence_number);
    
    if (currentSeqNum > lastSeqNum) {
      const txs = await client.getAccountTransactions(address, {
        limit: currentSeqNum - lastSeqNum
      });
      
      for (const tx of txs) {
        console.log('New transaction:', tx);
      }
      
      lastSeqNum = currentSeqNum;
    }
  }, 2000);
}
```

### 3.4 é”™è¯¯å¤„ç†

```typescript
class MempoolClient {
  async submitTransactionWithRetry(
    signedTx: any,
    maxRetries: number = 3
  ): Promise<string> {
    for (let i = 0; i < maxRetries; i++) {
      try {
        const result = await this.client.submitTransaction(signedTx);
        return result.hash;
      } catch (error: any) {
        console.error(`Submit failed (attempt ${i + 1}):`, error);
        
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
        if (this.shouldRetry(error)) {
          await this.sleep(1000 * Math.pow(2, i)); // æŒ‡æ•°é€€é¿
          continue;
        }
        
        throw error;
      }
    }
    
    throw new Error('Max retries exceeded');
  }
  
  shouldRetry(error: any): boolean {
    // ç½‘ç»œé”™è¯¯ - é‡è¯•
    if (error.code === 'ECONNREFUSED' || error.code === 'ETIMEDOUT') {
      return true;
    }
    
    // èŠ‚ç‚¹ç¹å¿™ - é‡è¯•
    if (error.status === 503 || error.status === 429) {
      return true;
    }
    
    // åºåˆ—å·é”™è¯¯ - ä¸é‡è¯•
    if (error.message?.includes('SEQUENCE_NUMBER')) {
      return false;
    }
    
    // ä½™é¢ä¸è¶³ - ä¸é‡è¯•
    if (error.message?.includes('INSUFFICIENT_BALANCE')) {
      return false;
    }
    
    // é»˜è®¤ä¸é‡è¯•
    return false;
  }
  
  sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

---

## 4. ç›‘æ§ç­–ç•¥è®¾è®¡

### 4.1 ç›‘æ§ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æ§ç³»ç»Ÿæ¶æ„                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Source 1  â”‚     â”‚  Data Source 2  â”‚     â”‚  Data Source 3  â”‚
â”‚  (Fullnode A)   â”‚     â”‚  (Fullnode B)   â”‚     â”‚   (Indexer)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Data Collector        â”‚
                    â”‚  - API è½®è¯¢              â”‚
                    â”‚  - WebSocket è®¢é˜…        â”‚
                    â”‚  - æ•°æ®æ ‡å‡†åŒ–            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Data Processor        â”‚
                    â”‚  - æ•°æ®è§£æ              â”‚
                    â”‚  - è¿‡æ»¤å’Œç­›é€‰            â”‚
                    â”‚  - å»é‡                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Opportunity Scanner   â”‚
                    â”‚  - å¥—åˆ©æœºä¼šè¯†åˆ«          â”‚
                    â”‚  - æ¸…ç®—æœºä¼šæ£€æµ‹          â”‚
                    â”‚  - ä»·æ ¼å¼‚å¸¸å‘Šè­¦          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Storage Layer         â”‚
                    â”‚  - æ—¶åºæ•°æ®åº“ (InfluxDB) â”‚
                    â”‚  - å…³ç³»æ•°æ®åº“ (Postgres) â”‚
                    â”‚  - ç¼“å­˜ (Redis)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notification   â”‚  â”‚   Dashboard        â”‚  â”‚  Strategy Engine â”‚
â”‚  - é‚®ä»¶å‘Šè­¦      â”‚  â”‚  - å®æ—¶ç›‘æ§é¢æ¿     â”‚  â”‚  - è‡ªåŠ¨äº¤æ˜“       â”‚
â”‚  - Telegram     â”‚  â”‚  - æ•°æ®å¯è§†åŒ–       â”‚  â”‚  - é£é™©æ§åˆ¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®æ”¶é›†ç­–ç•¥

#### ç­–ç•¥ 1: è½®è¯¢ (Polling)
```typescript
class PollingCollector {
  private interval: number = 2000; // 2ç§’
  
  async start() {
    setInterval(() => this.collect(), this.interval);
  }
  
  async collect() {
    try {
      const ledger = await this.client.getLedgerInfo();
      const currentVersion = Number(ledger.ledger_version);
      
      if (currentVersion > this.lastVersion) {
        await this.fetchNewTransactions(this.lastVersion, currentVersion);
        this.lastVersion = currentVersion;
      }
    } catch (error) {
      console.error('Collection error:', error);
    }
  }
}

// ä¼˜ç‚¹ï¼š
// - å®ç°ç®€å•
// - å¯æ§çš„è¯·æ±‚é¢‘ç‡
// - æ”¯æŒæ‰€æœ‰èŠ‚ç‚¹

// ç¼ºç‚¹ï¼š
// - å»¶è¿Ÿè¾ƒé«˜ (æœ€å¤š2ç§’)
// - å¯èƒ½é”™è¿‡å¿«é€Ÿäº¤æ˜“
// - è¯·æ±‚å¼€é”€å¤§
```

#### ç­–ç•¥ 2: é•¿è½®è¯¢ (Long Polling)
```typescript
class LongPollingCollector {
  async start() {
    while (this.running) {
      try {
        // ç­‰å¾…ç›´åˆ°æœ‰æ–°æ•°æ®æˆ–è¶…æ—¶
        const data = await this.client.waitForNewData({
          timeout: 30000
        });
        
        this.processData(data);
      } catch (error) {
        console.error('Long polling error:', error);
        await this.sleep(1000);
      }
    }
  }
}

// ä¼˜ç‚¹ï¼š
// - å»¶è¿Ÿè¾ƒä½
// - å‡å°‘æ— æ•ˆè¯·æ±‚

// ç¼ºç‚¹ï¼š
// - è¿æ¥ä¿æŒæ—¶é—´é•¿
// - å¯èƒ½è¢«ä»£ç†æœåŠ¡å™¨ä¸­æ–­
```

#### ç­–ç•¥ 3: äº‹ä»¶è®¢é˜… (GraphQL Subscription)
```typescript
class SubscriptionCollector {
  async start() {
    const ws = new WebSocket(INDEXER_WS_URL);
    
    ws.on('open', () => {
      ws.send(JSON.stringify({
        type: 'start',
        payload: {
          query: `
            subscription {
              transactions(
                limit: 10
                order_by: {version: desc}
              ) {
                version
                hash
                sender
                success
              }
            }
          `
        }
      }));
    });
    
    ws.on('message', (data) => {
      const message = JSON.parse(data);
      this.processTransactions(message.payload.data.transactions);
    });
  }
}

// ä¼˜ç‚¹ï¼š
// - å®æ—¶æ€§æœ€å¥½
// - æœåŠ¡å™¨æ¨é€ï¼Œæ— éœ€è½®è¯¢

// ç¼ºç‚¹ï¼š
// - éœ€è¦ WebSocket æ”¯æŒ
// - è¿æ¥ç®¡ç†å¤æ‚
```

### 4.3 è¿‡æ»¤å’Œç­›é€‰ç­–ç•¥

```typescript
interface FilterConfig {
  // æŒ‰äº¤æ˜“ç±»å‹è¿‡æ»¤
  types?: string[];
  
  // æŒ‰å‘é€è€…è¿‡æ»¤
  senders?: string[];
  
  // æŒ‰æ¥æ”¶è€…è¿‡æ»¤ (å¦‚æœé€‚ç”¨)
  recipients?: string[];
  
  // æŒ‰å‡½æ•°è¿‡æ»¤
  functions?: string[];
  
  // æŒ‰ Gas èŒƒå›´è¿‡æ»¤
  minGas?: number;
  maxGas?: number;
  
  // æŒ‰é‡‘é¢è¿‡æ»¤
  minAmount?: number;
  maxAmount?: number;
  
  // è‡ªå®šä¹‰è¿‡æ»¤å‡½æ•°
  custom?: (tx: Transaction) => boolean;
}

class TransactionFilter {
  constructor(private config: FilterConfig) {}
  
  shouldProcess(tx: Transaction): boolean {
    // æ£€æŸ¥äº¤æ˜“ç±»å‹
    if (this.config.types && this.config.types.length > 0) {
      if (!this.config.types.includes(tx.type)) {
        return false;
      }
    }
    
    // æ£€æŸ¥å‘é€è€…
    if (this.config.senders && this.config.senders.length > 0) {
      if (!this.config.senders.includes(tx.sender)) {
        return false;
      }
    }
    
    // æ£€æŸ¥å‡½æ•°è°ƒç”¨
    if (this.config.functions && this.config.functions.length > 0) {
      if (tx.payload.type === 'entry_function_payload') {
        const func = tx.payload.function;
        if (!this.config.functions.some(f => func.includes(f))) {
          return false;
        }
      }
    }
    
    // æ£€æŸ¥ Gas
    if (this.config.minGas && tx.max_gas_amount < this.config.minGas) {
      return false;
    }
    if (this.config.maxGas && tx.max_gas_amount > this.config.maxGas) {
      return false;
    }
    
    // è‡ªå®šä¹‰è¿‡æ»¤
    if (this.config.custom && !this.config.custom(tx)) {
      return false;
    }
    
    return true;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const dexFilter = new TransactionFilter({
  functions: ['swap', 'add_liquidity', 'remove_liquidity'],
  minAmount: 1000000000 // åªå…³æ³¨å¤§é¢äº¤æ˜“
});

monitorTransactions((tx) => {
  if (dexFilter.shouldProcess(tx)) {
    analyzeDEXTransaction(tx);
  }
});
```

### 4.4 å­˜å‚¨ç­–ç•¥

```typescript
// å¤šå±‚å­˜å‚¨æ¶æ„
class StorageManager {
  private redis: Redis;        // çƒ­æ•°æ®ç¼“å­˜
  private postgres: Pool;      // æŒä¹…åŒ–å­˜å‚¨
  private influxdb: InfluxDB;  // æ—¶åºæ•°æ®
  
  // ç¼“å­˜æœ€è¿‘äº¤æ˜“ (Redis)
  async cacheTransaction(tx: Transaction) {
    await this.redis.setex(
      `tx:${tx.hash}`,
      3600, // 1å°æ—¶è¿‡æœŸ
      JSON.stringify(tx)
    );
    
    await this.redis.zadd(
      'recent_transactions',
      Date.now(),
      tx.hash
    );
    
    // ä¿æŒæœ€è¿‘1000ç¬”
    await this.redis.zremrangebyrank('recent_transactions', 0, -1001);
  }
  
  // æŒä¹…åŒ–å­˜å‚¨ (PostgreSQL)
  async persistTransaction(tx: Transaction) {
    await this.postgres.query(`
      INSERT INTO transactions (
        hash, version, sender, success, gas_used, timestamp
      ) VALUES ($1, $2, $3, $4, $5, $6)
      ON CONFLICT (hash) DO NOTHING
    `, [
      tx.hash,
      tx.version,
      tx.sender,
      tx.success,
      tx.gas_used,
      tx.timestamp
    ]);
  }
  
  // æ—¶åºæŒ‡æ ‡ (InfluxDB)
  async recordMetrics(tx: Transaction) {
    await this.influxdb.writePoints([
      {
        measurement: 'transaction_metrics',
        tags: {
          type: tx.type,
          success: tx.success
        },
        fields: {
          gas_used: tx.gas_used,
          gas_price: tx.gas_unit_price
        },
        timestamp: Date.now()
      }
    ]);
  }
}
```

### 4.5 å‘Šè­¦ç­–ç•¥

```typescript
interface AlertConfig {
  type: 'email' | 'telegram' | 'webhook';
  threshold: number;
  cooldown: number; // å†·å´æ—¶é—´ï¼Œé¿å…å‘Šè­¦è½°ç‚¸
}

class AlertManager {
  private lastAlertTime = new Map<string, number>();
  
  async sendAlert(
    key: string,
    message: string,
    config: AlertConfig
  ) {
    const now = Date.now();
    const lastAlert = this.lastAlertTime.get(key) || 0;
    
    // æ£€æŸ¥å†·å´æ—¶é—´
    if (now - lastAlert < config.cooldown) {
      return;
    }
    
    // å‘é€å‘Šè­¦
    switch (config.type) {
      case 'email':
        await this.sendEmail(message);
        break;
      case 'telegram':
        await this.sendTelegram(message);
        break;
      case 'webhook':
        await this.sendWebhook(message);
        break;
    }
    
    this.lastAlertTime.set(key, now);
  }
  
  // å¥—åˆ©æœºä¼šå‘Šè­¦
  async alertArbitrageOpportunity(opportunity: ArbitrageOp) {
    if (opportunity.profit > 100) { // $100 åˆ©æ¶¦é˜ˆå€¼
      await this.sendAlert(
        'arbitrage',
        `ğŸš€ å¥—åˆ©æœºä¼š: é¢„æœŸåˆ©æ¶¦ $${opportunity.profit}`,
        {
          type: 'telegram',
          threshold: 100,
          cooldown: 60000 // 1åˆ†é’Ÿ
        }
      );
    }
  }
}
```

---

## 5. MEV æœºä¼šè¯†åˆ«

### 5.1 ä»€ä¹ˆæ˜¯ MEV?

**MEV (Maximal Extractable Value)** æ˜¯æŒ‡é€šè¿‡é‡æ–°æ’åºã€æ’å…¥æˆ–å®¡æŸ¥åŒºå—ä¸­çš„äº¤æ˜“æ¥æå–çš„æœ€å¤§ä»·å€¼ã€‚

```
MEV ç±»å‹ï¼š
1. å¥—åˆ© (Arbitrage)        - åˆ©ç”¨ä»·æ ¼å·®å¼‚
2. æ¸…ç®— (Liquidation)      - æ¸…ç®—æŠµæŠ¼ä¸è¶³çš„ä»“ä½
3. æŠ¢è·‘ (Front-running)    - åœ¨ç›®æ ‡äº¤æ˜“å‰æ‰§è¡Œ
4. åè·‘ (Back-running)     - åœ¨ç›®æ ‡äº¤æ˜“åæ‰§è¡Œ
5. ä¸‰æ˜æ²»æ”»å‡» (Sandwich)   - å‰åå¤¹å‡»
```

### 5.2 å¥—åˆ©æœºä¼šè¯†åˆ«

```typescript
interface ArbitrageOpportunity {
  dexA: string;
  dexB: string;
  tokenPair: string;
  priceA: number;
  priceB: number;
  profitPercent: number;
  estimatedProfit: number;
  timestamp: number;
}

class ArbitrageScanner {
  async scanOpportunities(): Promise<ArbitrageOpportunity[]> {
    const opportunities: ArbitrageOpportunity[] = [];
    
    // è·å–æ‰€æœ‰ DEX çš„ä»·æ ¼
    const prices = await this.getAllDEXPrices();
    
    // éå†æ‰€æœ‰äº¤æ˜“å¯¹
    for (const pair of this.tradingPairs) {
      const dexPrices = prices.filter(p => p.pair === pair);
      
      // å¯»æ‰¾ä»·æ ¼å·®å¼‚
      for (let i = 0; i < dexPrices.length; i++) {
        for (let j = i + 1; j < dexPrices.length; j++) {
          const priceDiff = Math.abs(dexPrices[i].price - dexPrices[j].price);
          const avgPrice = (dexPrices[i].price + dexPrices[j].price) / 2;
          const diffPercent = (priceDiff / avgPrice) * 100;
          
          // ä»·å·®è¶…è¿‡é˜ˆå€¼ (å¦‚ 0.5%)
          if (diffPercent > 0.5) {
            const opportunity: ArbitrageOpportunity = {
              dexA: dexPrices[i].dex,
              dexB: dexPrices[j].dex,
              tokenPair: pair,
              priceA: dexPrices[i].price,
              priceB: dexPrices[j].price,
              profitPercent: diffPercent,
              estimatedProfit: await this.calculateProfit(
                dexPrices[i],
                dexPrices[j]
              ),
              timestamp: Date.now()
            };
            
            opportunities.push(opportunity);
          }
        }
      }
    }
    
    return opportunities;
  }
  
  async calculateProfit(priceA: Price, priceB: Price): Promise<number> {
    // è®¡ç®—è€ƒè™‘ Gas è´¹ç”¨åçš„å®é™…åˆ©æ¶¦
    const tradeAmount = 10000; // å‡è®¾äº¤æ˜“é‡‘é¢
    const priceDiff = Math.abs(priceA.price - priceB.price);
    const grossProfit = tradeAmount * (priceDiff / priceA.price);
    
    const gasCost = await this.estimateGasCost();
    const fees = tradeAmount * 0.003 * 2; // 0.3% æ‰‹ç»­è´¹ * 2æ¬¡äº¤æ˜“
    
    const netProfit = grossProfit - gasCost - fees;
    return netProfit;
  }
}
```

### 5.3 æ¸…ç®—æœºä¼šæ£€æµ‹

```typescript
interface LiquidationOpportunity {
  protocol: string;
  account: string;
  collateral: number;
  debt: number;
  healthFactor: number;
  liquidationBonus: number;
  estimatedProfit: number;
}

class LiquidationScanner {
  async scanLiquidations(): Promise<LiquidationOpportunity[]> {
    const opportunities: LiquidationOpportunity[] = [];
    
    // è·å–æ‰€æœ‰å€Ÿè´·åè®®çš„ä»“ä½
    const positions = await this.getAllLendingPositions();
    
    for (const position of positions) {
      const healthFactor = await this.calculateHealthFactor(position);
      
      // å¥åº·å› å­ < 1.0 å¯ä»¥è¢«æ¸…ç®—
      if (healthFactor < 1.0) {
        const opportunity: LiquidationOpportunity = {
          protocol: position.protocol,
          account: position.account,
          collateral: position.collateral,
          debt: position.debt,
          healthFactor,
          liquidationBonus: position.liquidationBonus,
          estimatedProfit: this.calculateLiquidationProfit(position)
        };
        
        opportunities.push(opportunity);
      }
    }
    
    return opportunities;
  }
  
  async calculateHealthFactor(position: LendingPosition): Promise<number> {
    // å¥åº·å› å­ = (æŠµæŠ¼å“ä»·å€¼ * æ¸…ç®—é˜ˆå€¼) / å€ºåŠ¡ä»·å€¼
    const collateralPrice = await this.getPrice(position.collateralToken);
    const debtPrice = await this.getPrice(position.debtToken);
    
    const collateralValue = position.collateral * collateralPrice;
    const debtValue = position.debt * debtPrice;
    
    const healthFactor = 
      (collateralValue * position.liquidationThreshold) / debtValue;
    
    return healthFactor;
  }
}
```

### 5.4 Mempool äº¤æ˜“åˆ†æ

```typescript
class MempoolAnalyzer {
  // åˆ†æå¾…å¤„ç†çš„ DEX äº¤æ˜“
  async analyzeDEXTransaction(tx: Transaction) {
    if (tx.payload.type !== 'entry_function_payload') {
      return null;
    }
    
    const payload = tx.payload as EntryFunctionPayload;
    const func = payload.function;
    
    // è¯†åˆ« Swap äº¤æ˜“
    if (func.includes('swap')) {
      const analysis = {
        type: 'SWAP',
        dex: this.identifyDEX(func),
        tokenIn: payload.type_arguments[0],
        tokenOut: payload.type_arguments[1],
        amountIn: Number(payload.arguments[0]),
        minAmountOut: Number(payload.arguments[1]),
        sender: tx.sender,
        gasPrice: tx.gas_unit_price,
        timestamp: Date.now()
      };
      
      // æ£€æµ‹å¤§é¢äº¤æ˜“
      if (analysis.amountIn > this.largeTradeThreshold) {
        await this.alertLargeTrade(analysis);
      }
      
      // æ£€æµ‹å¯èƒ½çš„ä»·æ ¼å½±å“
      const priceImpact = await this.calculatePriceImpact(analysis);
      if (priceImpact > 5) { // 5% ä»·æ ¼å½±å“
        await this.alertHighPriceImpact(analysis, priceImpact);
      }
      
      return analysis;
    }
    
    return null;
  }
  
  // è¯†åˆ« DEX
  identifyDEX(functionStr: string): string {
    if (functionStr.includes('liquidswap')) return 'Liquidswap';
    if (functionStr.includes('pancake')) return 'PancakeSwap';
    if (functionStr.includes('sushi')) return 'SushiSwap';
    return 'Unknown';
  }
  
  // è®¡ç®—ä»·æ ¼å½±å“
  async calculatePriceImpact(swap: any): Promise<number> {
    const pool = await this.getPoolReserves(swap.dex, swap.tokenIn, swap.tokenOut);
    
    // ä½¿ç”¨æ’å®šä¹˜ç§¯å…¬å¼è®¡ç®—
    const k = pool.reserveIn * pool.reserveOut;
    const newReserveIn = pool.reserveIn + swap.amountIn;
    const newReserveOut = k / newReserveIn;
    const amountOut = pool.reserveOut - newReserveOut;
    
    const priceWithoutSlippage = pool.reserveOut / pool.reserveIn;
    const actualPrice = amountOut / swap.amountIn;
    
    const priceImpact = 
      Math.abs((actualPrice - priceWithoutSlippage) / priceWithoutSlippage) * 100;
    
    return priceImpact;
  }
}
```

### 5.5 åˆè§„ MEV ç­–ç•¥

âš ï¸ **é‡è¦æç¤º**: æŸäº› MEV ç­–ç•¥å¯èƒ½è¿åæ³•å¾‹æ³•è§„æˆ–å¹³å°è§„åˆ™ã€‚ä»¥ä¸‹æ˜¯åˆè§„çš„ç­–ç•¥ï¼š

#### âœ… åˆè§„ç­–ç•¥

1. **DEX å¥—åˆ©**
   ```
   - åœ¨ä¸åŒ DEX é—´è¿›è¡Œå¥—åˆ©
   - ä½¿ç”¨å…¬å¼€å¸‚åœºä»·æ ¼
   - ä¸ä¾èµ–ç‰¹æƒä¿¡æ¯
   - ä¸ºå¸‚åœºæä¾›æµåŠ¨æ€§
   ```

2. **æ¸…ç®—**
   ```
   - æ¸…ç®—åè®®è®¾è®¡çš„æ¸…ç®—æœºåˆ¶
   - å¸®åŠ©åè®®ç»´æŠ¤å¿ä»˜èƒ½åŠ›
   - è·å–åè®®è®¾å®šçš„æ¸…ç®—å¥–åŠ±
   ```

3. **æä¾›æµåŠ¨æ€§**
   ```
   - åœ¨ä»·æ ¼æ³¢åŠ¨æ—¶æä¾›æµåŠ¨æ€§
   - èµšå–æ‰‹ç»­è´¹
   - é™ä½å¸‚åœºæ³¢åŠ¨æ€§
   ```

#### âŒ ä¸åˆè§„ç­–ç•¥ (é¿å…ä½¿ç”¨)

1. **æŠ¢è·‘**
   ```
   - åœ¨ç”¨æˆ·äº¤æ˜“å‰æ’å…¥äº¤æ˜“
   - å¯èƒ½è¿åå…¬å¹³äº¤æ˜“åŸåˆ™
   ```

2. **ä¸‰æ˜æ²»æ”»å‡»**
   ```
   - å‰åå¤¹å‡»ç”¨æˆ·äº¤æ˜“
   - æŸå®³ç”¨æˆ·åˆ©ç›Š
   ```

3. **æ“çºµä»·æ ¼**
   ```
   - äººä¸ºåˆ¶é€ ä»·æ ¼æ³¢åŠ¨
   - å¯èƒ½æ„æˆå¸‚åœºæ“çºµ
   ```

---

## 6. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 6.1 è¿æ¥æ± ç®¡ç†

```typescript
class ConnectionPool {
  private pool: AptosClient[] = [];
  private maxConnections = 10;
  private currentIndex = 0;
  
  constructor(private nodeUrls: string[]) {
    // åˆ›å»ºè¿æ¥æ± 
    for (const url of nodeUrls) {
      for (let i = 0; i < this.maxConnections / nodeUrls.length; i++) {
        this.pool.push(new AptosClient(url));
      }
    }
  }
  
  // è½®è¯¢è·å–è¿æ¥
  getClient(): AptosClient {
    const client = this.pool[this.currentIndex];
    this.currentIndex = (this.currentIndex + 1) % this.pool.length;
    return client;
  }
  
  // å¹¶è¡Œè¯·æ±‚
  async parallelRequests<T>(
    requests: (() => Promise<T>)[]
  ): Promise<T[]> {
    return Promise.all(
      requests.map(req => req())
    );
  }
}
```

### 6.2 æ‰¹é‡å¤„ç†

```typescript
class BatchProcessor {
  private batchSize = 100;
  private batchTimeout = 1000; // 1ç§’
  private queue: Transaction[] = [];
  private timer: NodeJS.Timer | null = null;
  
  add(tx: Transaction) {
    this.queue.push(tx);
    
    // è¾¾åˆ°æ‰¹é‡å¤§å°ï¼Œç«‹å³å¤„ç†
    if (this.queue.length >= this.batchSize) {
      this.flush();
    } else if (!this.timer) {
      // è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
      this.timer = setTimeout(() => this.flush(), this.batchTimeout);
    }
  }
  
  flush() {
    if (this.queue.length === 0) return;
    
    const batch = this.queue.splice(0, this.batchSize);
    this.processBatch(batch);
    
    if (this.timer) {
      clearTimeout(this.timer);
      this.timer = null;
    }
  }
  
  async processBatch(transactions: Transaction[]) {
    // æ‰¹é‡æ’å…¥æ•°æ®åº“
    await this.db.batchInsert(transactions);
    
    // æ‰¹é‡åˆ†æ
    const analyses = transactions.map(tx => this.analyze(tx));
    
    // æ‰¹é‡å­˜å‚¨åˆ†æç»“æœ
    await this.db.batchInsertAnalyses(analyses);
  }
}
```

### 6.3 ç¼“å­˜ç­–ç•¥

```typescript
class CacheManager {
  private cache = new Map<string, CacheEntry>();
  private maxSize = 10000;
  
  interface CacheEntry {
    data: any;
    timestamp: number;
    ttl: number;
  }
  
  get(key: string): any | null {
    const entry = this.cache.get(key);
    
    if (!entry) return null;
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() - entry.timestamp > entry.ttl) {
      this.cache.delete(key);
      return null;
    }
    
    return entry.data;
  }
  
  set(key: string, data: any, ttl: number = 60000) {
    // LRU æ·˜æ±°
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(key, {
      data,
      timestamp: Date.now(),
      ttl
    });
  }
  
  // ç¼“å­˜äº¤æ˜“çŠ¶æ€
  async getTransactionStatus(hash: string): Promise<any> {
    const cached = this.get(`tx:${hash}`);
    if (cached) return cached;
    
    const status = await this.client.getTransactionByHash(hash);
    this.set(`tx:${hash}`, status, 60000); // ç¼“å­˜1åˆ†é’Ÿ
    
    return status;
  }
}
```

### 6.4 æ€§èƒ½ç›‘æ§

```typescript
class PerformanceMonitor {
  private metrics = {
    requestCount: 0,
    errorCount: 0,
    totalLatency: 0,
    transactionsProcessed: 0
  };
  
  async measureRequest<T>(
    name: string,
    fn: () => Promise<T>
  ): Promise<T> {
    const startTime = Date.now();
    
    try {
      const result = await fn();
      
      const latency = Date.now() - startTime;
      this.recordSuccess(name, latency);
      
      return result;
    } catch (error) {
      this.recordError(name);
      throw error;
    }
  }
  
  recordSuccess(name: string, latency: number) {
    this.metrics.requestCount++;
    this.metrics.totalLatency += latency;
  }
  
  recordError(name: string) {
    this.metrics.errorCount++;
  }
  
  getStats() {
    return {
      ...this.metrics,
      avgLatency: this.metrics.totalLatency / this.metrics.requestCount,
      errorRate: this.metrics.errorCount / this.metrics.requestCount,
      tps: this.metrics.transactionsProcessed / 
           ((Date.now() - this.startTime) / 1000)
    };
  }
  
  // å®šæœŸè¾“å‡ºç»Ÿè®¡
  startReporting(interval: number = 60000) {
    setInterval(() => {
      console.log('Performance Stats:', this.getStats());
    }, interval);
  }
}
```

### 6.5 æœ€ä½³å®è·µæ€»ç»“

```typescript
// âœ… æ¨èåšæ³•
class BestPracticesMonitor {
  // 1. ä½¿ç”¨è¿æ¥æ± 
  private pool = new ConnectionPool(NODE_URLS);
  
  // 2. æ‰¹é‡å¤„ç†
  private batchProcessor = new BatchProcessor();
  
  // 3. æ™ºèƒ½ç¼“å­˜
  private cache = new CacheManager();
  
  // 4. é”™è¯¯é‡è¯•
  private retryConfig = {
    maxRetries: 3,
    backoff: 'exponential'
  };
  
  // 5. æ€§èƒ½ç›‘æ§
  private monitor = new PerformanceMonitor();
  
  // 6. é™æµ
  private rateLimiter = new RateLimiter({
    maxRequests: 100,
    perInterval: 1000 // æ¯ç§’æœ€å¤š100ä¸ªè¯·æ±‚
  });
  
  // 7. è¶…æ—¶æ§åˆ¶
  private timeout = 30000; // 30ç§’è¶…æ—¶
  
  // 8. ä¼˜é›…å…³é—­
  async shutdown() {
    console.log('Shutting down gracefully...');
    
    // å¤„ç†å‰©ä½™é˜Ÿåˆ—
    await this.batchProcessor.flush();
    
    // å…³é—­è¿æ¥
    await this.pool.closeAll();
    
    // ä¿å­˜çŠ¶æ€
    await this.saveState();
    
    console.log('Shutdown complete');
  }
}
```

---

## æ€»ç»“

ä»Šå¤©æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº† Aptos Mempool ç›‘æ§å’Œäº¤æ˜“è¿½è¸ªï¼š

### æ ¸å¿ƒè¦ç‚¹

1. **Mempool æ¶æ„**
   - ç†è§£ Mempool åœ¨äº¤æ˜“æµç¨‹ä¸­çš„è§’è‰²
   - æŒæ¡ Aptos Mempool çš„ç‹¬ç‰¹ç‰¹ç‚¹
   - ç†è§£äº¤æ˜“éªŒè¯å’Œæ’åºæœºåˆ¶

2. **äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ**
   - ä»åˆ›å»ºåˆ°ç¡®è®¤çš„å®Œæ•´æµç¨‹
   - å„é˜¶æ®µçš„æ—¶é—´ä¼°ç®—
   - çŠ¶æ€æŸ¥è¯¢æ–¹æ³•

3. **API ä½¿ç”¨**
   - REST API ç«¯ç‚¹å’Œä½¿ç”¨æ–¹æ³•
   - TypeScript SDK é›†æˆ
   - é”™è¯¯å¤„ç†å’Œé‡è¯•ç­–ç•¥

4. **ç›‘æ§ç­–ç•¥**
   - è½®è¯¢ã€é•¿è½®è¯¢ã€è®¢é˜…ç­‰æ•°æ®æ”¶é›†æ–¹å¼
   - è¿‡æ»¤å’Œç­›é€‰ç­–ç•¥
   - å­˜å‚¨å’Œå‘Šè­¦æœºåˆ¶

5. **MEV æœºä¼š**
   - å¥—åˆ©æœºä¼šè¯†åˆ«
   - æ¸…ç®—æœºä¼šæ£€æµ‹
   - åˆè§„ MEV ç­–ç•¥

6. **æ€§èƒ½ä¼˜åŒ–**
   - è¿æ¥æ± ç®¡ç†
   - æ‰¹é‡å¤„ç†
   - ç¼“å­˜ç­–ç•¥
   - æ€§èƒ½ç›‘æ§

### ä¸‹ä¸€æ­¥

æ˜å¤©æˆ‘ä»¬å°†å­¦ä¹  **Day 30: å¥—åˆ©åŸç†**ï¼Œå°†ä»Šå¤©å­¦åˆ°çš„ç›‘æ§æŠ€æœ¯åº”ç”¨äºå®é™…çš„å¥—åˆ©ç­–ç•¥ã€‚

---

**ç»§ç»­åŠ æ²¹ï¼ğŸš€**
