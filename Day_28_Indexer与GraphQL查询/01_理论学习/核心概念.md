# Day 28 æ ¸å¿ƒæ¦‚å¿µï¼šIndexer ä¸ GraphQL æŸ¥è¯¢

## ğŸ“š ç›®å½•

1. [Aptos Indexer æ¶æ„æ·±å…¥](#1-aptos-indexer-æ¶æ„æ·±å…¥)
2. [GraphQL è¯­æ³•è¯¦è§£](#2-graphql-è¯­æ³•è¯¦è§£)
3. [æ•°æ®æ¨¡å‹å’Œ Schema](#3-æ•°æ®æ¨¡å‹å’Œ-schema)
4. [è®¢é˜…æœºåˆ¶åŸç†](#4-è®¢é˜…æœºåˆ¶åŸç†)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## 1. Aptos Indexer æ¶æ„æ·±å…¥

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ Indexerï¼Ÿ

åŒºå—é“¾çš„åŸå§‹æ•°æ®å­˜å‚¨æ–¹å¼ä¸é€‚åˆæŸ¥è¯¢ï¼š
- **é¡ºåºå­˜å‚¨**: æ•°æ®æŒ‰åŒºå—é¡ºåºå­˜å‚¨ï¼ŒæŸ¥è¯¢ç‰¹å®šäº¤æ˜“éœ€è¦æ‰«ææ•´ä¸ªé“¾
- **æ ¼å¼å¤æ‚**: æ•°æ®ä½¿ç”¨ BCS ç¼–ç ï¼Œä¸æ˜“ç›´æ¥æŸ¥è¯¢
- **ç¼ºä¹ç´¢å¼•**: æ²¡æœ‰æŒ‰è´¦æˆ·ã€æ—¶é—´ç­‰ç»´åº¦çš„ç´¢å¼•
- **æ€§èƒ½é—®é¢˜**: Fullnode ä¸“æ³¨äºå…±è¯†å’Œæ‰§è¡Œï¼Œä¸æ“…é•¿å¤æ‚æŸ¥è¯¢

**Indexer çš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
åŸå§‹åŒºå—é“¾æ•°æ® â†’ å¤„ç†å’Œè½¬æ¢ â†’ å…³ç³»å‹æ•°æ®åº“ â†’ GraphQL API â†’ åº”ç”¨
```

### 1.2 Indexer æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Aptos Fullnode                         â”‚
â”‚  - éªŒè¯å’Œæ‰§è¡Œäº¤æ˜“                                            â”‚
â”‚  - ç»´æŠ¤çŠ¶æ€æ ‘                                                â”‚
â”‚  - æä¾› Transaction Stream                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ gRPC Transaction Stream
                         â”‚ (å®æ—¶æ¨é€æ–°äº¤æ˜“)
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Transaction Stream Service (TSS)                 â”‚
â”‚  - ç›‘å¬ Fullnode çš„æ–°äº¤æ˜“                                    â”‚
â”‚  - ç¼“å†²å’Œæ‰¹å¤„ç†                                              â”‚
â”‚  - æ¨é€ç»™è®¢é˜…çš„ Processor                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Coin      â”‚ â”‚    Token     â”‚ â”‚    Event     â”‚
â”‚  Processor   â”‚ â”‚  Processor   â”‚ â”‚  Processor   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æå–ä»£å¸æ•°æ® â”‚ â”‚ æå–NFTæ•°æ®  â”‚ â”‚ æå–äº‹ä»¶æ•°æ® â”‚
â”‚ è®¡ç®—ä½™é¢     â”‚ â”‚ è§£æå…ƒæ•°æ®   â”‚ â”‚ åˆ†ç±»å’Œç´¢å¼•   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PostgreSQL Database                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Transactionsâ”‚   Events   â”‚  Accounts  â”‚   Tokens   â”‚     â”‚
â”‚  â”‚            â”‚            â”‚            â”‚            â”‚     â”‚
â”‚  â”‚ Coin       â”‚ Token      â”‚ Current    â”‚ Metadata   â”‚     â”‚
â”‚  â”‚ Balances   â”‚ Ownerships â”‚ State      â”‚            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ SQL Queries
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Hasura GraphQL Engine                          â”‚
â”‚  - åŸºäºæ•°æ®åº“ Schema è‡ªåŠ¨ç”Ÿæˆ GraphQL API                    â”‚
â”‚  - æä¾›æŸ¥è¯¢ã€è®¢é˜…æ¥å£                                        â”‚
â”‚  - æŸ¥è¯¢ä¼˜åŒ–å’Œç¼“å­˜                                            â”‚
â”‚  - æƒé™å’Œè®¤è¯                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ GraphQL over HTTP/WebSocket
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº                             â”‚
â”‚  - DApp å‰ç«¯                                                â”‚
â”‚  - é’±åŒ…åº”ç”¨                                                 â”‚
â”‚  - æ•°æ®åˆ†æå·¥å…·                                              â”‚
â”‚  - MEV æœºå™¨äºº                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Processor è¯¦è§£

æ¯ä¸ª Processor ä¸“æ³¨äºå¤„ç†ç‰¹å®šç±»å‹çš„æ•°æ®ï¼š

#### Coin Processor
```rust
// å¤„ç†æµç¨‹
1. æ¥æ”¶äº¤æ˜“æ•°æ®
2. æå– Coin ç›¸å…³äº‹ä»¶ (DepositEvent, WithdrawEvent)
3. è®¡ç®—è´¦æˆ·ä½™é¢å˜åŒ–
4. æ›´æ–° current_coin_balances è¡¨
5. è®°å½•å†å²ä½™é¢å˜åŒ–
```

**å¤„ç†çš„è¡¨**ï¼š
- `coin_balances`: å†å²ä½™é¢è®°å½•
- `current_coin_balances`: å½“å‰ä½™é¢
- `coin_infos`: ä»£å¸ä¿¡æ¯

#### Token Processor
```rust
// å¤„ç†æµç¨‹
1. æå– Token ç›¸å…³äº‹ä»¶ (Mint, Transfer, Burn)
2. è§£æ Token å…ƒæ•°æ®
3. æ›´æ–°æ‰€æœ‰æƒä¿¡æ¯
4. ç»´æŠ¤ Collection æ•°æ®
```

**å¤„ç†çš„è¡¨**ï¼š
- `tokens`: Token åŸºæœ¬ä¿¡æ¯
- `token_ownerships`: æ‰€æœ‰æƒå†å²
- `current_token_ownerships_v2`: å½“å‰æ‰€æœ‰æƒ
- `collections`: Collection ä¿¡æ¯

#### Event Processor
```rust
// å¤„ç†æµç¨‹
1. æå–æ‰€æœ‰äº‹ä»¶
2. æŒ‰ç±»å‹åˆ†ç±»
3. è§£æäº‹ä»¶æ•°æ®
4. åˆ›å»ºç´¢å¼•
```

**å¤„ç†çš„è¡¨**ï¼š
- `events`: æ‰€æœ‰äº‹ä»¶
- æŒ‰äº‹ä»¶ç±»å‹çš„ä¸“é—¨è¡¨

### 1.4 æ•°æ®å»¶è¿Ÿå’Œä¸€è‡´æ€§

**å»¶è¿Ÿåˆ†æ**ï¼š
```
Fullnode ç¡®è®¤äº¤æ˜“: T0
â†“ ~100ms
TSS æ¥æ”¶: T0 + 100ms
â†“ ~200ms
Processor å¤„ç†: T0 + 300ms
â†“ ~100ms
å†™å…¥æ•°æ®åº“: T0 + 400ms
â†“ ~50ms
GraphQL å¯æŸ¥è¯¢: T0 + 450ms
```

**æ€»å»¶è¿Ÿ**: é€šå¸¸ 400-500msï¼Œå³°å€¼å¯èƒ½è¾¾åˆ° 1-2 ç§’

**ä¸€è‡´æ€§ä¿è¯**ï¼š
- âœ… **æœ€ç»ˆä¸€è‡´æ€§**: æ‰€æœ‰æ•°æ®æœ€ç»ˆä¼šè¢«ç´¢å¼•
- âœ… **é¡ºåºä¿è¯**: åŒä¸€è´¦æˆ·çš„äº¤æ˜“æŒ‰é¡ºåºå¤„ç†
- âŒ **ä¸ä¿è¯å®æ—¶**: å¯èƒ½æœ‰å»¶è¿Ÿ

---

## 2. GraphQL è¯­æ³•è¯¦è§£

### 2.1 GraphQL åŸºç¡€

GraphQL æ˜¯ä¸€ç§æŸ¥è¯¢è¯­è¨€å’Œè¿è¡Œæ—¶ï¼Œç”¨äº API æŸ¥è¯¢ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Schema**: å®šä¹‰å¯æŸ¥è¯¢çš„æ•°æ®ç±»å‹å’Œå­—æ®µ
- **Query**: è¯»å–æ•°æ®
- **Mutation**: ä¿®æ”¹æ•°æ®ï¼ˆAptos Indexer ä¸æ”¯æŒï¼‰
- **Subscription**: è®¢é˜…æ•°æ®å˜åŒ–

### 2.2 æŸ¥è¯¢è¯­æ³•

#### åŸºæœ¬æŸ¥è¯¢
```graphql
# æœ€ç®€å•çš„æŸ¥è¯¢
query {
  transactions {
    version
    hash
  }
}
```

#### ä½¿ç”¨å‚æ•°
```graphql
query {
  transactions(limit: 10) {
    version
    hash
    sender
  }
}
```

#### ä½¿ç”¨å˜é‡
```graphql
# æŸ¥è¯¢å®šä¹‰
query GetTransactions($limit: Int!, $offset: Int!) {
  transactions(limit: $limit, offset: $offset) {
    version
    hash
  }
}

# å˜é‡ï¼ˆå•ç‹¬ä¼ é€’ï¼‰
{
  "limit": 10,
  "offset": 0
}
```

#### å­—æ®µåˆ«å
```graphql
query {
  recent: transactions(limit: 5, order_by: {version: desc}) {
    version
  }
  
  old: transactions(limit: 5, order_by: {version: asc}) {
    version
  }
}
```

#### ç‰‡æ®µï¼ˆFragmentsï¼‰
```graphql
# å®šä¹‰ç‰‡æ®µ
fragment TransactionFields on transactions {
  version
  hash
  sender
  success
  gas_used
}

# ä½¿ç”¨ç‰‡æ®µ
query {
  transactions(limit: 10) {
    ...TransactionFields
    timestamp
  }
}
```

#### åµŒå¥—æŸ¥è¯¢
```graphql
query {
  accounts(where: {address: {_eq: "0x1"}}) {
    address
    
    # åµŒå¥—æŸ¥è¯¢è¯¥è´¦æˆ·çš„äº¤æ˜“
    account_transactions(limit: 5) {
      transaction_version
      user_transaction {
        sender
        success
      }
    }
  }
}
```

### 2.3 è¿‡æ»¤æ¡ä»¶

#### ç›¸ç­‰æ€§è¿‡æ»¤
```graphql
query {
  transactions(where: {
    sender: {_eq: "0x1"}
  }) {
    version
  }
}
```

#### æ¯”è¾ƒè¿‡æ»¤
```graphql
query {
  transactions(where: {
    version: {
      _gt: 1000000,    # å¤§äº
      _lt: 2000000     # å°äº
    }
  }) {
    version
  }
}
```

#### åŒ…å«è¿‡æ»¤
```graphql
query {
  transactions(where: {
    sender: {_in: ["0x1", "0x2", "0x3"]}
  }) {
    version
    sender
  }
}
```

#### æ¨¡ç³ŠåŒ¹é…
```graphql
query {
  events(where: {
    type: {_like: "%CoinStore%"}
  }) {
    type
    data
  }
}
```

#### å¤åˆæ¡ä»¶
```graphql
query {
  transactions(where: {
    _and: [
      {success: {_eq: true}},
      {gas_used: {_gt: 1000}}
    ]
  }) {
    version
  }
}

query {
  transactions(where: {
    _or: [
      {sender: {_eq: "0x1"}},
      {success: {_eq: false}}
    ]
  }) {
    version
  }
}
```

### 2.4 æ’åºå’Œåˆ†é¡µ

#### æ’åº
```graphql
query {
  transactions(
    order_by: {version: desc}
  ) {
    version
  }
}

# å¤šå­—æ®µæ’åº
query {
  transactions(
    order_by: [
      {timestamp: desc},
      {version: desc}
    ]
  ) {
    version
    timestamp
  }
}
```

#### åˆ†é¡µ
```graphql
# Limit/Offset åˆ†é¡µ
query {
  transactions(
    limit: 100,
    offset: 0,
    order_by: {version: desc}
  ) {
    version
  }
}

# æ¸¸æ ‡åˆ†é¡µï¼ˆæ›´é«˜æ•ˆï¼‰
query {
  transactions(
    where: {version: {_lt: $cursor}},
    limit: 100,
    order_by: {version: desc}
  ) {
    version
  }
}
```

### 2.5 èšåˆæŸ¥è¯¢

```graphql
query {
  transactions_aggregate(where: {
    success: {_eq: true}
  }) {
    aggregate {
      count          # æ€»æ•°
      max {
        gas_used     # æœ€å¤§ gas
      }
      min {
        gas_used     # æœ€å° gas
      }
      avg {
        gas_used     # å¹³å‡ gas
      }
      sum {
        gas_used     # æ€» gas
      }
    }
  }
}
```

---

## 3. æ•°æ®æ¨¡å‹å’Œ Schema

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

#### transactions è¡¨
```sql
CREATE TABLE transactions (
    version BIGINT PRIMARY KEY,        -- äº¤æ˜“ç‰ˆæœ¬å·ï¼ˆå…¨å±€å”¯ä¸€é€’å¢ï¼‰
    hash VARCHAR,                      -- äº¤æ˜“å“ˆå¸Œ
    sender VARCHAR,                    -- å‘é€è€…åœ°å€
    sequence_number BIGINT,            -- è´¦æˆ·åºåˆ—å·
    max_gas_amount BIGINT,             -- æœ€å¤§ gas é™åˆ¶
    gas_unit_price BIGINT,             -- gas å•ä»·
    gas_used BIGINT,                   -- å®é™…ä½¿ç”¨çš„ gas
    success BOOLEAN,                   -- äº¤æ˜“æ˜¯å¦æˆåŠŸ
    vm_status VARCHAR,                 -- VM æ‰§è¡ŒçŠ¶æ€
    payload JSONB,                     -- äº¤æ˜“è½½è·
    events JSONB,                      -- äº‹ä»¶åˆ—è¡¨
    state_change_hash VARCHAR,         -- çŠ¶æ€å˜åŒ–å“ˆå¸Œ
    event_root_hash VARCHAR,           -- äº‹ä»¶æ ¹å“ˆå¸Œ
    accumulator_root_hash VARCHAR,     -- ç´¯åŠ å™¨æ ¹å“ˆå¸Œ
    inserted_at TIMESTAMP,             -- æ’å…¥æ—¶é—´
    epoch BIGINT,                      -- çºªå…ƒ
    block_height BIGINT,               -- åŒºå—é«˜åº¦
    timestamp TIMESTAMP                -- äº¤æ˜“æ—¶é—´æˆ³
);
```

**GraphQL Schema**:
```graphql
type transactions {
  version: bigint!
  hash: String!
  sender: String
  sequence_number: bigint
  success: Boolean
  gas_used: bigint
  timestamp: timestamp
  
  # å…³è”æŸ¥è¯¢
  user_transaction: user_transactions
  events: [events!]!
}
```

#### events è¡¨
```sql
CREATE TABLE events (
    transaction_version BIGINT,        -- å…³è”çš„äº¤æ˜“ç‰ˆæœ¬
    event_index BIGINT,                -- äº‹ä»¶åœ¨äº¤æ˜“ä¸­çš„ç´¢å¼•
    type VARCHAR,                      -- äº‹ä»¶ç±»å‹
    data JSONB,                        -- äº‹ä»¶æ•°æ®
    sequence_number BIGINT,            -- åºåˆ—å·
    account_address VARCHAR,           -- è´¦æˆ·åœ°å€
    inserted_at TIMESTAMP,
    
    PRIMARY KEY (transaction_version, event_index)
);
```

**GraphQL Schema**:
```graphql
type events {
  transaction_version: bigint!
  event_index: bigint!
  type: String!
  data: jsonb!
  sequence_number: bigint
  account_address: String
  
  # å…³è”äº¤æ˜“
  transaction: transactions
}
```

#### current_coin_balances è¡¨
```sql
CREATE TABLE current_coin_balances (
    owner_address VARCHAR,             -- æ‰€æœ‰è€…åœ°å€
    coin_type VARCHAR,                 -- ä»£å¸ç±»å‹ï¼ˆå®Œæ•´è·¯å¾„ï¼‰
    amount NUMERIC,                    -- ä½™é¢
    last_transaction_version BIGINT,   -- æœ€åæ›´æ–°çš„äº¤æ˜“ç‰ˆæœ¬
    last_transaction_timestamp TIMESTAMP,
    inserted_at TIMESTAMP,
    
    PRIMARY KEY (owner_address, coin_type)
);
```

**GraphQL Schema**:
```graphql
type current_coin_balances {
  owner_address: String!
  coin_type: String!
  amount: numeric!
  last_transaction_version: bigint
  last_transaction_timestamp: timestamp
}
```

#### current_token_ownerships_v2 è¡¨
```sql
CREATE TABLE current_token_ownerships_v2 (
    token_data_id VARCHAR,             -- Token æ•°æ® ID
    property_version_v1 NUMERIC,       -- å±æ€§ç‰ˆæœ¬
    owner_address VARCHAR,             -- æ‰€æœ‰è€…åœ°å€
    storage_id VARCHAR,                -- å­˜å‚¨ ID
    amount NUMERIC,                    -- æ•°é‡
    table_type_v1 VARCHAR,             -- è¡¨ç±»å‹
    token_properties_mutated_v1 JSONB, -- Token å±æ€§
    is_soulbound_v2 BOOLEAN,           -- æ˜¯å¦çµé­‚ç»‘å®š
    is_fungible_v2 BOOLEAN,            -- æ˜¯å¦å¯æ›¿ä»£
    last_transaction_version BIGINT,
    last_transaction_timestamp TIMESTAMP,
    inserted_at TIMESTAMP,
    
    PRIMARY KEY (token_data_id, property_version_v1, owner_address, storage_id)
);
```

### 3.2 è¡¨å…³ç³»

```
accounts (è´¦æˆ·)
    â†“ 1:N
account_transactions (è´¦æˆ·äº¤æ˜“å…³è”)
    â†“ N:1
transactions (äº¤æ˜“)
    â†“ 1:N
events (äº‹ä»¶)

accounts (è´¦æˆ·)
    â†“ 1:N
current_coin_balances (ä»£å¸ä½™é¢)

accounts (è´¦æˆ·)
    â†“ 1:N
current_token_ownerships_v2 (NFT æ‰€æœ‰æƒ)
```

### 3.3 å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

#### æŸ¥è¯¢è´¦æˆ·çš„æ‰€æœ‰ä»£å¸ä½™é¢
```graphql
query GetAccountCoins($address: String!) {
  current_coin_balances(
    where: {owner_address: {_eq: $address}}
  ) {
    coin_type
    amount
  }
}
```

#### æŸ¥è¯¢è´¦æˆ·çš„äº¤æ˜“å†å²
```graphql
query GetAccountTransactions($address: String!) {
  account_transactions(
    where: {account_address: {_eq: $address}},
    order_by: {transaction_version: desc},
    limit: 20
  ) {
    transaction_version
    user_transaction {
      sender
      success
      gas_used
      timestamp
      entry_function_id_str
    }
  }
}
```

#### æŸ¥è¯¢ç‰¹å®šäº‹ä»¶
```graphql
query GetSwapEvents {
  events(
    where: {
      type: {_eq: "0x1::swap::SwapEvent"}
    },
    order_by: {transaction_version: desc},
    limit: 10
  ) {
    transaction_version
    data
    sequence_number
  }
}
```

---

## 4. è®¢é˜…æœºåˆ¶åŸç†

### 4.1 è®¢é˜… vs è½®è¯¢

**è½®è¯¢ï¼ˆPollingï¼‰**ï¼š
```typescript
// æ¯ 5 ç§’æŸ¥è¯¢ä¸€æ¬¡
setInterval(async () => {
  const result = await client.query({
    query: GET_TRANSACTIONS
  });
  processTransactions(result.data.transactions);
}, 5000);
```

**ç¼ºç‚¹**ï¼š
- âŒ æµªè´¹å¸¦å®½ï¼ˆå¤§éƒ¨åˆ†è¯·æ±‚æ— æ–°æ•°æ®ï¼‰
- âŒ å»¶è¿Ÿé«˜ï¼ˆæœ€åæƒ…å†µæ¥è¿‘è½®è¯¢é—´éš”ï¼‰
- âŒ æœåŠ¡å™¨å‹åŠ›å¤§

**è®¢é˜…ï¼ˆSubscriptionï¼‰**ï¼š
```typescript
// å»ºç«‹ WebSocket è¿æ¥ï¼Œå®æ—¶æ¥æ”¶æ–°æ•°æ®
const subscription = client.subscribe({
  query: SUBSCRIBE_TRANSACTIONS
}).subscribe({
  next: (result) => {
    processTransactions(result.data.transactions);
  }
});
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶æ¨é€ï¼ˆå»¶è¿Ÿ < 1 ç§’ï¼‰
- âœ… èŠ‚çœå¸¦å®½ï¼ˆåªæ¨é€å˜åŒ–ï¼‰
- âœ… æœåŠ¡å™¨å‹å¥½ï¼ˆä¸€ä¸ªè¿æ¥ï¼‰

### 4.2 è®¢é˜…è¯­æ³•

```graphql
subscription NewTransactions {
  transactions(
    limit: 10,
    order_by: {version: desc}
  ) {
    version
    hash
    sender
    success
  }
}
```

### 4.3 WebSocket åè®®

**è¿æ¥å»ºç«‹**ï¼š
```
Client                          Server
  |                               |
  |-- WebSocket Handshake ------->|
  |<-- 101 Switching Protocols ---|
  |                               |
  |-- connection_init ----------->|
  |<-- connection_ack ------------|
  |                               |
  |-- subscribe ----------------->|
  |   (GraphQL subscription)      |
  |                               |
  |<-- next --------------------- |  (æ–°æ•°æ®æ¨é€)
  |<-- next --------------------- |
  |<-- next --------------------- |
  |                               |
  |-- complete ------------------>|  (å–æ¶ˆè®¢é˜…)
  |<-- complete ------------------ |
  |                               |
  |-- connection_terminate ------>|
  |                               |
  X                               X
```

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
// è®¢é˜…æ¶ˆæ¯
{
  "id": "1",
  "type": "subscribe",
  "payload": {
    "query": "subscription { ... }",
    "variables": {}
  }
}

// æ•°æ®æ¨é€
{
  "id": "1",
  "type": "next",
  "payload": {
    "data": {
      "transactions": [...]
    }
  }
}

// å®Œæˆ
{
  "id": "1",
  "type": "complete"
}
```

### 4.4 è®¢é˜…å®ç°ç¤ºä¾‹

```typescript
import { WebSocketLink } from '@apollo/client/link/ws';
import { ApolloClient, InMemoryCache } from '@apollo/client';

// åˆ›å»º WebSocket è¿æ¥
const wsLink = new WebSocketLink({
  uri: 'wss://indexer.mainnet.aptoslabs.com/v1/graphql',
  options: {
    reconnect: true,
    reconnectionAttempts: 5,
    connectionParams: {
      headers: {
        // å¯é€‰ï¼šæ·»åŠ è®¤è¯
      }
    }
  }
});

// åˆ›å»ºå®¢æˆ·ç«¯
const client = new ApolloClient({
  link: wsLink,
  cache: new InMemoryCache()
});

// è®¢é˜…
const subscription = client.subscribe({
  query: gql`
    subscription {
      transactions(limit: 1, order_by: {version: desc}) {
        version
        hash
      }
    }
  `
}).subscribe({
  next: (result) => {
    console.log('New transaction:', result.data);
  },
  error: (error) => {
    console.error('Subscription error:', error);
  },
  complete: () => {
    console.log('Subscription completed');
  }
});

// å–æ¶ˆè®¢é˜…
subscription.unsubscribe();
```

### 4.5 é”™è¯¯å¤„ç†å’Œé‡è¿

```typescript
class SubscriptionManager {
  private subscription: any;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 10;
  
  subscribe() {
    this.subscription = client.subscribe({
      query: SUBSCRIPTION_QUERY
    }).subscribe({
      next: this.handleData.bind(this),
      error: this.handleError.bind(this),
      complete: this.handleComplete.bind(this)
    });
  }
  
  handleError(error: any) {
    console.error('Subscription error:', error);
    
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++;
      const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
      
      console.log(`Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})...`);
      
      setTimeout(() => {
        this.subscribe();
      }, delay);
    } else {
      console.error('Max reconnection attempts reached');
    }
  }
  
  handleComplete() {
    console.log('Subscription completed');
    this.reconnectAttempts = 0;
  }
  
  handleData(result: any) {
    this.reconnectAttempts = 0;  // é‡ç½®é‡è¿è®¡æ•°
    // å¤„ç†æ•°æ®
  }
}
```

---

## 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 5.1 æŸ¥è¯¢ä¼˜åŒ–

#### åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
```graphql
# âŒ ä¸å¥½ï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
query {
  transactions {
    version
    hash
    sender
    sequence_number
    payload
    events
    changes
    # ... æ‰€æœ‰å­—æ®µ
  }
}

# âœ… å¥½ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
query {
  transactions {
    version
    sender
    success
  }
}
```

#### ä½¿ç”¨ç´¢å¼•å­—æ®µè¿‡æ»¤
```graphql
# âœ… å¥½ï¼šåœ¨ç´¢å¼•å­—æ®µä¸Šè¿‡æ»¤ï¼ˆå¿«ï¼‰
query {
  transactions(where: {
    version: {_eq: 12345}
  }) {
    hash
  }
}

# âŒ ä¸å¥½ï¼šåœ¨éç´¢å¼•å­—æ®µä¸Šè¿‡æ»¤ï¼ˆæ…¢ï¼‰
query {
  transactions(where: {
    payload: {_contains: "some_value"}
  }) {
    hash
  }
}
```

#### é™åˆ¶è¿”å›æ•°é‡
```graphql
# âœ… æ€»æ˜¯ä½¿ç”¨ limit
query {
  transactions(
    limit: 100,
    order_by: {version: desc}
  ) {
    version
  }
}
```

### 5.2 æ‰¹é‡æŸ¥è¯¢

```typescript
// âŒ ä¸å¥½ï¼šå¾ªç¯ä¸­æŸ¥è¯¢ï¼ˆN+1 é—®é¢˜ï¼‰
for (const address of addresses) {
  const balance = await getBalance(address);
}

// âœ… å¥½ï¼šæ‰¹é‡æŸ¥è¯¢
const balances = await getBatchBalances(addresses);
```

**GraphQL æ‰¹é‡æŸ¥è¯¢**ï¼š
```graphql
query GetMultipleAccountsBalance($addresses: [String!]!) {
  current_coin_balances(where: {
    owner_address: {_in: $addresses}
  }) {
    owner_address
    coin_type
    amount
  }
}
```

### 5.3 ç¼“å­˜ç­–ç•¥

#### å®¢æˆ·ç«¯ç¼“å­˜
```typescript
import { ApolloClient, InMemoryCache } from '@apollo/client';

const client = new ApolloClient({
  uri: 'https://indexer.mainnet.aptoslabs.com/v1/graphql',
  cache: new InMemoryCache({
    typePolicies: {
      transactions: {
        keyFields: ['version'],  // ä½¿ç”¨ version ä½œä¸ºå”¯ä¸€æ ‡è¯†
      },
      current_coin_balances: {
        keyFields: ['owner_address', 'coin_type'],
      }
    }
  })
});

// æŸ¥è¯¢æ—¶æŒ‡å®šç¼“å­˜ç­–ç•¥
const { data } = await client.query({
  query: GET_TRANSACTIONS,
  fetchPolicy: 'cache-first',  // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
});
```

#### æœ¬åœ°ç¼“å­˜
```typescript
class IndexerCache {
  private cache: Map<string, { data: any, timestamp: number }> = new Map();
  private ttl: number = 60000;  // 60 ç§’ TTL
  
  async get(key: string, fetcher: () => Promise<any>) {
    const cached = this.cache.get(key);
    
    if (cached && Date.now() - cached.timestamp < this.ttl) {
      return cached.data;  // è¿”å›ç¼“å­˜
    }
    
    const data = await fetcher();  // è·å–æ–°æ•°æ®
    this.cache.set(key, { data, timestamp: Date.now() });
    return data;
  }
}

// ä½¿ç”¨
const cache = new IndexerCache();
const balance = await cache.get(
  `balance:${address}`,
  () => fetchBalance(address)
);
```

### 5.4 è¿æ¥æ± ç®¡ç†

```typescript
import { ApolloClient, HttpLink } from '@apollo/client';
import fetch from 'cross-fetch';

const httpLink = new HttpLink({
  uri: 'https://indexer.mainnet.aptoslabs.com/v1/graphql',
  fetch,
  fetchOptions: {
    agent: new https.Agent({
      keepAlive: true,
      maxSockets: 50,  // è¿æ¥æ± å¤§å°
    })
  }
});

const client = new ApolloClient({
  link: httpLink,
  cache: new InMemoryCache()
});
```

### 5.5 æŸ¥è¯¢å¤æ‚åº¦æ§åˆ¶

```graphql
# âŒ ä¸å¥½ï¼šåµŒå¥—è¿‡æ·±
query {
  accounts {
    account_transactions {
      user_transaction {
        events {
          transaction {
            # åˆå›åˆ° transaction...
          }
        }
      }
    }
  }
}

# âœ… å¥½ï¼šæ‰å¹³åŒ–æŸ¥è¯¢
query {
  accounts(where: {address: {_eq: $addr}}) {
    address
  }
  
  account_transactions(where: {account_address: {_eq: $addr}}) {
    transaction_version
  }
}
```

### 5.6 åˆ†é¡µæœ€ä½³å®è·µ

#### æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰
```typescript
async function fetchAllTransactions() {
  let cursor = Number.MAX_SAFE_INTEGER;
  let hasMore = true;
  const allTransactions = [];
  
  while (hasMore) {
    const { data } = await client.query({
      query: gql`
        query GetTransactions($cursor: bigint!, $limit: Int!) {
          transactions(
            where: { version: { _lt: $cursor } },
            limit: $limit,
            order_by: { version: desc }
          ) {
            version
            hash
          }
        }
      `,
      variables: { cursor, limit: 1000 }
    });
    
    if (data.transactions.length === 0) {
      hasMore = false;
    } else {
      allTransactions.push(...data.transactions);
      cursor = data.transactions[data.transactions.length - 1].version;
    }
  }
  
  return allTransactions;
}
```

### 5.7 æ€§èƒ½ç›‘æ§

```typescript
class QueryPerformanceMonitor {
  async execute(query: string, variables: any) {
    const startTime = Date.now();
    
    try {
      const result = await client.query({ query, variables });
      const duration = Date.now() - startTime;
      
      console.log(`Query executed in ${duration}ms`);
      
      if (duration > 5000) {
        console.warn('Slow query detected:', { query, duration });
      }
      
      return result;
    } catch (error) {
      const duration = Date.now() - startTime;
      console.error(`Query failed after ${duration}ms:`, error);
      throw error;
    }
  }
}
```

---

## ğŸ“Š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **Indexer æ¶æ„**
   - æ•°æ®ä» Fullnode â†’ TSS â†’ Processor â†’ Database â†’ GraphQL
   - å¤šä¸ªä¸“é—¨çš„ Processor å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®
   - å»¶è¿Ÿé€šå¸¸åœ¨ 400-500ms

2. **GraphQL æŸ¥è¯¢**
   - åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
   - ä½¿ç”¨å˜é‡å’Œç‰‡æ®µ
   - åˆç†ä½¿ç”¨è¿‡æ»¤å’Œæ’åº
   - æ€»æ˜¯æ·»åŠ  limit

3. **è®¢é˜…æœºåˆ¶**
   - åŸºäº WebSocket çš„å®æ—¶æ¨é€
   - å¤„ç†æ–­çº¿é‡è¿
   - é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯

4. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨ç´¢å¼•å­—æ®µè¿‡æ»¤
   - æ‰¹é‡æŸ¥è¯¢
   - ç¼“å­˜ç­–ç•¥
   - æ¸¸æ ‡åˆ†é¡µ

### æœ€ä½³å®è·µæ¸…å•

- âœ… ä½¿ç”¨ TypeScript ç”Ÿæˆç±»å‹å®šä¹‰
- âœ… å®ç°æŸ¥è¯¢é‡è¯•æœºåˆ¶
- âœ… ç›‘æ§æŸ¥è¯¢æ€§èƒ½
- âœ… ä½¿ç”¨è¿æ¥æ± 
- âœ… å®ç°æœ¬åœ°ç¼“å­˜
- âœ… å¤„ç† API é€Ÿç‡é™åˆ¶
- âœ… è®°å½•é”™è¯¯æ—¥å¿—
- âœ… å®šæœŸæ¸…ç†ç¼“å­˜

---

**ä¸‹ä¸€æ­¥**: å®Œæˆå®è·µä»»åŠ¡ï¼Œæ„å»ºè‡ªå·±çš„æ•°æ®æŸ¥è¯¢å·¥å…·ï¼
