# Day 27 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

**è€ƒè¯•æ—¶é—´**ï¼š30åˆ†é’Ÿ  
**é¢˜ç›®æ•°é‡**ï¼š3é¢˜  
**æ€»åˆ†**ï¼š60åˆ†

**è¯´æ˜**ï¼šå®ç°ä»¥ä¸‹å‡½æ•°ï¼Œç¡®ä¿ä»£ç å¯ä»¥ç¼–è¯‘å¹¶é€šè¿‡æµ‹è¯•ã€‚

---

## ç¼–ç¨‹é¢˜ 1ï¼šäº¤æ˜“éªŒè¯å™¨ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªäº¤æ˜“éªŒè¯å‡½æ•°ï¼Œæ£€æŸ¥äº¤æ˜“æ˜¯å¦æ»¡è¶³æ‰€æœ‰åŸºæœ¬è¦æ±‚ã€‚

### è¦æ±‚

```move
module exam::transaction_validator {
    use aptos_framework::timestamp;
    
    /// äº¤æ˜“æ•°æ®ç»“æ„
    struct Transaction has drop {
        sender: address,
        sequence_number: u64,
        max_gas_amount: u64,
        gas_unit_price: u64,
        expiration_timestamp_secs: u64,
        chain_id: u8,
    }
    
    // å¸¸é‡å®šä¹‰
    const MAINNET_CHAIN_ID: u8 = 1;
    const MAX_GAS_LIMIT: u64 = 2_000_000;
    const MIN_GAS_PRICE: u64 = 100;
    
    const ERROR_INVALID_GAS_AMOUNT: u64 = 1;
    const ERROR_INVALID_GAS_PRICE: u64 = 2;
    const ERROR_EXPIRED: u64 = 3;
    const ERROR_INVALID_CHAIN_ID: u64 = 4;
    const ERROR_INVALID_SEQUENCE: u64 = 5;
    
    /// TODO: å®ç°äº¤æ˜“éªŒè¯å‡½æ•°
    /// 
    /// éªŒè¯è§„åˆ™ï¼š
    /// 1. max_gas_amount å¿…é¡» > 0 ä¸” <= MAX_GAS_LIMIT
    /// 2. gas_unit_price å¿…é¡» >= MIN_GAS_PRICE
    /// 3. expiration_timestamp_secs å¿…é¡» > å½“å‰æ—¶é—´
    /// 4. chain_id å¿…é¡» = MAINNET_CHAIN_ID
    /// 5. sequence_number å¿…é¡» > 0
    /// 
    /// è¿”å›ï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡è¿”å› trueï¼Œå¦åˆ™ abort å¯¹åº”é”™è¯¯ç 
    public fun validate_transaction(txn: &Transaction): bool {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        abort 0 // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: è®¡ç®—äº¤æ˜“çš„æœ€å¤§è´¹ç”¨ï¼ˆOctasï¼‰
    public fun calculate_max_fee(txn: &Transaction): u64 {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        0 // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test]
public fun test_valid_transaction() {
    let txn = Transaction {
        sender: @0x1,
        sequence_number: 1,
        max_gas_amount: 100_000,
        gas_unit_price: 100,
        expiration_timestamp_secs: timestamp::now_seconds() + 600,
        chain_id: 1,
    };
    assert!(validate_transaction(&txn), 0);
}

#[test]
#[expected_failure(abort_code = ERROR_INVALID_GAS_AMOUNT)]
public fun test_invalid_gas_amount() {
    let txn = Transaction {
        sender: @0x1,
        sequence_number: 1,
        max_gas_amount: 0, // æ— æ•ˆ
        gas_unit_price: 100,
        expiration_timestamp_secs: timestamp::now_seconds() + 600,
        chain_id: 1,
    };
    validate_transaction(&txn);
}

#[test]
public fun test_calculate_fee() {
    let txn = Transaction {
        sender: @0x1,
        sequence_number: 1,
        max_gas_amount: 100_000,
        gas_unit_price: 200,
        expiration_timestamp_secs: timestamp::now_seconds() + 600,
        chain_id: 1,
    };
    let fee = calculate_max_fee(&txn);
    assert!(fee == 20_000_000, 0);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ20åˆ†ï¼‰

- æ­£ç¡®å®ç°æ‰€æœ‰5ä¸ªéªŒè¯è§„åˆ™ï¼ˆ12åˆ†ï¼‰
- æ­£ç¡®è®¡ç®—æœ€å¤§è´¹ç”¨ï¼ˆ4åˆ†ï¼‰
- ä»£ç é£æ ¼å’Œå¯è¯»æ€§ï¼ˆ4åˆ†ï¼‰

---

## ç¼–ç¨‹é¢˜ 2ï¼šäº‹ä»¶è¿‡æ»¤å™¨ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªçµæ´»çš„äº‹ä»¶è¿‡æ»¤ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ¡ä»¶ç»„åˆè¿‡æ»¤ã€‚

### è¦æ±‚

```move
module exam::event_filter {
    use std::vector;
    use std::string::{Self, String};
    use std::option::{Self, Option};
    
    /// äº‹ä»¶æ•°æ®
    struct EventData has drop, copy {
        sequence_number: u64,
        event_type: String,
        data_length: u64,
    }
    
    /// è¿‡æ»¤å™¨
    struct EventFilter has drop {
        type_filter: Option<String>,
        min_sequence: Option<u64>,
        max_sequence: Option<u64>,
        min_data_length: Option<u64>,
    }
    
    /// TODO: åˆ›å»ºäº‹ä»¶æ•°æ®
    public fun create_event(
        sequence_number: u64,
        event_type: vector<u8>,
        data_length: u64,
    ): EventData {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        EventData {
            sequence_number: 0,
            event_type: string::utf8(b""),
            data_length: 0,
        } // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: åˆ›å»ºè¿‡æ»¤å™¨
    public fun create_filter(
        type_filter: Option<String>,
        min_sequence: Option<u64>,
        max_sequence: Option<u64>,
        min_data_length: Option<u64>,
    ): EventFilter {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        EventFilter {
            type_filter: option::none(),
            min_sequence: option::none(),
            max_sequence: option::none(),
            min_data_length: option::none(),
        } // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: æ£€æŸ¥äº‹ä»¶æ˜¯å¦åŒ¹é…è¿‡æ»¤å™¨
    /// 
    /// åŒ¹é…è§„åˆ™ï¼š
    /// - å¦‚æœ type_filter å­˜åœ¨ï¼Œevent_type å¿…é¡»åŒ¹é…
    /// - å¦‚æœ min_sequence å­˜åœ¨ï¼Œsequence_number å¿…é¡» >= min_sequence
    /// - å¦‚æœ max_sequence å­˜åœ¨ï¼Œsequence_number å¿…é¡» <= max_sequence
    /// - å¦‚æœ min_data_length å­˜åœ¨ï¼Œdata_length å¿…é¡» >= min_data_length
    /// - æ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³æ‰è¿”å› true
    public fun matches(event: &EventData, filter: &EventFilter): bool {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        false // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: åº”ç”¨è¿‡æ»¤å™¨åˆ°äº‹ä»¶åˆ—è¡¨
    public fun apply_filter(
        events: &vector<EventData>,
        filter: &EventFilter,
    ): vector<EventData> {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        vector::empty<EventData>() // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test]
public fun test_event_filtering() {
    use std::string;
    use std::option;
    
    let events = vector::empty<EventData>();
    vector::push_back(&mut events, create_event(0, b"SwapEvent", 64));
    vector::push_back(&mut events, create_event(1, b"TransferEvent", 32));
    vector::push_back(&mut events, create_event(2, b"SwapEvent", 128));
    
    // è¿‡æ»¤ SwapEvent
    let filter = create_filter(
        option::some(string::utf8(b"SwapEvent")),
        option::none(),
        option::none(),
        option::none(),
    );
    let filtered = apply_filter(&events, &filter);
    assert!(vector::length(&filtered) == 2, 0);
    
    // è¿‡æ»¤ sequence >= 1
    let filter2 = create_filter(
        option::none(),
        option::some(1),
        option::none(),
        option::none(),
    );
    let filtered2 = apply_filter(&events, &filter2);
    assert!(vector::length(&filtered2) == 2, 1);
    
    // ç»„åˆè¿‡æ»¤
    let filter3 = create_filter(
        option::some(string::utf8(b"SwapEvent")),
        option::some(1),
        option::none(),
        option::none(),
    );
    let filtered3 = apply_filter(&events, &filter3);
    assert!(vector::length(&filtered3) == 1, 2);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ20åˆ†ï¼‰

- æ­£ç¡®åˆ›å»ºäº‹ä»¶å’Œè¿‡æ»¤å™¨ï¼ˆ4åˆ†ï¼‰
- æ­£ç¡®å®ç°åŒ¹é…é€»è¾‘ï¼ˆ8åˆ†ï¼‰
- æ­£ç¡®åº”ç”¨è¿‡æ»¤å™¨ï¼ˆ4åˆ†ï¼‰
- ä»£ç è´¨é‡ï¼ˆ4åˆ†ï¼‰

---

## ç¼–ç¨‹é¢˜ 3ï¼šäº¤æ˜“åˆ†æå™¨ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°äº¤æ˜“ç»Ÿè®¡åˆ†æåŠŸèƒ½ï¼Œè®¡ç®—å¹³å‡ gasã€æˆåŠŸç‡ç­‰æŒ‡æ ‡ã€‚

### è¦æ±‚

```move
module exam::transaction_analyzer {
    use std::vector;
    use std::string::String;
    use std::option::{Self, Option};
    
    struct TransactionSummary has drop, copy {
        sender: address,
        gas_used: u64,
        success: bool,
    }
    
    /// TODO: è®¡ç®—å¹³å‡ gas ä½¿ç”¨é‡
    /// 
    /// æ³¨æ„ï¼š
    /// - å¤„ç†ç©ºå‘é‡çš„æƒ…å†µï¼ˆè¿”å› 0ï¼‰
    /// - ä½¿ç”¨ u128 é¿å…æº¢å‡º
    public fun calculate_average_gas(
        summaries: &vector<TransactionSummary>
    ): u64 {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        0 // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: è®¡ç®—æˆåŠŸç‡ï¼ˆç™¾åˆ†æ¯”ï¼Œ0-100ï¼‰
    /// 
    /// æ³¨æ„ï¼š
    /// - å¤„ç†ç©ºå‘é‡çš„æƒ…å†µï¼ˆè¿”å› 0ï¼‰
    /// - è¿”å›å€¼èŒƒå›´ï¼š0 åˆ° 100
    public fun calculate_success_rate(
        summaries: &vector<TransactionSummary>
    ): u64 {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        0 // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: æŸ¥æ‰¾æœ€é«˜ gas ä½¿ç”¨çš„äº¤æ˜“
    /// 
    /// æ³¨æ„ï¼š
    /// - ç©ºå‘é‡è¿”å› None
    /// - è¿”å› gas æœ€é«˜çš„äº¤æ˜“
    public fun find_highest_gas_transaction(
        summaries: &vector<TransactionSummary>
    ): Option<TransactionSummary> {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        option::none() // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
    
    /// TODO: ç»Ÿè®¡ç‰¹å®šå‘é€è€…çš„äº¤æ˜“æ•°é‡
    public fun count_transactions_from_sender(
        summaries: &vector<TransactionSummary>,
        sender: address,
    ): u64 {
        // åœ¨è¿™é‡Œå®ç°ä½ çš„ä»£ç 
        
        0 // åˆ é™¤è¿™ä¸€è¡Œï¼Œå®ç°ä½ çš„é€»è¾‘
    }
}
```

### æµ‹è¯•ç”¨ä¾‹

```move
#[test]
public fun test_transaction_analysis() {
    let summaries = vector::empty<TransactionSummary>();
    
    vector::push_back(&mut summaries, TransactionSummary {
        sender: @0x1,
        gas_used: 1000,
        success: true,
    });
    vector::push_back(&mut summaries, TransactionSummary {
        sender: @0x2,
        gas_used: 2000,
        success: true,
    });
    vector::push_back(&mut summaries, TransactionSummary {
        sender: @0x1,
        gas_used: 1500,
        success: false,
    });
    
    // æµ‹è¯•å¹³å‡ gas
    let avg = calculate_average_gas(&summaries);
    assert!(avg == 1500, 0);
    
    // æµ‹è¯•æˆåŠŸç‡
    let rate = calculate_success_rate(&summaries);
    assert!(rate == 66, 1); // 2/3 â‰ˆ 66%
    
    // æµ‹è¯•æœ€é«˜ gas
    let highest = find_highest_gas_transaction(&summaries);
    assert!(option::is_some(&highest), 2);
    let txn = option::borrow(&highest);
    assert!(txn.gas_used == 2000, 3);
    
    // æµ‹è¯•å‘é€è€…ç»Ÿè®¡
    let count = count_transactions_from_sender(&summaries, @0x1);
    assert!(count == 2, 4);
}

#[test]
public fun test_empty_summaries() {
    let summaries = vector::empty<TransactionSummary>();
    
    assert!(calculate_average_gas(&summaries) == 0, 0);
    assert!(calculate_success_rate(&summaries) == 0, 1);
    assert!(option::is_none(&find_highest_gas_transaction(&summaries)), 2);
}
```

### è¯„åˆ†æ ‡å‡†ï¼ˆ20åˆ†ï¼‰

- æ­£ç¡®è®¡ç®—å¹³å‡ gasï¼ˆ5åˆ†ï¼‰
- æ­£ç¡®è®¡ç®—æˆåŠŸç‡ï¼ˆ5åˆ†ï¼‰
- æ­£ç¡®æŸ¥æ‰¾æœ€é«˜ gas äº¤æ˜“ï¼ˆ5åˆ†ï¼‰
- æ­£ç¡®ç»Ÿè®¡å‘é€è€…äº¤æ˜“ï¼ˆ3åˆ†ï¼‰
- æ­£ç¡®å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆ2åˆ†ï¼‰

---

## ğŸ“ æäº¤è¯´æ˜

1. å°†ä½ çš„ç­”æ¡ˆä¿å­˜ä¸ºç‹¬ç«‹çš„ `.move` æ–‡ä»¶
2. ç¡®ä¿ä»£ç å¯ä»¥ç¼–è¯‘ï¼š`aptos move compile`
3. è¿è¡Œæµ‹è¯•ï¼š`aptos move test`
4. æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æäº¤

---

## ğŸ¯ è¯„åˆ†æ€»ç»“

| é¢˜ç›® | åˆ†å€¼ | å¾—åˆ† |
|------|------|------|
| ç¼–ç¨‹é¢˜ 1 | 20åˆ† | ____ |
| ç¼–ç¨‹é¢˜ 2 | 20åˆ† | ____ |
| ç¼–ç¨‹é¢˜ 3 | 20åˆ† | ____ |
| **æ€»è®¡** | **60åˆ†** | ____ |

**åŠæ ¼çº¿**ï¼š42åˆ†ï¼ˆ70%ï¼‰

---

**å®Œæˆåï¼Œè¯·æŸ¥çœ‹ `ç­”æ¡ˆè§£æ.md` æ–‡ä»¶æŸ¥çœ‹å‚è€ƒç­”æ¡ˆã€‚**

**å»ºè®®ç”¨æ—¶**ï¼š30åˆ†é’Ÿ
**éš¾åº¦**ï¼šâ­â­â­ ä¸­ç­‰
