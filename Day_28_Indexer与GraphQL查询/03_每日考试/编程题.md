# Day 28 æ¯æ—¥è€ƒè¯• - ç¼–ç¨‹é¢˜

**è€ƒè¯•æ—¶é—´**: 30 åˆ†é’Ÿ  
**æ€»åˆ†**: 60 åˆ†  
**åŠæ ¼åˆ†æ•°**: 42 åˆ†

---

## ğŸ“ ç­”é¢˜è¯´æ˜

- è¯·ç‹¬ç«‹å®Œæˆç¼–ç¨‹é¢˜
- ä»£ç éœ€è¦èƒ½å¤Ÿè¿è¡Œå¹¶äº§ç”Ÿæ­£ç¡®ç»“æœ
- æ³¨é‡ä»£ç è´¨é‡å’Œé”™è¯¯å¤„ç†
- å®Œæˆåå¯¹ç…§ç­”æ¡ˆè§£ææ–‡ä»¶æ£€æŸ¥

---

## ç¼–ç¨‹é¢˜ 1ï¼šå®ç° GraphQL æŸ¥è¯¢å‡½æ•°ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå‡½æ•° `getAccountTransactions`ï¼Œç”¨äºæŸ¥è¯¢æŒ‡å®šè´¦æˆ·çš„äº¤æ˜“å†å²ã€‚

### è¦æ±‚

1. ä½¿ç”¨ GraphQL æŸ¥è¯¢ Aptos Indexer
2. æ”¯æŒåˆ†é¡µï¼ˆlimit å’Œ offsetï¼‰
3. æ”¯æŒæŒ‰æ—¶é—´æ’åºï¼ˆé™åºï¼‰
4. è¿”å›æ ¼å¼åŒ–çš„äº¤æ˜“æ•°æ®
5. å®ç°é”™è¯¯å¤„ç†

### å‡½æ•°ç­¾å

```typescript
interface Transaction {
  version: string;
  hash: string;
  sender: string;
  success: boolean;
  gasUsed: number;
  timestamp: string;
  functionCalled?: string;
}

async function getAccountTransactions(
  endpoint: string,
  accountAddress: string,
  limit: number = 10,
  offset: number = 0
): Promise<Transaction[]> {
  // TODO: ä½ çš„å®ç°
}
```

### æµ‹è¯•ç”¨ä¾‹

```typescript
// æµ‹è¯•
const transactions = await getAccountTransactions(
  'https://indexer.testnet.aptoslabs.com/v1/graphql',
  '0x1',
  5,
  0
);

console.log(transactions);
// é¢„æœŸè¾“å‡ºï¼šåŒ…å« 5 æ¡äº¤æ˜“è®°å½•çš„æ•°ç»„
```

### è¯„åˆ†æ ‡å‡†

- GraphQL æŸ¥è¯¢æ­£ç¡®æ€§ï¼š8åˆ†
- æ•°æ®æ ¼å¼åŒ–ï¼š4åˆ†
- é”™è¯¯å¤„ç†ï¼š4åˆ†
- ä»£ç è´¨é‡ï¼š4åˆ†

---

## ç¼–ç¨‹é¢˜ 2ï¼šå®ç°äº‹ä»¶è¿‡æ»¤å™¨ï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ª `EventFilter` ç±»ï¼Œèƒ½å¤Ÿè®¢é˜…å¹¶è¿‡æ»¤ç‰¹å®šç±»å‹çš„äº‹ä»¶ã€‚

### è¦æ±‚

1. ä½¿ç”¨ WebSocket è®¢é˜…äº‹ä»¶
2. æ”¯æŒæŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤
3. æ”¯æŒæŒ‰é‡‘é¢èŒƒå›´è¿‡æ»¤ï¼ˆå¯¹äºåŒ…å« amount å­—æ®µçš„äº‹ä»¶ï¼‰
4. å®ç°äº‹ä»¶å¤„ç†å›è°ƒ
5. å®ç°æ–­çº¿é‡è¿

### ç±»å®šä¹‰

```typescript
interface Event {
  transaction_version: string;
  type: string;
  data: any;
  sequence_number: string;
}

interface FilterOptions {
  eventTypes: string[];
  minAmount?: number;
  maxAmount?: number;
}

class EventFilter {
  constructor(
    private wsEndpoint: string,
    private options: FilterOptions
  ) {
    // TODO: åˆå§‹åŒ–
  }

  // å¼€å§‹ç›‘å¬
  start(callback: (event: Event) => void): void {
    // TODO: å®ç°è®¢é˜…é€»è¾‘
  }

  // åœæ­¢ç›‘å¬
  stop(): void {
    // TODO: æ¸…ç†èµ„æº
  }

  // æ£€æŸ¥äº‹ä»¶æ˜¯å¦åŒ¹é…è¿‡æ»¤æ¡ä»¶
  private matches(event: Event): boolean {
    // TODO: å®ç°è¿‡æ»¤é€»è¾‘
  }
}
```

### ä½¿ç”¨ç¤ºä¾‹

```typescript
const filter = new EventFilter(
  'wss://indexer.testnet.aptoslabs.com/v1/graphql',
  {
    eventTypes: ['0x1::coin::WithdrawEvent'],
    minAmount: 1000000  // åªå…³æ³¨å¤§é¢ææ¬¾
  }
);

filter.start((event) => {
  console.log('æ£€æµ‹åˆ°å¤§é¢ææ¬¾:', event);
});

// 5åˆ†é’Ÿååœæ­¢
setTimeout(() => filter.stop(), 5 * 60 * 1000);
```

### è¯„åˆ†æ ‡å‡†

- WebSocket è¿æ¥ï¼š6åˆ†
- äº‹ä»¶è¿‡æ»¤é€»è¾‘ï¼š6åˆ†
- é‡è¿æœºåˆ¶ï¼š4åˆ†
- ä»£ç è´¨é‡ï¼š4åˆ†

---

## ç¼–ç¨‹é¢˜ 3ï¼šæ•°æ®ç»Ÿè®¡åˆ†æï¼ˆ20åˆ†ï¼‰

### é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªå‡½æ•° `analyzeTransactionPatterns`ï¼Œåˆ†æè´¦æˆ·çš„äº¤æ˜“æ¨¡å¼å¹¶ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šã€‚

### è¦æ±‚

1. æŸ¥è¯¢è´¦æˆ·çš„æœ€è¿‘ N ç¬”äº¤æ˜“
2. è®¡ç®—ä»¥ä¸‹ç»Ÿè®¡æ•°æ®ï¼š
   - æ€»äº¤æ˜“æ•°
   - æˆåŠŸç‡
   - å¹³å‡ Gas ä½¿ç”¨é‡
   - æœ€å¸¸è°ƒç”¨çš„ 5 ä¸ªå‡½æ•°
   - äº¤æ˜“æ—¶é—´åˆ†å¸ƒï¼ˆæŒ‰å°æ—¶ï¼‰
3. è¿”å›ç»“æ„åŒ–çš„åˆ†æç»“æœ

### å‡½æ•°ç­¾å

```typescript
interface TransactionPattern {
  totalTransactions: number;
  successRate: number;  // ç™¾åˆ†æ¯”
  averageGas: number;
  topFunctions: Array<{
    function: string;
    count: number;
    percentage: number;
  }>;
  hourlyDistribution: Record<number, number>;  // hour -> count
}

async function analyzeTransactionPatterns(
  endpoint: string,
  accountAddress: string,
  transactionCount: number = 100
): Promise<TransactionPattern> {
  // TODO: ä½ çš„å®ç°
}
```

### æµ‹è¯•ç”¨ä¾‹

```typescript
const analysis = await analyzeTransactionPatterns(
  'https://indexer.testnet.aptoslabs.com/v1/graphql',
  '0x1',
  50
);

console.log(analysis);
/* é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š
{
  totalTransactions: 50,
  successRate: 96.0,
  averageGas: 523,
  topFunctions: [
    { function: '0x1::coin::transfer', count: 25, percentage: 50.0 },
    { function: '0x1::aptos_account::create_account', count: 10, percentage: 20.0 },
    ...
  ],
  hourlyDistribution: {
    0: 2,
    1: 1,
    14: 5,
    ...
  }
}
*/
```

### è¯„åˆ†æ ‡å‡†

- æ•°æ®æŸ¥è¯¢ï¼š5åˆ†
- ç»Ÿè®¡è®¡ç®—å‡†ç¡®æ€§ï¼š8åˆ†
- æ•°æ®ç»“æ„è®¾è®¡ï¼š4åˆ†
- ä»£ç è´¨é‡ï¼š3åˆ†

---

## ğŸ’¡ æç¤º

### GraphQL æŸ¥è¯¢ç¤ºä¾‹

```graphql
query GetAccountTransactions($address: String!, $limit: Int!, $offset: Int!) {
  account_transactions(
    where: {account_address: {_eq: $address}}
    limit: $limit
    offset: $offset
    order_by: {transaction_version: desc}
  ) {
    transaction_version
    user_transaction {
      hash
      sender
      success
      gas_used
      timestamp
      entry_function_id_str
    }
  }
}
```

### WebSocket è®¢é˜…ç¤ºä¾‹

```typescript
import { ApolloClient, InMemoryCache, gql } from '@apollo/client';
import { WebSocketLink } from '@apollo/client/link/ws';

const wsLink = new WebSocketLink({
  uri: wsEndpoint,
  options: {
    reconnect: true
  }
});

const client = new ApolloClient({
  link: wsLink,
  cache: new InMemoryCache()
});

const subscription = client.subscribe({
  query: gql`
    subscription {
      events(limit: 1, order_by: {transaction_version: desc}) {
        type
        data
      }
    }
  `
});
```

### æ—¶é—´å¤„ç†ç¤ºä¾‹

```typescript
// ä»æ—¶é—´æˆ³æå–å°æ—¶
const hour = new Date(timestamp).getHours();

// æ—¶é—´åˆ†å¸ƒç»Ÿè®¡
const distribution: Record<number, number> = {};
for (const tx of transactions) {
  const hour = new Date(tx.timestamp).getHours();
  distribution[hour] = (distribution[hour] || 0) + 1;
}
```

---

## ğŸ“¦ ä¾èµ–å®‰è£…

```bash
npm install @apollo/client graphql subscriptions-transport-ws ws
npm install --save-dev @types/ws
```

---

**å®Œæˆåè¯·æ£€æŸ¥ä»£ç æ˜¯å¦èƒ½æ­£ç¡®è¿è¡Œï¼Œç„¶åæŸ¥çœ‹ç­”æ¡ˆè§£æï¼**
