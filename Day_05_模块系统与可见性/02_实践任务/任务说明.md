# Day 05: æ¨¡å—ç³»ç»Ÿä¸å¯è§æ€§ - å®è·µä»»åŠ¡

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

é€šè¿‡å®Œæˆä»¥ä¸‹å®è·µä»»åŠ¡ï¼ŒæŒæ¡ï¼š
1. æ¨¡å—çš„å®šä¹‰å’Œç»„ç»‡
2. ä¸åŒå¯è§æ€§çº§åˆ«çš„ä½¿ç”¨
3. æ¨¡å—é—´çš„ä¾èµ–å…³ç³»
4. å‹å…ƒæœºåˆ¶çš„å®é™…åº”ç”¨
5. å¤šæ¨¡å—é¡¹ç›®çš„æ¶æ„è®¾è®¡

---

## ğŸ“‹ ä»»åŠ¡æ¸…å•

### âœ… ä»»åŠ¡ 1ï¼šå›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿï¼ˆåŸºç¡€ï¼‰

**éš¾åº¦**: â­â­  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
åˆ›å»ºä¸€ä¸ªç®€å•çš„å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«ä¸¤ä¸ªæ¨¡å—ï¼š
- `library_core`: æ ¸å¿ƒæ•°æ®ç»“æ„
- `library_service`: ä¸šåŠ¡é€»è¾‘

#### å…·ä½“è¦æ±‚

1. **library_core æ¨¡å—**ï¼ˆ`sources/library_core.move`ï¼‰
   - å®šä¹‰ `Book` ç»“æ„ä½“ï¼ˆå…¬å…±ï¼‰
     - `id: u64`
     - `title: vector<u8>`
     - `available: bool`
   - å®šä¹‰ `Library` èµ„æºï¼ˆå…¬å…±ï¼‰
     - `books: vector<Book>`
   - æä¾›å…¬å…±æ„é€ å‡½æ•° `create_book`
   - æä¾›å…¬å…±è®¿é—®å™¨å‡½æ•° `is_available`

2. **library_service æ¨¡å—**ï¼ˆ`sources/library_service.move`ï¼‰
   - ä¾èµ– `library_core`
   - å®ç° `initialize_library` (entry)ï¼šåˆ›å»ºå›¾ä¹¦é¦†
   - å®ç° `add_book` (entry)ï¼šæ·»åŠ å›¾ä¹¦
   - å®ç° `borrow_book` (public entry)ï¼šå€Ÿä¹¦ï¼ˆä¿®æ”¹ available ä¸º falseï¼‰
   - å®ç° `return_book` (public entry)ï¼šè¿˜ä¹¦ï¼ˆä¿®æ”¹ available ä¸º trueï¼‰

#### æˆåŠŸæ ‡å‡†
- [ ] ä¸¤ä¸ªæ¨¡å—éƒ½èƒ½ç¼–è¯‘é€šè¿‡
- [ ] æ­£ç¡®ä½¿ç”¨ publicã€entry ä¿®é¥°ç¬¦
- [ ] library_service æ­£ç¡®å¯¼å…¥ library_core
- [ ] å¯ä»¥é€šè¿‡äº¤æ˜“è°ƒç”¨ entry å‡½æ•°

#### ç¤ºä¾‹ä»£ç æ¡†æ¶

```move
module my_addr::library_core {
    public struct Book has store, drop {
        // TODO: æ·»åŠ å­—æ®µ
    }
    
    public struct Library has key {
        // TODO: æ·»åŠ å­—æ®µ
    }
    
    public fun create_book(/* å‚æ•° */): Book {
        // TODO: å®ç°
    }
}
```

---

### âœ… ä»»åŠ¡ 2ï¼šæƒé™ç®¡ç†ç³»ç»Ÿï¼ˆä¸­çº§ï¼‰

**éš¾åº¦**: â­â­â­  
**é¢„è®¡æ—¶é—´**: 45 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
å®ç°ä¸€ä¸ªåŸºäºè§’è‰²çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼Œä½¿ç”¨å‹å…ƒæœºåˆ¶ä¿æŠ¤æ•æ„Ÿæ“ä½œã€‚

#### å…·ä½“è¦æ±‚

1. **permission_core æ¨¡å—**
   - å®šä¹‰ `Role` æšä¸¾ï¼ˆä½¿ç”¨ u8 è¡¨ç¤ºï¼‰ï¼šAdmin=1, Moderator=2, User=3
   - å®šä¹‰ `Account` èµ„æº
     - `role: u8`
     - `permissions: vector<u8>`
   - å£°æ˜ `permission_admin` ä¸ºå‹å…ƒ
   - å®ç° `register_account` (public entry)ï¼šæ³¨å†Œæ™®é€šç”¨æˆ·
   - å®ç° `promote_user` (public(friend))ï¼šæå‡æƒé™
   - å®ç° `has_permission` (public)ï¼šæ£€æŸ¥æƒé™

2. **permission_admin æ¨¡å—**
   - å®šä¹‰ `AdminCap` èƒ½åŠ›ï¼ˆè¯æ˜ç®¡ç†å‘˜èº«ä»½ï¼‰
   - å®ç° `initialize_admin` (entry)ï¼šåˆå§‹åŒ–ç®¡ç†å‘˜
   - å®ç° `grant_role` (entry)ï¼šæˆäºˆè§’è‰²ï¼ˆè°ƒç”¨å‹å…ƒå‡½æ•°ï¼‰
   - å®ç° `revoke_role` (entry)ï¼šæ’¤é”€è§’è‰²

#### æˆåŠŸæ ‡å‡†
- [ ] æ­£ç¡®ä½¿ç”¨ friend å£°æ˜
- [ ] å‹å…ƒå‡½æ•°åªèƒ½è¢«æˆæƒæ¨¡å—è°ƒç”¨
- [ ] ç®¡ç†å‘˜éªŒè¯é€»è¾‘æ­£ç¡®
- [ ] æƒé™æ£€æŸ¥åŠŸèƒ½å®Œæ•´

---

### âœ… ä»»åŠ¡ 3ï¼šå¤šå±‚æ¶æ„ DeFi é¡¹ç›®ï¼ˆé«˜çº§ï¼‰

**éš¾åº¦**: â­â­â­â­  
**é¢„è®¡æ—¶é—´**: 60-90 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
è®¾è®¡å¹¶å®ç°ä¸€ä¸ªç®€åŒ–çš„ DeFi å€Ÿè´·åè®®ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„ã€‚

#### æ¨¡å—ç»“æ„

```
lending_protocol/
â”œâ”€â”€ sources/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ tokens.move          # æ ¸å¿ƒä»£å¸ç±»å‹
â”‚   â”‚   â””â”€â”€ storage.move         # å­˜å‚¨ç»“æ„
â”‚   â”œâ”€â”€ logic/
â”‚   â”‚   â”œâ”€â”€ interest.move        # åˆ©æ¯è®¡ç®—
â”‚   â”‚   â””â”€â”€ collateral.move      # æŠµæŠ¼å“ç®¡ç†
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ lend.move            # å€Ÿå‡º API
â”‚       â””â”€â”€ borrow.move          # å€Ÿå…¥ API
```

#### å…·ä½“è¦æ±‚

**ç¬¬ 1 å±‚ï¼šCoreï¼ˆæ ¸å¿ƒå±‚ï¼‰**

1. `tokens.move`
   ```move
   module lending::tokens {
       public struct LToken has store { amount: u64 }
       public struct BToken has store { amount: u64 }
       
       public fun mint_ltoken(amount: u64): LToken { }
       public fun burn_ltoken(token: LToken): u64 { }
   }
   ```

2. `storage.move`
   ```move
   module lending::storage {
       friend lending::lend;
       friend lending::borrow;
       
       public struct Pool has key {
           total_supplied: u64,
           total_borrowed: u64,
           interest_rate: u64,
       }
       
       public(friend) fun update_supply(/* å‚æ•° */) { }
       public(friend) fun update_borrow(/* å‚æ•° */) { }
   }
   ```

**ç¬¬ 2 å±‚ï¼šLogicï¼ˆé€»è¾‘å±‚ï¼‰**

3. `interest.move`
   ```move
   module lending::interest {
       public fun calculate_interest(
           principal: u64,
           rate: u64,
           time: u64
       ): u64 {
           // ç®€å•åˆ©æ¯å…¬å¼
       }
       
       public fun get_borrow_rate(
           utilization: u64
       ): u64 {
           // æ ¹æ®èµ„é‡‘åˆ©ç”¨ç‡è®¡ç®—å€Ÿæ¬¾åˆ©ç‡
       }
   }
   ```

4. `collateral.move`
   ```move
   module lending::collateral {
       public fun calculate_max_borrow(
           collateral_value: u64,
           ltv_ratio: u64  // Loan-to-Value
       ): u64 { }
       
       public fun is_healthy(
           collateral: u64,
           debt: u64
       ): bool { }
   }
   ```

**ç¬¬ 3 å±‚ï¼šAPIï¼ˆæ¥å£å±‚ï¼‰**

5. `lend.move`
   ```move
   module lending::lend {
       use lending::storage;
       use lending::tokens;
       
       public entry fun supply(
           account: &signer,
           amount: u64
       ) {
           // 1. æ›´æ–°å­˜å‚¨æ± 
           // 2. é“¸é€  LToken
           // 3. è½¬ç§»ç»™ç”¨æˆ·
       }
       
       public entry fun withdraw(
           account: &signer,
           amount: u64
       ) {
           // 1. é”€æ¯ LToken
           // 2. æ›´æ–°å­˜å‚¨æ± 
           // 3. è¿”è¿˜èµ„äº§
       }
   }
   ```

6. `borrow.move`
   ```move
   module lending::borrow {
       use lending::storage;
       use lending::collateral;
       use lending::interest;
       
       public entry fun borrow(
           account: &signer,
           amount: u64,
           collateral_amount: u64
       ) {
           // 1. æ£€æŸ¥æŠµæŠ¼å“æ˜¯å¦è¶³å¤Ÿ
           // 2. æ›´æ–°å€Ÿæ¬¾è®°å½•
           // 3. è½¬ç§»èµ„äº§
       }
       
       public entry fun repay(
           account: &signer,
           amount: u64
       ) {
           // 1. è®¡ç®—åˆ©æ¯
           // 2. æ›´æ–°å€ºåŠ¡
           // 3. é‡Šæ”¾æŠµæŠ¼å“
       }
   }
   ```

#### æˆåŠŸæ ‡å‡†
- [ ] æ‰€æœ‰æ¨¡å—èŒè´£å•ä¸€
- [ ] åˆ†å±‚æ¶æ„æ¸…æ™°
- [ ] æ­£ç¡®ä½¿ç”¨å‹å…ƒæ§åˆ¶å†…éƒ¨å‡½æ•°è®¿é—®
- [ ] å…¬å…± API è®¾è®¡åˆç†
- [ ] æ¨¡å—é—´ä¾èµ–å…³ç³»æ­£ç¡®
- [ ] èƒ½å¤Ÿç¼–è¯‘é€šè¿‡

#### é¢å¤–æŒ‘æˆ˜
- [ ] æ·»åŠ äº‹ä»¶ç³»ç»Ÿè®°å½•æ“ä½œ
- [ ] å®ç°æ¸…ç®—æœºåˆ¶
- [ ] æ·»åŠ ç®¡ç†å‘˜æ§åˆ¶

---

### âœ… ä»»åŠ¡ 4ï¼šæ¨¡å—å‡çº§ç­–ç•¥å®è·µï¼ˆæŒ‘æˆ˜ï¼‰

**éš¾åº¦**: â­â­â­â­â­  
**é¢„è®¡æ—¶é—´**: 60 åˆ†é’Ÿ

#### éœ€æ±‚æè¿°
ç”±äº Move æ¨¡å—ä¸å¯å˜ï¼Œå®ç°ä¸€ä¸ªå¯å‡çº§çš„ä»£ç†æ¨¡å¼ã€‚

#### å…·ä½“è¦æ±‚

1. **registry æ¨¡å—**ï¼šæ³¨å†Œä¸­å¿ƒ
   ```move
   module upgrade::registry {
       struct ImplementationRegistry has key {
           current_version: u64,
           implementation_address: address,
       }
       
       public entry fun register_implementation(
           admin: &signer,
           version: u64,
           impl_addr: address
       ) { }
   }
   ```

2. **proxy æ¨¡å—**ï¼šä»£ç†æ¨¡å—
   ```move
   module upgrade::proxy {
       use upgrade::registry;
       
       public entry fun execute(
           account: &signer,
           // å‚æ•°
       ) {
           // ä»æ³¨å†Œä¸­å¿ƒè·å–å½“å‰å®ç°åœ°å€
           // è°ƒç”¨å®ç°æ¨¡å—çš„å‡½æ•°
       }
   }
   ```

3. **implementation_v1** å’Œ **implementation_v2**
   - å®ç°ç›¸åŒçš„æ¥å£
   - ä¸åŒçš„ä¸šåŠ¡é€»è¾‘

#### æˆåŠŸæ ‡å‡†
- [ ] èƒ½å¤Ÿåˆ‡æ¢å®ç°ç‰ˆæœ¬
- [ ] ä»£ç†æ¨¡å—æ­£ç¡®è½¬å‘è°ƒç”¨
- [ ] ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½å®Œæ•´

---

## ğŸ”§ å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. åˆå§‹åŒ–é¡¹ç›®

```bash
cd Day_05_æ¨¡å—ç³»ç»Ÿä¸å¯è§æ€§
```

### 2. é…ç½® Move.toml

```toml
[package]
name = "day05_module_system"
version = "1.0.0"

[addresses]
my_addr = "_"
lending = "_"
upgrade = "_"

[dependencies.AptosFramework]
git = "https://github.com/aptos-labs/aptos-core.git"
rev = "mainnet"
subdir = "aptos-move/framework/aptos-framework"
```

### 3. ç¼–è¯‘æµ‹è¯•

```bash
# ç¼–è¯‘æ‰€æœ‰æ¨¡å—
aptos move compile

# æµ‹è¯•
aptos move test
```

---

## âœ… æäº¤æ£€æŸ¥æ¸…å•

å®Œæˆä»»åŠ¡åï¼Œè¯·ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰ä»£ç éƒ½æœ‰é€‚å½“çš„æ³¨é‡Š
- [ ] éµå¾ª Move å‘½åè§„èŒƒï¼ˆsnake_caseï¼‰
- [ ] æ­£ç¡®ä½¿ç”¨å¯è§æ€§ä¿®é¥°ç¬¦
- [ ] æ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°
- [ ] ä»£ç èƒ½å¤Ÿç¼–è¯‘é€šè¿‡
- [ ] ç¼–å†™äº†åŸºæœ¬çš„æµ‹è¯•ç”¨ä¾‹

---

## ğŸ“š å‚è€ƒèµ„æº

- Move Book: https://move-language.github.io/move/
- Aptos Framework Source: https://github.com/aptos-labs/aptos-core
- Move Patterns: https://www.move-patterns.com/

---

## ğŸ’¡ æç¤º

### ä»»åŠ¡ 1 æç¤º
- Book ç»“æ„ä½“éœ€è¦ `store` å’Œ `drop` èƒ½åŠ›
- Library èµ„æºéœ€è¦ `key` èƒ½åŠ›
- ä½¿ç”¨ `vector::length` æ£€æŸ¥ä¹¦ç±æ•°é‡

### ä»»åŠ¡ 2 æç¤º
- ä½¿ç”¨ `exists<AdminCap>()` éªŒè¯ç®¡ç†å‘˜èº«ä»½
- æƒé™å¯ä»¥ç”¨ä½æ ‡å¿—ï¼ˆbit flagsï¼‰è¡¨ç¤º
- è€ƒè™‘æ·»åŠ é”™è¯¯å¸¸é‡

### ä»»åŠ¡ 3 æç¤º
- ä»åº•å±‚ï¼ˆCoreï¼‰å¼€å§‹å®ç°
- åˆ©ç”¨ç‡ = æ€»å€Ÿæ¬¾ / æ€»å­˜æ¬¾
- LTVï¼ˆLoan-to-Valueï¼‰é€šå¸¸ä¸º 50-80%
- è€ƒè™‘æ·»åŠ äº‹ä»¶ä»¥ä¾¿é“¾ä¸‹è·Ÿè¸ª

### ä»»åŠ¡ 4 æç¤º
- ä½¿ç”¨åŠ¨æ€è°ƒåº¦éœ€è¦å°å¿ƒè®¾è®¡
- è€ƒè™‘ä½¿ç”¨ `borrow_global` è·å–å®ç°åœ°å€
- ç‰ˆæœ¬ç®¡ç†éœ€è¦æƒé™æ§åˆ¶

---

## ğŸ“ å­¦ä¹ æˆæœ

å®Œæˆè¿™äº›ä»»åŠ¡åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ç‹¬ç«‹è®¾è®¡å¤šæ¨¡å— Move é¡¹ç›®
- âœ… æ­£ç¡®ä½¿ç”¨å¯è§æ€§æ§åˆ¶ä¿æŠ¤ä»£ç 
- âœ… å®ç°æ¨¡å—é—´çš„åä½œ
- âœ… è®¾è®¡å¯ç»´æŠ¤çš„ä»£ç æ¶æ„

**åŠ æ²¹ï¼ç¥ä½ ç¼–ç æ„‰å¿«ï¼** ğŸš€
