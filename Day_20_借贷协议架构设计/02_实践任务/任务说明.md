# Day 20 实践任务 - 借贷协议架构设计

## 📋 任务概述

在本次实践任务中,你将设计一个完整的借贷协议架构。这不仅仅是编写代码,更重要的是**架构设计思维**的锻炼。

**任务目标**:
- 📝 编写完整的架构设计文档
- 🏗️ 定义清晰的模块划分
- 📊 设计合理的数据结构
- 🔧 规划核心接口和算法
- ⚖️ 制定风险参数

**完成时间**: 3-4 小时

---

## 🎯 任务要求

### 任务 1: 架构设计文档 (30%)

创建一个 Markdown 文档 `你的答案/lending_protocol_design.md`,包含以下内容:

#### 1.1 项目概述
```markdown
- 项目名称
- 目标用户
- 核心功能列表
- 与 Aave/Compound 的差异化特性
```

#### 1.2 系统架构图
```
绘制系统架构图,包括:
- 核心模块及其职责
- 模块间的依赖关系
- 外部依赖(预言机等)
```

#### 1.3 技术选型
```markdown
说明以下技术选型理由:
- 为什么使用 Move 语言
- 泛型 vs 具体类型
- Table vs SimpleMap
- 事件设计
```

### 任务 2: 数据模型设计 (25%)

在文档中定义以下数据结构:

#### 2.1 资产池 (Asset Pool)
```move
需要包含的字段:
- 资产标识
- 总存款/总借款
- 利息指数
- 利率参数
- 风险参数
- 储备金
- 时间戳
```

#### 2.2 用户账户 (User Account)
```move
需要包含的字段:
- 存款信息(多资产)
- 借款信息(多资产)
- 抵押品列表
- 账户状态
```

#### 2.3 配置参数 (Configuration)
```move
需要包含的参数:
- 抵押率 (Collateral Factor)
- 清算阈值 (Liquidation Threshold)
- 清算奖励 (Liquidation Bonus)
- 利率模型参数
- 储备金因子
```

### 任务 3: 核心接口设计 (20%)

设计以下核心接口的函数签名和伪代码:

#### 3.1 用户操作接口
```move
1. deposit() - 存款
2. withdraw() - 提款
3. borrow() - 借款
4. repay() - 还款
5. set_collateral() - 设置抵押品
```

#### 3.2 清算接口
```move
1. liquidate() - 执行清算
2. is_liquidatable() - 检查是否可清算
```

#### 3.3 查询接口
```move
1. get_user_account_data() - 获取用户账户数据
2. get_pool_data() - 获取资产池数据
3. get_health_factor() - 计算健康因子
```

### 任务 4: 核心算法设计 (15%)

详细描述以下算法的实现逻辑:

#### 4.1 利率计算算法
```
输入: 利用率
输出: 借款利率、存款利率

伪代码:
function calculate_rates(utilization):
    if utilization <= optimal_utilization:
        ...
    else:
        ...
```

#### 4.2 健康因子计算
```
输入: 用户地址
输出: 健康因子

伪代码:
function calculate_health_factor(user):
    total_collateral = ...
    total_debt = ...
    health_factor = ...
    return health_factor
```

#### 4.3 清算执行流程
```
输入: 清算人、借款人、债务类型、抵押品类型、金额
输出: 清算人获得的抵押品数量

步骤:
1. 验证清算条件
2. 计算清算金额
3. 转移资产
4. 更新状态
```

### 任务 5: 风险参数设置 (10%)

为以下资产设置合理的风险参数:

| 资产 | 抵押率 | 清算阈值 | 清算奖励 | 理由 |
|------|--------|---------|---------|------|
| USDC | ? | ? | ? | ? |
| USDT | ? | ? | ? | ? |
| APT  | ? | ? | ? | ? |
| BTC  | ? | ? | ? | ? |
| ETH  | ? | ? | ? | ? |

**考虑因素**:
- 资产的流动性
- 价格波动性
- 市场深度
- 去中心化程度

---

## 📝 任务模板

在 `你的答案/` 文件夹中,我们提供了以下模板:

### 1. 架构文档模板
```
你的答案/
├── lending_protocol_design.md  (主设计文档)
├── data_models.md             (数据模型详解)
├── api_specification.md       (API 规范)
└── risk_parameters.md         (风险参数说明)
```

### 2. 设计文档大纲

```markdown
# XX 借贷协议架构设计

## 1. 项目概述
### 1.1 背景与目标
### 1.2 核心功能
### 1.3 差异化特性

## 2. 系统架构
### 2.1 整体架构图
### 2.2 模块设计
### 2.3 技术选型

## 3. 数据模型
### 3.1 资产池模型
### 3.2 用户账户模型
### 3.3 配置模型

## 4. 接口设计
### 4.1 用户接口
### 4.2 清算接口
### 4.3 查询接口
### 4.4 管理接口

## 5. 核心算法
### 5.1 利率模型
### 5.2 健康因子计算
### 5.3 清算机制

## 6. 风险管理
### 6.1 风险参数设置
### 6.2 风险控制措施
### 6.3 应急预案

## 7. 安全性设计
### 7.1 重入防护
### 7.2 溢出保护
### 7.3 预言机安全
### 7.4 暂停机制

## 8. Gas 优化
### 8.1 存储优化
### 8.2 计算优化
### 8.3 批量操作

## 9. 可扩展性
### 9.1 新资产添加
### 9.2 功能扩展
### 9.3 升级策略

## 10. 测试策略
### 10.1 单元测试
### 10.2 集成测试
### 10.3 压力测试

## 11. 部署计划
### 11.1 测试网部署
### 11.2 审计计划
### 11.3 主网部署
```

---

## 💡 实践指南

### Step 1: 研究现有协议 (30 分钟)

在开始设计前,先研究主流协议:

**Aave V3**:
- 优势: 功能丰富,多种创新机制
- 劣势: 复杂度高,Gas 成本较高
- 学习重点: eMode, 隔离模式, 闪电贷

**Compound V2/V3**:
- 优势: 简洁易懂,Gas 效率高
- 劣势: 功能相对基础
- 学习重点: cToken 机制,治理模型

**思考**:
```
1. 哪些设计值得借鉴?
2. 哪些地方可以改进?
3. 如何适配 Aptos 生态?
```

### Step 2: 确定设计目标 (20 分钟)

明确你的协议定位:

```
[ ] 简洁型 - 类似 Compound,专注核心功能
[ ] 全功能型 - 类似 Aave,提供丰富功能
[ ] 创新型 - 引入独特机制

选择理由:
...
```

### Step 3: 绘制架构图 (30 分钟)

使用工具绘制系统架构:
- [Draw.io](https://app.diagrams.net/)
- [Excalidraw](https://excalidraw.com/)
- 或手绘后拍照

**架构图应包含**:
```
┌──────────────────────────────────────────┐
│            用户界面层                      │
│   (钱包、DApp、API)                       │
└──────────────┬───────────────────────────┘
               │
┌──────────────▼───────────────────────────┐
│          核心业务层                        │
│  ┌─────────┬─────────┬─────────┐         │
│  │存款模块  │借款模块  │清算模块  │         │
│  └─────────┴─────────┴─────────┘         │
└──────────────┬───────────────────────────┘
               │
┌──────────────▼───────────────────────────┐
│          支撑服务层                        │
│  ┌─────────┬─────────┬─────────┐         │
│  │利率模块  │预言机   │治理模块  │         │
│  └─────────┴─────────┴─────────┘         │
└──────────────┬───────────────────────────┘
               │
┌──────────────▼───────────────────────────┐
│          数据存储层                        │
│   (资产池、用户账户、配置)                  │
└──────────────────────────────────────────┘
```

### Step 4: 定义数据结构 (40 分钟)

从数据模型开始设计:

**设计原则**:
```
1. 最小化存储 - 只存必要数据
2. 高效查询 - 合理使用索引
3. 类型安全 - 利用 Move 类型系统
4. 可扩展 - 预留扩展字段
```

**示例 - 资产池设计**:
```move
struct Pool<phantom CoinType> has key {
    // 基础数据
    coins: Coin<CoinType>,
    total_deposits: u64,
    total_borrows: u64,
    
    // 利息相关
    deposit_index: u128,    // 初始 1e18
    borrow_index: u128,     // 初始 1e18
    last_update: u64,       // 时间戳
    
    // 利率参数
    rate_config: RateConfig,
    
    // 风险参数
    risk_config: RiskConfig,
    
    // 统计数据
    reserves: u64,          // 储备金
    total_fees: u64,        // 累计手续费
}
```

### Step 5: 设计接口 (40 分钟)

定义清晰的函数签名:

**接口设计清单**:
```
✅ 函数名是否语义清晰?
✅ 参数是否最小化?
✅ 返回值是否有意义?
✅ 错误处理是否完善?
✅ 权限控制是否合理?
```

**示例**:
```move
/// 存款
/// 
/// 参数:
///   - user: 用户签名者
///   - amount: 存款数量
///   - enable_collateral: 是否启用为抵押品
/// 
/// 返回: 无
/// 
/// 错误:
///   - E_INSUFFICIENT_BALANCE: 余额不足
///   - E_PROTOCOL_PAUSED: 协议暂停
/// 
/// 事件: DepositEvent
public entry fun deposit<CoinType>(
    user: &signer,
    amount: u64,
    enable_collateral: bool
)
```

### Step 6: 描述核心算法 (40 分钟)

用伪代码描述关键算法:

**利率计算示例**:
```
算法: calculate_borrow_rate

输入:
  - utilization: 利用率 (0-100%)
  - config: 利率配置

输出:
  - borrow_rate: 借款年化利率

逻辑:
  if utilization <= optimal_utilization:
      // 线性段
      rate = base_rate + (utilization / optimal) × slope1
  else:
      // 陡峭段
      excess = utilization - optimal_utilization
      rate = base_rate + slope1 + (excess / (100% - optimal)) × slope2
  
  return rate

复杂度: O(1)
Gas 估算: ~500 gas
```

### Step 7: 设置风险参数 (30 分钟)

基于资产特性设置参数:

**参数设置方法论**:
```
1. 收集数据
   - 历史价格波动
   - 交易量
   - 市场深度

2. 计算指标
   - 30/60/90 日波动率
   - 最大回撤
   - 流动性评分

3. 设定参数
   - 抵押率 = f(波动率, 流动性)
   - 清算阈值 = 抵押率 + 安全边际
   - 清算奖励 = f(清算难度)
```

**示例分析**:
```
资产: USDC (稳定币)

特性:
- 价格波动: <1% (锚定 $1)
- 流动性: 极高
- 风险: 极低

参数:
- 抵押率: 80% (高)
- 清算阈值: 85%
- 清算奖励: 5% (低)

理由:
稳定币价格稳定,即使 80% 抵押率,
也有 5% 缓冲区,足以应对小幅波动。
```

---

## ✅ 评分标准

### 总分: 100 分

| 评分项 | 分值 | 要求 |
|--------|------|------|
| **架构设计** | 30 分 | 模块划分清晰,职责明确,依赖合理 |
| **数据模型** | 25 分 | 结构完整,字段合理,类型安全 |
| **接口设计** | 20 分 | 签名清晰,文档完整,易于使用 |
| **算法设计** | 15 分 | 逻辑正确,伪代码清晰,考虑边界 |
| **风险参数** | 10 分 | 参数合理,有理有据,风险可控 |

### 优秀作品标准 (≥85 分)

```
✅ 架构图专业,一目了然
✅ 数据模型完整,考虑周全
✅ 接口文档详尽,注释清晰
✅ 算法描述精确,有复杂度分析
✅ 风险参数有数据支撑
✅ 包含创新点或优化
✅ 考虑边界情况和异常处理
```

### 常见问题 (-5 到 -10 分)

```
❌ 架构图混乱或缺失
❌ 数据结构字段不完整
❌ 接口缺少错误处理
❌ 算法描述模糊
❌ 风险参数拍脑袋决定
❌ 没有考虑安全性
❌ Gas 优化意识不足
```

---

## 🎯 进阶挑战 (可选)

完成基础任务后,可以尝试:

### 挑战 1: 创新机制设计
```
设计一个独特的功能,例如:
- 动态抵押率调整
- 信用评分系统
- 自动再平衡
- 跨链借贷
```

### 挑战 2: 性能优化
```
分析并优化:
- 存储布局
- 批量操作
- 懒惰计算
- 缓存策略
```

### 挑战 3: 安全加固
```
设计防护措施:
- 多重签名
- 时间锁
- 熔断机制
- 漏洞赏金计划
```

### 挑战 4: 完整实现
```
将设计转化为代码:
- 实现核心模块
- 编写单元测试
- 本地部署测试
- 代码审查
```

---

## 📚 参考资源

### 官方文档
- [Aave V3 Docs](https://docs.aave.com/developers/getting-started/readme)
- [Compound Docs](https://docs.compound.finance/)
- [Move Book](https://move-language.github.io/move/)

### 设计案例
- [Aave V3 Whitepaper](https://github.com/aave/aave-v3-core/blob/master/techpaper/Aave_V3_Technical_Paper.pdf)
- [Compound V3](https://www.comp.xyz/t/compound-iii/3351)

### 工具推荐
- **架构图**: Draw.io, Figma, Excalidraw
- **文档**: Markdown + VSCode
- **计算**: Excel / Python (参数分析)

---

## 💡 提示与技巧

### 设计思维
```
1. 从用户体验出发
   - 用户最关心什么?
   - 操作流程是否简单?
   
2. 数据驱动决策
   - 用数据支撑参数设置
   - 参考主流协议的实践
   
3. 安全优先
   - 每个设计都考虑安全性
   - What if 思维:如果 XX 会怎样?
   
4. 渐进式设计
   - 先 MVP,再扩展
   - 不要过度设计
```

### 时间分配建议
```
研究分析: 30 分钟
架构设计: 40 分钟
数据建模: 40 分钟
接口设计: 40 分钟
算法设计: 40 分钟
风险参数: 30 分钟
文档撰写: 40 分钟
审查优化: 20 分钟
─────────────────
总计: 4 小时
```

---

## 🚀 提交要求

### 文件清单
```
你的答案/
├── lending_protocol_design.md  (必需,主设计文档)
├── architecture_diagram.png    (必需,架构图)
├── data_models.md             (可选,详细数据模型)
├── api_specification.md       (可选,API 文档)
└── risk_analysis.xlsx         (可选,风险参数分析)
```

### 文档规范
- 使用 Markdown 格式
- 代码块使用 move 语法高亮
- 图表清晰可读
- 章节编号规范
- 目录完整

---

## ❓ 常见问题

**Q1: 必须完全原创吗?**
A: 可以参考 Aave/Compound,但要理解并用自己的话表达。照抄扣分。

**Q2: 需要写实际代码吗?**
A: 本任务主要是设计,用伪代码 + 接口定义即可。想写实际代码可以作为加分项。

**Q3: 风险参数怎么设置?**
A: 参考主流协议,结合资产特性。重要的是说明理由,不是拍脑袋。

**Q4: 架构图用什么工具?**
A: 任何工具都可以,甚至手绘拍照。清晰易懂最重要。

**Q5: 时间不够怎么办?**
A: 专注核心部分(架构+数据+接口),其他可以简化。质量 > 数量。

---

**开始你的设计之旅吧!记住:好的架构是成功的一半!** 🎨

*遇到问题?重新阅读理论学习部分,或参考代码示例。*
