# åˆ©ç‡æ¨¡å‹ä¸æ¸…ç®—æœºåˆ¶ - æ ¸å¿ƒæ¦‚å¿µ

## ğŸ“š ç›®å½•

1. [åˆ©ç‡æ¨¡å‹åŸºç¡€ç†è®º](#1-åˆ©ç‡æ¨¡å‹åŸºç¡€ç†è®º)
2. [çº¿æ€§åˆ©ç‡æ¨¡å‹](#2-çº¿æ€§åˆ©ç‡æ¨¡å‹)
3. [è·³è·ƒåˆ©ç‡æ¨¡å‹](#3-è·³è·ƒåˆ©ç‡æ¨¡å‹)
4. [åŠ¨æ€åˆ©ç‡è®¡ç®—](#4-åŠ¨æ€åˆ©ç‡è®¡ç®—)
5. [æ¸…ç®—æœºåˆ¶æ·±åº¦è§£æ](#5-æ¸…ç®—æœºåˆ¶æ·±åº¦è§£æ)
6. [æ¸…ç®—æ¿€åŠ±ä¸æƒ©ç½š](#6-æ¸…ç®—æ¿€åŠ±ä¸æƒ©ç½š)
7. [æ¸…ç®—ç­–ç•¥ä¸ä¼˜åŒ–](#7-æ¸…ç®—ç­–ç•¥ä¸ä¼˜åŒ–)
8. [å®é™…æ¡ˆä¾‹åˆ†æ](#8-å®é™…æ¡ˆä¾‹åˆ†æ)

---

## 1. åˆ©ç‡æ¨¡å‹åŸºç¡€ç†è®º

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ©ç‡æ¨¡å‹ï¼Ÿ

å€Ÿè´·åè®®ä¸­çš„åˆ©ç‡æ¨¡å‹æœ‰ä¸¤ä¸ªæ ¸å¿ƒç›®æ ‡ï¼š

```
ç›®æ ‡ 1: å¹³è¡¡ä¾›éœ€
  - ä½¿ç”¨ç‡ä½ â†’ åˆ©ç‡ä½ â†’ é¼“åŠ±å€Ÿæ¬¾
  - ä½¿ç”¨ç‡é«˜ â†’ åˆ©ç‡é«˜ â†’ é¼“åŠ±å­˜æ¬¾ã€æŠ‘åˆ¶å€Ÿæ¬¾
  
ç›®æ ‡ 2: ä¿è¯æµåŠ¨æ€§
  - é¿å…æ‰€æœ‰èµ„é‡‘è¢«å€Ÿå‡ºï¼ˆä¿ç•™å‚¨å¤‡é‡‘ï¼‰
  - é€šè¿‡é«˜åˆ©ç‡æƒ©ç½šæç«¯ä½¿ç”¨ç‡
  - ç¡®ä¿å­˜æ¬¾äººå¯ä»¥éšæ—¶æç°
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µå®šä¹‰

#### ä½¿ç”¨ç‡ (Utilization Rate)

```
å®šä¹‰ï¼š
  ä½¿ç”¨ç‡ = å·²å€Ÿå‡ºé‡‘é¢ / æ€»å­˜æ¬¾é‡‘é¢

å…¬å¼ï¼š
  U = Total_Borrows / Total_Deposits
  
ç¤ºä¾‹ï¼š
  æ€»å­˜æ¬¾ï¼š1,000,000 USDC
  å·²å€Ÿå‡ºï¼š750,000 USDC
  ä½¿ç”¨ç‡ = 750,000 / 1,000,000 = 0.75 = 75%
  
ç‰©ç†æ„ä¹‰ï¼š
  - 75% çš„èµ„é‡‘åœ¨å¤–æµé€š
  - 25% çš„èµ„é‡‘ä½œä¸ºå‚¨å¤‡
  - ä½¿ç”¨ç‡è¶Šé«˜ï¼ŒæµåŠ¨æ€§é£é™©è¶Šå¤§
```

#### å€Ÿæ¬¾åˆ©ç‡ (Borrow Rate)

```
å®šä¹‰ï¼š
  å€Ÿæ¬¾äººéœ€è¦æ”¯ä»˜çš„å¹´åŒ–åˆ©ç‡ï¼ˆAPRï¼‰

ç‰¹ç‚¹ï¼š
  - åŠ¨æ€å˜åŒ–ï¼Œå–å†³äºä½¿ç”¨ç‡
  - å¤åˆ©è®¡ç®—ï¼ˆæ¯ä¸ªåŒºå—ï¼‰
  - å½±å“å€Ÿæ¬¾æˆæœ¬
  
ç¤ºä¾‹ï¼š
  å€Ÿæ¬¾åˆ©ç‡ = 10% APR
  å€Ÿæ¬¾é‡‘é¢ = 10,000 USDC
  å¹´åˆ©æ¯ = 10,000 Ã— 10% = 1,000 USDC
```

#### å­˜æ¬¾åˆ©ç‡ (Supply Rate)

```
å®šä¹‰ï¼š
  å­˜æ¬¾äººè·å¾—çš„å¹´åŒ–åˆ©ç‡ï¼ˆAPRï¼‰

å…¬å¼ï¼š
  Supply_Rate = Borrow_Rate Ã— Utilization Ã— (1 - Reserve_Factor)
  
ç¤ºä¾‹ï¼š
  å€Ÿæ¬¾åˆ©ç‡ = 10%
  ä½¿ç”¨ç‡ = 75%
  å‚¨å¤‡é‡‘ç‡ = 10%
  
  å­˜æ¬¾åˆ©ç‡ = 10% Ã— 75% Ã— (1 - 10%)
           = 10% Ã— 0.75 Ã— 0.9
           = 6.75%
           
è§£é‡Šï¼š
  - å­˜æ¬¾åˆ©ç‡ < å€Ÿæ¬¾åˆ©ç‡ï¼ˆåè®®éœ€è¦èµšå–å·®ä»·ï¼‰
  - ä½¿ç”¨ç‡è¶Šé«˜ï¼Œå­˜æ¬¾åˆ©ç‡è¶Šé«˜
  - å‚¨å¤‡é‡‘ç‡ç”¨äºåè®®æ”¶å…¥
```

### 1.3 åˆ©ç‡ä¸ APR/APY

#### APR vs APY

```
APR (Annual Percentage Rate):
  - ç®€å•å¹´åŒ–åˆ©ç‡
  - ä¸è€ƒè™‘å¤åˆ©
  - è®¡ç®—å…¬å¼ï¼šAPR = åŒºå—åˆ©ç‡ Ã— åŒºå—æ•°/å¹´
  
APY (Annual Percentage Yield):
  - å¤åˆå¹´åŒ–æ”¶ç›Šç‡
  - è€ƒè™‘å¤åˆ©æ•ˆåº”
  - è®¡ç®—å…¬å¼ï¼šAPY = (1 + åŒºå—åˆ©ç‡)^åŒºå—æ•°/å¹´ - 1

ç¤ºä¾‹ï¼š
  åŒºå—åˆ©ç‡ = 0.000001 (æ¯åŒºå—)
  å¹´åŒºå—æ•° = 31,536,000 (å‡è®¾æ¯ç§’ä¸€ä¸ªåŒºå—)
  
  APR = 0.000001 Ã— 31,536,000 = 3.1536% = 3.15%
  APY = (1.000001)^31,536,000 - 1 â‰ˆ 3.20%
  
  å·®å¼‚ï¼šå¤åˆ©ä½¿ APY ç•¥é«˜äº APR
```

### 1.4 åˆ©ç‡æ¨¡å‹çš„å…³é”®å‚æ•°

```
1. åŸºç¡€åˆ©ç‡ (Base Rate)
   - ä½¿ç”¨ç‡ä¸º 0 æ—¶çš„æœ€ä½åˆ©ç‡
   - é€šå¸¸ 0-5%
   - è¡¥å¿å­˜æ¬¾äººçš„æœºä¼šæˆæœ¬

2. æœ€ä¼˜ä½¿ç”¨ç‡ (Optimal Utilization)
   - ç›®æ ‡ä½¿ç”¨ç‡
   - é€šå¸¸ 70-90%
   - åœ¨æ­¤ç‚¹ä¹‹å‰åˆ©ç‡ç¼“æ…¢å¢é•¿

3. æ–œç‡ 1 (Slope 1)
   - 0% â†’ æœ€ä¼˜ä½¿ç”¨ç‡çš„åˆ©ç‡å¢é•¿é€Ÿåº¦
   - è¾ƒç¼“å’Œçš„å¢é•¿

4. æ–œç‡ 2 (Slope 2)
   - æœ€ä¼˜ä½¿ç”¨ç‡ â†’ 100% çš„åˆ©ç‡å¢é•¿é€Ÿåº¦
   - é™¡å³­å¢é•¿ï¼Œæƒ©ç½šé«˜ä½¿ç”¨ç‡

5. æœ€å¤§åˆ©ç‡ (Max Rate)
   - ä½¿ç”¨ç‡ 100% æ—¶çš„åˆ©ç‡ä¸Šé™
   - é˜²æ­¢æç«¯æƒ…å†µ
```

---

## 2. çº¿æ€§åˆ©ç‡æ¨¡å‹

### 2.1 åŸºæœ¬åŸç†

æœ€ç®€å•çš„åˆ©ç‡æ¨¡å‹ï¼Œåˆ©ç‡ä¸ä½¿ç”¨ç‡å‘ˆçº¿æ€§å…³ç³»ï¼š

```
å…¬å¼ï¼š
  Borrow_Rate = Base_Rate + Utilization Ã— Slope
  
  å…¶ä¸­ï¼š
    Base_Rate: åŸºç¡€åˆ©ç‡
    Slope: æ–œç‡ï¼ˆåˆ©ç‡å¢é•¿é€Ÿåº¦ï¼‰
    Utilization: ä½¿ç”¨ç‡

å›¾ç¤ºï¼š
  å€Ÿæ¬¾åˆ©ç‡ (%)
      ^
  100%|                            /
      |                          /
   50%|                        /
      |                      /
   20%|                    /
      |                  /
   10%|________________/
      +------------------+-------------------> ä½¿ç”¨ç‡ (%)
      0%               50%               100%
```

### 2.2 æ•°å­¦æ¨¡å‹

```
å®Œæ•´å…¬å¼ï¼š

Borrow_Rate = Base_Rate + (Utilization Ã— Slope)

Supply_Rate = Borrow_Rate Ã— Utilization Ã— (1 - Reserve_Factor)

å…¶ä¸­ï¼š
  - Base_Rate: åŸºç¡€åˆ©ç‡ (å¦‚ 2%)
  - Slope: æ–œç‡ (å¦‚ 20%)
  - Reserve_Factor: å‚¨å¤‡é‡‘ç‡ (å¦‚ 10%)
```

### 2.3 ä»£ç å®ç°

```move
/// çº¿æ€§åˆ©ç‡æ¨¡å‹
struct LinearInterestRateModel has store {
    base_rate_per_second: u128,      // åŸºç¡€åˆ©ç‡ï¼ˆæ¯ç§’ï¼‰
    slope_per_second: u128,           // æ–œç‡ï¼ˆæ¯ç§’ï¼‰
    reserve_factor: u128,             // å‚¨å¤‡é‡‘ç‡
}

/// è®¡ç®—å€Ÿæ¬¾åˆ©ç‡
public fun get_borrow_rate(
    model: &LinearInterestRateModel,
    utilization: u128  // ä½¿ç”¨ç‡ï¼Œç²¾åº¦ 1e18
): u128 {
    // å€Ÿæ¬¾åˆ©ç‡ = åŸºç¡€åˆ©ç‡ + ä½¿ç”¨ç‡ Ã— æ–œç‡
    let variable_rate = (utilization * model.slope_per_second) / PRECISION;
    model.base_rate_per_second + variable_rate
}

/// è®¡ç®—å­˜æ¬¾åˆ©ç‡
public fun get_supply_rate(
    model: &LinearInterestRateModel,
    utilization: u128,
    borrow_rate: u128
): u128 {
    // å­˜æ¬¾åˆ©ç‡ = å€Ÿæ¬¾åˆ©ç‡ Ã— ä½¿ç”¨ç‡ Ã— (1 - å‚¨å¤‡é‡‘ç‡)
    let rate_to_pool = borrow_rate * (PRECISION - model.reserve_factor) / PRECISION;
    (rate_to_pool * utilization) / PRECISION
}
```

### 2.4 å‚æ•°ç¤ºä¾‹

```
ç¤ºä¾‹é…ç½®ï¼ˆç¨³å®šå¸ï¼‰:

Base_Rate = 0%
Slope = 10%
Reserve_Factor = 10%

è®¡ç®—ç¤ºä¾‹ï¼š
  ä½¿ç”¨ç‡ = 0%:
    å€Ÿæ¬¾åˆ©ç‡ = 0% + 0% Ã— 10% = 0%
    å­˜æ¬¾åˆ©ç‡ = 0%
  
  ä½¿ç”¨ç‡ = 50%:
    å€Ÿæ¬¾åˆ©ç‡ = 0% + 50% Ã— 10% = 5%
    å­˜æ¬¾åˆ©ç‡ = 5% Ã— 50% Ã— 90% = 2.25%
  
  ä½¿ç”¨ç‡ = 80%:
    å€Ÿæ¬¾åˆ©ç‡ = 0% + 80% Ã— 10% = 8%
    å­˜æ¬¾åˆ©ç‡ = 8% Ã— 80% Ã— 90% = 5.76%
  
  ä½¿ç”¨ç‡ = 100%:
    å€Ÿæ¬¾åˆ©ç‡ = 0% + 100% Ã— 10% = 10%
    å­˜æ¬¾åˆ©ç‡ = 10% Ã— 100% Ã— 90% = 9%
```

### 2.5 ä¼˜ç¼ºç‚¹åˆ†æ

```
âœ… ä¼˜ç‚¹ï¼š
  1. ç®€å•æ˜“æ‡‚
  2. è®¡ç®—é«˜æ•ˆï¼ˆGas ä½ï¼‰
  3. è¡Œä¸ºå¯é¢„æµ‹
  4. é€‚åˆç¨³å®šå¸

âŒ ç¼ºç‚¹ï¼š
  1. æ— æ³•ç²¾ç»†æ§åˆ¶é«˜ä½¿ç”¨ç‡æ—¶çš„åˆ©ç‡
  2. ä¸èƒ½è®¾ç½®æœ€ä¼˜ä½¿ç”¨ç‡
  3. å¯èƒ½å¯¼è‡´æç«¯ä½¿ç”¨ç‡
  4. ç¼ºä¹çµæ´»æ€§
```

---

## 3. è·³è·ƒåˆ©ç‡æ¨¡å‹

### 3.1 åŸºæœ¬åŸç†

è·³è·ƒåˆ©ç‡æ¨¡å‹ï¼ˆKinked Interest Rate Modelï¼‰åœ¨æœ€ä¼˜ä½¿ç”¨ç‡å¤„å‘ç”Ÿ"è·³è·ƒ"ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„æ–œç‡ï¼š

```
å…¬å¼ï¼š

if Utilization â‰¤ Optimal_Utilization:
    Borrow_Rate = Base_Rate + (Utilization / Optimal_Utilization) Ã— Slope_1
else:
    Borrow_Rate = Base_Rate + Slope_1 + 
                  ((Utilization - Optimal_Utilization) / (1 - Optimal_Utilization)) Ã— Slope_2

å›¾ç¤ºï¼š
  å€Ÿæ¬¾åˆ©ç‡ (%)
      ^
  200%|                                        /
      |                                      /
  100%|                                    /
      |                                  /
   50%|                                /  è·³è·ƒç‚¹
      |                              /|
   20%|                            / |
      |                          /   |
   10%|________________________/     |
      +---------------------------+--+---------> ä½¿ç”¨ç‡ (%)
      0%                        80% 100%
                          æœ€ä¼˜ä½¿ç”¨ç‡
```

### 3.2 æ•°å­¦æ¨¡å‹è¯¦è§£

```
åˆ†æ®µå‡½æ•°ï¼š

é˜¶æ®µ 1: U â‰¤ U_optimal (æ­£å¸¸èŒƒå›´)
  Borrow_Rate = Base + (U / U_optimal) Ã— Slope_1
  
  ç‰¹ç‚¹ï¼š
    - æ¸©å’Œå¢é•¿
    - é¼“åŠ±å€Ÿæ¬¾
    - ç»´æŒæµåŠ¨æ€§

é˜¶æ®µ 2: U > U_optimal (é«˜ä½¿ç”¨ç‡)
  Borrow_Rate = Base + Slope_1 + ((U - U_optimal) / (1 - U_optimal)) Ã— Slope_2
  
  ç‰¹ç‚¹ï¼š
    - é™¡å³­å¢é•¿
    - æŠ‘åˆ¶å€Ÿæ¬¾
    - ä¿æŠ¤æµåŠ¨æ€§

å‚æ•°å…³ç³»ï¼š
  Slope_2 >> Slope_1  ï¼ˆè·³è·ƒï¼‰
  
ç¤ºä¾‹å‚æ•°ï¼š
  Base = 2%
  Slope_1 = 10%
  Slope_2 = 100%
  U_optimal = 80%
```

### 3.3 è¯¦ç»†è®¡ç®—ç¤ºä¾‹

```
å‚æ•°é…ç½®ï¼š
  Base_Rate = 2%
  Slope_1 = 10%
  Slope_2 = 100%
  Optimal_Utilization = 80%
  Reserve_Factor = 10%

è®¡ç®—è¿‡ç¨‹ï¼š

ç¤ºä¾‹ 1: ä½¿ç”¨ç‡ = 40% (æ­£å¸¸èŒƒå›´)
  é˜¶æ®µåˆ¤æ–­: 40% â‰¤ 80%ï¼Œä½¿ç”¨ Slope_1
  
  å€Ÿæ¬¾åˆ©ç‡ = 2% + (40% / 80%) Ã— 10%
          = 2% + 0.5 Ã— 10%
          = 2% + 5%
          = 7%
  
  å­˜æ¬¾åˆ©ç‡ = 7% Ã— 40% Ã— (1 - 10%)
          = 7% Ã— 0.4 Ã— 0.9
          = 2.52%

ç¤ºä¾‹ 2: ä½¿ç”¨ç‡ = 80% (æœ€ä¼˜ç‚¹)
  é˜¶æ®µåˆ¤æ–­: 80% = 80%ï¼Œä¸´ç•Œç‚¹
  
  å€Ÿæ¬¾åˆ©ç‡ = 2% + (80% / 80%) Ã— 10%
          = 2% + 10%
          = 12%
  
  å­˜æ¬¾åˆ©ç‡ = 12% Ã— 80% Ã— 90%
          = 8.64%

ç¤ºä¾‹ 3: ä½¿ç”¨ç‡ = 90% (é«˜ä½¿ç”¨ç‡)
  é˜¶æ®µåˆ¤æ–­: 90% > 80%ï¼Œä½¿ç”¨ Slope_2
  
  è¶…å‡ºéƒ¨åˆ† = 90% - 80% = 10%
  è¶…å‡ºæ¯”ä¾‹ = 10% / (100% - 80%) = 10% / 20% = 0.5
  
  å€Ÿæ¬¾åˆ©ç‡ = 2% + 10% + 0.5 Ã— 100%
          = 2% + 10% + 50%
          = 62%
  
  å­˜æ¬¾åˆ©ç‡ = 62% Ã— 90% Ã— 90%
          = 50.22%

ç¤ºä¾‹ 4: ä½¿ç”¨ç‡ = 100% (æç«¯æƒ…å†µ)
  é˜¶æ®µåˆ¤æ–­: 100% > 80%ï¼Œä½¿ç”¨ Slope_2
  
  è¶…å‡ºæ¯”ä¾‹ = (100% - 80%) / (100% - 80%) = 1.0
  
  å€Ÿæ¬¾åˆ©ç‡ = 2% + 10% + 1.0 Ã— 100%
          = 112%
  
  å­˜æ¬¾åˆ©ç‡ = 112% Ã— 100% Ã— 90%
          = 100.8%
```

### 3.4 Move ä»£ç å®ç°

```move
/// è·³è·ƒåˆ©ç‡æ¨¡å‹
struct KinkedInterestRateModel has store {
    base_rate_per_second: u128,           // åŸºç¡€åˆ©ç‡ï¼ˆæ¯ç§’ï¼‰
    optimal_utilization: u128,            // æœ€ä¼˜ä½¿ç”¨ç‡ï¼ˆç²¾åº¦ 1e18ï¼‰
    slope_1_per_second: u128,             // æ–œç‡ 1ï¼ˆæ¯ç§’ï¼‰
    slope_2_per_second: u128,             // æ–œç‡ 2ï¼ˆæ¯ç§’ï¼‰
    reserve_factor: u128,                 // å‚¨å¤‡é‡‘ç‡ï¼ˆç²¾åº¦ 1e18ï¼‰
}

const PRECISION: u128 = 1_000_000_000_000_000_000; // 1e18

/// è®¡ç®—å€Ÿæ¬¾åˆ©ç‡
public fun get_borrow_rate(
    model: &KinkedInterestRateModel,
    utilization: u128  // ç²¾åº¦ 1e18
): u128 {
    if (utilization <= model.optimal_utilization) {
        // é˜¶æ®µ 1: æ­£å¸¸èŒƒå›´
        // rate = base + (utilization / optimal) * slope_1
        let utilization_ratio = (utilization * PRECISION) / model.optimal_utilization;
        let variable_rate = (utilization_ratio * model.slope_1_per_second) / PRECISION;
        model.base_rate_per_second + variable_rate
    } else {
        // é˜¶æ®µ 2: é«˜ä½¿ç”¨ç‡
        // rate = base + slope_1 + ((utilization - optimal) / (1 - optimal)) * slope_2
        let excess_utilization = utilization - model.optimal_utilization;
        let excess_range = PRECISION - model.optimal_utilization;
        let excess_ratio = (excess_utilization * PRECISION) / excess_range;
        let excess_rate = (excess_ratio * model.slope_2_per_second) / PRECISION;
        
        model.base_rate_per_second + model.slope_1_per_second + excess_rate
    }
}

/// è®¡ç®—å­˜æ¬¾åˆ©ç‡
public fun get_supply_rate(
    model: &KinkedInterestRateModel,
    utilization: u128,
    borrow_rate: u128
): u128 {
    // supply_rate = borrow_rate * utilization * (1 - reserve_factor)
    let rate_to_pool = (borrow_rate * (PRECISION - model.reserve_factor)) / PRECISION;
    (rate_to_pool * utilization) / PRECISION
}

/// åˆ›å»ºè·³è·ƒåˆ©ç‡æ¨¡å‹
public fun create_kinked_model(
    base_rate_per_year: u128,      // å¹´åŒ–åŸºç¡€åˆ©ç‡ï¼Œç²¾åº¦ 1e18
    optimal_utilization: u128,     // æœ€ä¼˜ä½¿ç”¨ç‡ï¼Œç²¾åº¦ 1e18
    slope_1_per_year: u128,        // å¹´åŒ–æ–œç‡ 1ï¼Œç²¾åº¦ 1e18
    slope_2_per_year: u128,        // å¹´åŒ–æ–œç‡ 2ï¼Œç²¾åº¦ 1e18
    reserve_factor: u128           // å‚¨å¤‡é‡‘ç‡ï¼Œç²¾åº¦ 1e18
): KinkedInterestRateModel {
    // å°†å¹´åŒ–åˆ©ç‡è½¬æ¢ä¸ºæ¯ç§’åˆ©ç‡
    // å‡è®¾ä¸€å¹´ = 31,536,000 ç§’
    const SECONDS_PER_YEAR: u128 = 31_536_000;
    
    KinkedInterestRateModel {
        base_rate_per_second: base_rate_per_year / SECONDS_PER_YEAR,
        optimal_utilization,
        slope_1_per_second: slope_1_per_year / SECONDS_PER_YEAR,
        slope_2_per_second: slope_2_per_year / SECONDS_PER_YEAR,
        reserve_factor,
    }
}
```

### 3.5 å®é™…åº”ç”¨åœºæ™¯

```
ç¨³å®šå¸ï¼ˆUSDCï¼‰é…ç½®ï¼š
  Base_Rate = 0%
  Optimal_Utilization = 90%
  Slope_1 = 4%
  Slope_2 = 60%
  Reserve_Factor = 10%
  
  ç†ç”±ï¼š
    - ç¨³å®šå¸æµåŠ¨æ€§å¥½ï¼Œå¯ä»¥é«˜ä½¿ç”¨ç‡
    - æ–œç‡è¾ƒå°ï¼Œé¼“åŠ±å€Ÿæ¬¾
    - é«˜ä½¿ç”¨ç‡æ—¶å¿«é€Ÿæå‡åˆ©ç‡ä¿æŠ¤æµåŠ¨æ€§

æ³¢åŠ¨èµ„äº§ï¼ˆETHï¼‰é…ç½®ï¼š
  Base_Rate = 2%
  Optimal_Utilization = 75%
  Slope_1 = 8%
  Slope_2 = 100%
  Reserve_Factor = 15%
  
  ç†ç”±ï¼š
    - ä»·æ ¼æ³¢åŠ¨å¤§ï¼Œéœ€è¦æ›´å¤šå‚¨å¤‡
    - æœ€ä¼˜ä½¿ç”¨ç‡æ›´ä½
    - æ–œç‡æ›´å¤§ï¼Œæ§åˆ¶é£é™©
```

---

## 4. åŠ¨æ€åˆ©ç‡è®¡ç®—

### 4.1 åˆ©æ¯ç´¯ç§¯æœºåˆ¶

å€Ÿè´·åè®®éœ€è¦**è¿ç»­ç´¯ç§¯åˆ©æ¯**ï¼Œä½†åŒºå—é“¾æ˜¯ç¦»æ•£çš„ï¼š

```
æŒ‘æˆ˜ï¼š
  - åŒºå—é“¾æ—¶é—´ä¸è¿ç»­ï¼ˆæ¯ç§’æˆ–æ›´é•¿ï¼‰
  - ä¸èƒ½å®æ—¶è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„åˆ©æ¯
  - éœ€è¦é«˜æ•ˆçš„æ‰¹é‡è®¡ç®—æ–¹æ³•

è§£å†³æ–¹æ¡ˆï¼šåˆ©æ¯æŒ‡æ•°ï¼ˆInterest Indexï¼‰
  - å…¨å±€ç´¯ç§¯åˆ©æ¯æŒ‡æ•°
  - ç”¨æˆ·åªå­˜å‚¨æœ¬é‡‘å’Œä¸Šæ¬¡æ›´æ–°æ—¶çš„æŒ‡æ•°
  - è®¡ç®—æ—¶ä½¿ç”¨æŒ‡æ•°å·®å€¼
```

### 4.2 åˆ©æ¯æŒ‡æ•°åŸç†

```
æ ¸å¿ƒæ€æƒ³ï¼š
  å°†åˆ©æ¯ç´¯ç§¯è½¬åŒ–ä¸ºæŒ‡æ•°å¢é•¿

å…¬å¼ï¼š
  æ–°æŒ‡æ•° = æ—§æŒ‡æ•° Ã— (1 + åˆ©ç‡ Ã— æ—¶é—´é—´éš”)

ç¤ºä¾‹ï¼š
  åˆå§‹æŒ‡æ•° = 1.0
  åˆ©ç‡ = 10% per year = 0.0000000031709 per second
  æ—¶é—´é—´éš” = 1 ç§’
  
  æ–°æŒ‡æ•° = 1.0 Ã— (1 + 0.0000000031709 Ã— 1)
        = 1.0000000031709
  
  1000 ç§’åï¼š
  æ–°æŒ‡æ•° = 1.0 Ã— (1.0000000031709)^1000
        â‰ˆ 1.00000003171
```

### 4.3 å€Ÿæ¬¾æŒ‡æ•° (Borrow Index)

```
å®šä¹‰ï¼š
  è¿½è¸ªå€Ÿæ¬¾åˆ©æ¯çš„ç´¯ç§¯æŒ‡æ•°

æ›´æ–°æ—¶æœºï¼š
  - æ¯æ¬¡æœ‰å€Ÿæ¬¾/è¿˜æ¬¾æ“ä½œ
  - æ¯æ¬¡åˆ©ç‡å˜åŒ–
  - å®šæœŸæ›´æ–°ï¼ˆæ¯ä¸ªåŒºå—ï¼‰

è®¡ç®—å…¬å¼ï¼š
  New_Borrow_Index = Old_Borrow_Index Ã— (1 + Borrow_Rate Ã— Time_Delta)

ç”¨æˆ·å€Ÿæ¬¾è®¡ç®—ï¼š
  Current_Borrow = Principal Ã— (Current_Borrow_Index / User_Borrow_Index)
  
  å…¶ä¸­ï¼š
    Principal: ç”¨æˆ·çš„å€Ÿæ¬¾æœ¬é‡‘
    User_Borrow_Index: ç”¨æˆ·å€Ÿæ¬¾æ—¶çš„æŒ‡æ•°
    Current_Borrow_Index: å½“å‰çš„æŒ‡æ•°
```

### 4.4 å­˜æ¬¾æŒ‡æ•° (Supply Index)

```
å®šä¹‰ï¼š
  è¿½è¸ªå­˜æ¬¾åˆ©æ¯çš„ç´¯ç§¯æŒ‡æ•°

æ›´æ–°æ—¶æœºï¼š
  - ä¸å€Ÿæ¬¾æŒ‡æ•°åŒæ­¥æ›´æ–°

è®¡ç®—å…¬å¼ï¼š
  New_Supply_Index = Old_Supply_Index Ã— (1 + Supply_Rate Ã— Time_Delta)

ç”¨æˆ·å­˜æ¬¾è®¡ç®—ï¼š
  Current_Deposit = Principal Ã— (Current_Supply_Index / User_Supply_Index)
```

### 4.5 å®Œæ•´ä»£ç å®ç°

```move
/// å¸‚åœºçŠ¶æ€
struct MarketState has store {
    total_deposits: u128,              // æ€»å­˜æ¬¾ï¼ˆæœ¬é‡‘ï¼‰
    total_borrows: u128,               // æ€»å€Ÿæ¬¾ï¼ˆæœ¬é‡‘ï¼‰
    borrow_index: u128,                // å€Ÿæ¬¾æŒ‡æ•°
    supply_index: u128,                // å­˜æ¬¾æŒ‡æ•°
    last_update_timestamp: u64,        // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
    interest_rate_model: KinkedInterestRateModel,
}

/// ç”¨æˆ·è´¦æˆ·
struct UserAccount has store {
    deposit_principal: u128,           // å­˜æ¬¾æœ¬é‡‘
    deposit_index: u128,               // å­˜æ¬¾æ—¶çš„æŒ‡æ•°
    borrow_principal: u128,            // å€Ÿæ¬¾æœ¬é‡‘
    borrow_index: u128,                // å€Ÿæ¬¾æ—¶çš„æŒ‡æ•°
}

/// æ›´æ–°å¸‚åœºåˆ©æ¯æŒ‡æ•°
public fun accrue_interest(market: &mut MarketState, current_timestamp: u64) {
    let time_delta = current_timestamp - market.last_update_timestamp;
    
    if (time_delta == 0) {
        return // åŒä¸€æ—¶åˆ»ï¼Œæ— éœ€æ›´æ–°
    };
    
    // è®¡ç®—ä½¿ç”¨ç‡
    let utilization = if (market.total_deposits == 0) {
        0
    } else {
        (market.total_borrows * PRECISION) / market.total_deposits
    };
    
    // è®¡ç®—å€Ÿæ¬¾åˆ©ç‡ï¼ˆæ¯ç§’ï¼‰
    let borrow_rate = get_borrow_rate(&market.interest_rate_model, utilization);
    
    // è®¡ç®—å­˜æ¬¾åˆ©ç‡ï¼ˆæ¯ç§’ï¼‰
    let supply_rate = get_supply_rate(&market.interest_rate_model, utilization, borrow_rate);
    
    // æ›´æ–°å€Ÿæ¬¾æŒ‡æ•°
    // new_index = old_index * (1 + rate * time_delta)
    let borrow_interest_factor = PRECISION + (borrow_rate * (time_delta as u128));
    market.borrow_index = (market.borrow_index * borrow_interest_factor) / PRECISION;
    
    // æ›´æ–°å­˜æ¬¾æŒ‡æ•°
    let supply_interest_factor = PRECISION + (supply_rate * (time_delta as u128));
    market.supply_index = (market.supply_index * supply_interest_factor) / PRECISION;
    
    // æ›´æ–°æ€»å€Ÿæ¬¾ï¼ˆè€ƒè™‘åˆ©æ¯ï¼‰
    market.total_borrows = (market.total_borrows * borrow_interest_factor) / PRECISION;
    
    // æ›´æ–°æ—¶é—´æˆ³
    market.last_update_timestamp = current_timestamp;
}

/// è®¡ç®—ç”¨æˆ·å½“å‰å€Ÿæ¬¾ä½™é¢ï¼ˆå«åˆ©æ¯ï¼‰
public fun get_borrow_balance(
    user: &UserAccount,
    market: &MarketState
): u128 {
    if (user.borrow_principal == 0) {
        return 0
    };
    
    // current_balance = principal * (current_index / user_index)
    (user.borrow_principal * market.borrow_index) / user.borrow_index
}

/// è®¡ç®—ç”¨æˆ·å½“å‰å­˜æ¬¾ä½™é¢ï¼ˆå«åˆ©æ¯ï¼‰
public fun get_deposit_balance(
    user: &UserAccount,
    market: &MarketState
): u128 {
    if (user.deposit_principal == 0) {
        return 0
    };
    
    // current_balance = principal * (current_index / user_index)
    (user.deposit_principal * market.supply_index) / user.deposit_index
}
```

### 4.6 ç²¾åº¦å¤„ç†ç¤ºä¾‹

```
åœºæ™¯ï¼šç”¨æˆ·å€Ÿæ¬¾ 1000 USDC

åˆå§‹çŠ¶æ€ï¼š
  Borrow_Index = 1.0 Ã— 10^18
  User_Borrow_Principal = 1000 Ã— 10^6 (USDC 6 ä½å°æ•°)
  User_Borrow_Index = 1.0 Ã— 10^18

10 å¤©åï¼ˆåˆ©ç‡ 10% APRï¼‰ï¼š
  æ—¶é—´é—´éš” = 10 Ã— 24 Ã— 3600 = 864,000 ç§’
  æ¯ç§’åˆ©ç‡ = 10% / 31,536,000 â‰ˆ 3.17 Ã— 10^-9
  
  åˆ©æ¯å› å­ = 1 + (3.17 Ã— 10^-9 Ã— 864,000)
           = 1 + 0.00274
           = 1.00274
  
  New_Borrow_Index = 1.0 Ã— 10^18 Ã— 1.00274
                   = 1.00274 Ã— 10^18
  
  ç”¨æˆ·å½“å‰å€Ÿæ¬¾ = 1000 Ã— 10^6 Ã— (1.00274 Ã— 10^18 / 1.0 Ã— 10^18)
              = 1000 Ã— 10^6 Ã— 1.00274
              = 1,002,740,000 (1002.74 USDC)
  
  åˆ©æ¯ = 1002.74 - 1000 = 2.74 USDC
```

---

## 5. æ¸…ç®—æœºåˆ¶æ·±åº¦è§£æ

### 5.1 æ¸…ç®—çš„æœ¬è´¨

```
ä»€ä¹ˆæ˜¯æ¸…ç®—ï¼Ÿ
  å½“å€Ÿæ¬¾äººçš„æŠµæŠ¼å“ä»·å€¼ä¸è¶³ä»¥æ”¯æ’‘å…¶å€ºåŠ¡æ—¶ï¼Œ
  åè®®å…è®¸ç¬¬ä¸‰æ–¹ï¼ˆæ¸…ç®—äººï¼‰ä»£ä¸ºå¿è¿˜éƒ¨åˆ†å€ºåŠ¡ï¼Œ
  å¹¶è·å¾—æŠ˜æ‰£ä»·çš„æŠµæŠ¼å“ä½œä¸ºå¥–åŠ±ã€‚

ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç®—ï¼Ÿ
  1. ä¿æŠ¤åè®®ï¼šé˜²æ­¢åè´¦ç´¯ç§¯
  2. ä¿æŠ¤å­˜æ¬¾äººï¼šç¡®ä¿èµ„é‡‘å®‰å…¨
  3. å¸‚åœºæœºåˆ¶ï¼šé€šè¿‡æ¿€åŠ±å¸å¼•æ¸…ç®—äºº
  4. é£é™©æ§åˆ¶ï¼šåŠæ—¶å¤„ç†ä¸è‰¯å¤´å¯¸

æ¸…ç®—æµç¨‹ï¼š
  1. ç›‘æ§å¥åº·å› å­
  2. è§¦å‘æ¸…ç®—ï¼ˆHF < 1.0ï¼‰
  3. æ¸…ç®—äººå¿è¿˜å€ºåŠ¡
  4. æ¸…ç®—äººè·å¾—æŠµæŠ¼å“ + å¥–åŠ±
  5. æ›´æ–°ç”¨æˆ·å¤´å¯¸
```

### 5.2 æ¸…ç®—è§¦å‘æ¡ä»¶

```
åŸºæœ¬æ¡ä»¶ï¼š
  Health_Factor < 1.0

è¯¦ç»†æ£€æŸ¥ï¼š
  1. è®¡ç®—ç”¨æˆ·å¥åº·å› å­
  2. æ£€æŸ¥æ˜¯å¦ä½äºé˜ˆå€¼
  3. éªŒè¯ä»·æ ¼æ•°æ®æœ‰æ•ˆæ€§
  4. ç¡®è®¤å¯æ¸…ç®—é‡‘é¢

å¥åº·å› å­è®¡ç®—ï¼ˆå¤ä¹ ï¼‰ï¼š
  HF = (æ€»æŠµæŠ¼å“ä»·å€¼ Ã— åŠ æƒæŠµæŠ¼ç‡) / æ€»å€ºåŠ¡ä»·å€¼
  
ç¤ºä¾‹ï¼š
  æŠµæŠ¼å“ï¼š1 ETH = $2000ï¼ŒæŠµæŠ¼ç‡ 75%
  å€ºåŠ¡ï¼š1800 USDC = $1800
  
  HF = ($2000 Ã— 75%) / $1800 = $1500 / $1800 = 0.833
  
  ç»“è®ºï¼šHF = 0.833 < 1.0ï¼Œå¯ä»¥è¢«æ¸…ç®—
```

### 5.3 æ¸…ç®—é‡‘é¢è®¡ç®—

å¤§å¤šæ•°åè®®é‡‡ç”¨**éƒ¨åˆ†æ¸…ç®—**ç­–ç•¥ï¼š

```
éƒ¨åˆ†æ¸…ç®—å…¬å¼ï¼š
  Max_Liquidation_Amount = Total_Debt Ã— Close_Factor
  
  å…¶ä¸­ï¼š
    Close_Factor: å•æ¬¡æ¸…ç®—æ¯”ä¾‹ï¼ˆå¦‚ 50%ï¼‰
    
ç¤ºä¾‹ï¼š
  ç”¨æˆ·æ€»å€ºåŠ¡ = 1800 USDC
  Close_Factor = 50%
  
  æœ€å¤§æ¸…ç®—é‡‘é¢ = 1800 Ã— 50% = 900 USDC
  
  æ¸…ç®—äººæœ€å¤šå¯ä»¥å¿è¿˜ 900 USDC å€ºåŠ¡
```

### 5.4 æ¸…ç®—å¥–åŠ±è®¡ç®—

```
æ¸…ç®—å¥–åŠ±æœºåˆ¶ï¼š
  æ¸…ç®—äººè·å¾—ä»·å€¼é«˜äºå¿è¿˜å€ºåŠ¡çš„æŠµæŠ¼å“

å…¬å¼ï¼š
  æŠµæŠ¼å“è·å¾— = (å¿è¿˜å€ºåŠ¡é‡‘é¢ Ã— (1 + æ¸…ç®—å¥–åŠ±)) / æŠµæŠ¼å“ä»·æ ¼
  
ç¤ºä¾‹ï¼š
  å¿è¿˜å€ºåŠ¡ï¼š900 USDC
  æ¸…ç®—å¥–åŠ±ï¼š10%
  ETH ä»·æ ¼ï¼š$2000
  
  åº”è·å¾— ETH = (900 Ã— 1.10) / 2000
              = 990 / 2000
              = 0.495 ETH
  
  æ¸…ç®—äººè·åˆ©ï¼š
    æ”¯ä»˜ï¼š900 USDC
    è·å¾—ï¼š0.495 ETH Ã— $2000 = $990
    åˆ©æ¶¦ï¼š$990 - $900 = $90 (10%)
```

### 5.5 æ¸…ç®—æƒ©ç½š

```
æ¸…ç®—æƒ©ç½šï¼š
  è¢«æ¸…ç®—ç”¨æˆ·é™¤äº†å¤±å»æŠµæŠ¼å“ï¼Œè¿˜è¦é¢å¤–æ”¯ä»˜ç½šé‡‘

å…¬å¼ï¼š
  æ¸…ç®—æƒ©ç½š = å¿è¿˜å€ºåŠ¡é‡‘é¢ Ã— æ¸…ç®—æƒ©ç½šç‡
  
åˆ†é…ï¼š
  æ¸…ç®—æƒ©ç½š = æ¸…ç®—å¥–åŠ± + åè®®æ”¶å…¥
  
ç¤ºä¾‹ï¼š
  å¿è¿˜å€ºåŠ¡ï¼š900 USDC
  æ¸…ç®—æƒ©ç½šç‡ï¼š12%
  æ¸…ç®—å¥–åŠ±ç‡ï¼š10%
  åè®®æ”¶å…¥ç‡ï¼š2%
  
  æ€»æƒ©ç½š = 900 Ã— 12% = 108 USDC
  æ¸…ç®—äººè·å¾— = 900 Ã— 10% = 90 USDC
  åè®®æ”¶å…¥ = 900 Ã— 2% = 18 USDC
  
  ç”¨æˆ·æŸå¤±ï¼š
    å€ºåŠ¡å‡å°‘ï¼š900 USDC
    æŠµæŠ¼å“æŸå¤±ï¼š900 + 108 = 1008 USDC ç­‰å€¼çš„æŠµæŠ¼å“
    é¢å¤–æŸå¤±ï¼š108 USDCï¼ˆæƒ©ç½šï¼‰
```

### 5.6 æ¸…ç®—ä»£ç å®ç°

```move
/// æ¸…ç®—é…ç½®
struct LiquidationConfig has store {
    close_factor: u128,              // å•æ¬¡æ¸…ç®—æ¯”ä¾‹ï¼ˆç²¾åº¦ 1e18ï¼‰
    liquidation_incentive: u128,     // æ¸…ç®—å¥–åŠ±ç‡ï¼ˆç²¾åº¦ 1e18ï¼‰
    liquidation_penalty: u128,       // æ¸…ç®—æƒ©ç½šç‡ï¼ˆç²¾åº¦ 1e18ï¼‰
    min_health_factor: u128,         // æœ€å°å¥åº·å› å­ï¼ˆæ¸…ç®—é˜ˆå€¼ï¼‰
}

/// æ¸…ç®—ä¿¡æ¯
struct LiquidationInfo has drop {
    can_liquidate: bool,             // æ˜¯å¦å¯æ¸…ç®—
    max_repay_amount: u128,          // æœ€å¤§å¿è¿˜é‡‘é¢
    collateral_to_seize: u128,       // åº”è·å¾—çš„æŠµæŠ¼å“
    liquidation_reward: u128,        // æ¸…ç®—å¥–åŠ±
}

/// æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¸…ç®—
public fun check_liquidation(
    user: address,
    config: &LiquidationConfig
): bool {
    let health_factor = calculate_health_factor(user);
    health_factor < config.min_health_factor
}

/// è®¡ç®—æ¸…ç®—ä¿¡æ¯
public fun calculate_liquidation_info(
    borrower: address,
    repay_asset: address,        // è¦å¿è¿˜çš„å€ºåŠ¡èµ„äº§
    collateral_asset: address,   // è¦è·å–çš„æŠµæŠ¼å“èµ„äº§
    repay_amount: u128,          // æ¸…ç®—äººæƒ³å¿è¿˜çš„é‡‘é¢
    config: &LiquidationConfig
): LiquidationInfo {
    // 1. æ£€æŸ¥å¥åº·å› å­
    let health_factor = calculate_health_factor(borrower);
    if (health_factor >= config.min_health_factor) {
        return LiquidationInfo {
            can_liquidate: false,
            max_repay_amount: 0,
            collateral_to_seize: 0,
            liquidation_reward: 0,
        }
    };
    
    // 2. è®¡ç®—æœ€å¤§æ¸…ç®—é‡‘é¢
    let total_borrow = get_user_borrow_balance(borrower, repay_asset);
    let max_repay = (total_borrow * config.close_factor) / PRECISION;
    
    // 3. é™åˆ¶å®é™…å¿è¿˜é‡‘é¢
    let actual_repay = if (repay_amount > max_repay) {
        max_repay
    } else {
        repay_amount
    };
    
    // 4. è®¡ç®—åº”è·å¾—çš„æŠµæŠ¼å“
    // collateral = (repay_amount * (1 + incentive) * repay_price) / collateral_price
    let repay_price = oracle::get_price(repay_asset);
    let collateral_price = oracle::get_price(collateral_asset);
    
    let repay_value = (actual_repay * repay_price) / PRICE_PRECISION;
    let incentive_value = (repay_value * config.liquidation_incentive) / PRECISION;
    let total_value = repay_value + incentive_value;
    let collateral_amount = (total_value * PRICE_PRECISION) / collateral_price;
    
    // 5. è®¡ç®—å¥–åŠ±
    let reward = (actual_repay * config.liquidation_incentive) / PRECISION;
    
    LiquidationInfo {
        can_liquidate: true,
        max_repay_amount: actual_repay,
        collateral_to_seize: collateral_amount,
        liquidation_reward: reward,
    }
}

/// æ‰§è¡Œæ¸…ç®—
public entry fun liquidate(
    liquidator: &signer,
    borrower: address,
    repay_asset: address,
    collateral_asset: address,
    repay_amount: u128,
    config: &LiquidationConfig
) acquires MarketState, UserAccount {
    let liquidator_addr = signer::address_of(liquidator);
    
    // 1. æ›´æ–°å¸‚åœºåˆ©æ¯
    let current_time = timestamp::now_seconds();
    accrue_interest(borrow_global_mut<MarketState>(repay_asset), current_time);
    accrue_interest(borrow_global_mut<MarketState>(collateral_asset), current_time);
    
    // 2. è®¡ç®—æ¸…ç®—ä¿¡æ¯
    let info = calculate_liquidation_info(
        borrower,
        repay_asset,
        collateral_asset,
        repay_amount,
        config
    );
    
    assert!(info.can_liquidate, ERROR_NOT_LIQUIDATABLE);
    assert!(info.max_repay_amount > 0, ERROR_ZERO_LIQUIDATION);
    
    // 3. è½¬ç§»å¿è¿˜èµ„äº§ï¼ˆä»æ¸…ç®—äººåˆ°åè®®ï¼‰
    transfer_asset(liquidator_addr, repay_asset, info.max_repay_amount);
    
    // 4. å‡å°‘å€Ÿæ¬¾äººçš„å€ºåŠ¡
    reduce_borrow(borrower, repay_asset, info.max_repay_amount);
    
    // 5. è½¬ç§»æŠµæŠ¼å“ï¼ˆä»å€Ÿæ¬¾äººåˆ°æ¸…ç®—äººï¼‰
    transfer_collateral(
        borrower,
        liquidator_addr,
        collateral_asset,
        info.collateral_to_seize
    );
    
    // 6. æ›´æ–°å¥åº·å› å­
    let new_health_factor = calculate_health_factor(borrower);
    
    // 7. å‘å‡ºæ¸…ç®—äº‹ä»¶
    emit_liquidation_event(
        liquidator_addr,
        borrower,
        repay_asset,
        collateral_asset,
        info.max_repay_amount,
        info.collateral_to_seize,
        new_health_factor
    );
}
```

---

## 6. æ¸…ç®—æ¿€åŠ±ä¸æƒ©ç½š

### 6.1 æ¿€åŠ±æœºåˆ¶è®¾è®¡

```
ç›®æ ‡ï¼š
  1. å¸å¼•æ¸…ç®—äººåŠæ—¶æ¸…ç®—
  2. è¡¥å¿æ¸…ç®—äººçš„ Gas æˆæœ¬
  3. å¥–åŠ±é£é™©æ‰¿æ‹…
  4. ä¿æŒå¸‚åœºæ•ˆç‡

æ¸…ç®—äººæ”¶ç›Šæ¥æºï¼š
  1. æ¸…ç®—å¥–åŠ±ï¼ˆä¸»è¦ï¼‰
  2. ä»·æ ¼å·®å¼‚ï¼ˆæ¬¡è¦ï¼‰
  3. æ‰¹é‡æ¸…ç®—ä¼˜åŒ–
```

### 6.2 æ¸…ç®—å¥–åŠ±è®¾ç½®

```
ä¸åŒèµ„äº§çš„å¥–åŠ±ç‡ï¼š

ç¨³å®šå¸ï¼ˆä½é£é™©ï¼‰ï¼š
  - æ¸…ç®—å¥–åŠ±ï¼š3-5%
  - ç†ç”±ï¼šä»·æ ¼ç¨³å®šï¼Œé£é™©ä½
  - ç¤ºä¾‹ï¼šUSDC, USDT, DAI

ä¸»æµå¸ï¼ˆä¸­é£é™©ï¼‰ï¼š
  - æ¸…ç®—å¥–åŠ±ï¼š8-10%
  - ç†ç”±ï¼šä»·æ ¼æ³¢åŠ¨é€‚ä¸­
  - ç¤ºä¾‹ï¼šETH, BTC

å±±å¯¨å¸ï¼ˆé«˜é£é™©ï¼‰ï¼š
  - æ¸…ç®—å¥–åŠ±ï¼š12-20%
  - ç†ç”±ï¼šä»·æ ¼æ³¢åŠ¨å¤§ï¼ŒæµåŠ¨æ€§å·®
  - ç¤ºä¾‹ï¼šå°å¸‚å€¼ä»£å¸

è®¡ç®—ç¤ºä¾‹ï¼š
  å¿è¿˜ 1000 USDC å€ºåŠ¡
  æ¸…ç®—å¥–åŠ± 10%
  ETH ä»·æ ¼ $2000
  
  æ¸…ç®—äººè·åˆ©ï¼š
    æ”¯ä»˜ï¼š1000 USDC
    è·å¾—ï¼š(1000 Ã— 1.10) / 2000 = 0.55 ETH
    ä»·å€¼ï¼š0.55 Ã— $2000 = $1100
    åˆ©æ¶¦ï¼š$100 (10%)
```

### 6.3 æ¸…ç®—æƒ©ç½šè®¾ç½®

```
ç›®çš„ï¼š
  1. æƒ©ç½šé£é™©ç®¡ç†ä¸å½“
  2. ä¸ºæ¸…ç®—äººæä¾›æ¿€åŠ±
  3. åè®®æ”¶å…¥æ¥æº
  4. é¿å…æ•…æ„åˆ¶é€ æ¸…ç®—

æƒ©ç½š = å¥–åŠ± + åè®®æ”¶å…¥

ç¤ºä¾‹é…ç½®ï¼š
  æ¸…ç®—æƒ©ç½šç‡ï¼š12%
  æ¸…ç®—å¥–åŠ±ç‡ï¼š10%
  åè®®æ”¶å…¥ç‡ï¼š2%
  
  å¿è¿˜ 1000 USDCï¼š
    æ€»æƒ©ç½š = 1000 Ã— 12% = 120 USDC
    æ¸…ç®—äºº = 1000 Ã— 10% = 100 USDC
    åè®® = 1000 Ã— 2% = 20 USDC
```

### 6.4 æ¸…ç®—ä¿æŠ¤æœºåˆ¶

```
1. Close Factorï¼ˆå•æ¬¡æ¸…ç®—æ¯”ä¾‹ï¼‰
   - é™åˆ¶ï¼šé€šå¸¸ 50%
   - ç›®çš„ï¼šé¿å…è¿‡åº¦æ¸…ç®—
   - æ•ˆæœï¼šç»™ç”¨æˆ·è¡¥ä»“æœºä¼š

2. æ¸…ç®—ä¸Šé™
   - å•ç¬”æ¸…ç®—é‡‘é¢ä¸Šé™
   - é¿å…å¤§é¢æ¸…ç®—å½±å“å¸‚åœº
   
3. æ¸…ç®—å»¶è¿Ÿ
   - å¥åº·å› å­ç¼“å†²åŒº
   - è§¦å‘ç‚¹ï¼šHF < 0.98ï¼ˆè€Œé 1.0ï¼‰
   - ç»™ç”¨æˆ·é¢„è­¦æ—¶é—´

4. ä»·æ ¼æ£€æŸ¥
   - éªŒè¯é¢„è¨€æœºä»·æ ¼
   - é¿å…ä»·æ ¼æ“çºµ
   - ä½¿ç”¨å¤šæºä»·æ ¼

ä»£ç ç¤ºä¾‹ï¼š
```move
/// æ¸…ç®—ä¿æŠ¤é…ç½®
struct LiquidationProtection has store {
    close_factor: u128,              // 50% = 0.5 Ã— 10^18
    max_liquidation_amount: u128,    // å•ç¬”æœ€å¤§æ¸…ç®—é‡‘é¢
    health_factor_buffer: u128,      // ç¼“å†²åŒºï¼ˆå¦‚ 0.98 Ã— 10^18ï¼‰
    price_deviation_threshold: u128, // ä»·æ ¼åå·®é˜ˆå€¼
}

/// æ£€æŸ¥æ¸…ç®—æ˜¯å¦å®‰å…¨
public fun is_safe_to_liquidate(
    borrower: address,
    repay_amount: u128,
    protection: &LiquidationProtection
): bool {
    // 1. æ£€æŸ¥å¥åº·å› å­ï¼ˆå«ç¼“å†²ï¼‰
    let hf = calculate_health_factor(borrower);
    if (hf >= protection.health_factor_buffer) {
        return false
    };
    
    // 2. æ£€æŸ¥å•ç¬”ä¸Šé™
    if (repay_amount > protection.max_liquidation_amount) {
        return false
    };
    
    // 3. æ£€æŸ¥ä»·æ ¼åå·®
    if (!oracle::is_price_valid(protection.price_deviation_threshold)) {
        return false
    };
    
    true
}
```

---

## 7. æ¸…ç®—ç­–ç•¥ä¸ä¼˜åŒ–

### 7.1 æ¸…ç®—äººç­–ç•¥

```
ç­–ç•¥ 1: ç›‘æ§æ‰€æœ‰å¤´å¯¸
  - å®æ—¶è®¡ç®—å¥åº·å› å­
  - å»ºç«‹æ¸…ç®—é¢„è­¦ç³»ç»Ÿ
  - ä¼˜å…ˆæ¸…ç®—å¤§é¢å¤´å¯¸

ç­–ç•¥ 2: ä»·æ ¼ç›‘æ§
  - ç›‘æ§æŠµæŠ¼å“ä»·æ ¼ä¸‹è·Œ
  - é¢„æµ‹å¯èƒ½æ¸…ç®—çš„å¤´å¯¸
  - æå‰å‡†å¤‡èµ„é‡‘

ç­–ç•¥ 3: Gas ä¼˜åŒ–
  - æ‰¹é‡æ¸…ç®—
  - ä¼˜åŒ–åˆçº¦è°ƒç”¨
  - é€‰æ‹©æœ€ä¼˜ Gas ä»·æ ¼

ç­–ç•¥ 4: èµ„é‡‘ç®¡ç†
  - å‡†å¤‡å¤šç§èµ„äº§
  - é—ªç”µè´·ç»„åˆ
  - è‡ªåŠ¨å†å¹³è¡¡
```

### 7.2 æ‰¹é‡æ¸…ç®—

```
åœºæ™¯ï¼š
  å¸‚åœºæš´è·Œï¼Œå¤šä¸ªè´¦æˆ·åŒæ—¶å¯è¢«æ¸…ç®—

ä¼˜åŒ–æ–¹æ¡ˆï¼š
  1. æ‰¹é‡æ£€æŸ¥å¥åº·å› å­
  2. æŒ‰åˆ©æ¶¦æ’åº
  3. æ‰¹é‡æ‰§è¡Œæ¸…ç®—
  4. ä¼˜åŒ– Gas æˆæœ¬

ä»£ç æ¡†æ¶ï¼š
```move
/// æ‰¹é‡æ¸…ç®—
public entry fun batch_liquidate(
    liquidator: &signer,
    borrowers: vector<address>,
    repay_asset: address,
    collateral_asset: address,
    config: &LiquidationConfig
) {
    let i = 0;
    let len = vector::length(&borrowers);
    let total_profit = 0;
    
    while (i < len) {
        let borrower = *vector::borrow(&borrowers, i);
        
        // æ£€æŸ¥æ˜¯å¦å¯æ¸…ç®—
        if (check_liquidation(borrower, config)) {
            // è®¡ç®—æœ€ä¼˜æ¸…ç®—é‡‘é¢
            let info = calculate_optimal_liquidation(
                borrower,
                repay_asset,
                collateral_asset,
                config
            );
            
            // æ‰§è¡Œæ¸…ç®—
            execute_single_liquidation(
                liquidator,
                borrower,
                repay_asset,
                collateral_asset,
                info.max_repay_amount,
                config
            );
            
            total_profit = total_profit + info.liquidation_reward;
        };
        
        i = i + 1;
    };
    
    // å‘å‡ºæ‰¹é‡æ¸…ç®—äº‹ä»¶
    emit_batch_liquidation_event(liquidator, len, total_profit);
}
```

### 7.3 é—ªç”µè´·æ¸…ç®—

```
åŸç†ï¼š
  ä½¿ç”¨é—ªç”µè´·è·å–èµ„é‡‘ï¼Œæ‰§è¡Œæ¸…ç®—ï¼Œè·åˆ©åå½’è¿˜è´·æ¬¾

æµç¨‹ï¼š
  1. é—ªç”µè´·å€Ÿå…¥èµ„é‡‘
  2. å¿è¿˜ç›®æ ‡ç”¨æˆ·å€ºåŠ¡
  3. è·å¾—æŠ˜æ‰£æŠµæŠ¼å“
  4. å–å‡ºæŠµæŠ¼å“
  5. å½’è¿˜é—ªç”µè´· + æ‰‹ç»­è´¹
  6. ä¿ç•™åˆ©æ¶¦

ä¼˜åŠ¿ï¼š
  - æ— éœ€è‡ªæœ‰èµ„é‡‘
  - å¯æ¸…ç®—å¤§é¢å¤´å¯¸
  - æé«˜èµ„é‡‘æ•ˆç‡

é£é™©ï¼š
  - Gas æˆæœ¬å¯èƒ½è¶…è¿‡åˆ©æ¶¦
  - ä»·æ ¼æ»‘ç‚¹
  - é—ªç”µè´·æ‰‹ç»­è´¹

ä»£ç ç¤ºä¾‹ï¼š
```move
/// é—ªç”µè´·æ¸…ç®—
public entry fun flash_liquidate(
    liquidator: &signer,
    borrower: address,
    repay_asset: address,
    collateral_asset: address,
    flash_loan_amount: u128
) {
    // 1. é—ªç”µè´·å€Ÿæ¬¾
    let loan = flash_loan::borrow(repay_asset, flash_loan_amount);
    
    // 2. æ‰§è¡Œæ¸…ç®—
    liquidate(
        liquidator,
        borrower,
        repay_asset,
        collateral_asset,
        flash_loan_amount,
        &get_liquidation_config()
    );
    
    // 3. è·å¾—çš„æŠµæŠ¼å“
    let collateral_received = get_collateral_balance(liquidator, collateral_asset);
    
    // 4. å–å‡ºæŠµæŠ¼å“æ¢å›å¿è¿˜èµ„äº§
    let repay_asset_received = dex::swap(
        collateral_asset,
        repay_asset,
        collateral_received
    );
    
    // 5. å½’è¿˜é—ªç”µè´·
    flash_loan::repay(loan, repay_asset_received);
    
    // 6. å‰©ä½™å³ä¸ºåˆ©æ¶¦
}
```

### 7.4 æ¸…ç®—ä¼˜å…ˆçº§

```
ä¼˜å…ˆçº§æ’åºå› ç´ ï¼š

1. åˆ©æ¶¦å¤§å°
   - è®¡ç®—é¢„æœŸåˆ©æ¶¦
   - ä¼˜å…ˆæ¸…ç®—é«˜åˆ©æ¶¦å¤´å¯¸

2. å¥åº·å› å­
   - ä¼˜å…ˆæ¸…ç®—æœ€å±é™©å¤´å¯¸ï¼ˆHF æœ€ä½ï¼‰
   - é˜²æ­¢åè´¦ç´¯ç§¯

3. Gas æˆæœ¬
   - è€ƒè™‘ Gas ä»·æ ¼
   - è®¡ç®—å‡€åˆ©æ¶¦

4. èµ„äº§ç±»å‹
   - ä¼˜å…ˆæ¸…ç®—æµåŠ¨æ€§å¥½çš„èµ„äº§
   - é¿å…éš¾ä»¥å–å‡ºçš„æŠµæŠ¼å“

è¯„åˆ†å…¬å¼ï¼š
  Score = (Profit - Gas_Cost) Ã— Liquidity_Factor Ã— Urgency_Factor
  
  å…¶ä¸­ï¼š
    Liquidity_Factor: æµåŠ¨æ€§è¯„åˆ†ï¼ˆ0-1ï¼‰
    Urgency_Factor: ç´§æ€¥åº¦è¯„åˆ†ï¼ˆåŸºäº HFï¼‰
```

---

## 8. å®é™…æ¡ˆä¾‹åˆ†æ

### 8.1 Aave V3 åˆ©ç‡æ¨¡å‹

```
é…ç½®ï¼ˆUSDCï¼‰ï¼š
  Base_Rate = 0%
  Optimal_Utilization = 90%
  Slope_1 = 4%
  Slope_2 = 60%
  Reserve_Factor = 10%

åˆ©ç‡æ›²çº¿ï¼š
  U = 0%:   Borrow = 0%,    Supply = 0%
  U = 50%:  Borrow = 2.22%, Supply = 1.0%
  U = 90%:  Borrow = 4%,    Supply = 3.24%
  U = 95%:  Borrow = 34%,   Supply = 29.07%
  U = 100%: Borrow = 64%,   Supply = 57.6%

åˆ†æï¼š
  - æœ€ä¼˜ç‚¹ä¹‹å‰åˆ©ç‡å¾ˆä½ï¼Œé¼“åŠ±å€Ÿæ¬¾
  - è¶…è¿‡ 90% ååˆ©ç‡æš´æ¶¨ï¼Œä¿æŠ¤æµåŠ¨æ€§
  - å³ä½¿ 100% ä½¿ç”¨ç‡ï¼Œå­˜æ¬¾äººä»æœ‰æ”¶ç›Š
```

### 8.2 Compound V2 æ¸…ç®—æœºåˆ¶

```
é…ç½®ï¼š
  Close_Factor = 50%
  Liquidation_Incentive = 8%

ç¤ºä¾‹ï¼š
  ç”¨æˆ·æŠµæŠ¼ï¼š2 ETH ($4000)ï¼ŒæŠµæŠ¼ç‡ 75%
  å€Ÿæ¬¾ï¼š2400 USDC
  
  ä»·æ ¼å˜åŒ–ï¼š
    ETH è·Œè‡³ $1900
    æŠµæŠ¼å“ä»·å€¼ = 2 Ã— $1900 = $3800
    æŠµæŠ¼èƒ½åŠ› = $3800 Ã— 75% = $2850
    
  å¥åº·å› å­ï¼š
    HF = $2850 / $2400 = 1.1875
    
  ç»§ç»­ä¸‹è·Œï¼š
    ETH è·Œè‡³ $1600
    æŠµæŠ¼èƒ½åŠ› = 2 Ã— $1600 Ã— 75% = $2400
    HF = $2400 / $2400 = 1.0ï¼ˆä¸´ç•Œç‚¹ï¼‰
    
  è§¦å‘æ¸…ç®—ï¼š
    ETH è·Œè‡³ $1550
    æŠµæŠ¼èƒ½åŠ› = 2 Ã— $1550 Ã— 75% = $2325
    HF = $2325 / $2400 = 0.96875 < 1.0
    
  æ¸…ç®—æ‰§è¡Œï¼š
    æœ€å¤§å¿è¿˜ = 2400 Ã— 50% = 1200 USDC
    è·å¾— ETH = (1200 Ã— 1.08) / 1550 = 0.836 ETH
    
  æ¸…ç®—äººåˆ©æ¶¦ï¼š
    æ”¯ä»˜ï¼š1200 USDC
    è·å¾—ï¼š0.836 ETH Ã— $1550 = $1295.8
    åˆ©æ¶¦ï¼š$95.8 (8%)
    
  ç”¨æˆ·æŸå¤±ï¼š
    å€ºåŠ¡å‡å°‘ï¼š1200 USDC
    æŠµæŠ¼å“æŸå¤±ï¼š0.836 ETH ($1295.8)
    é¢å¤–æŸå¤±ï¼š$95.8ï¼ˆæƒ©ç½šï¼‰
```

### 8.3 æç«¯å¸‚åœºæƒ…å†µ

```
åœºæ™¯ï¼š312 æš´è·Œï¼ˆ2020å¹´3æœˆ12æ—¥ï¼‰

èƒŒæ™¯ï¼š
  - ETH ä» $200 è·Œè‡³ $100ï¼ˆ24å°æ—¶å†…ï¼‰
  - å¤§é‡æ¸…ç®—åŒæ—¶è§¦å‘
  - Gas ä»·æ ¼æš´æ¶¨
  - é¢„è¨€æœºå»¶è¿Ÿ

é—®é¢˜ï¼š
  1. æ¸…ç®—ç§¯å‹
     - ç­‰å¾…ç¡®è®¤çš„æ¸…ç®—äº¤æ˜“è¿‡å¤š
     - Gas ç«ä»·æˆ˜
     
  2. é¢„è¨€æœºå»¶è¿Ÿ
     - ä»·æ ¼æ›´æ–°ä¸åŠæ—¶
     - æ¸…ç®—è§¦å‘å»¶è¿Ÿ
     
  3. æµåŠ¨æ€§å±æœº
     - DEX æ»‘ç‚¹å·¨å¤§
     - æŠµæŠ¼å“éš¾ä»¥å–å‡º

åº”å¯¹æªæ–½ï¼ˆåè®®æ”¹è¿›ï¼‰ï¼š
  1. è·å…°å¼æ‹å–æ¸…ç®—
  2. å¤šæºé¢„è¨€æœº
  3. æ¸…ç®—ä¼˜å…ˆçº§é˜Ÿåˆ—
  4. æ–­è·¯å™¨æœºåˆ¶
```

### 8.4 æœ€ä½³å®è·µæ€»ç»“

```
åè®®è®¾è®¡ï¼š
  âœ… ä¿å®ˆçš„æŠµæŠ¼ç‡è®¾ç½®
  âœ… åˆç†çš„æ¸…ç®—æ¿€åŠ±
  âœ… å¤šå±‚æ¬¡çš„é£é™©ä¿æŠ¤
  âœ… é«˜è´¨é‡çš„ä»·æ ¼æº
  âœ… å®Œå–„çš„æµ‹è¯•

æ¸…ç®—äººç­–ç•¥ï¼š
  âœ… å®æ—¶ç›‘æ§ç³»ç»Ÿ
  âœ… å……è¶³çš„èµ„é‡‘å‡†å¤‡
  âœ… é—ªç”µè´·é›†æˆ
  âœ… Gas ä¼˜åŒ–
  âœ… é£é™©ç®¡ç†

ç”¨æˆ·ä¿æŠ¤ï¼š
  âœ… å¥åº·å› å­é¢„è­¦
  âœ… è‡ªåŠ¨è¡¥ä»“æœºåˆ¶
  âœ… éƒ¨åˆ†æ¸…ç®—ç­–ç•¥
  âœ… æ¸…ç®—å»¶è¿Ÿç¼“å†²
```

---

## ğŸ“Š æ€»ç»“å¯¹æ¯”

### åˆ©ç‡æ¨¡å‹å¯¹æ¯”

| ç‰¹æ€§ | çº¿æ€§æ¨¡å‹ | è·³è·ƒæ¨¡å‹ | ä¸‰æ®µå¼æ¨¡å‹ |
|------|----------|----------|------------|
| å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ | å¤æ‚ |
| Gas æˆæœ¬ | ä½ | ä¸­ | é«˜ |
| çµæ´»æ€§ | ä½ | é«˜ | å¾ˆé«˜ |
| é€‚ç”¨åœºæ™¯ | ç¨³å®šå¸ | é€šç”¨ | ç‰¹æ®Šèµ„äº§ |
| æµåŠ¨æ€§ä¿æŠ¤ | å¼± | å¼º | å¾ˆå¼º |

### æ¸…ç®—å‚æ•°å¯¹æ¯”

| èµ„äº§ç±»å‹ | æ¸…ç®—é˜ˆå€¼(LTV) | æ¸…ç®—æƒ©ç½š | æ¸…ç®—å¥–åŠ± | Close Factor |
|---------|--------------|----------|----------|--------------|
| ç¨³å®šå¸ | 80-85% | 3-5% | 3-5% | 50% |
| ä¸»æµå¸ | 70-75% | 8-12% | 8-10% | 50% |
| å±±å¯¨å¸ | 50-65% | 12-20% | 12-15% | 50% |

---

## ğŸ¯ å…³é”®è¦ç‚¹

### åˆ©ç‡æ¨¡å‹

1. **ä½¿ç”¨ç‡æ˜¯æ ¸å¿ƒ**: æ‰€æœ‰åˆ©ç‡æ¨¡å‹éƒ½åŸºäºä½¿ç”¨ç‡
2. **è·³è·ƒä¿æŠ¤æµåŠ¨æ€§**: é«˜ä½¿ç”¨ç‡æ—¶åˆ©ç‡æš´æ¶¨
3. **åŠ¨æ€å¹³è¡¡ä¾›éœ€**: è‡ªåŠ¨è°ƒèŠ‚å€Ÿè´·å¸‚åœº
4. **ç²¾åº¦è‡³å…³é‡è¦**: å¤åˆ©ç´¯ç§¯éœ€è¦é«˜ç²¾åº¦
5. **æ—¶é—´å¤„ç†**: æ­£ç¡®å¤„ç†åŒºå—æ—¶é—´é—´éš”

### æ¸…ç®—æœºåˆ¶

1. **å¥åº·å› å­æ˜¯è§¦å‘æ¡ä»¶**: HF < 1.0
2. **æ¿€åŠ±é©±åŠ¨æ•ˆç‡**: åˆç†æ¿€åŠ±å¸å¼•æ¸…ç®—äºº
3. **éƒ¨åˆ†æ¸…ç®—ä¿æŠ¤ç”¨æˆ·**: é¿å…è¿‡åº¦æ¸…ç®—
4. **é—ªç”µè´·æå‡æ•ˆç‡**: æ— éœ€è‡ªæœ‰èµ„é‡‘
5. **æç«¯æƒ…å†µå‡†å¤‡**: è®¾è®¡åº”å¯¹å¸‚åœºå±æœº

---

## ğŸ”— æ‰©å±•é˜…è¯»

- [Aave Risk Parameters](https://docs.aave.com/risk/asset-risk/methodology)
- [Compound Interest Rate Model](https://compound.finance/docs/interest-rates)
- [Gauntlet Risk Modeling](https://gauntlet.network/)
- [Euler Interest Rate Model](https://docs.euler.finance/getting-started/methodology/interest-rates)
- [Liquidation Analysis](https://arxiv.org/abs/2212.07306)

---

**æ­å–œä½ å®Œæˆç†è®ºå­¦ä¹ ï¼ç°åœ¨è®©æˆ‘ä»¬è¿›å…¥ä»£ç å®ç°éƒ¨åˆ†ã€‚** ğŸš€
