# äº‹ä»¶ç³»ç»Ÿä¸é“¾ä¸‹ç´¢å¼•æ ¸å¿ƒæ¦‚å¿µ

## ç¬¬ä¸€éƒ¨åˆ†ï¼šäº‹ä»¶ç³»ç»Ÿæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼Ÿ

äº‹ä»¶ï¼ˆEventï¼‰æ˜¯æ™ºèƒ½åˆçº¦å‘å¤–éƒ¨ä¸–ç•Œå‘é€ä¿¡æ¯çš„æœºåˆ¶ï¼Œç±»ä¼¼äºæ—¥å¿—è®°å½•ã€‚

**ç±»æ¯”ï¼šé¤å…çš„è®¢å•ç³»ç»Ÿ**
- åˆçº¦ = å¨æˆ¿
- äº‹ä»¶ = è®¢å•é€šçŸ¥é“ƒå£°
- é“¾ä¸‹ç›‘å¬å™¨ = æœåŠ¡å‘˜
- å½“å¨æˆ¿å®Œæˆè®¢å•æ—¶ï¼Œé“ƒå£°å“èµ·ï¼ŒæœåŠ¡å‘˜ç«‹å³çŸ¥é“å¹¶å»å–é¤

### 1.2 äº‹ä»¶ vs å­˜å‚¨æ•°æ®

| ç‰¹æ€§ | äº‹ä»¶ | å…¨å±€å­˜å‚¨ |
|------|------|----------|
| å¯é“¾ä¸Šè¯»å– | âŒ ä¸å¯ä»¥ | âœ… å¯ä»¥ |
| å¯é“¾ä¸‹ç›‘å¬ | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| å­˜å‚¨æˆæœ¬ | ä½ | é«˜ |
| å†å²è®°å½• | æ°¸ä¹…ä¿å­˜ | å¯è¢«è¦†ç›– |
| ç”¨é€” | é€šçŸ¥ã€æ—¥å¿—ã€ç´¢å¼• | çŠ¶æ€å­˜å‚¨ |

**å…³é”®ç†è§£**ï¼š
- äº‹ä»¶æ˜¯"**åªå†™**"çš„ï¼šåˆçº¦å‘å°„ï¼Œä½†ä¸èƒ½è¯»å–
- å­˜å‚¨æ˜¯"**è¯»å†™**"çš„ï¼šå¯ä»¥è¯»å–å’Œä¿®æ”¹
- äº‹ä»¶ç”¨äº**é€šçŸ¥**ï¼Œå­˜å‚¨ç”¨äº**çŠ¶æ€**

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šäº‹ä»¶çš„åŸºæœ¬ä½¿ç”¨

### 2.1 å£°æ˜äº‹ä»¶

äº‹ä»¶æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œé€šå¸¸å¸¦æœ‰ `drop` å’Œ `store` èƒ½åŠ›ï¼š

```move
struct TransferEvent has drop, store {
    from: address,
    to: address,
    amount: u64,
    timestamp: u64
}
```

**èƒ½åŠ›è¯´æ˜**ï¼š
- `drop`ï¼šäº‹ä»¶å‘å°„åå¯ä»¥è¢«ä¸¢å¼ƒ
- `store`ï¼šäº‹ä»¶å¯ä»¥å­˜å‚¨åœ¨ EventHandle ä¸­

### 2.2 EventHandle

`EventHandle` æ˜¯äº‹ä»¶çš„å®¹å™¨ï¼Œå¿…é¡»å­˜å‚¨åœ¨èµ„æºä¸­ï¼š

```move
use aptos_framework::event;

struct CoinStore has key {
    balance: u64,
    transfer_events: event::EventHandle<TransferEvent>
}
```

**åˆ›å»º EventHandle**ï¼š
```move
public fun create_account(account: &signer) {
    move_to(account, CoinStore {
        balance: 0,
        transfer_events: event::new_event_handle<TransferEvent>(account)
    });
}
```

### 2.3 å‘å°„äº‹ä»¶

ä½¿ç”¨ `event::emit_event` å‘å°„äº‹ä»¶ï¼š

```move
public fun transfer(
    from: &signer,
    to: address,
    amount: u64
) acquires CoinStore {
    let from_addr = signer::address_of(from);
    
    // è½¬è´¦é€»è¾‘...
    
    // å‘å°„äº‹ä»¶
    let from_store = borrow_global_mut<CoinStore>(from_addr);
    event::emit_event(
        &mut from_store.transfer_events,
        TransferEvent {
            from: from_addr,
            to,
            amount,
            timestamp: timestamp::now_seconds()
        }
    );
}
```

### 2.4 å®Œæ•´ç¤ºä¾‹

```move
module my_addr::simple_coin {
    use std::signer;
    use aptos_framework::event;
    use aptos_framework::timestamp;
    
    /// è½¬è´¦äº‹ä»¶
    struct TransferEvent has drop, store {
        from: address,
        to: address,
        amount: u64,
        timestamp: u64
    }
    
    /// é“¸å¸äº‹ä»¶
    struct MintEvent has drop, store {
        recipient: address,
        amount: u64,
        timestamp: u64
    }
    
    /// ä»£å¸å­˜å‚¨
    struct CoinStore has key {
        balance: u64,
        transfer_events: event::EventHandle<TransferEvent>,
        mint_events: event::EventHandle<MintEvent>
    }
    
    /// åˆ›å»ºè´¦æˆ·
    public fun register(account: &signer) {
        move_to(account, CoinStore {
            balance: 0,
            transfer_events: event::new_event_handle<TransferEvent>(account),
            mint_events: event::new_event_handle<MintEvent>(account)
        });
    }
    
    /// é“¸å¸
    public fun mint(account: &signer, amount: u64) acquires CoinStore {
        let addr = signer::address_of(account);
        let store = borrow_global_mut<CoinStore>(addr);
        
        store.balance = store.balance + amount;
        
        // å‘å°„é“¸å¸äº‹ä»¶
        event::emit_event(
            &mut store.mint_events,
            MintEvent {
                recipient: addr,
                amount,
                timestamp: timestamp::now_seconds()
            }
        );
    }
    
    /// è½¬è´¦
    public fun transfer(
        from: &signer,
        to: address,
        amount: u64
    ) acquires CoinStore {
        let from_addr = signer::address_of(from);
        
        // æ‰£é™¤å‘é€æ–¹ä½™é¢
        {
            let from_store = borrow_global_mut<CoinStore>(from_addr);
            assert!(from_store.balance >= amount, 1);
            from_store.balance = from_store.balance - amount;
        };
        
        // å¢åŠ æ¥æ”¶æ–¹ä½™é¢
        {
            let to_store = borrow_global_mut<CoinStore>(to);
            to_store.balance = to_store.balance + amount;
        };
        
        // å‘å°„è½¬è´¦äº‹ä»¶ï¼ˆåœ¨å‘é€æ–¹çš„ EventHandle ä¸­ï¼‰
        let from_store = borrow_global_mut<CoinStore>(from_addr);
        event::emit_event(
            &mut from_store.transfer_events,
            TransferEvent {
                from: from_addr,
                to,
                amount,
                timestamp: timestamp::now_seconds()
            }
        );
    }
}
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šäº‹ä»¶çš„é«˜çº§ç‰¹æ€§

### 3.1 äº‹ä»¶åºå·

æ¯ä¸ªäº‹ä»¶éƒ½æœ‰ä¸€ä¸ªè‡ªåŠ¨é€’å¢çš„åºå·ï¼ˆsequence numberï¼‰ï¼š

```
EventHandle {
    counter: 0,  // åˆå§‹ä¸º 0
    guid: {...}  // å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦
}

å‘å°„ç¬¬1ä¸ªäº‹ä»¶ -> counter = 1
å‘å°„ç¬¬2ä¸ªäº‹ä»¶ -> counter = 2
...
```

**ç”¨é€”**ï¼š
- ä¿è¯äº‹ä»¶é¡ºåº
- æ£€æµ‹æ˜¯å¦æœ‰é—æ¼çš„äº‹ä»¶
- ä»ç‰¹å®šåºå·å¼€å§‹æŸ¥è¯¢

### 3.2 å¤šä¸ª EventHandle

ä¸€ä¸ªèµ„æºå¯ä»¥æœ‰å¤šä¸ª EventHandleï¼š

```move
struct DEX has key {
    liquidity: u64,
    
    // ä¸åŒç±»å‹çš„äº‹ä»¶
    swap_events: event::EventHandle<SwapEvent>,
    add_liquidity_events: event::EventHandle<AddLiquidityEvent>,
    remove_liquidity_events: event::EventHandle<RemoveLiquidityEvent>
}
```

**æœ€ä½³å®è·µ**ï¼šæŒ‰äº‹ä»¶ç±»å‹åˆ†ç±»ï¼Œä¾¿äºé“¾ä¸‹ç›‘å¬

### 3.3 äº‹ä»¶æ•°æ®è®¾è®¡

**åŸåˆ™ 1ï¼šç²¾ç®€ä½†å®Œæ•´**
```move
// âœ… å¥½çš„è®¾è®¡
struct TradeEvent has drop, store {
    trader: address,
    token_in: TypeInfo,  // è¾“å…¥ä»£å¸ç±»å‹
    amount_in: u64,
    token_out: TypeInfo, // è¾“å‡ºä»£å¸ç±»å‹
    amount_out: u64,
    timestamp: u64
}

// âŒ ä¸å¥½ï¼šæ•°æ®è¿‡å¤š
struct TradeEvent has drop, store {
    trader: address,
    full_trade_history: vector<u8>,  // å¤ªå¤§ï¼
    ...
}
```

**åŸåˆ™ 2ï¼šåŒ…å«å…³é”®æŸ¥è¯¢å­—æ®µ**
```move
struct OrderEvent has drop, store {
    order_id: u64,        // ç”¨äºç²¾ç¡®æŸ¥è¯¢
    user: address,         // ç”¨äºæŒ‰ç”¨æˆ·æŸ¥è¯¢
    price: u64,
    amount: u64,
    order_type: u8,        // ç”¨äºæŒ‰ç±»å‹ç­›é€‰
    timestamp: u64         // ç”¨äºæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
}
```

### 3.4 æ¡ä»¶äº‹ä»¶å‘å°„

æ ¹æ®ä¸åŒæƒ…å†µå‘å°„ä¸åŒäº‹ä»¶ï¼š

```move
public fun execute_trade(
    user: &signer,
    order_type: u8,
    amount: u64
) acquires TradingPlatform {
    let platform = borrow_global_mut<TradingPlatform>(@platform_addr);
    
    if (order_type == ORDER_TYPE_MARKET) {
        // å¸‚ä»·å•
        event::emit_event(
            &mut platform.market_order_events,
            MarketOrderEvent { ... }
        );
    } else {
        // é™ä»·å•
        event::emit_event(
            &mut platform.limit_order_events,
            LimitOrderEvent { ... }
        );
    };
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šé“¾ä¸‹ç´¢å¼•

### 4.1 ä»€ä¹ˆæ˜¯ç´¢å¼•å™¨ï¼Ÿ

ç´¢å¼•å™¨ï¼ˆIndexerï¼‰æ˜¯é“¾ä¸‹æœåŠ¡ï¼Œç›‘å¬åŒºå—é“¾äº‹ä»¶å¹¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚

**å·¥ä½œæµç¨‹**ï¼š
```
åŒºå—é“¾ -> äº‹ä»¶ -> ç´¢å¼•å™¨ -> æ•°æ®åº“ -> API -> å‰ç«¯
```

**ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•å™¨ï¼Ÿ**
1. é“¾ä¸ŠæŸ¥è¯¢æ…¢ä¸”è´µ
2. éœ€è¦å¤æ‚æŸ¥è¯¢ï¼ˆå¦‚æŒ‰æ—¶é—´èŒƒå›´ã€èšåˆç»Ÿè®¡ï¼‰
3. éœ€è¦å†å²æ•°æ®åˆ†æ

### 4.2 Aptos ç´¢å¼•å™¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Aptos Node â”‚ å‘å°„äº‹ä»¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Indexer   â”‚ ç›‘å¬å¹¶è§£æ
â”‚  Processor  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL â”‚ å­˜å‚¨æ•°æ®
â”‚   Database  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GraphQL    â”‚ æä¾›æŸ¥è¯¢
â”‚     API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ç›‘å¬äº‹ä»¶ï¼ˆé“¾ä¸‹ä»£ç ï¼‰

**TypeScript ç¤ºä¾‹**ï¼š
```typescript
import { AptosClient } from "aptos";

const client = new AptosClient("https://fullnode.mainnet.aptoslabs.com");

// ç›‘å¬ç‰¹å®šè´¦æˆ·çš„äº‹ä»¶
async function listenToEvents() {
    const accountAddress = "0x1234...";
    const eventHandleStruct = "0x1::coin::CoinStore";
    const fieldName = "transfer_events";
    
    let sequenceNumber = 0;
    
    while (true) {
        try {
            const events = await client.getEventsByEventHandle(
                accountAddress,
                eventHandleStruct,
                fieldName,
                { start: sequenceNumber, limit: 10 }
            );
            
            for (const event of events) {
                console.log("æ–°äº‹ä»¶:", event.data);
                processEvent(event);
                sequenceNumber = event.sequence_number + 1;
            }
            
            await sleep(1000); // ç­‰å¾…1ç§’
        } catch (error) {
            console.error("ç›‘å¬é”™è¯¯:", error);
        }
    }
}

function processEvent(event: any) {
    // è§£æäº‹ä»¶æ•°æ®
    const { from, to, amount } = event.data;
    
    // å­˜å‚¨åˆ°æ•°æ®åº“
    db.insert({
        from,
        to,
        amount,
        timestamp: event.data.timestamp,
        tx_hash: event.transaction_hash
    });
}
```

### 4.4 GraphQL æŸ¥è¯¢ç¤ºä¾‹

```graphql
query GetTransferEvents {
  events(
    where: {
      type: {_eq: "0x1::coin::TransferEvent"}
      data: {
        from: {_eq: "0x1234..."}
        amount: {_gte: "1000000"}
      }
    }
    order_by: {transaction_version: desc}
    limit: 10
  ) {
    type
    data
    transaction_version
    sequence_number
  }
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨æ¨¡å¼

### 5.1 æ¨¡å¼ 1ï¼šäº¤æ˜“æ—¥å¿—ç³»ç»Ÿ

```move
module my_addr::transaction_log {
    use aptos_framework::event;
    
    struct ActionEvent has drop, store {
        user: address,
        action_type: u8,
        details: vector<u8>,
        timestamp: u64
    }
    
    struct Logger has key {
        events: event::EventHandle<ActionEvent>
    }
    
    public fun log_action(
        user: &signer,
        action_type: u8,
        details: vector<u8>
    ) acquires Logger {
        let logger = borrow_global_mut<Logger>(@module_addr);
        event::emit_event(
            &mut logger.events,
            ActionEvent {
                user: signer::address_of(user),
                action_type,
                details,
                timestamp: timestamp::now_seconds()
            }
        );
    }
}
```

### 5.2 æ¨¡å¼ 2ï¼šä»·æ ¼æ›´æ–°é€šçŸ¥

```move
struct PriceUpdateEvent has drop, store {
    token_pair: vector<u8>,  // e.g., "APT/USDC"
    old_price: u64,
    new_price: u64,
    timestamp: u64
}

public fun update_price(
    admin: &signer,
    new_price: u64
) acquires PriceOracle {
    let oracle = borrow_global_mut<PriceOracle>(@oracle_addr);
    let old_price = oracle.current_price;
    
    oracle.current_price = new_price;
    
    // å‘å°„ä»·æ ¼æ›´æ–°äº‹ä»¶
    event::emit_event(
        &mut oracle.price_events,
        PriceUpdateEvent {
            token_pair: b"APT/USDC",
            old_price,
            new_price,
            timestamp: timestamp::now_seconds()
        }
    );
}
```

### 5.3 æ¨¡å¼ 3ï¼šNFT æ´»åŠ¨è¿½è¸ª

```move
struct NFTEvent has drop, store {
    token_id: u64,
    event_type: u8,  // MINT=1, TRANSFER=2, BURN=3
    from: address,
    to: address,
    price: u64,
    timestamp: u64
}

public fun mint_nft(user: &signer) acquires NFTCollection {
    let collection = borrow_global_mut<NFTCollection>(@collection_addr);
    let token_id = collection.next_token_id;
    
    // é“¸é€ é€»è¾‘...
    
    event::emit_event(
        &mut collection.nft_events,
        NFTEvent {
            token_id,
            event_type: 1, // MINT
            from: @0x0,
            to: signer::address_of(user),
            price: 0,
            timestamp: timestamp::now_seconds()
        }
    );
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæœ€ä½³å®è·µ

### 6.1 äº‹ä»¶å‘½åè§„èŒƒ

```move
// âœ… å¥½çš„å‘½å
struct TokenMintedEvent has drop, store { ... }
struct OrderFilledEvent has drop, store { ... }
struct LiquidityAddedEvent has drop, store { ... }

// âŒ ä¸å¥½çš„å‘½å
struct Event1 has drop, store { ... }
struct Data has drop, store { ... }
```

### 6.2 äº‹ä»¶å­—æ®µè®¾è®¡

**å¿…é¡»åŒ…å«**ï¼š
- `timestamp`ï¼šæ—¶é—´æˆ³
- å…³é”®å®ä½“çš„ ID æˆ–åœ°å€
- æ“ä½œç±»å‹ï¼ˆå¦‚æœæœ‰å¤šç§ï¼‰

**å¯é€‰åŒ…å«**ï¼š
- é‡‘é¢ã€æ•°é‡ç­‰æ•°å€¼
- çŠ¶æ€å˜åŒ–ï¼ˆbefore/afterï¼‰
- å…ƒæ•°æ®

### 6.3 é”™è¯¯å¤„ç†

```move
// äº‹ä»¶å‘å°„ä¸åº”è¯¥å¤±è´¥
// å¦‚æœå¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“ä¼šå›æ»š

public fun risky_operation(user: &signer) acquires Data {
    // å…ˆå®Œæˆæ ¸å¿ƒé€»è¾‘
    let data = borrow_global_mut<Data>(signer::address_of(user));
    data.value = data.value + 1;
    
    // æœ€åå‘å°„äº‹ä»¶
    event::emit_event(&mut data.events, ...);
}
```

---

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **äº‹ä»¶æ˜¯åªå†™çš„**ï¼šåˆçº¦å‘å°„ï¼Œé“¾ä¸‹ç›‘å¬ï¼Œé“¾ä¸Šä¸èƒ½è¯»å–
2. **EventHandle å¿…é¡»åœ¨èµ„æºä¸­**ï¼šä¸èƒ½ä½œä¸ºå‡½æ•°å‚æ•°
3. **äº‹ä»¶æœ‰åºå·**ï¼šè‡ªåŠ¨é€’å¢ï¼Œä¿è¯é¡ºåº
4. **ç²¾ç®€æ•°æ®**ï¼šåªåŒ…å«å¿…è¦ä¿¡æ¯ï¼Œå¤§æ•°æ®ç”¨ IPFS
5. **ç´¢å¼•å™¨æ˜¯æ¡¥æ¢**ï¼šè¿æ¥é“¾ä¸Šå’Œé“¾ä¸‹ä¸–ç•Œ

---

## ğŸ¯ æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆäº‹ä»¶ä¸èƒ½åœ¨é“¾ä¸Šè¯»å–ï¼Ÿ
2. EventHandle çš„åºå·æœ‰ä»€ä¹ˆç”¨é€”ï¼Ÿ
3. å¦‚ä½•è®¾è®¡ä¸€ä¸ª DEX çš„äº‹ä»¶ç³»ç»Ÿï¼Ÿ
4. ç´¢å¼•å™¨å¦‚ä½•ä¿è¯ä¸é—æ¼äº‹ä»¶ï¼Ÿ

ç­”æ¡ˆåœ¨ä»Šæ—¥è€ƒè¯•ä¸­ï¼

---

**ä¸‹ä¸€æ­¥**ï¼šé˜…è¯» `ä»£ç ç¤ºä¾‹.move`ï¼Œçœ‹å®é™…é¡¹ç›®ä¸­çš„äº‹ä»¶åº”ç”¨ã€‚
