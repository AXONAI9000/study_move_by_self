# Day 07 每日考试 - 编程题

**总分：50 分**  
**时间：30 分钟**

---

## 题目：简易积分系统（50 分）

### 📋 问题描述

实现一个用户积分管理系统，支持积分的赚取、消费和查询功能。

### 🎯 功能要求

实现以下结构和函数：

```move
module my_addr::points_system {
    use std::signer;
    use std::error;
    
    /// 用户积分账户
    struct PointsAccount has key {
        points: u64,
        total_earned: u64,    // 累计赚取
        total_spent: u64,     // 累计消费
        level: u8             // 等级 (0-5)
    }
    
    /// 错误码
    const E_ACCOUNT_ALREADY_EXISTS: u64 = 1;
    const E_ACCOUNT_NOT_FOUND: u64 = 2;
    const E_INSUFFICIENT_POINTS: u64 = 3;
    const E_INVALID_AMOUNT: u64 = 4;
    
    /// 创建积分账户
    public fun create_account(account: &signer) {
        // TODO: 实现
    }
    
    /// 赚取积分
    public fun earn_points(account: &signer, amount: u64) acquires PointsAccount {
        // TODO: 实现
        // 每赚取 1000 积分升 1 级（最高 5 级）
    }
    
    /// 消费积分
    public fun spend_points(account: &signer, amount: u64) acquires PointsAccount {
        // TODO: 实现
    }
    
    /// 查询积分余额
    public fun get_balance(addr: address): u64 acquires PointsAccount {
        // TODO: 实现
    }
    
    /// 查询用户等级
    public fun get_level(addr: address): u8 acquires PointsAccount {
        // TODO: 实现
    }
    
    /// 查询账户统计信息
    public fun get_statistics(addr: address): (u64, u64, u64, u8) acquires PointsAccount {
        // TODO: 实现
        // 返回 (points, total_earned, total_spent, level)
    }
    
    /// 检查账户是否存在
    public fun account_exists(addr: address): bool {
        // TODO: 实现
    }
    
    #[test(user = @0x1)]
    fun test_points_system(user: &signer) acquires PointsAccount {
        // 创建账户
        create_account(user);
        let addr = signer::address_of(user);
        
        // 测试赚取积分
        earn_points(user, 500);
        assert!(get_balance(addr) == 500, 0);
        assert!(get_level(addr) == 0, 1);
        
        // 赚取更多积分，升级
        earn_points(user, 1500);
        assert!(get_balance(addr) == 2000, 2);
        assert!(get_level(addr) == 2, 3);  // 2000 / 1000 = 2
        
        // 测试消费积分
        spend_points(user, 500);
        assert!(get_balance(addr) == 1500, 4);
        
        // 测试统计信息
        let (points, earned, spent, level) = get_statistics(addr);
        assert!(points == 1500, 5);
        assert!(earned == 2000, 6);
        assert!(spent == 500, 7);
        assert!(level == 2, 8);
    }
    
    #[test(user = @0x1)]
    #[expected_failure(abort_code = E_ACCOUNT_ALREADY_EXISTS)]
    fun test_duplicate_account(user: &signer) {
        create_account(user);
        create_account(user);  // 应该失败
    }
    
    #[test(user = @0x1)]
    #[expected_failure(abort_code = E_INSUFFICIENT_POINTS)]
    fun test_insufficient_points(user: &signer) acquires PointsAccount {
        create_account(user);
        earn_points(user, 100);
        spend_points(user, 200);  // 应该失败
    }
}
```

### 📝 实现要求

1. **create_account**：
   - 检查账户是否已存在
   - 初始化所有字段为 0
   - 使用 `move_to` 存储资源

2. **earn_points**：
   - 增加 points 和 total_earned
   - 根据 total_earned 计算等级：`level = min(total_earned / 1000, 5)`
   - 验证 amount > 0

3. **spend_points**：
   - 检查余额是否充足
   - 减少 points，增加 total_spent
   - 验证 amount > 0

4. **查询函数**：
   - 使用 `exists<T>()` 和 `borrow_global<T>()`
   - 正确处理不存在的情况

5. **错误处理**：
   - 使用定义的错误码
   - 使用 `assert!` 进行验证

### ✅ 测试要求

所有测试用例必须通过：
```bash
aptos move test --filter points_system
```

### 💡 提示

1. 等级计算：`level = min(total_earned / 1000, 5)`
2. 使用作用域避免借用冲突
3. 先验证再修改状态
4. 记得添加 `acquires` 声明

### 📊 评分标准

| 项目 | 分数 | 说明 |
|------|------|------|
| **基础功能** | 20 | create, earn, spend 正确实现 |
| **等级计算** | 10 | 升级逻辑正确 |
| **查询函数** | 10 | 所有查询函数正确 |
| **错误处理** | 5 | 正确使用错误码和 assert |
| **acquires** | 5 | 正确声明 acquires |
| **测试通过** | 10 | 所有测试用例通过 |

**总分**：60 分  
**及格线**：42 分（70%）

---

## 提交方式

将完整代码保存为：
```
03_每日考试/你的答案/points_system.move
```

## ⏰ 时间建议

- 阅读题目：5 分钟
- 实现代码：20 分钟
- 测试调试：5 分钟

**祝你成功！** 🚀
